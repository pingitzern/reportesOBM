[{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\__tests__\\api.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\__tests__\\auth.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\__tests__\\forms.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\__tests__\\main.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\__tests__\\remitos-gestion.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\_forms_impl.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\animations.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\api.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'getCurrentToken' is defined but never used.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":25},{"ruleId":"no-unused-vars","severity":2,"message":"'handleSessionExpiration' is defined but never used.","line":1,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":50},{"ruleId":"no-unused-vars","severity":2,"message":"'isDevMode' is defined but never used.","line":1,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":61},{"ruleId":"no-unused-vars","severity":2,"message":"'getSignedPhotoUrl' is defined but never used.","line":560,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":560,"endColumn":33},{"ruleId":"no-undef","severity":2,"message":"'uploadRemitoPdfHtml' is not defined.","line":799,"column":25,"nodeType":"Identifier","messageId":"undef","endLine":799,"endColumn":44}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getCurrentToken, handleSessionExpiration, isDevMode } from './modules/login/auth.js';\r\nimport { state } from './modules/mantenimiento/state.js';\r\nimport { supabase } from './supabaseClient.js';\r\n\r\n// ============================================================================\r\n// AUTENTICACI├ôN - Supabase Auth\r\n// ============================================================================\r\n\r\nexport async function login(email, password) {\r\n    const credentials = {\r\n        email: typeof email === 'string' ? email.trim() : '',\r\n        password: typeof password === 'string' ? password : '',\r\n    };\r\n\r\n    const { data, error } = await supabase.auth.signInWithPassword(credentials);\r\n\r\n    if (error || !data?.session) {\r\n        console.error('Supabase auth login failed', error);\r\n        throw new Error('Credenciales inv├ílidas. Verific├í tu mail y contrase├▒a.');\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\nexport async function verificarSesion() {\r\n    const { data, error } = await supabase.auth.getSession();\r\n    if (error) {\r\n        console.error('Supabase getSession failed', error);\r\n        throw new Error('No se pudo verificar la sesi├│n actual.');\r\n    }\r\n    return data;\r\n}\r\n\r\nexport async function renovarToken() {\r\n    const { data, error } = await supabase.auth.refreshSession();\r\n    if (error) {\r\n        console.error('Supabase refreshSession failed', error);\r\n        throw new Error('No se pudo renovar la sesi├│n.');\r\n    }\r\n    return data;\r\n}\r\n\r\nexport async function guardarMantenimiento(datos) {\r\n    return guardarMantenimientoSupabase(datos);\r\n}\r\n\r\nexport async function guardarMantenimientoAblandador({ payload } = {}) {\r\n    const normalizedPayload = { ...(payload || {}) };\r\n    normalizedPayload.type = 'softener';\r\n    return guardarMantenimientoSupabase(normalizedPayload);\r\n}\r\n\r\nexport async function generarPdfMantenimiento({ maintenanceId, forceRegenerate = false } = {}) {\r\n    if (!maintenanceId) {\r\n        throw new Error('maintenanceId es requerido para generar el PDF.');\r\n    }\r\n\r\n    const { data, error } = await supabase.functions.invoke('generate-maintenance-pdf', {\r\n        body: { maintenanceId, forceRegenerate },\r\n    });\r\n\r\n    if (error) {\r\n        console.error('Supabase PDF generation failed', error);\r\n        throw new Error('No se pudo generar el PDF del mantenimiento.');\r\n    }\r\n\r\n    // Actualizar pdf_path en la tabla maintenances\r\n    if (data?.path) {\r\n        await supabase\r\n            .from('maintenances')\r\n            .update({ pdf_path: data.path })\r\n            .eq('id', maintenanceId);\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\n// Alias para compatibilidad con c├│digo existente\r\nexport async function generarPdfAblandador(options) {\r\n    return generarPdfMantenimiento(options);\r\n}\r\n\r\nexport async function obtenerUrlPdfMantenimiento(pdfPath) {\r\n    if (!pdfPath) {\r\n        return null;\r\n    }\r\n\r\n    const { data, error } = await supabase.storage\r\n        .from('maintenance-reports')\r\n        .createSignedUrl(pdfPath, 3600); // URL v├ílida por 1 hora\r\n\r\n    if (error) {\r\n        console.error('Error obteniendo URL del PDF:', error);\r\n        return null;\r\n    }\r\n\r\n    return data?.signedUrl || null;\r\n}\r\n\r\nexport async function buscarMantenimientos(filtros = {}) {\r\n    // Construir query base\r\n    let query = supabase\r\n        .from('maintenances')\r\n        .select(`\r\n            id,\r\n            client_id,\r\n            equipment_id,\r\n            technician_id,\r\n            service_date,\r\n            status,\r\n            type,\r\n            report_data,\r\n            pdf_path,\r\n            clients:client_id (\r\n                id,\r\n                razon_social\r\n            ),\r\n            profiles:technician_id (\r\n                id,\r\n                full_name\r\n            ),\r\n            equipments:equipment_id (\r\n                id,\r\n                modelo,\r\n                serial_number\r\n            )\r\n        `)\r\n        .order('service_date', { ascending: false });\r\n\r\n    // Filtro por cliente (busca en razon_social del cliente o en report_data)\r\n    if (filtros.cliente && filtros.cliente.trim()) {\r\n        const clienteSearch = filtros.cliente.trim().toLowerCase();\r\n        // Primero buscar clientes que coincidan\r\n        const { data: matchingClients } = await supabase\r\n            .from('clients')\r\n            .select('id')\r\n            .ilike('razon_social', `%${clienteSearch}%`);\r\n\r\n        if (matchingClients && matchingClients.length > 0) {\r\n            const clientIds = matchingClients.map(c => c.id);\r\n            query = query.in('client_id', clientIds);\r\n        } else {\r\n            // Si no hay clientes, buscar en report_data\r\n            query = query.or(`report_data->>Cliente.ilike.%${clienteSearch}%,report_data->>cliente.ilike.%${clienteSearch}%`);\r\n        }\r\n    }\r\n\r\n    // Filtro por t├®cnico (busca en full_name del perfil o en report_data)\r\n    if (filtros.tecnico && filtros.tecnico.trim()) {\r\n        const tecnicoSearch = filtros.tecnico.trim().toLowerCase();\r\n        const { data: matchingTecnicos } = await supabase\r\n            .from('profiles')\r\n            .select('id')\r\n            .ilike('full_name', `%${tecnicoSearch}%`);\r\n\r\n        if (matchingTecnicos && matchingTecnicos.length > 0) {\r\n            const tecnicoIds = matchingTecnicos.map(t => t.id);\r\n            query = query.in('technician_id', tecnicoIds);\r\n        } else {\r\n            query = query.or(`report_data->>Tecnico_Asignado.ilike.%${tecnicoSearch}%,report_data->>tecnico.ilike.%${tecnicoSearch}%`);\r\n        }\r\n    }\r\n\r\n    // Filtro por fecha\r\n    if (filtros.fecha && filtros.fecha.trim()) {\r\n        const fecha = filtros.fecha.trim();\r\n        // Buscar mantenimientos en esa fecha espec├¡fica\r\n        query = query.gte('service_date', `${fecha}T00:00:00`)\r\n            .lte('service_date', `${fecha}T23:59:59`);\r\n    }\r\n\r\n    // L├¡mite de resultados\r\n    query = query.limit(100);\r\n\r\n    const { data, error } = await query;\r\n\r\n    if (error) {\r\n        console.error('Error buscando mantenimientos:', error);\r\n        throw new Error('No se pudieron buscar los mantenimientos.');\r\n    }\r\n\r\n    // Normalizar resultados al formato esperado por el frontend\r\n    return (data || []).map(m => {\r\n        const reportData = m.report_data || {};\r\n        const clienteName = m.clients?.razon_social || reportData.Cliente || reportData.cliente || '';\r\n\r\n        // Buscar t├®cnico en m├║ltiples ubicaciones\r\n        const tecnicoName = m.profiles?.full_name\r\n            || reportData.Tecnico_Asignado\r\n            || reportData.tecnico\r\n            || reportData.seccion_A_cliente?.tecnico\r\n            || reportData.seccion_A_identificacion?.tecnico\r\n            || '';\r\n\r\n        // Buscar modelo de equipo en m├║ltiples ubicaciones\r\n        const modeloEquipo = m.equipments?.modelo\r\n            || reportData.Modelo_Equipo\r\n            || reportData.modelo\r\n            || reportData.equipo\r\n            || reportData.seccion_B_equipo?.modelo\r\n            || '';\r\n\r\n        return {\r\n            // ID ├║nico para edici├│n/eliminaci├│n\r\n            ID_Unico: m.id,\r\n            id: m.id,\r\n            // Campos principales\r\n            Cliente: clienteName,\r\n            cliente: clienteName,\r\n            Fecha_Servicio: m.service_date ? m.service_date.split('T')[0] : '',\r\n            fecha_servicio: m.service_date,\r\n            Tecnico_Asignado: tecnicoName,\r\n            tecnico: tecnicoName,\r\n            Modelo_Equipo: modeloEquipo,\r\n            modelo: modeloEquipo,\r\n            // Campos adicionales del report_data para edici├│n\r\n            Proximo_Mantenimiento: reportData.Proximo_Mantenimiento || reportData.proximo_mantenimiento || '',\r\n            Conductividad_Permeado_Left: reportData.Conductividad_Permeado_Left || reportData.conductividad_permeado || 0,\r\n            Resumen_Recomendaciones: reportData.Resumen_Recomendaciones || reportData.resumen || '',\r\n            // Tipo de mantenimiento\r\n            type: m.type,\r\n            status: m.status,\r\n            // PDF path\r\n            pdf_path: m.pdf_path || null,\r\n            // Todo el report_data por si se necesita\r\n            ...reportData\r\n        };\r\n    });\r\n}\r\n\r\nexport async function actualizarMantenimiento(datos) {\r\n    if (!datos || typeof datos !== 'object') {\r\n        throw new Error('Datos del mantenimiento inv├ílidos.');\r\n    }\r\n\r\n    const maintenanceId = datos.id || datos.maintenanceId;\r\n    if (!maintenanceId) {\r\n        throw new Error('ID del mantenimiento requerido para actualizar.');\r\n    }\r\n\r\n    // Preparar datos para actualizar\r\n    const updateData = {};\r\n\r\n    if (datos.client_id !== undefined) updateData.client_id = datos.client_id;\r\n    if (datos.equipment_id !== undefined) updateData.equipment_id = datos.equipment_id;\r\n    if (datos.technician_id !== undefined) updateData.technician_id = datos.technician_id;\r\n    if (datos.service_date !== undefined) updateData.service_date = datos.service_date;\r\n    if (datos.status !== undefined) updateData.status = datos.status;\r\n    if (datos.type !== undefined) updateData.type = datos.type;\r\n\r\n    // Si hay datos del reporte, actualizarlos\r\n    if (datos.report_data !== undefined) {\r\n        updateData.report_data = datos.report_data;\r\n    } else {\r\n        // Construir report_data desde campos individuales\r\n        const reportFields = { ...datos };\r\n        delete reportFields.id;\r\n        delete reportFields.maintenanceId;\r\n        delete reportFields.client_id;\r\n        delete reportFields.equipment_id;\r\n        delete reportFields.technician_id;\r\n        delete reportFields.service_date;\r\n        delete reportFields.status;\r\n        delete reportFields.type;\r\n\r\n        if (Object.keys(reportFields).length > 0) {\r\n            // Obtener report_data actual y merge\r\n            const { data: current } = await supabase\r\n                .from('maintenances')\r\n                .select('report_data')\r\n                .eq('id', maintenanceId)\r\n                .single();\r\n\r\n            updateData.report_data = {\r\n                ...(current?.report_data || {}),\r\n                ...reportFields\r\n            };\r\n        }\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n        .from('maintenances')\r\n        .update(updateData)\r\n        .eq('id', maintenanceId)\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error('Error actualizando mantenimiento:', error);\r\n        throw new Error('No se pudo actualizar el mantenimiento.');\r\n    }\r\n\r\n    return { success: true, data };\r\n}\r\n\r\nexport async function eliminarMantenimiento(id) {\r\n    const maintenanceId = typeof id === 'object' ? (id.id || id.maintenanceId) : id;\r\n\r\n    if (!maintenanceId) {\r\n        throw new Error('ID del mantenimiento requerido para eliminar.');\r\n    }\r\n\r\n    // Obtener el mantenimiento para saber si tiene PDF asociado\r\n    const { data: maintenance } = await supabase\r\n        .from('maintenances')\r\n        .select('report_data')\r\n        .eq('id', maintenanceId)\r\n        .single();\r\n\r\n    // Si tiene PDF en Storage, eliminarlo\r\n    if (maintenance?.report_data?.pdf_path) {\r\n        await supabase.storage\r\n            .from('maintenance-reports')\r\n            .remove([maintenance.report_data.pdf_path]);\r\n    }\r\n\r\n    const { error } = await supabase\r\n        .from('maintenances')\r\n        .delete()\r\n        .eq('id', maintenanceId);\r\n\r\n    if (error) {\r\n        console.error('Error eliminando mantenimiento:', error);\r\n        throw new Error('No se pudo eliminar el mantenimiento.');\r\n    }\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport async function obtenerDashboard() {\r\n    const now = new Date();\r\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();\r\n    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).toISOString();\r\n\r\n    // Total de mantenimientos\r\n    const { count: totalMantenimientos } = await supabase\r\n        .from('maintenances')\r\n        .select('*', { count: 'exact', head: true });\r\n\r\n    // Mantenimientos este mes\r\n    const { count: esteMes } = await supabase\r\n        .from('maintenances')\r\n        .select('*', { count: 'exact', head: true })\r\n        .gte('service_date', startOfMonth)\r\n        .lte('service_date', endOfMonth);\r\n\r\n    // Pr├│ximos mantenimientos (status pendiente o programado)\r\n    const { data: proximosData, count: proximos } = await supabase\r\n        .from('maintenances')\r\n        .select(`\r\n            id,\r\n            service_date,\r\n            status,\r\n            report_data,\r\n            clients:client_id (razon_social)\r\n        `, { count: 'exact' })\r\n        .in('status', ['pendiente', 'programado', 'borrador'])\r\n        .gte('service_date', now.toISOString())\r\n        .order('service_date', { ascending: true })\r\n        .limit(5);\r\n\r\n    // T├®cnicos activos (que hayan hecho mantenimientos en los ├║ltimos 30 d├¡as)\r\n    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString();\r\n    const { data: tecnicosData } = await supabase\r\n        .from('maintenances')\r\n        .select('technician_id')\r\n        .gte('service_date', thirtyDaysAgo)\r\n        .not('technician_id', 'is', null);\r\n\r\n    const tecnicosUnicos = new Set((tecnicosData || []).map(m => m.technician_id));\r\n    const tecnicosActivos = tecnicosUnicos.size;\r\n\r\n    // Mantenimientos por mes (├║ltimos 6 meses)\r\n    const mantenimientosPorMes = [];\r\n    for (let i = 5; i >= 0; i--) {\r\n        const monthStart = new Date(now.getFullYear(), now.getMonth() - i, 1);\r\n        const monthEnd = new Date(now.getFullYear(), now.getMonth() - i + 1, 0, 23, 59, 59);\r\n\r\n        const { count } = await supabase\r\n            .from('maintenances')\r\n            .select('*', { count: 'exact', head: true })\r\n            .gte('service_date', monthStart.toISOString())\r\n            .lte('service_date', monthEnd.toISOString());\r\n\r\n        const monthName = monthStart.toLocaleDateString('es-AR', { month: 'short' });\r\n        mantenimientosPorMes.push({\r\n            mes: monthName,\r\n            cantidad: count || 0\r\n        });\r\n    }\r\n\r\n    // Distribuci├│n por t├®cnico (├║ltimos 30 d├¡as)\r\n    const { data: distData } = await supabase\r\n        .from('maintenances')\r\n        .select(`\r\n            technician_id,\r\n            profiles:technician_id (full_name)\r\n        `)\r\n        .gte('service_date', thirtyDaysAgo)\r\n        .not('technician_id', 'is', null);\r\n\r\n    const tecnicoCount = {};\r\n    (distData || []).forEach(m => {\r\n        const nombre = m.profiles?.full_name || 'Sin asignar';\r\n        tecnicoCount[nombre] = (tecnicoCount[nombre] || 0) + 1;\r\n    });\r\n\r\n    const distribucionTecnico = Object.entries(tecnicoCount).map(([tecnico, cantidad]) => ({\r\n        tecnico,\r\n        cantidad\r\n    }));\r\n\r\n    // Pr├│ximos mantenimientos formateados\r\n    const proximosMantenimientos = (proximosData || []).map(m => ({\r\n        id: m.id,\r\n        cliente: m.clients?.razon_social || m.report_data?.Cliente || 'N/A',\r\n        fecha: m.service_date ? new Date(m.service_date).toLocaleDateString('es-AR') : 'N/A',\r\n        status: m.status\r\n    }));\r\n\r\n    return {\r\n        totalMantenimientos: totalMantenimientos || 0,\r\n        esteMes: esteMes || 0,\r\n        proximos: proximos || 0,\r\n        tecnicosActivos,\r\n        mantenimientosPorMes,\r\n        distribucionTecnico,\r\n        proximosMantenimientos\r\n    };\r\n}\r\n\r\n// ============================================================================\r\n// CLIENTES - Supabase\r\n// ============================================================================\r\n\r\nexport async function obtenerClientes({ forceRefresh = false } = {}) {\r\n    if (!forceRefresh && state.clientesLoaded) {\r\n        return state.clientes;\r\n    }\r\n\r\n    const data = await fetchClientesSupabase();\r\n\r\n    if (!Array.isArray(data)) {\r\n        throw new Error('La respuesta de clientes no es v├ílida.');\r\n    }\r\n\r\n    state.clientes = data.map(normalizeClienteRecord);\r\n    state.clientesLoaded = true;\r\n\r\n    return state.clientes;\r\n}\r\n\r\n// ============================================================================\r\n// REMITOS - Funciones migradas a Supabase\r\n// ============================================================================\r\n\r\n/**\r\n * Obtiene la lista paginada de remitos desde Supabase\r\n */\r\nexport async function obtenerRemitos({ page = 1, pageSize = 20 } = {}) {\r\n    const from = (page - 1) * pageSize;\r\n    const to = from + pageSize - 1;\r\n\r\n    // Obtener total de registros\r\n    const { count, error: countError } = await supabase\r\n        .from('remitos')\r\n        .select('*', { count: 'exact', head: true });\r\n\r\n    if (countError) {\r\n        console.error('Error contando remitos:', countError);\r\n        throw new Error('No se pudo obtener el total de remitos.');\r\n    }\r\n\r\n    // Obtener remitos con datos del cliente\r\n    const { data, error } = await supabase\r\n        .from('remitos')\r\n        .select(`\r\n            *,\r\n            clients:client_id (\r\n                id,\r\n                razon_social,\r\n                direccion,\r\n                cuit,\r\n                contacto_info\r\n            )\r\n        `)\r\n        .order('fecha_remito', { ascending: false })\r\n        .range(from, to);\r\n\r\n    if (error) {\r\n        console.error('Error obteniendo remitos:', error);\r\n        throw new Error('No se pudieron cargar los remitos.');\r\n    }\r\n\r\n    // Mapear a formato esperado por el frontend\r\n    const remitos = (data || []).map(remito => ({\r\n        id: remito.id,\r\n        numeroRemito: remito.numero_remito,\r\n        NumeroRemito: remito.numero_remito,\r\n        numeroReporte: remito.numero_reporte,\r\n        NumeroReporte: remito.numero_reporte,\r\n        cliente: remito.cliente_nombre || remito.clients?.razon_social || '',\r\n        Cliente: remito.cliente_nombre || remito.clients?.razon_social || '',\r\n        fechaRemito: remito.fecha_remito,\r\n        FechaRemito: remito.fecha_remito,\r\n        fechaRemitoISO: remito.fecha_remito,\r\n        fechaServicio: remito.fecha_servicio,\r\n        FechaServicio: remito.fecha_servicio,\r\n        fechaServicioISO: remito.fecha_servicio,\r\n        tecnico: remito.technician_id,\r\n        Tecnico: remito.technician_id,\r\n        observaciones: remito.observaciones,\r\n        Observaciones: remito.observaciones,\r\n        direccion: remito.direccion,\r\n        Direccion: remito.direccion,\r\n        telefono: remito.telefono,\r\n        Telefono: remito.telefono,\r\n        email: remito.email,\r\n        Email: remito.email,\r\n        cuit: remito.cuit,\r\n        CUIT: remito.cuit,\r\n        reporteId: remito.maintenance_id,\r\n        ReporteID: remito.maintenance_id,\r\n        // Datos del equipo\r\n        equipo_descripcion: remito.equipo_descripcion || '',\r\n        equipo_modelo: remito.equipo_modelo || '',\r\n        equipo_serie: remito.equipo_serie || '',\r\n        equipo_interno: remito.equipo_interno || '',\r\n        equipo_ubicacion: remito.equipo_ubicacion || '',\r\n        // Repuestos (JSON)\r\n        repuestos: remito.repuestos || [],\r\n        // Path del PDF guardado\r\n        pdf_path: remito.pdf_path || '',\r\n        // Paths de fotos (se resuelven URLs firmadas bajo demanda)\r\n        Foto1Id: remito.foto_1_path || '',\r\n        Foto2Id: remito.foto_2_path || '',\r\n        Foto3Id: remito.foto_3_path || '',\r\n        Foto4Id: remito.foto_4_path || '',\r\n        foto_1_path: remito.foto_1_path || '',\r\n        foto_2_path: remito.foto_2_path || '',\r\n        foto_3_path: remito.foto_3_path || '',\r\n        foto_4_path: remito.foto_4_path || '',\r\n    }));\r\n\r\n    const totalItems = count || 0;\r\n    const totalPages = Math.ceil(totalItems / pageSize);\r\n\r\n    return {\r\n        remitos,\r\n        totalItems,\r\n        totalPages,\r\n        currentPage: page,\r\n        pageSize,\r\n    };\r\n}\r\n\r\n/**\r\n * Obtiene URL firmada para una foto en Storage\r\n */\r\nasync function getSignedPhotoUrl(path) {\r\n    if (!path) return '';\r\n\r\n    try {\r\n        const { data, error } = await supabase.storage\r\n            .from('maintenance-reports')\r\n            .createSignedUrl(path, 3600); // 1 hora de validez\r\n\r\n        if (error) {\r\n            console.warn('Error obteniendo URL firmada:', error);\r\n            return '';\r\n        }\r\n        return data?.signedUrl || '';\r\n    } catch (err) {\r\n        console.warn('Error en getSignedPhotoUrl:', err);\r\n        return '';\r\n    }\r\n}\r\n\r\n/**\r\n * Sube una foto a Storage y retorna el path\r\n */\r\nasync function uploadRemitoPhoto(remitoId, photoData, slotIndex) {\r\n    if (!photoData?.base64Data) return null;\r\n\r\n    const mimeType = photoData.mimeType || 'image/jpeg';\r\n    const extension = mimeType.split('/')[1] || 'jpg';\r\n    const fileName = `foto_${slotIndex}.${extension}`;\r\n    const filePath = `Remitos/${remitoId}/${fileName}`;\r\n\r\n    // Convertir base64 a Blob\r\n    const byteCharacters = atob(photoData.base64Data);\r\n    const byteNumbers = new Array(byteCharacters.length);\r\n    for (let i = 0; i < byteCharacters.length; i++) {\r\n        byteNumbers[i] = byteCharacters.charCodeAt(i);\r\n    }\r\n    const byteArray = new Uint8Array(byteNumbers);\r\n    const blob = new Blob([byteArray], { type: mimeType });\r\n\r\n    const { error } = await supabase.storage\r\n        .from('maintenance-reports')\r\n        .upload(filePath, blob, {\r\n            contentType: mimeType,\r\n            upsert: true,\r\n        });\r\n\r\n    if (error) {\r\n        console.error(`Error subiendo foto ${slotIndex}:`, error);\r\n        return null;\r\n    }\r\n\r\n    return filePath;\r\n}\r\n\r\n/**\r\n * Sube un PDF blob al Storage de Supabase\r\n * @param {string} remitoId - ID del remito\r\n * @param {Blob} pdfBlob - Blob del PDF generado\r\n * @param {string} numeroRemito - N├║mero de remito para el nombre del archivo\r\n * @returns {Promise<string|null>} Path del archivo subido o null si falla\r\n */\r\nasync function uploadRemitoPdfBlob(remitoId, pdfBlob, numeroRemito) {\r\n    if (!pdfBlob) return null;\r\n\r\n    // Nombre del archivo: remito_R2025-00001.pdf\r\n    const fileName = `remito_${numeroRemito || remitoId}.pdf`;\r\n    const filePath = `Remitos/${remitoId}/${fileName}`;\r\n\r\n    const { error } = await supabase.storage\r\n        .from('maintenance-reports')\r\n        .upload(filePath, pdfBlob, {\r\n            contentType: 'application/pdf',\r\n            upsert: true,\r\n        });\r\n\r\n    if (error) {\r\n        console.error('Error subiendo PDF:', error);\r\n        return null;\r\n    }\r\n\r\n    return filePath;\r\n}\r\n\r\n/**\r\n * Guarda el PDF blob de un remito en Storage y actualiza la BD\r\n * @param {string} remitoId - ID del remito\r\n * @param {Blob} pdfBlob - Blob del PDF generado con jsPDF\r\n * @param {string} numeroRemito - N├║mero de remito\r\n * @returns {Promise<string|null>} Path del PDF o null si falla\r\n */\r\nexport async function guardarPdfRemito(remitoId, pdfBlob, numeroRemito) {\r\n    if (!remitoId || !pdfBlob) return null;\r\n\r\n    const pdfPath = await uploadRemitoPdfBlob(remitoId, pdfBlob, numeroRemito);\r\n    if (!pdfPath) return null;\r\n\r\n    // Actualizar el remito con el path del PDF\r\n    const { error } = await supabase\r\n        .from('remitos')\r\n        .update({ pdf_path: pdfPath })\r\n        .eq('id', remitoId);\r\n\r\n    if (error) {\r\n        console.warn('Error actualizando pdf_path en remito:', error);\r\n    }\r\n\r\n    return pdfPath;\r\n}\r\n\r\n/**\r\n * Obtiene URL firmada para descargar el PDF del remito\r\n */\r\nexport async function obtenerUrlPdfRemito(pdfPath) {\r\n    if (!pdfPath) return null;\r\n\r\n    try {\r\n        const { data, error } = await supabase.storage\r\n            .from('maintenance-reports')\r\n            .createSignedUrl(pdfPath, 3600); // 1 hora de validez\r\n\r\n        if (error) {\r\n            console.warn('Error obteniendo URL del PDF:', error);\r\n            return null;\r\n        }\r\n        return data?.signedUrl || null;\r\n    } catch (err) {\r\n        console.warn('Error en obtenerUrlPdfRemito:', err);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Crea un nuevo remito en Supabase\r\n */\r\nexport async function crearRemito(datos) {\r\n    if (!datos || typeof datos !== 'object') {\r\n        throw new Error('Datos del remito inv├ílidos.');\r\n    }\r\n\r\n    const reporteData = datos.reporteData || datos;\r\n\r\n    // Intentar generar n├║mero de remito manualmente si no se conf├¡a en el default de la BD\r\n    let numeroRemitoGenerado = null;\r\n    try {\r\n        const { data: nextNumber, error: rpcError } = await supabase.rpc('generate_remito_number');\r\n        if (!rpcError && nextNumber) {\r\n            numeroRemitoGenerado = nextNumber;\r\n        }\r\n    } catch (err) {\r\n        console.warn('No se pudo generar n├║mero de remito v├¡a RPC, confiando en default de BD:', err);\r\n    }\r\n\r\n    // Preparar datos para insertar\r\n    const remitoData = {\r\n        numero_reporte: reporteData.numero_reporte || reporteData.NumeroReporte || null,\r\n        maintenance_id: reporteData.maintenanceId || reporteData.maintenance_id || null,\r\n        client_id: reporteData.clientId || reporteData.client_id || null,\r\n        fecha_remito: new Date().toISOString(),\r\n        fecha_servicio: reporteData.fecha_servicio || reporteData.fecha || null,\r\n        cliente_nombre: reporteData.clienteNombre || reporteData.cliente_nombre || reporteData.cliente || reporteData.Cliente || '',\r\n        direccion: reporteData.direccion || reporteData.cliente_direccion || '',\r\n        telefono: reporteData.cliente_telefono || reporteData.telefono || '',\r\n        email: reporteData.cliente_email || reporteData.email || '',\r\n        cuit: reporteData.cliente_cuit || reporteData.cuit || '',\r\n        equipo_descripcion: reporteData.equipo || '',\r\n        equipo_modelo: reporteData.modelo || '',\r\n        equipo_serie: reporteData.n_serie || reporteData.numero_serie || '',\r\n        equipo_interno: reporteData.id_interna || '',\r\n        equipo_ubicacion: reporteData.ubicacion || '',\r\n        observaciones: datos.observaciones || reporteData.observaciones || '',\r\n        repuestos: JSON.stringify(reporteData.repuestos || []),\r\n    };\r\n\r\n    if (numeroRemitoGenerado) {\r\n        remitoData.numero_remito = numeroRemitoGenerado;\r\n    }\r\n\r\n    // Si el cliente_nombre parece ser un UUID, buscar el nombre real del cliente\r\n    const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n    if (remitoData.cliente_nombre && uuidPattern.test(remitoData.cliente_nombre)) {\r\n        try {\r\n            // El nombre del cliente es un UUID, buscar el cliente real\r\n            const clientId = remitoData.client_id || remitoData.cliente_nombre;\r\n            const { data: clientData, error: clientError } = await supabase\r\n                .from('clients')\r\n                .select('razon_social')\r\n                .eq('id', clientId)\r\n                .maybeSingle();\r\n\r\n            if (!clientError && clientData?.razon_social) {\r\n                remitoData.cliente_nombre = clientData.razon_social;\r\n            }\r\n        } catch (err) {\r\n            console.warn('No se pudo obtener el nombre del cliente desde la BD:', err);\r\n        }\r\n    }\r\n\r\n    // Insertar remito (el numero_remito se genera autom├íticamente si no se provee)\r\n    const { data: remito, error } = await supabase\r\n        .from('remitos')\r\n        .insert([remitoData])\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error('Error creando remito:', error);\r\n        throw new Error('No se pudo crear el remito.');\r\n    }\r\n\r\n    // Subir fotos si las hay\r\n    const fotos = datos.fotos || [];\r\n    const fotoPaths = { foto_1_path: null, foto_2_path: null, foto_3_path: null, foto_4_path: null };\r\n\r\n    for (let i = 0; i < Math.min(fotos.length, 4); i++) {\r\n        const foto = fotos[i];\r\n        if (foto?.base64Data) {\r\n            const path = await uploadRemitoPhoto(remito.id, foto, i + 1);\r\n            if (path) {\r\n                fotoPaths[`foto_${i + 1}_path`] = path;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Actualizar remito con los paths de las fotos si se subieron\r\n    const hasPhotos = Object.values(fotoPaths).some(p => p !== null);\r\n    if (hasPhotos) {\r\n        const { error: updateError } = await supabase\r\n            .from('remitos')\r\n            .update(fotoPaths)\r\n            .eq('id', remito.id);\r\n\r\n        if (updateError) {\r\n            console.warn('Error actualizando paths de fotos:', updateError);\r\n        }\r\n    }\r\n\r\n    // Guardar el HTML del PDF si se proporciona\r\n    let pdfPath = null;\r\n    if (datos.pdfHtml) {\r\n        pdfPath = await uploadRemitoPdfHtml(remito.id, datos.pdfHtml);\r\n        if (pdfPath) {\r\n            await supabase\r\n                .from('remitos')\r\n                .update({ pdf_path: pdfPath })\r\n                .eq('id', remito.id);\r\n        }\r\n    }\r\n\r\n    return {\r\n        success: true,\r\n        data: {\r\n            id: remito.id,\r\n            NumeroRemito: remito.numero_remito,\r\n            numeroRemito: remito.numero_remito,\r\n            pdfPath: pdfPath,\r\n            emailStatus: { skipped: true, message: 'Env├¡o de email pendiente de migraci├│n' },\r\n        },\r\n    };\r\n}\r\n\r\n/**\r\n * Actualiza un remito existente en Supabase\r\n */\r\nexport async function actualizarRemito(datos) {\r\n    if (!datos || typeof datos !== 'object') {\r\n        throw new Error('Datos del remito inv├ílidos.');\r\n    }\r\n\r\n    const remitoId = datos.remitoId || datos.id;\r\n    if (!remitoId) {\r\n        throw new Error('ID del remito requerido para actualizar.');\r\n    }\r\n\r\n    // Preparar datos para actualizar\r\n    const updateData = {};\r\n\r\n    if (datos.cliente !== undefined) updateData.cliente_nombre = datos.cliente;\r\n    if (datos.direccion !== undefined) updateData.direccion = datos.direccion;\r\n    if (datos.telefono !== undefined) updateData.telefono = datos.telefono;\r\n    if (datos.email !== undefined) updateData.email = datos.email;\r\n    if (datos.cuit !== undefined) updateData.cuit = datos.cuit;\r\n    if (datos.observaciones !== undefined) updateData.observaciones = datos.observaciones;\r\n    if (datos.fechaServicio !== undefined) updateData.fecha_servicio = datos.fechaServicio;\r\n    if (datos.tecnico !== undefined) updateData.technician_id = datos.tecnico;\r\n    if (datos.repuestos !== undefined) updateData.repuestos = JSON.stringify(datos.repuestos);\r\n\r\n    const { data: remito, error } = await supabase\r\n        .from('remitos')\r\n        .update(updateData)\r\n        .eq('id', remitoId)\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error('Error actualizando remito:', error);\r\n        throw new Error('No se pudo actualizar el remito.');\r\n    }\r\n\r\n    // Manejar fotos: subir nuevas, eliminar marcadas para remover\r\n    const fotos = datos.fotos || [];\r\n    for (let i = 0; i < Math.min(fotos.length, 4); i++) {\r\n        const foto = fotos[i];\r\n        const pathKey = `foto_${i + 1}_path`;\r\n\r\n        if (foto?.shouldRemove && remito[pathKey]) {\r\n            // Eliminar foto de Storage\r\n            await supabase.storage\r\n                .from('maintenance-reports')\r\n                .remove([remito[pathKey]]);\r\n\r\n            await supabase\r\n                .from('remitos')\r\n                .update({ [pathKey]: null })\r\n                .eq('id', remitoId);\r\n        } else if (foto?.base64Data) {\r\n            // Subir nueva foto\r\n            const path = await uploadRemitoPhoto(remitoId, foto, i + 1);\r\n            if (path) {\r\n                await supabase\r\n                    .from('remitos')\r\n                    .update({ [pathKey]: path })\r\n                    .eq('id', remitoId);\r\n            }\r\n        }\r\n    }\r\n\r\n    return {\r\n        success: true,\r\n        data: {\r\n            id: remito.id,\r\n            NumeroRemito: remito.numero_remito,\r\n            numeroRemito: remito.numero_remito,\r\n        },\r\n    };\r\n}\r\n\r\n/**\r\n * Elimina un remito de Supabase (incluyendo fotos)\r\n */\r\nexport async function eliminarRemito(remitoId) {\r\n    // Normalizar input\r\n    const id = typeof remitoId === 'object'\r\n        ? (remitoId.remitoId || remitoId.id)\r\n        : remitoId;\r\n\r\n    if (!id) {\r\n        throw new Error('ID del remito requerido para eliminar.');\r\n    }\r\n\r\n    // Obtener remito para saber qu├® fotos eliminar\r\n    const { data: remito, error: fetchError } = await supabase\r\n        .from('remitos')\r\n        .select('foto_1_path, foto_2_path, foto_3_path, foto_4_path')\r\n        .eq('id', id)\r\n        .single();\r\n\r\n    if (fetchError && fetchError.code !== 'PGRST116') {\r\n        console.error('Error obteniendo remito para eliminar:', fetchError);\r\n    }\r\n\r\n    // Eliminar fotos del Storage\r\n    if (remito) {\r\n        const fotosToDelete = [\r\n            remito.foto_1_path,\r\n            remito.foto_2_path,\r\n            remito.foto_3_path,\r\n            remito.foto_4_path,\r\n        ].filter(Boolean);\r\n\r\n        if (fotosToDelete.length > 0) {\r\n            const { error: storageError } = await supabase.storage\r\n                .from('maintenance-reports')\r\n                .remove(fotosToDelete);\r\n\r\n            if (storageError) {\r\n                console.warn('Error eliminando fotos:', storageError);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Eliminar remito de la base de datos\r\n    const { error } = await supabase\r\n        .from('remitos')\r\n        .delete()\r\n        .eq('id', id);\r\n\r\n    if (error) {\r\n        console.error('Error eliminando remito:', error);\r\n        throw new Error('No se pudo eliminar el remito.');\r\n    }\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport async function obtenerVersionServidor() {\r\n    // Versi├│n hardcodeada - ya no depende del backend de Google Apps Script\r\n    return {\r\n        version: '2.0.0',\r\n        build: 'supabase-migration',\r\n        date: '2025-11-27',\r\n        environment: 'supabase'\r\n    };\r\n}\r\n\r\nexport async function enviarFeedbackTicket(datos) {\r\n    if (!datos || typeof datos !== 'object') {\r\n        throw new Error('Datos del feedback inv├ílidos.');\r\n    }\r\n\r\n    // Obtener usuario actual si est├í autenticado\r\n    const { data: sessionData } = await supabase.auth.getSession();\r\n    const userId = sessionData?.session?.user?.id || null;\r\n    const userEmail = sessionData?.session?.user?.email || datos.email || datos.usuario || '';\r\n\r\n    // Mapear categor├¡as del frontend al formato de la BD\r\n    const categoriaMap = {\r\n        'bug': 'bug',\r\n        'error': 'bug',\r\n        'mejora': 'mejora',\r\n        'sugerencia': 'mejora',\r\n        'rendimiento': 'rendimiento',\r\n        'performance': 'rendimiento',\r\n        'otro': 'otro',\r\n        'other': 'otro'\r\n    };\r\n\r\n    const impactoMap = {\r\n        'bajo': 'bajo',\r\n        'low': 'bajo',\r\n        'medio': 'medio',\r\n        'medium': 'medio',\r\n        'alto': 'alto',\r\n        'high': 'alto',\r\n        'critico': 'critico',\r\n        'critical': 'critico'\r\n    };\r\n\r\n    const categoria = categoriaMap[(datos.categoria || datos.category || 'otro').toLowerCase()] || 'otro';\r\n    const impacto = impactoMap[(datos.impacto || datos.impact || 'bajo').toLowerCase()] || 'bajo';\r\n\r\n    const feedbackData = {\r\n        user_email: userEmail,\r\n        user_id: userId,\r\n        categoria,\r\n        impacto,\r\n        mensaje: datos.mensaje || datos.message || '',\r\n        contacto_info: datos.contactoInfo || datos.contacto || '',\r\n        permitir_contacto: datos.permitirContacto ?? datos.allowContact ?? false,\r\n        origen_url: datos.origenUrl || datos.url || (typeof window !== 'undefined' ? window.location.href : ''),\r\n        user_agent: datos.userAgent || (typeof navigator !== 'undefined' ? navigator.userAgent : ''),\r\n        estado: 'nuevo'\r\n    };\r\n\r\n    const { data, error } = await supabase\r\n        .from('feedback')\r\n        .insert([feedbackData])\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error('Error enviando feedback:', error);\r\n        throw new Error('No se pudo enviar el feedback.');\r\n    }\r\n\r\n    // Enviar notificaci├│n por email al admin\r\n    try {\r\n        const userName = sessionData?.session?.user?.user_metadata?.nombre\r\n            || sessionData?.session?.user?.user_metadata?.full_name\r\n            || '';\r\n\r\n        await supabase.functions.invoke('send-email', {\r\n            body: {\r\n                type: 'feedback-notificacion',\r\n                to: 'info@ohminstrumental.net',\r\n                data: {\r\n                    userEmail,\r\n                    userName,\r\n                    categoria,\r\n                    impacto,\r\n                    mensaje: feedbackData.mensaje,\r\n                    origenUrl: feedbackData.origen_url,\r\n                    ticketId: data.id,\r\n                },\r\n            },\r\n        });\r\n        console.log('[feedback] Email de notificaci├│n enviado');\r\n    } catch (emailError) {\r\n        // No bloquear si el email falla - el feedback ya se guard├│\r\n        console.warn('[feedback] Error enviando email de notificaci├│n:', emailError);\r\n    }\r\n\r\n    return { success: true, ticketId: data.id };\r\n}\r\n\r\nexport async function fetchClientesSupabase() {\r\n    const { data, error } = await supabase\r\n        .from('clients')\r\n        .select('*')\r\n        .order('razon_social', { ascending: true });\r\n\r\n    if (error) {\r\n        console.error('Supabase fetch error:', error);\r\n        throw error;\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n    window.testSupabase = fetchClientesSupabase;\r\n}\r\n\r\nexport async function guardarMantenimientoSupabase(payload = {}) {\r\n    if (!payload || typeof payload !== 'object') {\r\n        throw new Error('Los datos del formulario son inv├ílidos.');\r\n    }\r\n\r\n    const clientId = extractClientIdFromPayload(payload);\r\n    if (!clientId) {\r\n        throw new Error('Selecciona un cliente v├ílido antes de guardar.');\r\n    }\r\n\r\n    const serviceDate = normalizeDate(payload.fecha_servicio || payload.service_date || payload.fecha);\r\n    const type = determineMaintenanceType(payload);\r\n\r\n    const reportData = { ...payload };\r\n    delete reportData.client_id;\r\n    delete reportData.clienteId;\r\n    delete reportData.cliente;\r\n    delete reportData.Cliente;\r\n    delete reportData.razon_social;\r\n    delete reportData.RazonSocial;\r\n    delete reportData.type;\r\n    delete reportData.tipo_mantenimiento;\r\n    delete reportData.service_date;\r\n    delete reportData.fecha_servicio;\r\n\r\n    // Intentar obtener el technician_id basado en el nombre del t├®cnico\r\n    // Buscar en m├║ltiples ubicaciones del payload\r\n    let technicianId = null;\r\n    const tecnicoNombre = payload.Tecnico_Asignado\r\n        || payload.tecnico_asignado\r\n        || payload.tecnico\r\n        || payload.seccion_A_cliente?.tecnico\r\n        || payload.seccion_A_identificacion?.tecnico\r\n        || '';\r\n\r\n    if (tecnicoNombre) {\r\n        const { data: tecnicoData } = await supabase\r\n            .from('profiles')\r\n            .select('id')\r\n            .ilike('full_name', tecnicoNombre)\r\n            .limit(1)\r\n            .maybeSingle();\r\n\r\n        if (tecnicoData?.id) {\r\n            technicianId = tecnicoData.id;\r\n        }\r\n    }\r\n\r\n    // Intentar obtener o crear el equipment_id basado en los datos del equipo\r\n    let equipmentId = null;\r\n    const equipoData = payload.seccion_B_equipo || {};\r\n    const equipoModelo = equipoData.modelo || '';\r\n    const equipoSerial = equipoData.numero_serie || '';\r\n\r\n    if (clientId && (equipoModelo || equipoSerial)) {\r\n        // Buscar equipo existente por cliente y serial/modelo\r\n        let equipoQuery = supabase\r\n            .from('equipments')\r\n            .select('id')\r\n            .eq('client_id', clientId);\r\n\r\n        if (equipoSerial) {\r\n            equipoQuery = equipoQuery.eq('serial_number', equipoSerial);\r\n        } else if (equipoModelo) {\r\n            equipoQuery = equipoQuery.eq('modelo', equipoModelo);\r\n        }\r\n\r\n        const { data: equipoExistente } = await equipoQuery.limit(1).single();\r\n\r\n        if (equipoExistente?.id) {\r\n            equipmentId = equipoExistente.id;\r\n        } else if (equipoModelo || equipoSerial) {\r\n            // Crear nuevo equipo\r\n            const { data: nuevoEquipo } = await supabase\r\n                .from('equipments')\r\n                .insert({\r\n                    client_id: clientId,\r\n                    modelo: equipoModelo || null,\r\n                    serial_number: equipoSerial || null,\r\n                    type: type || 'softener'\r\n                })\r\n                .select('id')\r\n                .single();\r\n\r\n            if (nuevoEquipo?.id) {\r\n                equipmentId = nuevoEquipo.id;\r\n            }\r\n        }\r\n    }\r\n\r\n    const insertData = {\r\n        client_id: clientId,\r\n        type,\r\n        report_data: reportData,\r\n        service_date: serviceDate,\r\n        status: 'finalizado',\r\n    };\r\n\r\n    // Solo agregar technician_id si se encontr├│\r\n    if (technicianId) {\r\n        insertData.technician_id = technicianId;\r\n    }\r\n\r\n    // Solo agregar equipment_id si se encontr├│ o cre├│\r\n    if (equipmentId) {\r\n        insertData.equipment_id = equipmentId;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n        .from('maintenances')\r\n        .insert(insertData)\r\n        .select('id')\r\n        .single();\r\n\r\n    if (error || !data?.id) {\r\n        console.error('Supabase insert failed:', error);\r\n        throw new Error('No se pudo guardar el mantenimiento en Supabase.');\r\n    }\r\n\r\n    let pdfUrl = null;\r\n    try {\r\n        const { data: pdfData, error: pdfError } = await supabase.functions.invoke('generate-maintenance-pdf', {\r\n            body: { maintenanceId: data.id },\r\n        });\r\n\r\n        if (pdfError) {\r\n            throw pdfError;\r\n        }\r\n\r\n        pdfUrl = pdfData?.url || pdfData?.signedUrl || null;\r\n        if (pdfUrl) {\r\n            await promptPdfDownload(pdfUrl);\r\n        }\r\n    } catch (pdfError) {\r\n        console.warn('No se pudo generar el PDF autom├íticamente', pdfError);\r\n    }\r\n\r\n    return { success: true, maintenanceId: data.id, pdfUrl };\r\n}\r\n\r\nasync function promptPdfDownload(url) {\r\n    if (typeof window === 'undefined' || !url) {\r\n        return;\r\n    }\r\n\r\n    if (window.Swal && typeof window.Swal.fire === 'function') {\r\n        const result = await window.Swal.fire({\r\n            title: 'Reporte generado',\r\n            text: 'El PDF est├í listo. ┬┐Quer├®s descargarlo ahora?',\r\n            icon: 'success',\r\n            confirmButtonText: 'Descargar PDF',\r\n            cancelButtonText: 'Cerrar',\r\n            showCancelButton: true,\r\n        });\r\n\r\n        if (result.isConfirmed) {\r\n            window.open(url, '_blank', 'noopener');\r\n        }\r\n        return;\r\n    }\r\n\r\n    const shouldDownload = window.confirm(\r\n        'El PDF del mantenimiento est├í listo. Seleccion├í Aceptar para descargarlo o Cancelar para cerrar.',\r\n    );\r\n    if (shouldDownload) {\r\n        window.open(url, '_blank', 'noopener');\r\n    }\r\n}\r\n\r\nfunction extractClientIdFromPayload(payload) {\r\n    const candidateValues = [\r\n        payload.client_id,\r\n        payload.clienteId,\r\n        payload.ClienteId,\r\n        payload.cliente_id,\r\n        payload.cliente,\r\n        payload.Cliente,\r\n        payload.razon_social,\r\n        payload.RazonSocial,\r\n    ];\r\n\r\n    for (const value of candidateValues) {\r\n        const resolved = resolveClientIdentifier(value);\r\n        if (resolved) {\r\n            return resolved;\r\n        }\r\n    }\r\n\r\n    if (payload.cliente && typeof payload.cliente === 'object') {\r\n        return extractClientIdFromPayload(payload.cliente);\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\nfunction resolveClientIdentifier(value) {\r\n    if (typeof value !== 'string') {\r\n        return null;\r\n    }\r\n\r\n    const trimmed = value.trim();\r\n    if (!trimmed) {\r\n        return null;\r\n    }\r\n\r\n    if (isLikelyUuid(trimmed)) {\r\n        return trimmed;\r\n    }\r\n\r\n    return findClientIdByName(trimmed);\r\n}\r\n\r\nfunction isLikelyUuid(value) {\r\n    return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(value);\r\n}\r\n\r\nfunction findClientIdByName(name) {\r\n    if (!Array.isArray(state.clientes) || state.clientes.length === 0) {\r\n        return null;\r\n    }\r\n\r\n    const target = normalizeComparableString(name);\r\n    if (!target) {\r\n        return null;\r\n    }\r\n\r\n    for (const cliente of state.clientes) {\r\n        if (!cliente || typeof cliente !== 'object') {\r\n            continue;\r\n        }\r\n\r\n        const nameCandidates = [\r\n            cliente.razon_social,\r\n            cliente.RazonSocial,\r\n            cliente.nombre,\r\n            cliente.Nombre,\r\n            cliente.cliente,\r\n            cliente.Cliente,\r\n        ];\r\n\r\n        if (nameCandidates.some(value => normalizeComparableString(value) === target)) {\r\n            if (typeof cliente.id === 'string' && cliente.id.trim()) {\r\n                return cliente.id.trim();\r\n            }\r\n        }\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\nfunction normalizeComparableString(value) {\r\n    return typeof value === 'string' ? value.trim().toLowerCase() : '';\r\n}\r\n\r\nfunction normalizeDate(value) {\r\n    if (!value) {\r\n        return new Date().toISOString();\r\n    }\r\n    const date = new Date(value);\r\n    if (Number.isNaN(date.getTime())) {\r\n        return new Date().toISOString();\r\n    }\r\n    return date.toISOString();\r\n}\r\n\r\nfunction determineMaintenanceType(payload) {\r\n    const rawType = (payload?.type || payload?.tipo_mantenimiento || '').toString().toLowerCase();\r\n    if (rawType.includes('soft')) {\r\n        return 'softener';\r\n    }\r\n\r\n    const formName = (payload?.metadata?.formulario || payload?.formulario || '').toString().toLowerCase();\r\n    if (formName.includes('ablandador') || formName.includes('softener')) {\r\n        return 'softener';\r\n    }\r\n    return 'ro';\r\n}\r\n\r\nfunction normalizeClienteRecord(cliente) {\r\n    if (!cliente || typeof cliente !== 'object') {\r\n        return {};\r\n    }\r\n\r\n    const contacto = cliente.contacto_info && typeof cliente.contacto_info === 'object'\r\n        ? cliente.contacto_info\r\n        : {};\r\n\r\n    const razonSocial = pickFirstTruthy([\r\n        cliente.razon_social,\r\n        cliente.RazonSocial,\r\n        cliente.nombre,\r\n        cliente.Nombre,\r\n        cliente.cliente,\r\n        cliente.Cliente,\r\n    ]);\r\n\r\n    const direccion = pickFirstTruthy([\r\n        cliente.direccion,\r\n        contacto.direccion,\r\n        contacto.Direccion,\r\n        contacto.address,\r\n    ]);\r\n\r\n    const telefono = pickFirstTruthy([\r\n        cliente.telefono,\r\n        cliente.Telefono,\r\n        contacto.telefono,\r\n        contacto.Telefono,\r\n        contacto.tel,\r\n        contacto.phone,\r\n    ]);\r\n\r\n    const email = pickFirstTruthy([\r\n        cliente.email,\r\n        cliente.Email,\r\n        contacto.email,\r\n        contacto.Email,\r\n        contacto.mail,\r\n        contacto.Mail,\r\n    ]);\r\n\r\n    const cuit = pickFirstTruthy([\r\n        cliente.cuit,\r\n        cliente.CUIT,\r\n        contacto.cuit,\r\n        contacto.CUIT,\r\n    ]);\r\n\r\n    return {\r\n        ...cliente,\r\n        contacto_info: contacto,\r\n        id: cliente.id,\r\n        nombre: razonSocial || cliente.nombre || '',\r\n        Nombre: razonSocial || cliente.Nombre || '',\r\n        cliente: razonSocial || cliente.cliente || '',\r\n        Cliente: razonSocial || cliente.Cliente || '',\r\n        razon_social: razonSocial || cliente.razon_social || '',\r\n        RazonSocial: razonSocial || cliente.RazonSocial || '',\r\n        direccion,\r\n        Direccion: direccion,\r\n        telefono,\r\n        Telefono: telefono,\r\n        email,\r\n        Email: email,\r\n        cuit,\r\n        CUIT: cuit,\r\n    };\r\n}\r\n\r\nfunction pickFirstTruthy(values) {\r\n    for (const value of values) {\r\n        if (typeof value === 'string' && value.trim()) {\r\n            return value.trim();\r\n        }\r\n    }\r\n    return '';\r\n}\r\n\r\n// ============================================================================\r\n// EQUIPOS ABLANDADOR - Gesti├│n de configuraci├│n fija de equipos\r\n// ============================================================================\r\n\r\n/**\r\n * Obtiene todos los equipos ablandador asociados a un cliente\r\n * @param {string} clienteId - UUID del cliente\r\n * @returns {Promise<Array>} Lista de equipos del cliente\r\n */\r\nexport async function obtenerEquiposAblandadorPorCliente(clienteId) {\r\n    if (!clienteId) {\r\n        return [];\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n        .from('equipos_ablandador')\r\n        .select('*')\r\n        .eq('cliente_id', clienteId)\r\n        .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n        console.error('Error obteniendo equipos ablandador:', error);\r\n        throw new Error('No se pudieron obtener los equipos del cliente.');\r\n    }\r\n\r\n    return data || [];\r\n}\r\n\r\n/**\r\n * Obtiene un equipo ablandador por su n├║mero de serie y cliente\r\n * @param {string} clienteId - UUID del cliente\r\n * @param {string} numeroSerie - N├║mero de serie del equipo\r\n * @returns {Promise<Object|null>} Equipo encontrado o null\r\n */\r\nexport async function obtenerEquipoAblandadorPorSerie(clienteId, numeroSerie) {\r\n    if (!clienteId || !numeroSerie) {\r\n        return null;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n        .from('equipos_ablandador')\r\n        .select('*')\r\n        .eq('cliente_id', clienteId)\r\n        .eq('numero_serie', numeroSerie.trim())\r\n        .maybeSingle();\r\n\r\n    if (error) {\r\n        console.error('Error obteniendo equipo por serie:', error);\r\n        return null;\r\n    }\r\n\r\n    return data || null;\r\n}\r\n\r\n/**\r\n * Crea un nuevo equipo ablandador\r\n * @param {Object} equipo - Datos del equipo\r\n * @returns {Promise<Object>} Equipo creado\r\n */\r\nexport async function crearEquipoAblandador(equipo) {\r\n    const { data, error } = await supabase\r\n        .from('equipos_ablandador')\r\n        .insert([{\r\n            cliente_id: equipo.cliente_id,\r\n            numero_serie: equipo.numero_serie?.trim(),\r\n            tipo_ablandador: equipo.tipo_ablandador || 'Custom',\r\n            modelo: equipo.modelo || '',\r\n            volumen_resina: equipo.volumen_resina || 25,\r\n            ubicacion: equipo.ubicacion || '',\r\n            tipo_regeneracion: equipo.tipo_regeneracion || 'Por Volumen',\r\n            prefiltro: equipo.prefiltro || 'No Aplica',\r\n            proteccion_entrada: equipo.proteccion_entrada || 'No Aplica',\r\n            manometros: equipo.manometros || 'No cuenta con man├│metros',\r\n            notas_equipo: equipo.notas_equipo || '',\r\n            created_by: equipo.created_by || '',\r\n            updated_by: equipo.created_by || '',\r\n        }])\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        // Error de duplicado\r\n        if (error.code === '23505') {\r\n            throw new Error(`Ya existe un equipo con n├║mero de serie \"${equipo.numero_serie}\" para este cliente.`);\r\n        }\r\n        console.error('Error creando equipo ablandador:', error);\r\n        throw new Error('No se pudo crear el equipo ablandador.');\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\n/**\r\n * Actualiza un equipo ablandador existente\r\n * @param {string} equipoId - UUID del equipo\r\n * @param {Object} cambios - Campos a actualizar\r\n * @returns {Promise<Object>} Equipo actualizado\r\n */\r\nexport async function actualizarEquipoAblandador(equipoId, cambios) {\r\n    if (!equipoId) {\r\n        throw new Error('Se requiere el ID del equipo para actualizar.');\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n        .from('equipos_ablandador')\r\n        .update({\r\n            tipo_ablandador: cambios.tipo_ablandador,\r\n            modelo: cambios.modelo,\r\n            volumen_resina: cambios.volumen_resina,\r\n            ubicacion: cambios.ubicacion,\r\n            tipo_regeneracion: cambios.tipo_regeneracion,\r\n            prefiltro: cambios.prefiltro,\r\n            proteccion_entrada: cambios.proteccion_entrada,\r\n            manometros: cambios.manometros,\r\n            notas_equipo: cambios.notas_equipo,\r\n            updated_by: cambios.updated_by || '',\r\n        })\r\n        .eq('id', equipoId)\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error('Error actualizando equipo ablandador:', error);\r\n        throw new Error('No se pudo actualizar el equipo ablandador.');\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\n/**\r\n * Verifica si hay cambios entre los datos del formulario y el equipo guardado\r\n * @param {Object} equipoGuardado - Datos del equipo en BD\r\n * @param {Object} datosFormulario - Datos actuales del formulario\r\n * @returns {Object} { hayCambios: boolean, cambios: Object }\r\n */\r\nexport function detectarCambiosEquipo(equipoGuardado, datosFormulario) {\r\n    const camposAComparar = [\r\n        'tipo_ablandador',\r\n        'modelo',\r\n        'volumen_resina',\r\n        'ubicacion',\r\n        'tipo_regeneracion',\r\n        'prefiltro',\r\n        'proteccion_entrada',\r\n        'manometros',\r\n        'notas_equipo',\r\n    ];\r\n\r\n    const cambios = {};\r\n    let hayCambios = false;\r\n\r\n    for (const campo of camposAComparar) {\r\n        const valorGuardado = String(equipoGuardado[campo] || '').trim();\r\n        const valorFormulario = String(datosFormulario[campo] || '').trim();\r\n\r\n        if (valorGuardado !== valorFormulario) {\r\n            hayCambios = true;\r\n            cambios[campo] = {\r\n                anterior: valorGuardado,\r\n                nuevo: valorFormulario,\r\n            };\r\n        }\r\n    }\r\n\r\n    return { hayCambios, cambios };\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\auth.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\dashboard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\forms.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\main.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'navigateToDashboard' is defined but never used.","line":57,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":29},{"ruleId":"no-unused-vars","severity":2,"message":"'showScriptVersion' is defined but never used.","line":276,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":276,"endColumn":33}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/* global __APP_VERSION__ */\r\nimport { showView } from './viewManager.js';\r\nimport * as api from './api.js';\r\nimport { initializeAuth, getCurrentUserRole } from './modules/login/auth.js';\r\nimport { initializeTheme } from './modules/theme/theme.js';\r\nimport { createDashboardModule } from './modules/dashboard/dashboard.js';\r\nimport { createMaintenanceModule } from './modules/mantenimiento/maintenance.js';\r\nimport { setCategoriaReporte } from './modules/mantenimiento/forms.js';\r\nimport { createSearchModule } from './modules/busqueda/busqueda.js';\r\nimport { createRemitoModule } from './modules/remito/remito.js';\r\nimport { createRemitosGestionModule } from './modules/remitos-gestion/remitos-gestion.js';\r\nimport { createMantenimientosGestionModule } from './modules/mantenimientos-gestion/mantenimientos-gestion.js';\r\nimport { createSoftenerModule } from './modules/mantenimiento-ablandador/ablandador.js';\r\nimport { createFeedbackModule } from './modules/feedback/feedback.js';\r\nimport { createAdminPanelModule } from './modules/admin/adminPanel.js';\r\nimport { initEquipmentHistory } from './modules/equipmentHistory/equipmentHistory.js';\r\nimport { supabase } from './supabaseClient.js';\r\nimport { mountScheduler } from './modules/agenda/index.tsx';\r\n\r\nconst {\r\n    guardarMantenimiento,\r\n    guardarMantenimientoAblandador,\r\n    buscarMantenimientos,\r\n    actualizarMantenimiento,\r\n    eliminarMantenimiento,\r\n    obtenerDashboard,\r\n    obtenerClientes,\r\n    obtenerRemitos,\r\n    crearRemito,\r\n    actualizarRemito,\r\n    eliminarRemito,\r\n    obtenerVersionServidor,\r\n    enviarFeedbackTicket,\r\n    obtenerUrlPdfRemito,\r\n    guardarPdfRemito,\r\n    generarPdfMantenimiento,\r\n    obtenerUrlPdfMantenimiento,\r\n} = api;\r\n\r\ninitializeTheme();\r\n\r\n// Cargar Google Maps API si est├í configurada\r\nconst googleMapsApiKey = import.meta.env?.VITE_GOOGLE_MAPS_API_KEY || '';\r\nif (googleMapsApiKey && typeof window.loadGoogleMaps === 'function') {\r\n    window.loadGoogleMaps(googleMapsApiKey);\r\n}\r\n\r\nfunction navigateToMantenimientos() {\r\n    showView('mantenimientos-gestion-view');\r\n    setActiveNavigation(null, 'tab-mantenimientos-btn');\r\n    // Recargar lista de mantenimientos\r\n    if (appModules.mantenimientosGestion) {\r\n        appModules.mantenimientosGestion.loadMantenimientos();\r\n    }\r\n}\r\n\r\nfunction navigateToDashboard() {\r\n    showView('tab-dashboard');\r\n    setActiveNavigation('dashboard');\r\n}\r\n\r\nconst remitoModule = createRemitoModule({\r\n    showView,\r\n    crearRemito,\r\n    guardarPdfRemito,\r\n    navigateToDashboard: navigateToMantenimientos, // Ahora va a mantenimientos despu├®s del remito\r\n    onRemitoComplete: () => {\r\n        // Limpiar formularios de mantenimiento despu├®s de completar el remito\r\n        if (appModules.maintenance && typeof appModules.maintenance.handleResetClick === 'function') {\r\n            appModules.maintenance.handleResetClick();\r\n        }\r\n        if (appModules.softener && typeof appModules.softener.silentReset === 'function') {\r\n            appModules.softener.silentReset();\r\n        }\r\n        // Volver al panel de mantenimientos\r\n        navigateToMantenimientos();\r\n    },\r\n});\r\n\r\nconst maintenanceModule = createMaintenanceModule(\r\n    {\r\n        guardarMantenimiento,\r\n        obtenerClientes,\r\n    },\r\n    {\r\n        onReportSaved: datos => {\r\n            remitoModule.handleMaintenanceSaved(datos);\r\n        },\r\n        onReportReset: () => {\r\n            remitoModule.reset();\r\n        },\r\n    },\r\n);\r\n\r\nconst searchModule = createSearchModule(\r\n    {\r\n        buscarMantenimientos,\r\n        actualizarMantenimiento,\r\n        eliminarMantenimiento,\r\n    },\r\n    {\r\n        showView,\r\n    },\r\n);\r\n\r\nconst dashboardModule = createDashboardModule(\r\n    { obtenerDashboard },\r\n    { showView },\r\n);\r\n\r\nconst remitosGestionModule = createRemitosGestionModule({\r\n    obtenerRemitos,\r\n    crearRemito,\r\n    actualizarRemito,\r\n    eliminarRemito,\r\n    obtenerClientes,\r\n    obtenerUrlPdfRemito,\r\n    guardarPdfRemito,\r\n});\r\n\r\nconst softenerModule = createSoftenerModule({\r\n    showView,\r\n    guardarMantenimientoAblandador,\r\n    obtenerClientes,\r\n    remitoModule,\r\n    onMaintenanceSaved: (reportData) => {\r\n        if (remitoModule && typeof remitoModule.handleMaintenanceSaved === 'function') {\r\n            remitoModule.handleMaintenanceSaved(reportData);\r\n        }\r\n    },\r\n});\r\n\r\nconst feedbackModule = createFeedbackModule({\r\n    enviarFeedbackTicket,\r\n});\r\n\r\nconst adminPanelModule = createAdminPanelModule();\r\n\r\nconst mantenimientosGestionModule = createMantenimientosGestionModule({\r\n    buscarMantenimientos,\r\n    generarPdfMantenimiento,\r\n    obtenerUrlPdfMantenimiento,\r\n    showView,\r\n    onNuevoReporte: () => openMaintenanceTypeModal(),\r\n});\r\n\r\nconst appModules = {\r\n    maintenance: maintenanceModule,\r\n    remito: remitoModule,\r\n    search: searchModule,\r\n    dashboard: dashboardModule,\r\n    remitosGestion: remitosGestionModule,\r\n    mantenimientosGestion: mantenimientosGestionModule,\r\n    softener: softenerModule,\r\n    feedback: feedbackModule,\r\n    adminPanel: adminPanelModule,\r\n};\r\n\r\nconst SECTION_LABELS = Object.freeze({\r\n    'tab-dashboard': 'Dashboard',\r\n    'mantenimientos-gestion-view': 'Mantenimientos',\r\n    'tab-nuevo': 'Mantenimiento ├ôsmosis',\r\n    'tab-ablandador': 'Mantenimiento Ablandador',\r\n    'tab-buscar': 'Buscar y Editar',\r\n    'remito-view': 'Generaci├│n de Remito',\r\n    'remitos-gestion-view': 'Gesti├│n de Remitos',\r\n    'admin-panel-view': 'Panel de Administraci├│n',\r\n});\r\n\r\nfunction resolveSectionTitle(viewId) {\r\n    if (typeof viewId === 'string' && SECTION_LABELS[viewId]) {\r\n        return SECTION_LABELS[viewId];\r\n    }\r\n    return 'Portal de Gesti├│n';\r\n}\r\n\r\nfunction updateSectionTitle(viewId) {\r\n    const target = document.getElementById('current-section-title');\r\n    if (!target) {\r\n        return;\r\n    }\r\n    target.textContent = resolveSectionTitle(viewId);\r\n}\r\n\r\ndocument.addEventListener('view:changed', event => {\r\n    const viewId = event?.detail?.viewId;\r\n    if (!viewId) {\r\n        return;\r\n    }\r\n    updateSectionTitle(viewId);\r\n});\r\n\r\nfunction setTextOrHide(element, text) {\r\n    if (!element) {\r\n        return;\r\n    }\r\n\r\n    if (typeof text === 'string' && text.trim()) {\r\n        element.textContent = text.trim();\r\n        element.classList.remove('hidden');\r\n    } else {\r\n        element.textContent = '';\r\n        element.classList.add('hidden');\r\n    }\r\n}\r\n\r\nfunction showAppVersion() {\r\n    const versionElement = document.getElementById('app-version-menu');\r\n    if (!versionElement) {\r\n        return;\r\n    }\r\n\r\n    if (typeof __APP_VERSION__ !== 'undefined') {\r\n        const versionValue = `${__APP_VERSION__}`.trim();\r\n        if (versionValue) {\r\n            setTextOrHide(versionElement, `Frontend v${versionValue}`);\r\n            return;\r\n        }\r\n    }\r\n\r\n    setTextOrHide(versionElement, '');\r\n}\r\n\r\nfunction formatScriptVersion(rawInfo) {\r\n    if (!rawInfo) {\r\n        return '';\r\n    }\r\n\r\n    if (typeof rawInfo === 'string') {\r\n        const trimmed = rawInfo.trim();\r\n        return trimmed ? `Scripts ${trimmed}` : '';\r\n    }\r\n\r\n    if (typeof rawInfo !== 'object') {\r\n        return '';\r\n    }\r\n\r\n    const info = rawInfo;\r\n    const parts = [];\r\n\r\n    if (info.versionNumber !== undefined && info.versionNumber !== null) {\r\n        parts.push(`#${info.versionNumber}`);\r\n    }\r\n\r\n    if (typeof info.description === 'string' && info.description.trim()) {\r\n        parts.push(info.description.trim());\r\n    }\r\n\r\n    if (!parts.length && typeof info.label === 'string' && info.label.trim()) {\r\n        parts.push(info.label.trim());\r\n    }\r\n\r\n    if (!parts.length && typeof info.deploymentId === 'string' && info.deploymentId.trim()) {\r\n        parts.push(`ID ${info.deploymentId.trim()}`);\r\n    }\r\n\r\n    let label = parts.join(' ÔÇô ');\r\n\r\n    if (typeof info.generatedAt === 'string') {\r\n        const generatedDate = new Date(info.generatedAt);\r\n        if (!Number.isNaN(generatedDate.getTime())) {\r\n            const locale = navigator?.language || 'es-AR';\r\n            const formattedDate = generatedDate.toLocaleString(locale, {\r\n                dateStyle: 'short',\r\n                timeStyle: 'short',\r\n            });\r\n            if (formattedDate) {\r\n                label = label ? `${label} ┬À ${formattedDate}` : formattedDate;\r\n            }\r\n        }\r\n    }\r\n\r\n    return label ? `Scripts ${label}` : '';\r\n}\r\n\r\nasync function showScriptVersion() {\r\n    const versionElement = document.getElementById('script-version-menu');\r\n    if (!versionElement) {\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const info = await obtenerVersionServidor();\r\n        const formatted = formatScriptVersion(info);\r\n        if (formatted) {\r\n            setTextOrHide(versionElement, formatted);\r\n        } else {\r\n            setTextOrHide(versionElement, 'Scripts versi├│n no disponible');\r\n        }\r\n    } catch (error) {\r\n        console.error('No se pudo obtener la versi├│n de los scripts:', error);\r\n        setTextOrHide(versionElement, 'Scripts versi├│n no disponible');\r\n    }\r\n}\r\n\r\nfunction initializeHelpToggle() {\r\n    const helpButton = document.getElementById('help-menu-item');\r\n    const helpInfo = document.getElementById('help-info');\r\n\r\n    if (helpButton && helpInfo) {\r\n        helpButton.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            helpInfo.classList.toggle('hidden');\r\n        });\r\n    }\r\n}\r\n\r\nfunction setActiveNavigation(tabName, customButtonId) {\r\n    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));\r\n    let tabButton = null;\r\n\r\n    if (typeof customButtonId === 'string' && customButtonId) {\r\n        tabButton = document.getElementById(customButtonId);\r\n    }\r\n\r\n    if (!tabButton && typeof tabName === 'string' && tabName) {\r\n        tabButton = document.getElementById(`tab-${tabName}-btn`);\r\n    }\r\n\r\n    if (tabButton) {\r\n        tabButton.classList.add('active');\r\n    }\r\n}\r\n\r\nfunction showMaintenanceTab() {\r\n    // Limpiar formulario de ablandador al cambiar a ├│smosis\r\n    if (appModules.softener && typeof appModules.softener.silentReset === 'function') {\r\n        appModules.softener.silentReset();\r\n    }\r\n    setCategoriaReporte('osmosis');\r\n    showView('tab-nuevo');\r\n    setActiveNavigation('nuevo');\r\n}\r\n\r\nfunction showSoftenerTab() {\r\n    // Limpiar formulario de ├│smosis al cambiar a ablandador\r\n    if (appModules.maintenance && typeof appModules.maintenance.handleResetClick === 'function') {\r\n        appModules.maintenance.handleResetClick();\r\n    }\r\n    setCategoriaReporte('ablandador');\r\n    appModules.softener.show();\r\n    setActiveNavigation('nuevo');\r\n}\r\n\r\nfunction getMaintenanceModalElements() {\r\n    return {\r\n        modal: document.getElementById('maintenance-type-modal'),\r\n        backdrop: document.getElementById('maintenance-type-backdrop'),\r\n    };\r\n}\r\n\r\nfunction openMaintenanceTypeModal() {\r\n    const { modal, backdrop } = getMaintenanceModalElements();\r\n    if (backdrop) {\r\n        backdrop.classList.remove('hidden');\r\n    }\r\n    if (modal) {\r\n        modal.classList.remove('hidden');\r\n        modal.setAttribute('aria-hidden', 'false');\r\n    }\r\n}\r\n\r\nfunction closeMaintenanceTypeModal() {\r\n    const { modal, backdrop } = getMaintenanceModalElements();\r\n    if (backdrop) {\r\n        backdrop.classList.add('hidden');\r\n    }\r\n    if (modal) {\r\n        modal.classList.add('hidden');\r\n        modal.setAttribute('aria-hidden', 'true');\r\n    }\r\n}\r\n\r\nfunction showSearchTab() {\r\n    appModules.search.show();\r\n    setActiveNavigation('buscar');\r\n}\r\n\r\nlet historyInitialized = false;\r\n\r\nasync function showDashboardTab() {\r\n    setActiveNavigation('dashboard');\r\n    await appModules.dashboard.show();\r\n\r\n    // Inicializar historial de equipos una sola vez\r\n    if (!historyInitialized) {\r\n        const target = document.getElementById('equipment-history-target');\r\n        if (target) {\r\n            await initEquipmentHistory(api, supabase, target);\r\n            historyInitialized = true;\r\n        }\r\n    }\r\n}\r\n\r\nfunction initializeNavigation() {\r\n    const tabMantenimientosBtn = document.getElementById('tab-mantenimientos-btn');\r\n    if (tabMantenimientosBtn) {\r\n        tabMantenimientosBtn.addEventListener('click', () => {\r\n            showView('mantenimientos-gestion-view');\r\n            setActiveNavigation(null, 'tab-mantenimientos-btn');\r\n            appModules.mantenimientosGestion.loadMantenimientos();\r\n        });\r\n    }\r\n\r\n    const tabBuscarBtn = document.getElementById('tab-buscar-btn');\r\n    if (tabBuscarBtn) {\r\n        tabBuscarBtn.addEventListener('click', () => {\r\n            showSearchTab();\r\n        });\r\n    }\r\n\r\n    const tabDashboardBtn = document.getElementById('tab-dashboard-btn');\r\n    if (tabDashboardBtn) {\r\n        tabDashboardBtn.addEventListener('click', () => {\r\n            void showDashboardTab();\r\n        });\r\n    }\r\n\r\n    const remitosBtn = document.getElementById('nav-remitos-btn');\r\n    if (remitosBtn) {\r\n        remitosBtn.addEventListener('click', () => {\r\n            showView('remitos-gestion-view');\r\n            setActiveNavigation(null, 'nav-remitos-btn');\r\n            void remitosGestionModule.renderListado({ page: 1 });\r\n        });\r\n    }\r\n\r\n    // Agenda button - lazy load scheduler\r\n    let schedulerMounted = false;\r\n    const agendaBtn = document.getElementById('nav-agenda-btn');\r\n    if (agendaBtn) {\r\n        agendaBtn.addEventListener('click', () => {\r\n            showView('agenda-view');\r\n            setActiveNavigation(null, 'nav-agenda-btn');\r\n            if (!schedulerMounted) {\r\n                mountScheduler('scheduler-root');\r\n                schedulerMounted = true;\r\n            }\r\n        });\r\n    }\r\n\r\n    const modalOsmosisBtn = document.getElementById('maintenance-type-osmosis');\r\n    if (modalOsmosisBtn) {\r\n        modalOsmosisBtn.addEventListener('click', () => {\r\n            showMaintenanceTab();\r\n            closeMaintenanceTypeModal();\r\n        });\r\n    }\r\n\r\n    const modalSoftenerBtn = document.getElementById('maintenance-type-softener');\r\n    if (modalSoftenerBtn) {\r\n        modalSoftenerBtn.addEventListener('click', () => {\r\n            showSoftenerTab();\r\n            closeMaintenanceTypeModal();\r\n        });\r\n    }\r\n\r\n    const modalCancelBtn = document.getElementById('maintenance-type-cancel');\r\n    if (modalCancelBtn) {\r\n        modalCancelBtn.addEventListener('click', () => {\r\n            closeMaintenanceTypeModal();\r\n        });\r\n    }\r\n\r\n    const { modal, backdrop } = getMaintenanceModalElements();\r\n    if (backdrop) {\r\n        backdrop.addEventListener('click', () => {\r\n            closeMaintenanceTypeModal();\r\n        });\r\n    }\r\n\r\n    if (modal) {\r\n        modal.addEventListener('click', event => {\r\n            if (event.target === modal) {\r\n                closeMaintenanceTypeModal();\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nasync function initializeApp() {\r\n    showAppVersion();\r\n    // showScriptVersion(); // Disabled while legacy API is offline\r\n    initializeNavigation();\r\n    initializeHelpToggle();\r\n    appModules.feedback.initialize();\r\n    // Inicializar m├│dulos que no requieren autenticaci├│n\r\n    appModules.remito.initialize();\r\n    appModules.search.initialize();\r\n    appModules.remitosGestion.initialize();\r\n    appModules.mantenimientosGestion.initialize();\r\n\r\n    try {\r\n        // Primero autenticar\r\n        await initializeAuth();\r\n\r\n        // Inicializar panel de administraci├│n (muestra/oculta opci├│n seg├║n rol)\r\n        appModules.adminPanel.init();\r\n\r\n        // Despu├®s inicializar m├│dulos que requieren datos del backend\r\n        await appModules.maintenance.initialize();\r\n        appModules.softener.initialize();\r\n\r\n        // Redirigir seg├║n el rol del usuario\r\n        const userRole = getCurrentUserRole();\r\n        console.log('[main] Usuario autenticado con rol:', userRole);\r\n\r\n        if (userRole === 'Administrador' || userRole === 'admin') {\r\n            // Admins van al dashboard\r\n            showView('tab-dashboard');\r\n            setActiveNavigation('dashboard');\r\n            appModules.dashboard.show();\r\n        } else if (userRole === 'T├®cnico' || userRole === 'tecnico') {\r\n            // T├®cnicos van a gesti├│n de remitos\r\n            showView('remitos-gestion-view');\r\n            setActiveNavigation('remitos');\r\n            // Cargar el listado de remitos autom├íticamente\r\n            void appModules.remitosGestion.renderListado({ page: 1 });\r\n        } else {\r\n            // Fallback: mostrar panel de mantenimientos\r\n            showView('mantenimientos-gestion-view');\r\n            setActiveNavigation(null, 'tab-mantenimientos-btn');\r\n            appModules.mantenimientosGestion.loadMantenimientos();\r\n        }\r\n    } catch (error) {\r\n        console.error('Error inicializando la aplicaci├│n:', error);\r\n        alert('No se pudo inicializar la aplicaci├│n. Revisa la consola para m├ís detalles.');\r\n    }\r\n}\r\n\r\nexport const __testables__ = {\r\n    handleGuardarClick: () => appModules.maintenance.handleGuardarClick(),\r\n    handleGenerarRemitoClick: () => appModules.remito.handleGenerarRemitoClick(),\r\n    handleFinalizarRemitoClick: () => appModules.remito.handleFinalizarRemitoClick(),\r\n    showView,\r\n    setLastSavedReportDataForTests: data => appModules.remito.setLastSavedReportForTests(data),\r\n    getLastSavedReportDataForTests: () => appModules.remito.getLastSavedReportForTests(),\r\n    initializeRemitoModuleForTests: () => appModules.remito.initialize(),\r\n};\r\n\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    initializeApp();\r\n});\r\n\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\admin\\adminPanel.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'getCurrentUserRole' is defined but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":28},{"ruleId":"no-unused-vars","severity":2,"message":"'est' is assigned a value but never used.","line":2086,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":2086,"endColumn":18}],"suppressedMessages":[{"ruleId":"no-undef","severity":2,"message":"'google' is not defined.","line":50,"column":34,"nodeType":"Identifier","messageId":"undef","endLine":50,"endColumn":40,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Admin Panel Module\r\n * M├│dulo para la gesti├│n de clientes (ABM) y administraci├│n del sistema\r\n */\r\n\r\nimport { supabase } from '../../supabaseClient.js';\r\nimport { getCurrentUserRole, isAdmin, canAccessAdminPanel } from '../login/auth.js';\r\nimport { bindSistemasEquiposEventListeners, loadSistemas, loadEquipos } from './sistemasEquipos.js';\r\n\r\nconst ITEMS_PER_PAGE = 15;\r\n\r\nlet currentPage = 1;\r\nlet totalClientes = 0;\r\nlet clientesCache = [];\r\nlet currentFilters = {\r\n    search: '',\r\n    division: '',\r\n    canal: ''\r\n};\r\nlet divisiones = [];\r\nlet canales = [];\r\nlet placesAutocomplete = null;\r\n\r\n// ============================================\r\n// Google Places Autocomplete\r\n// ============================================\r\n\r\nfunction initGooglePlacesAutocomplete() {\r\n    const direccionInput = document.getElementById('admin-cliente-direccion');\r\n\r\n    if (!direccionInput) {\r\n        console.warn('[AdminPanel] Direccion input not found');\r\n        return;\r\n    }\r\n\r\n    // Si ya est├í inicializado, no hacer nada\r\n    if (placesAutocomplete) {\r\n        return;\r\n    }\r\n\r\n    // Verificar si Google Places est├í disponible\r\n    if (!window.google?.maps?.places) {\r\n        console.log('[AdminPanel] Google Places not loaded yet, waiting...');\r\n        return;\r\n    }\r\n\r\n    try {\r\n        // Crear el autocomplete\r\n        // eslint-disable-next-line no-undef\r\n        placesAutocomplete = new google.maps.places.Autocomplete(direccionInput, {\r\n            types: ['address'],\r\n            componentRestrictions: { country: 'ar' }, // Restringir a Argentina\r\n            fields: ['formatted_address', 'address_components', 'geometry']\r\n        });\r\n\r\n        // Evitar que el formulario se env├¡e al presionar Enter en el autocomplete\r\n        direccionInput.addEventListener('keydown', (e) => {\r\n            if (e.key === 'Enter') {\r\n                e.preventDefault();\r\n            }\r\n        });\r\n\r\n        // Manejar la selecci├│n de una direcci├│n\r\n        placesAutocomplete.addListener('place_changed', () => {\r\n            const place = placesAutocomplete.getPlace();\r\n\r\n            if (place.formatted_address) {\r\n                direccionInput.value = place.formatted_address;\r\n                console.log('[AdminPanel] Address selected:', place.formatted_address);\r\n            }\r\n        });\r\n\r\n        console.log('[AdminPanel] Google Places Autocomplete initialized');\r\n    } catch (error) {\r\n        console.error('[AdminPanel] Error initializing Google Places:', error);\r\n    }\r\n}\r\n\r\n// Intentar inicializar cuando el modal se abre\r\nfunction tryInitPlacesOnModalOpen() {\r\n    if (window.googlePlacesReady) {\r\n        // Peque├▒o delay para asegurar que el input est├® visible\r\n        setTimeout(initGooglePlacesAutocomplete, 100);\r\n    }\r\n}\r\n\r\n// Mostrar/ocultar opci├│n del men├║ seg├║n rol\r\n// Visible para: admin, ventas\r\nfunction updateAdminMenuVisibility() {\r\n    const adminMenuItem = document.getElementById('admin-panel-menu-item');\r\n    const hasAccess = canAccessAdminPanel();\r\n    console.log('[AdminPanel] updateAdminMenuVisibility - canAccessAdminPanel:', hasAccess);\r\n\r\n    if (adminMenuItem) {\r\n        if (hasAccess) {\r\n            adminMenuItem.classList.remove('hidden');\r\n            console.log('[AdminPanel] Admin menu item shown');\r\n        } else {\r\n            adminMenuItem.classList.add('hidden');\r\n            console.log('[AdminPanel] Admin menu item hidden');\r\n        }\r\n    } else {\r\n        console.warn('[AdminPanel] Admin menu item not found in DOM');\r\n    }\r\n\r\n    // Ocultar tab de Usuarios para roles que no son admin\r\n    const usuariosTabBtn = document.getElementById('admin-tab-usuarios-btn');\r\n    const usuariosTabContent = document.getElementById('admin-tab-usuarios');\r\n\r\n    if (usuariosTabBtn) {\r\n        if (isAdmin()) {\r\n            usuariosTabBtn.classList.remove('hidden');\r\n            console.log('[AdminPanel] Usuarios tab shown (admin)');\r\n        } else {\r\n            usuariosTabBtn.classList.add('hidden');\r\n            // Tambi├®n ocultar el contenido si estaba visible\r\n            if (usuariosTabContent) {\r\n                usuariosTabContent.classList.add('hidden');\r\n            }\r\n            console.log('[AdminPanel] Usuarios tab hidden (non-admin)');\r\n        }\r\n    }\r\n\r\n    // Ocultar tab de Feedback para roles que no son admin\r\n    const feedbackTabBtn = document.getElementById('admin-tab-feedback-btn');\r\n    const feedbackTabContent = document.getElementById('admin-tab-feedback');\r\n\r\n    if (feedbackTabBtn) {\r\n        if (isAdmin()) {\r\n            feedbackTabBtn.classList.remove('hidden');\r\n            console.log('[AdminPanel] Feedback tab shown (admin)');\r\n        } else {\r\n            feedbackTabBtn.classList.add('hidden');\r\n            if (feedbackTabContent) {\r\n                feedbackTabContent.classList.add('hidden');\r\n            }\r\n            console.log('[AdminPanel] Feedback tab hidden (non-admin)');\r\n        }\r\n    }\r\n}\r\n\r\n// Cargar estad├¡sticas r├ípidas\r\nasync function loadStats() {\r\n    try {\r\n        // Total clientes\r\n        const { count: total } = await supabase\r\n            .from('clients')\r\n            .select('*', { count: 'exact', head: true });\r\n\r\n        // Con email\r\n        const { count: conEmail } = await supabase\r\n            .from('clients')\r\n            .select('*', { count: 'exact', head: true })\r\n            .not('email', 'is', null)\r\n            .neq('email', '');\r\n\r\n        // Con tel├®fono\r\n        const { count: conTelefono } = await supabase\r\n            .from('clients')\r\n            .select('*', { count: 'exact', head: true })\r\n            .not('telefono', 'is', null)\r\n            .neq('telefono', '');\r\n\r\n        // Con CUIT\r\n        const { count: conCuit } = await supabase\r\n            .from('clients')\r\n            .select('*', { count: 'exact', head: true })\r\n            .not('cuit', 'is', null)\r\n            .neq('cuit', '');\r\n\r\n        document.getElementById('admin-stat-total-clientes').textContent = total || 0;\r\n        document.getElementById('admin-stat-con-email').textContent = conEmail || 0;\r\n        document.getElementById('admin-stat-con-telefono').textContent = conTelefono || 0;\r\n        document.getElementById('admin-stat-con-cuit').textContent = conCuit || 0;\r\n\r\n        totalClientes = total || 0;\r\n    } catch (error) {\r\n        console.error('[AdminPanel] Error loading stats:', error);\r\n    }\r\n}\r\n\r\n// Cargar filtros din├ímicos (divisiones y canales)\r\nasync function loadFilterOptions() {\r\n    try {\r\n        // Obtener divisiones ├║nicas\r\n        const { data: divisionesData } = await supabase\r\n            .from('clients')\r\n            .select('division')\r\n            .not('division', 'is', null)\r\n            .neq('division', '');\r\n\r\n        divisiones = [...new Set(divisionesData?.map(d => d.division).filter(Boolean))].sort();\r\n\r\n        // Obtener canales ├║nicos\r\n        const { data: canalesData } = await supabase\r\n            .from('clients')\r\n            .select('canal')\r\n            .not('canal', 'is', null)\r\n            .neq('canal', '');\r\n\r\n        canales = [...new Set(canalesData?.map(c => c.canal).filter(Boolean))].sort();\r\n\r\n        // Poblar selects\r\n        const divisionSelect = document.getElementById('admin-clientes-filter-division');\r\n        const canalSelect = document.getElementById('admin-clientes-filter-canal');\r\n\r\n        if (divisionSelect) {\r\n            divisionSelect.innerHTML = '<option value=\"\">Todas las divisiones</option>' +\r\n                divisiones.map(d => `<option value=\"${escapeHtml(d)}\">${escapeHtml(d)}</option>`).join('');\r\n        }\r\n\r\n        if (canalSelect) {\r\n            canalSelect.innerHTML = '<option value=\"\">Todos los canales</option>' +\r\n                canales.map(c => `<option value=\"${escapeHtml(c)}\">${escapeHtml(c)}</option>`).join('');\r\n        }\r\n\r\n        // Tambi├®n poblar los selects del formulario modal\r\n        populateFormSelects();\r\n    } catch (error) {\r\n        console.error('[AdminPanel] Error loading filter options:', error);\r\n    }\r\n}\r\n\r\n// Poblar los selects del formulario de cliente con las opciones disponibles\r\nfunction populateFormSelects() {\r\n    const divisionSelect = document.getElementById('admin-cliente-division');\r\n    const canalSelect = document.getElementById('admin-cliente-canal');\r\n\r\n    if (divisionSelect) {\r\n        const currentValue = divisionSelect.value;\r\n        divisionSelect.innerHTML = '<option value=\"\">Seleccionar divisi├│n...</option>' +\r\n            divisiones.map(d => `<option value=\"${escapeHtml(d)}\">${escapeHtml(d)}</option>`).join('');\r\n        if (currentValue) divisionSelect.value = currentValue;\r\n    }\r\n\r\n    if (canalSelect) {\r\n        const currentValue = canalSelect.value;\r\n        canalSelect.innerHTML = '<option value=\"\">Seleccionar canal...</option>' +\r\n            canales.map(c => `<option value=\"${escapeHtml(c)}\">${escapeHtml(c)}</option>`).join('');\r\n        if (currentValue) canalSelect.value = currentValue;\r\n    }\r\n}\r\n\r\n// Cargar clientes con paginaci├│n y filtros\r\nasync function loadClientes(page = 1) {\r\n    currentPage = page;\r\n    const tbody = document.getElementById('admin-clientes-tbody');\r\n\r\n    if (!tbody) return;\r\n\r\n    tbody.innerHTML = `\r\n        <tr>\r\n            <td colspan=\"5\" class=\"px-6 py-8 text-center text-gray-500\">\r\n                <div class=\"flex items-center justify-center gap-2\">\r\n                    <svg class=\"animate-spin h-5 w-5 text-indigo-600\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                        <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\r\n                        <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z\"></path>\r\n                    </svg>\r\n                    Cargando clientes...\r\n                </div>\r\n            </td>\r\n        </tr>\r\n    `;\r\n\r\n    try {\r\n        let query = supabase\r\n            .from('clients')\r\n            .select('*', { count: 'exact' });\r\n\r\n        // Aplicar filtros\r\n        if (currentFilters.search) {\r\n            const searchTerm = `%${currentFilters.search}%`;\r\n            query = query.or(`razon_social.ilike.${searchTerm},cuit.ilike.${searchTerm},direccion.ilike.${searchTerm},email.ilike.${searchTerm}`);\r\n        }\r\n\r\n        if (currentFilters.division) {\r\n            query = query.eq('division', currentFilters.division);\r\n        }\r\n\r\n        if (currentFilters.canal) {\r\n            query = query.eq('canal', currentFilters.canal);\r\n        }\r\n\r\n        // Ordenar y paginar\r\n        const from = (page - 1) * ITEMS_PER_PAGE;\r\n        const to = from + ITEMS_PER_PAGE - 1;\r\n\r\n        query = query\r\n            .order('razon_social', { ascending: true })\r\n            .range(from, to);\r\n\r\n        const { data: clientes, count, error } = await query;\r\n\r\n        if (error) throw error;\r\n\r\n        clientesCache = clientes || [];\r\n        totalClientes = count || 0;\r\n\r\n        renderClientes(clientes);\r\n        updatePagination();\r\n    } catch (error) {\r\n        console.error('[AdminPanel] Error loading clientes:', error);\r\n        tbody.innerHTML = `\r\n            <tr>\r\n                <td colspan=\"5\" class=\"px-6 py-8 text-center text-red-500\">\r\n                    Error al cargar los clientes. Intent├í de nuevo.\r\n                </td>\r\n            </tr>\r\n        `;\r\n    }\r\n}\r\n\r\n// Renderizar tabla de clientes\r\nfunction renderClientes(clientes) {\r\n    const tbody = document.getElementById('admin-clientes-tbody');\r\n\r\n    if (!clientes || clientes.length === 0) {\r\n        tbody.innerHTML = `\r\n            <tr>\r\n                <td colspan=\"5\" class=\"px-6 py-8 text-center text-gray-500\">\r\n                    No se encontraron clientes con los filtros aplicados.\r\n                </td>\r\n            </tr>\r\n        `;\r\n        return;\r\n    }\r\n\r\n    tbody.innerHTML = clientes.map(cliente => `\r\n        <tr class=\"hover:bg-gray-50 transition-colors cursor-pointer\" data-cliente-id=\"${cliente.id}\">\r\n            <td class=\"px-6 py-4\">\r\n                <div class=\"flex items-center gap-3\">\r\n                    <div class=\"h-10 w-10 rounded-xl bg-indigo-100 flex items-center justify-center flex-shrink-0\">\r\n                        <span class=\"text-indigo-600 font-semibold text-sm\">\r\n                            ${getInitials(cliente.razon_social)}\r\n                        </span>\r\n                    </div>\r\n                    <div class=\"min-w-0\">\r\n                        <p class=\"font-medium text-gray-900 truncate\">${escapeHtml(cliente.razon_social)}</p>\r\n                        <p class=\"text-sm text-gray-500 truncate\">${escapeHtml(cliente.direccion || '-')}</p>\r\n                    </div>\r\n                </div>\r\n            </td>\r\n            <td class=\"px-6 py-4\">\r\n                <div class=\"text-sm\">\r\n                    ${cliente.telefono ? `<p class=\"text-gray-900\">${escapeHtml(cliente.telefono)}</p>` : ''}\r\n                    ${cliente.email ? `<p class=\"text-gray-500 truncate\">${escapeHtml(cliente.email)}</p>` : ''}\r\n                    ${!cliente.telefono && !cliente.email ? '<p class=\"text-gray-400\">Sin contacto</p>' : ''}\r\n                </div>\r\n            </td>\r\n            <td class=\"px-6 py-4\">\r\n                <span class=\"text-sm text-gray-900\">${escapeHtml(cliente.cuit || '-')}</span>\r\n            </td>\r\n            <td class=\"px-6 py-4\">\r\n                <div class=\"flex flex-wrap gap-1\">\r\n                    ${cliente.division ? `<span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800\">${escapeHtml(cliente.division)}</span>` : ''}\r\n                    ${cliente.canal ? `<span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800\">${escapeHtml(cliente.canal)}</span>` : ''}\r\n                </div>\r\n            </td>\r\n            <td class=\"px-6 py-4 text-right\">\r\n                <div class=\"flex items-center justify-end gap-2\">\r\n                    <button type=\"button\" class=\"admin-cliente-view-btn p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors\" title=\"Ver detalle\" data-id=\"${cliente.id}\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\r\n                        </svg>\r\n                    </button>\r\n                    <button type=\"button\" class=\"admin-cliente-edit-btn p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors\" title=\"Editar\" data-id=\"${cliente.id}\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\r\n                        </svg>\r\n                    </button>\r\n                    <button type=\"button\" class=\"admin-cliente-delete-btn p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors\" title=\"Eliminar\" data-id=\"${cliente.id}\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\r\n                        </svg>\r\n                    </button>\r\n                </div>\r\n            </td>\r\n        </tr>\r\n    `).join('');\r\n\r\n    // Event listeners para los botones de acci├│n\r\n    tbody.querySelectorAll('.admin-cliente-view-btn').forEach(btn => {\r\n        btn.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            showClienteDetalle(btn.dataset.id);\r\n        });\r\n    });\r\n\r\n    tbody.querySelectorAll('.admin-cliente-edit-btn').forEach(btn => {\r\n        btn.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            openEditModal(btn.dataset.id);\r\n        });\r\n    });\r\n\r\n    tbody.querySelectorAll('.admin-cliente-delete-btn').forEach(btn => {\r\n        btn.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            confirmDeleteCliente(btn.dataset.id);\r\n        });\r\n    });\r\n\r\n    // Click en fila para ver detalle\r\n    tbody.querySelectorAll('tr[data-cliente-id]').forEach(row => {\r\n        row.addEventListener('click', () => {\r\n            showClienteDetalle(row.dataset.clienteId);\r\n        });\r\n    });\r\n}\r\n\r\n// Actualizar paginaci├│n\r\nfunction updatePagination() {\r\n    const totalPages = Math.ceil(totalClientes / ITEMS_PER_PAGE);\r\n    const info = document.getElementById('admin-clientes-info');\r\n    const prevBtn = document.getElementById('admin-clientes-prev-btn');\r\n    const nextBtn = document.getElementById('admin-clientes-next-btn');\r\n\r\n    const from = totalClientes === 0 ? 0 : (currentPage - 1) * ITEMS_PER_PAGE + 1;\r\n    const to = Math.min(currentPage * ITEMS_PER_PAGE, totalClientes);\r\n\r\n    if (info) {\r\n        info.textContent = `Mostrando ${from}-${to} de ${totalClientes} clientes`;\r\n    }\r\n\r\n    if (prevBtn) {\r\n        prevBtn.disabled = currentPage <= 1;\r\n    }\r\n\r\n    if (nextBtn) {\r\n        nextBtn.disabled = currentPage >= totalPages;\r\n    }\r\n}\r\n\r\n// Abrir modal para nuevo cliente\r\nfunction openNewModal() {\r\n    const modal = document.getElementById('admin-cliente-modal');\r\n    const backdrop = document.getElementById('admin-cliente-modal-backdrop');\r\n    const title = document.getElementById('admin-cliente-modal-title');\r\n    const form = document.getElementById('admin-cliente-form');\r\n\r\n    if (!modal || !form) return;\r\n\r\n    // Asegurar que los selects est├®n poblados\r\n    populateFormSelects();\r\n\r\n    title.textContent = 'Nuevo Cliente';\r\n    form.reset();\r\n    document.getElementById('admin-cliente-id').value = '';\r\n    document.getElementById('admin-cliente-error').classList.add('hidden');\r\n\r\n    modal.classList.remove('hidden');\r\n    backdrop.classList.remove('hidden');\r\n\r\n    // Inicializar Google Places para el campo de direcci├│n\r\n    tryInitPlacesOnModalOpen();\r\n\r\n    document.getElementById('admin-cliente-razon-social').focus();\r\n}\r\n\r\n// Abrir modal para editar cliente\r\nasync function openEditModal(id) {\r\n    const cliente = clientesCache.find(c => c.id == id);\r\n\r\n    if (!cliente) {\r\n        // Cargar desde BD\r\n        const { data, error } = await supabase\r\n            .from('clients')\r\n            .select('*')\r\n            .eq('id', id)\r\n            .single();\r\n\r\n        if (error || !data) {\r\n            alert('No se pudo cargar el cliente');\r\n            return;\r\n        }\r\n\r\n        fillEditForm(data);\r\n    } else {\r\n        fillEditForm(cliente);\r\n    }\r\n}\r\n\r\nfunction fillEditForm(cliente) {\r\n    const modal = document.getElementById('admin-cliente-modal');\r\n    const backdrop = document.getElementById('admin-cliente-modal-backdrop');\r\n    const title = document.getElementById('admin-cliente-modal-title');\r\n\r\n    // Asegurar que los selects est├®n poblados antes de setear valores\r\n    populateFormSelects();\r\n\r\n    title.textContent = 'Editar Cliente';\r\n    document.getElementById('admin-cliente-id').value = cliente.id;\r\n    document.getElementById('admin-cliente-razon-social').value = cliente.razon_social || '';\r\n    document.getElementById('admin-cliente-direccion').value = cliente.direccion || '';\r\n    document.getElementById('admin-cliente-telefono').value = cliente.telefono || '';\r\n    document.getElementById('admin-cliente-email').value = cliente.email || '';\r\n    document.getElementById('admin-cliente-cuit').value = cliente.cuit || '';\r\n    document.getElementById('admin-cliente-division').value = cliente.division || '';\r\n    document.getElementById('admin-cliente-canal').value = cliente.canal || '';\r\n    document.getElementById('admin-cliente-error').classList.add('hidden');\r\n\r\n    modal.classList.remove('hidden');\r\n    backdrop.classList.remove('hidden');\r\n\r\n    // Inicializar Google Places para el campo de direcci├│n\r\n    tryInitPlacesOnModalOpen();\r\n}\r\n\r\n// Cerrar modal de cliente\r\nfunction closeModal() {\r\n    const modal = document.getElementById('admin-cliente-modal');\r\n    const backdrop = document.getElementById('admin-cliente-modal-backdrop');\r\n\r\n    modal?.classList.add('hidden');\r\n    backdrop?.classList.add('hidden');\r\n}\r\n\r\n// Guardar cliente\r\nasync function saveCliente(event) {\r\n    event.preventDefault();\r\n\r\n    const errorEl = document.getElementById('admin-cliente-error');\r\n    const saveBtn = document.getElementById('admin-cliente-save-btn');\r\n\r\n    const id = document.getElementById('admin-cliente-id').value;\r\n    const razonSocial = document.getElementById('admin-cliente-razon-social').value.trim();\r\n\r\n    if (!razonSocial) {\r\n        errorEl.textContent = 'La raz├│n social es obligatoria';\r\n        errorEl.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    const clienteData = {\r\n        razon_social: razonSocial,\r\n        direccion: document.getElementById('admin-cliente-direccion').value.trim() || null,\r\n        telefono: document.getElementById('admin-cliente-telefono').value.trim() || null,\r\n        email: document.getElementById('admin-cliente-email').value.trim() || null,\r\n        cuit: document.getElementById('admin-cliente-cuit').value.trim() || null,\r\n        division: document.getElementById('admin-cliente-division').value.trim() || null,\r\n        canal: document.getElementById('admin-cliente-canal').value.trim() || null\r\n    };\r\n\r\n    saveBtn.disabled = true;\r\n    saveBtn.textContent = 'Guardando...';\r\n\r\n    try {\r\n        let result;\r\n\r\n        if (id) {\r\n            // Actualizar\r\n            result = await supabase\r\n                .from('clients')\r\n                .update(clienteData)\r\n                .eq('id', id);\r\n        } else {\r\n            // Crear\r\n            result = await supabase\r\n                .from('clients')\r\n                .insert(clienteData);\r\n        }\r\n\r\n        if (result.error) throw result.error;\r\n\r\n        closeModal();\r\n        await loadClientes(currentPage);\r\n        await loadStats();\r\n        await loadFilterOptions();\r\n    } catch (error) {\r\n        console.error('[AdminPanel] Error saving cliente:', error);\r\n        errorEl.textContent = error.message || 'Error al guardar el cliente';\r\n        errorEl.classList.remove('hidden');\r\n    } finally {\r\n        saveBtn.disabled = false;\r\n        saveBtn.textContent = 'Guardar';\r\n    }\r\n}\r\n\r\n// Confirmar eliminaci├│n\r\nasync function confirmDeleteCliente(id) {\r\n    const cliente = clientesCache.find(c => c.id == id);\r\n    const nombre = cliente?.razon_social || 'este cliente';\r\n\r\n    if (!confirm(`┬┐Est├ís seguro de eliminar \"${nombre}\"? Esta acci├│n no se puede deshacer.`)) {\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const { error } = await supabase\r\n            .from('clients')\r\n            .delete()\r\n            .eq('id', id);\r\n\r\n        if (error) throw error;\r\n\r\n        await loadClientes(currentPage);\r\n        await loadStats();\r\n    } catch (error) {\r\n        console.error('[AdminPanel] Error deleting cliente:', error);\r\n        alert('Error al eliminar el cliente: ' + error.message);\r\n    }\r\n}\r\n\r\n// Mostrar detalle del cliente\r\nasync function showClienteDetalle(id) {\r\n    let cliente = clientesCache.find(c => c.id == id);\r\n\r\n    if (!cliente) {\r\n        const { data, error } = await supabase\r\n            .from('clients')\r\n            .select('*')\r\n            .eq('id', id)\r\n            .single();\r\n\r\n        if (error || !data) {\r\n            alert('No se pudo cargar el cliente');\r\n            return;\r\n        }\r\n        cliente = data;\r\n    }\r\n\r\n    const modal = document.getElementById('admin-cliente-detalle-modal');\r\n    const backdrop = document.getElementById('admin-cliente-detalle-backdrop');\r\n    const title = document.getElementById('admin-cliente-detalle-title');\r\n    const subtitle = document.getElementById('admin-cliente-detalle-subtitle');\r\n    const content = document.getElementById('admin-cliente-detalle-content');\r\n\r\n    title.textContent = cliente.razon_social;\r\n    subtitle.textContent = cliente.cuit || '';\r\n\r\n    content.innerHTML = `\r\n        <div class=\"space-y-6\">\r\n            <!-- Informaci├│n principal -->\r\n            <div class=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                <div class=\"space-y-4\">\r\n                    <h4 class=\"text-sm font-semibold text-gray-500 uppercase tracking-wider\">Informaci├│n General</h4>\r\n                    \r\n                    <div>\r\n                        <p class=\"text-sm text-gray-500\">Raz├│n Social</p>\r\n                        <p class=\"text-gray-900 font-medium\">${escapeHtml(cliente.razon_social)}</p>\r\n                    </div>\r\n                    \r\n                    <div>\r\n                        <p class=\"text-sm text-gray-500\">Direcci├│n</p>\r\n                        <p class=\"text-gray-900\">${escapeHtml(cliente.direccion || '-')}</p>\r\n                    </div>\r\n                    \r\n                    <div>\r\n                        <p class=\"text-sm text-gray-500\">CUIT</p>\r\n                        <p class=\"text-gray-900\">${escapeHtml(cliente.cuit || '-')}</p>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"space-y-4\">\r\n                    <h4 class=\"text-sm font-semibold text-gray-500 uppercase tracking-wider\">Contacto</h4>\r\n                    \r\n                    <div>\r\n                        <p class=\"text-sm text-gray-500\">Tel├®fono</p>\r\n                        <p class=\"text-gray-900\">\r\n                            ${cliente.telefono\r\n            ? `<a href=\"tel:${cliente.telefono}\" class=\"text-indigo-600 hover:underline\">${escapeHtml(cliente.telefono)}</a>`\r\n            : '-'}\r\n                        </p>\r\n                    </div>\r\n                    \r\n                    <div>\r\n                        <p class=\"text-sm text-gray-500\">Email</p>\r\n                        <p class=\"text-gray-900\">\r\n                            ${cliente.email\r\n            ? `<a href=\"mailto:${cliente.email}\" class=\"text-indigo-600 hover:underline\">${escapeHtml(cliente.email)}</a>`\r\n            : '-'}\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            \r\n            <!-- Clasificaci├│n -->\r\n            <div class=\"border-t border-gray-200 pt-6\">\r\n                <h4 class=\"text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4\">Clasificaci├│n</h4>\r\n                <div class=\"flex flex-wrap gap-3\">\r\n                    ${cliente.division\r\n            ? `<div class=\"flex items-center gap-2 px-4 py-2 bg-indigo-50 rounded-xl\">\r\n                            <span class=\"text-sm text-gray-600\">Divisi├│n:</span>\r\n                            <span class=\"font-medium text-indigo-700\">${escapeHtml(cliente.division)}</span>\r\n                           </div>`\r\n            : ''}\r\n                    ${cliente.canal\r\n            ? `<div class=\"flex items-center gap-2 px-4 py-2 bg-purple-50 rounded-xl\">\r\n                            <span class=\"text-sm text-gray-600\">Canal:</span>\r\n                            <span class=\"font-medium text-purple-700\">${escapeHtml(cliente.canal)}</span>\r\n                           </div>`\r\n            : ''}\r\n                    ${!cliente.division && !cliente.canal\r\n            ? '<p class=\"text-gray-500 text-sm\">Sin clasificaci├│n asignada</p>'\r\n            : ''}\r\n                </div>\r\n            </div>\r\n            \r\n            <!-- Metadata -->\r\n            <div class=\"border-t border-gray-200 pt-6\">\r\n                <h4 class=\"text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4\">Informaci├│n del Registro</h4>\r\n                <div class=\"grid grid-cols-2 gap-4 text-sm\">\r\n                    <div>\r\n                        <p class=\"text-gray-500\">Fecha de creaci├│n</p>\r\n                        <p class=\"text-gray-900\">${formatDate(cliente.created_at)}</p>\r\n                    </div>\r\n                    <div>\r\n                        <p class=\"text-gray-500\">├Ültima actualizaci├│n</p>\r\n                        <p class=\"text-gray-900\">${formatDate(cliente.updated_at)}</p>\r\n                    </div>\r\n                    <div>\r\n                        <p class=\"text-gray-500\">ID del Cliente</p>\r\n                        <p class=\"text-gray-900 font-mono text-xs\">${cliente.id}</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    // Guardar ID para el bot├│n de editar\r\n    modal.dataset.clienteId = cliente.id;\r\n\r\n    modal.classList.remove('hidden');\r\n    backdrop.classList.remove('hidden');\r\n}\r\n\r\n// Cerrar modal de detalle\r\nfunction closeDetalleModal() {\r\n    const modal = document.getElementById('admin-cliente-detalle-modal');\r\n    const backdrop = document.getElementById('admin-cliente-detalle-backdrop');\r\n\r\n    modal?.classList.add('hidden');\r\n    backdrop?.classList.add('hidden');\r\n}\r\n\r\n// Helpers\r\nfunction escapeHtml(str) {\r\n    if (!str) return '';\r\n    const div = document.createElement('div');\r\n    div.textContent = str;\r\n    return div.innerHTML;\r\n}\r\n\r\nfunction getInitials(name) {\r\n    if (!name) return '?';\r\n    return name\r\n        .split(' ')\r\n        .slice(0, 2)\r\n        .map(word => word.charAt(0).toUpperCase())\r\n        .join('');\r\n}\r\n\r\nfunction formatDate(dateStr) {\r\n    if (!dateStr) return '-';\r\n    try {\r\n        return new Date(dateStr).toLocaleDateString('es-AR', {\r\n            day: '2-digit',\r\n            month: '2-digit',\r\n            year: 'numeric',\r\n            hour: '2-digit',\r\n            minute: '2-digit'\r\n        });\r\n    } catch {\r\n        return '-';\r\n    }\r\n}\r\n\r\n// Debounce para b├║squeda\r\nfunction debounce(fn, delay) {\r\n    let timeoutId;\r\n    return function (...args) {\r\n        clearTimeout(timeoutId);\r\n        timeoutId = setTimeout(() => fn.apply(this, args), delay);\r\n    };\r\n}\r\n\r\n// Inicializar event listeners\r\nfunction bindEventListeners() {\r\n    // Bot├│n de nuevo cliente\r\n    const nuevoBtn = document.getElementById('admin-cliente-nuevo-btn');\r\n    nuevoBtn?.addEventListener('click', openNewModal);\r\n\r\n    // Formulario de cliente\r\n    const form = document.getElementById('admin-cliente-form');\r\n    form?.addEventListener('submit', saveCliente);\r\n\r\n    // Bot├│n cancelar del modal\r\n    const cancelBtn = document.getElementById('admin-cliente-cancel-btn');\r\n    cancelBtn?.addEventListener('click', closeModal);\r\n\r\n    // Cerrar modal con backdrop\r\n    const backdrop = document.getElementById('admin-cliente-modal-backdrop');\r\n    backdrop?.addEventListener('click', closeModal);\r\n\r\n    // B├║squeda con debounce\r\n    const searchInput = document.getElementById('admin-clientes-search');\r\n    searchInput?.addEventListener('input', debounce((e) => {\r\n        currentFilters.search = e.target.value;\r\n        loadClientes(1);\r\n    }, 300));\r\n\r\n    // Filtros\r\n    const divisionFilter = document.getElementById('admin-clientes-filter-division');\r\n    divisionFilter?.addEventListener('change', (e) => {\r\n        currentFilters.division = e.target.value;\r\n        loadClientes(1);\r\n    });\r\n\r\n    const canalFilter = document.getElementById('admin-clientes-filter-canal');\r\n    canalFilter?.addEventListener('change', (e) => {\r\n        currentFilters.canal = e.target.value;\r\n        loadClientes(1);\r\n    });\r\n\r\n    // Paginaci├│n\r\n    const prevBtn = document.getElementById('admin-clientes-prev-btn');\r\n    prevBtn?.addEventListener('click', () => {\r\n        if (currentPage > 1) {\r\n            loadClientes(currentPage - 1);\r\n        }\r\n    });\r\n\r\n    const nextBtn = document.getElementById('admin-clientes-next-btn');\r\n    nextBtn?.addEventListener('click', () => {\r\n        const totalPages = Math.ceil(totalClientes / ITEMS_PER_PAGE);\r\n        if (currentPage < totalPages) {\r\n            loadClientes(currentPage + 1);\r\n        }\r\n    });\r\n\r\n    // Modal de detalle\r\n    const detalleCloseBtn = document.getElementById('admin-cliente-detalle-close-btn');\r\n    detalleCloseBtn?.addEventListener('click', closeDetalleModal);\r\n\r\n    const detalleBackdrop = document.getElementById('admin-cliente-detalle-backdrop');\r\n    detalleBackdrop?.addEventListener('click', closeDetalleModal);\r\n\r\n    const detalleEditBtn = document.getElementById('admin-cliente-detalle-edit-btn');\r\n    detalleEditBtn?.addEventListener('click', () => {\r\n        const modal = document.getElementById('admin-cliente-detalle-modal');\r\n        const id = modal?.dataset.clienteId;\r\n        if (id) {\r\n            closeDetalleModal();\r\n            openEditModal(id);\r\n        }\r\n    });\r\n\r\n    // Opci├│n de men├║ Panel de Administraci├│n\r\n    const adminMenuItem = document.getElementById('admin-panel-menu-item');\r\n    adminMenuItem?.addEventListener('click', (e) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        // Cerrar men├║ de usuario\r\n        const userMenu = document.getElementById('user-menu');\r\n        userMenu?.classList.add('hidden');\r\n\r\n        // Disparar evento de navegaci├│n\r\n        document.dispatchEvent(new CustomEvent('auth:navigate', {\r\n            detail: { action: 'admin' }\r\n        }));\r\n    });\r\n\r\n    // Event listeners para usuarios\r\n    bindUsuarioEventListeners();\r\n\r\n    // Event listeners para sistemas y equipos\r\n    bindSistemasEquiposEventListeners();\r\n\r\n    // Event listeners para feedback filters\r\n    const feedbackEstadoFilter = document.getElementById('admin-feedback-filter-estado');\r\n    const feedbackCategoriaFilter = document.getElementById('admin-feedback-filter-categoria');\r\n    const feedbackImpactoFilter = document.getElementById('admin-feedback-filter-impacto');\r\n\r\n    feedbackEstadoFilter?.addEventListener('change', (e) => {\r\n        feedbackFilters.estado = e.target.value;\r\n        loadFeedback();\r\n    });\r\n    feedbackCategoriaFilter?.addEventListener('change', (e) => {\r\n        feedbackFilters.categoria = e.target.value;\r\n        loadFeedback();\r\n    });\r\n    feedbackImpactoFilter?.addEventListener('change', (e) => {\r\n        feedbackFilters.impacto = e.target.value;\r\n        loadFeedback();\r\n    });\r\n\r\n    // Cargar feedback cuando se cambia a la pesta├▒a de feedback\r\n    document.querySelectorAll('.admin-tab-button').forEach(btn => {\r\n        btn.addEventListener('click', () => {\r\n            const tabId = btn.dataset.adminTab;\r\n            if (tabId === 'feedback') {\r\n                loadFeedback();\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n// ============================================\r\n// GESTI├ôN DE USUARIOS\r\n// ============================================\r\n\r\nlet usuariosCache = [];\r\nlet usuarioFilters = {\r\n    search: '',\r\n    rol: ''\r\n};\r\n\r\n// URL de la Edge Function (se configura seg├║n el entorno)\r\nfunction getAdminUsersUrl() {\r\n    // Obtener la URL base de Supabase y construir la URL de la funci├│n\r\n    const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || '';\r\n    return `${supabaseUrl}/functions/v1/admin-users`;\r\n}\r\n\r\n// Obtener token de autorizaci├│n\r\nasync function getAuthToken() {\r\n    const { data: { session }, error } = await supabase.auth.getSession();\r\n    if (error) {\r\n        console.error('[AdminPanel] Error getting session:', error);\r\n    }\r\n    const token = session?.access_token || '';\r\n    console.log('[AdminPanel] Token obtained:', token ? `${token.substring(0, 20)}...` : 'EMPTY');\r\n    return token;\r\n}\r\n\r\n// Hacer petici├│n a la Edge Function\r\nasync function fetchAdminUsers(method, endpoint = '', body = null) {\r\n    const token = await getAuthToken();\r\n\r\n    if (!token) {\r\n        console.error('[AdminPanel] No token available - user might not be logged in');\r\n        throw new Error('No hay sesi├│n activa. Por favor, vuelva a iniciar sesi├│n.');\r\n    }\r\n\r\n    const url = getAdminUsersUrl() + endpoint;\r\n\r\n    const options = {\r\n        method,\r\n        headers: {\r\n            'Authorization': `Bearer ${token}`,\r\n            'Content-Type': 'application/json',\r\n        },\r\n    };\r\n\r\n    if (body) {\r\n        options.body = JSON.stringify(body);\r\n    }\r\n\r\n    const response = await fetch(url, options);\r\n    const data = await response.json();\r\n\r\n    if (!response.ok) {\r\n        console.error('[AdminPanel] API Error:', response.status, data);\r\n        throw new Error(data.error || data.message || 'Error en la operaci├│n');\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\n// Cargar lista de usuarios\r\nasync function loadUsuarios() {\r\n    const tbody = document.getElementById('admin-usuarios-tbody');\r\n\r\n    if (!tbody) return;\r\n\r\n    tbody.innerHTML = `\r\n        <tr>\r\n            <td colspan=\"6\" class=\"px-6 py-8 text-center text-gray-500\">\r\n                <div class=\"flex items-center justify-center gap-2\">\r\n                    <svg class=\"animate-spin h-5 w-5 text-indigo-600\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                        <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\r\n                        <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z\"></path>\r\n                    </svg>\r\n                    Cargando usuarios...\r\n                </div>\r\n            </td>\r\n        </tr>\r\n    `;\r\n\r\n    try {\r\n        const data = await fetchAdminUsers('GET');\r\n        usuariosCache = data.users || [];\r\n\r\n        // Aplicar filtros\r\n        let filteredUsers = usuariosCache;\r\n\r\n        if (usuarioFilters.search) {\r\n            const searchLower = usuarioFilters.search.toLowerCase();\r\n            filteredUsers = filteredUsers.filter(u =>\r\n                u.email?.toLowerCase().includes(searchLower) ||\r\n                u.nombre?.toLowerCase().includes(searchLower)\r\n            );\r\n        }\r\n\r\n        if (usuarioFilters.rol) {\r\n            filteredUsers = filteredUsers.filter(u => u.rol === usuarioFilters.rol);\r\n        }\r\n\r\n        renderUsuariosTable(filteredUsers);\r\n        updateUsuariosStats();\r\n\r\n    } catch (error) {\r\n        console.error('[AdminPanel] Error loading users:', error);\r\n        tbody.innerHTML = `\r\n            <tr>\r\n                <td colspan=\"6\" class=\"px-6 py-8 text-center text-red-500\">\r\n                    Error al cargar usuarios: ${escapeHtml(error.message)}\r\n                </td>\r\n            </tr>\r\n        `;\r\n    }\r\n}\r\n\r\n// Renderizar tabla de usuarios\r\nfunction renderUsuariosTable(usuarios) {\r\n    const tbody = document.getElementById('admin-usuarios-tbody');\r\n\r\n    if (!tbody) return;\r\n\r\n    if (usuarios.length === 0) {\r\n        tbody.innerHTML = `\r\n            <tr>\r\n                <td colspan=\"6\" class=\"px-6 py-8 text-center text-gray-500\">\r\n                    No se encontraron usuarios\r\n                </td>\r\n            </tr>\r\n        `;\r\n        return;\r\n    }\r\n\r\n    tbody.innerHTML = usuarios.map(usuario => {\r\n        const rolBadge = getRolBadge(usuario.rol);\r\n        const estadoBadge = getEstadoBadge(usuario);\r\n        const lastAccess = formatLastAccess(usuario.last_sign_in_at);\r\n        const isBanned = !!usuario.banned_until;\r\n        const blockButton = getBlockButton(usuario);\r\n\r\n        return `\r\n            <tr class=\"hover:bg-gray-50 transition-colors ${isBanned ? 'bg-red-50/50' : ''}\">\r\n                <td class=\"px-6 py-4\">\r\n                    <div class=\"flex items-center gap-3\">\r\n                        <div class=\"w-10 h-10 rounded-full ${isBanned ? 'bg-gradient-to-br from-gray-400 to-gray-500' : 'bg-gradient-to-br from-indigo-500 to-purple-600'} flex items-center justify-center text-white font-semibold\">\r\n                            ${getInitials(usuario.nombre || usuario.email)}\r\n                        </div>\r\n                        <div>\r\n                            <p class=\"font-medium text-gray-900 ${isBanned ? 'line-through text-gray-500' : ''}\">${escapeHtml(usuario.nombre || 'Sin nombre')}</p>\r\n                            <p class=\"text-sm text-gray-500\">${escapeHtml(usuario.cargo || '')}</p>\r\n                        </div>\r\n                    </div>\r\n                </td>\r\n                <td class=\"px-6 py-4 text-sm text-gray-600\">${escapeHtml(usuario.email)}</td>\r\n                <td class=\"px-6 py-4\">${rolBadge}</td>\r\n                <td class=\"px-6 py-4 text-sm text-gray-500\">${lastAccess}</td>\r\n                <td class=\"px-6 py-4\">${estadoBadge}</td>\r\n                <td class=\"px-6 py-4 text-right\">\r\n                    <div class=\"flex items-center justify-end gap-1\">\r\n                        ${blockButton}\r\n                        <button onclick=\"window.adminResetPassword('${escapeHtml(usuario.email)}', '${escapeHtml(usuario.nombre || usuario.email)}')\" \r\n                                class=\"p-2 text-gray-400 hover:text-amber-600 hover:bg-amber-50 rounded-lg transition-colors\" \r\n                                title=\"Enviar email de reset de contrase├▒a\">\r\n                            <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z\" />\r\n                            </svg>\r\n                        </button>\r\n                        <button onclick=\"window.adminEditUsuario('${usuario.id}')\" \r\n                                class=\"p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors\" \r\n                                title=\"Editar\">\r\n                            <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\r\n                            </svg>\r\n                        </button>\r\n                        <button onclick=\"window.adminDeleteUsuario('${usuario.id}', '${escapeHtml(usuario.nombre || usuario.email)}')\" \r\n                                class=\"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors\" \r\n                                title=\"Eliminar\">\r\n                            <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\r\n                            </svg>\r\n                        </button>\r\n                    </div>\r\n                </td>\r\n            </tr>\r\n        `;\r\n    }).join('');\r\n}\r\n\r\n// Obtener badge de rol\r\nfunction getRolBadge(rol) {\r\n    const roles = {\r\n        'Administrador': 'bg-purple-100 text-purple-700',\r\n        'admin': 'bg-purple-100 text-purple-700',\r\n        'ventas': 'bg-emerald-100 text-emerald-700',\r\n        'coordinador': 'bg-amber-100 text-amber-700',\r\n        'jefe_servicio': 'bg-blue-100 text-blue-700',\r\n        'tecnico': 'bg-gray-100 text-gray-700'\r\n    };\r\n\r\n    const colorClass = roles[rol] || 'bg-gray-100 text-gray-700';\r\n    const roleLabels = {\r\n        'admin': 'Administrador',\r\n        'Administrador': 'Administrador',\r\n        'ventas': 'Ventas',\r\n        'coordinador': 'Coordinador',\r\n        'jefe_servicio': 'Jefe de Servicio',\r\n        'tecnico': 'T├®cnico'\r\n    };\r\n    const displayRol = roleLabels[rol] || rol;\r\n\r\n    return `<span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}\">${escapeHtml(displayRol)}</span>`;\r\n}\r\n\r\n// Obtener bot├│n de bloquear/desbloquear\r\nfunction getBlockButton(usuario) {\r\n    const isBanned = !!usuario.banned_until;\r\n\r\n    if (isBanned) {\r\n        // Bot├│n para desbloquear\r\n        return `\r\n            <button onclick=\"window.adminToggleBlockUsuario('${usuario.id}', false, '${escapeHtml(usuario.nombre || usuario.email)}')\" \r\n                    class=\"p-2 text-green-500 hover:text-green-700 hover:bg-green-50 rounded-lg transition-colors\" \r\n                    title=\"Desbloquear usuario\">\r\n                <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z\" />\r\n                </svg>\r\n            </button>\r\n        `;\r\n    } else {\r\n        // Bot├│n para bloquear\r\n        return `\r\n            <button onclick=\"window.adminToggleBlockUsuario('${usuario.id}', true, '${escapeHtml(usuario.nombre || usuario.email)}')\" \r\n                    class=\"p-2 text-gray-400 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors\" \r\n                    title=\"Bloquear usuario\">\r\n                <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\" />\r\n                </svg>\r\n            </button>\r\n        `;\r\n    }\r\n}\r\n\r\n// Obtener badge de estado\r\nfunction getEstadoBadge(usuario) {\r\n    if (usuario.banned_until) {\r\n        return `<span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700\">Bloqueado</span>`;\r\n    }\r\n    if (!usuario.email_confirmed_at) {\r\n        return `<span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700\">Pendiente</span>`;\r\n    }\r\n    return `<span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700\">Activo</span>`;\r\n}\r\n\r\n// Formatear ├║ltimo acceso\r\nfunction formatLastAccess(date) {\r\n    if (!date) return 'Nunca';\r\n\r\n    const d = new Date(date);\r\n    const now = new Date();\r\n    const diffMs = now - d;\r\n    const diffHours = diffMs / (1000 * 60 * 60);\r\n    const diffDays = diffMs / (1000 * 60 * 60 * 24);\r\n\r\n    if (diffHours < 1) {\r\n        return 'Hace menos de 1 hora';\r\n    } else if (diffHours < 24) {\r\n        return `Hace ${Math.floor(diffHours)} horas`;\r\n    } else if (diffDays < 7) {\r\n        return `Hace ${Math.floor(diffDays)} d├¡as`;\r\n    } else {\r\n        return d.toLocaleDateString('es-AR');\r\n    }\r\n}\r\n\r\n// Actualizar estad├¡sticas de usuarios\r\nfunction updateUsuariosStats() {\r\n    const total = usuariosCache.length;\r\n    const admins = usuariosCache.filter(u => u.rol === 'Administrador' || u.rol === 'admin').length;\r\n    const tecnicos = usuariosCache.filter(u => u.rol === 'tecnico').length;\r\n\r\n    // Activos hoy = usuarios que accedieron en las ├║ltimas 24 horas\r\n    const now = new Date();\r\n    const activosHoy = usuariosCache.filter(u => {\r\n        if (!u.last_sign_in_at) return false;\r\n        const lastAccess = new Date(u.last_sign_in_at);\r\n        return (now - lastAccess) < (24 * 60 * 60 * 1000);\r\n    }).length;\r\n\r\n    document.getElementById('admin-stat-total-usuarios')?.textContent !== undefined &&\r\n        (document.getElementById('admin-stat-total-usuarios').textContent = total);\r\n    document.getElementById('admin-stat-admins')?.textContent !== undefined &&\r\n        (document.getElementById('admin-stat-admins').textContent = admins);\r\n    document.getElementById('admin-stat-tecnicos')?.textContent !== undefined &&\r\n        (document.getElementById('admin-stat-tecnicos').textContent = tecnicos);\r\n    document.getElementById('admin-stat-activos-hoy')?.textContent !== undefined &&\r\n        (document.getElementById('admin-stat-activos-hoy').textContent = activosHoy);\r\n}\r\n\r\n// Abrir modal para nuevo usuario\r\nfunction openUsuarioNewModal() {\r\n    const modal = document.getElementById('admin-usuario-modal');\r\n    const backdrop = document.getElementById('admin-usuario-modal-backdrop');\r\n    const title = document.getElementById('admin-usuario-modal-title');\r\n    const form = document.getElementById('admin-usuario-form');\r\n    const passwordHint = document.getElementById('admin-usuario-password-hint');\r\n    const passwordInfo = document.getElementById('admin-usuario-password-info');\r\n    const passwordConfirmHint = document.getElementById('admin-usuario-password-confirm-hint');\r\n    const passwordConfirmGroup = document.getElementById('admin-usuario-password-confirm-group');\r\n    const emailInput = document.getElementById('admin-usuario-email');\r\n\r\n    if (!modal || !form) return;\r\n\r\n    title.textContent = 'Nuevo Usuario';\r\n    form.reset();\r\n    document.getElementById('admin-usuario-id').value = '';\r\n    document.getElementById('admin-usuario-error').classList.add('hidden');\r\n\r\n    // Para nuevo usuario, contrase├▒a es requerida\r\n    passwordHint.textContent = '*';\r\n    passwordConfirmHint.textContent = '*';\r\n    passwordInfo.classList.add('hidden');\r\n    passwordConfirmGroup?.classList.remove('hidden');\r\n    emailInput.removeAttribute('disabled');\r\n\r\n    // Resetear indicadores de fortaleza\r\n    resetPasswordIndicators();\r\n\r\n    // Mostrar secci├│n de t├®cnico (ya que rol por defecto es 'tecnico')\r\n    updateTecnicoSectionVisibility('tecnico');\r\n\r\n    // Resetear campos de t├®cnico a valores por defecto\r\n    loadTecnicoFields({\r\n        score_ponderado: 0,\r\n        hora_entrada: '08:00',\r\n        hora_salida: '18:00',\r\n        max_horas_dia: 10,\r\n        dias_laborables: ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'],\r\n        direccion_base: '',\r\n        lat: null,\r\n        lng: null,\r\n        activo: true\r\n    });\r\n\r\n    modal.classList.remove('hidden');\r\n    backdrop.classList.remove('hidden');\r\n\r\n    emailInput.focus();\r\n}\r\n\r\n// Abrir modal para editar usuario\r\nfunction openUsuarioEditModal(id) {\r\n    const usuario = usuariosCache.find(u => u.id === id);\r\n\r\n    if (!usuario) {\r\n        alert('Usuario no encontrado');\r\n        return;\r\n    }\r\n\r\n    const modal = document.getElementById('admin-usuario-modal');\r\n    const backdrop = document.getElementById('admin-usuario-modal-backdrop');\r\n    const title = document.getElementById('admin-usuario-modal-title');\r\n    const passwordHint = document.getElementById('admin-usuario-password-hint');\r\n    const passwordInfo = document.getElementById('admin-usuario-password-info');\r\n    const passwordConfirmHint = document.getElementById('admin-usuario-password-confirm-hint');\r\n    const passwordConfirmGroup = document.getElementById('admin-usuario-password-confirm-group');\r\n    const emailInput = document.getElementById('admin-usuario-email');\r\n\r\n    title.textContent = 'Editar Usuario';\r\n    document.getElementById('admin-usuario-id').value = usuario.id;\r\n    emailInput.value = usuario.email || '';\r\n    emailInput.setAttribute('disabled', 'disabled'); // No permitir cambiar email\r\n    document.getElementById('admin-usuario-password').value = '';\r\n    document.getElementById('admin-usuario-password-confirm').value = '';\r\n    document.getElementById('admin-usuario-nombre').value = usuario.nombre || '';\r\n    document.getElementById('admin-usuario-cargo').value = usuario.cargo || '';\r\n    document.getElementById('admin-usuario-rol').value = usuario.rol || 'tecnico';\r\n    document.getElementById('admin-usuario-telefono').value = usuario.telefono || '';\r\n    document.getElementById('admin-usuario-error').classList.add('hidden');\r\n\r\n    // Cargar campos de t├®cnico\r\n    loadTecnicoFields(usuario);\r\n\r\n    // Mostrar/ocultar secci├│n de t├®cnico seg├║n rol\r\n    updateTecnicoSectionVisibility(usuario.rol || 'tecnico');\r\n\r\n    // Para edici├│n, contrase├▒a es opcional\r\n    passwordHint.textContent = '(opcional)';\r\n    passwordConfirmHint.textContent = '(opcional)';\r\n    passwordInfo.classList.remove('hidden');\r\n    passwordConfirmGroup?.classList.remove('hidden');\r\n\r\n    // Resetear indicadores de fortaleza\r\n    resetPasswordIndicators();\r\n\r\n    modal.classList.remove('hidden');\r\n    backdrop.classList.remove('hidden');\r\n}\r\n\r\n// Resetear indicadores de contrase├▒a\r\nfunction resetPasswordIndicators() {\r\n    // Ocultar indicadores de fortaleza\r\n    document.getElementById('admin-usuario-password-strength')?.classList.add('hidden');\r\n    document.getElementById('admin-usuario-password-requirements')?.classList.add('hidden');\r\n    document.getElementById('admin-usuario-password-match')?.classList.add('hidden');\r\n\r\n    // Resetear barras de fortaleza\r\n    ['strength-bar-1', 'strength-bar-2', 'strength-bar-3', 'strength-bar-4'].forEach(id => {\r\n        const bar = document.getElementById(id);\r\n        if (bar) {\r\n            bar.className = 'h-1 flex-1 rounded-full bg-gray-200';\r\n        }\r\n    });\r\n\r\n    // Resetear requisitos\r\n    ['req-length', 'req-uppercase', 'req-lowercase', 'req-number', 'req-special'].forEach(reqId => {\r\n        const reqEl = document.getElementById(reqId);\r\n        if (reqEl) {\r\n            const svg = reqEl.querySelector('svg');\r\n            const span = reqEl.querySelector('span');\r\n            svg?.classList.remove('text-green-500');\r\n            svg?.classList.add('text-gray-300');\r\n            span?.classList.remove('text-green-600');\r\n            span?.classList.add('text-gray-500');\r\n        }\r\n    });\r\n\r\n    // Resetear tipo de input a password\r\n    const passwordInput = document.getElementById('admin-usuario-password');\r\n    const passwordConfirmInput = document.getElementById('admin-usuario-password-confirm');\r\n    if (passwordInput) passwordInput.type = 'password';\r\n    if (passwordConfirmInput) passwordConfirmInput.type = 'password';\r\n\r\n    // Resetear iconos de ojo\r\n    document.getElementById('admin-usuario-password-eye')?.classList.remove('hidden');\r\n    document.getElementById('admin-usuario-password-eye-off')?.classList.add('hidden');\r\n    document.getElementById('admin-usuario-password-confirm-eye')?.classList.remove('hidden');\r\n    document.getElementById('admin-usuario-password-confirm-eye-off')?.classList.add('hidden');\r\n}\r\n\r\n// Mostrar/ocultar secci├│n de t├®cnico seg├║n rol\r\nfunction updateTecnicoSectionVisibility(rol) {\r\n    const tecnicoSection = document.getElementById('admin-usuario-tecnico-section');\r\n    if (!tecnicoSection) return;\r\n\r\n    if (rol === 'tecnico') {\r\n        tecnicoSection.classList.remove('hidden');\r\n    } else {\r\n        tecnicoSection.classList.add('hidden');\r\n    }\r\n}\r\n\r\n// Cargar campos de t├®cnico en el formulario\r\nfunction loadTecnicoFields(usuario) {\r\n    // Score\r\n    const scoreInput = document.getElementById('admin-usuario-score');\r\n    const scoreDisplay = document.getElementById('admin-usuario-score-display');\r\n    if (scoreInput) {\r\n        scoreInput.value = usuario.score_ponderado || 0;\r\n        if (scoreDisplay) scoreDisplay.textContent = usuario.score_ponderado || 0;\r\n    }\r\n\r\n    // Horarios\r\n    const horaEntradaInput = document.getElementById('admin-usuario-hora-entrada');\r\n    if (horaEntradaInput) horaEntradaInput.value = usuario.hora_entrada || '08:00';\r\n\r\n    const horaSalidaInput = document.getElementById('admin-usuario-hora-salida');\r\n    if (horaSalidaInput) horaSalidaInput.value = usuario.hora_salida || '18:00';\r\n\r\n    const maxHorasInput = document.getElementById('admin-usuario-max-horas');\r\n    if (maxHorasInput) maxHorasInput.value = usuario.max_horas_dia || 10;\r\n\r\n    // D├¡as laborables - desmarcar todos primero, luego marcar los que corresponden\r\n    const diasCheckboxes = document.querySelectorAll('input[name=\"dias_laborables\"]');\r\n    const diasLaborables = usuario.dias_laborables || ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'];\r\n    diasCheckboxes.forEach(cb => {\r\n        cb.checked = diasLaborables.includes(cb.value);\r\n    });\r\n\r\n    // Direcci├│n base\r\n    const direccionInput = document.getElementById('admin-usuario-direccion');\r\n    if (direccionInput) direccionInput.value = usuario.direccion_base || '';\r\n\r\n    const latInput = document.getElementById('admin-usuario-lat');\r\n    if (latInput) latInput.value = usuario.lat || '';\r\n\r\n    const lngInput = document.getElementById('admin-usuario-lng');\r\n    if (lngInput) lngInput.value = usuario.lng || '';\r\n\r\n    // Activo\r\n    const activoInput = document.getElementById('admin-usuario-activo');\r\n    if (activoInput) activoInput.checked = usuario.activo !== false;\r\n}\r\n\r\n// Cerrar modal de usuario\r\nfunction closeUsuarioModal() {\r\n    const modal = document.getElementById('admin-usuario-modal');\r\n    const backdrop = document.getElementById('admin-usuario-modal-backdrop');\r\n\r\n    modal?.classList.add('hidden');\r\n    backdrop?.classList.add('hidden');\r\n}\r\n\r\n// Guardar usuario (crear o editar)\r\nasync function saveUsuario(event) {\r\n    event.preventDefault();\r\n\r\n    const errorEl = document.getElementById('admin-usuario-error');\r\n    const saveBtn = document.getElementById('admin-usuario-save-btn');\r\n    const id = document.getElementById('admin-usuario-id').value;\r\n\r\n    const userData = {\r\n        email: document.getElementById('admin-usuario-email').value.trim(),\r\n        password: document.getElementById('admin-usuario-password').value,\r\n        nombre: document.getElementById('admin-usuario-nombre').value.trim(),\r\n        cargo: document.getElementById('admin-usuario-cargo').value.trim(),\r\n        rol: document.getElementById('admin-usuario-rol').value,\r\n        telefono: document.getElementById('admin-usuario-telefono').value.trim(),\r\n    };\r\n\r\n    // Agregar campos de t├®cnico si el rol es 'tecnico'\r\n    if (userData.rol === 'tecnico') {\r\n        userData.score_ponderado = parseFloat(document.getElementById('admin-usuario-score')?.value || '0');\r\n        userData.hora_entrada = document.getElementById('admin-usuario-hora-entrada')?.value || '08:00';\r\n        userData.hora_salida = document.getElementById('admin-usuario-hora-salida')?.value || '18:00';\r\n        userData.max_horas_dia = parseInt(document.getElementById('admin-usuario-max-horas')?.value || '10');\r\n        userData.direccion_base = document.getElementById('admin-usuario-direccion')?.value?.trim() || '';\r\n        userData.lat = parseFloat(document.getElementById('admin-usuario-lat')?.value) || null;\r\n        userData.lng = parseFloat(document.getElementById('admin-usuario-lng')?.value) || null;\r\n        userData.activo = document.getElementById('admin-usuario-activo')?.checked ?? true;\r\n\r\n        // Obtener d├¡as laborables de checkboxes\r\n        const diasCheckboxes = document.querySelectorAll('input[name=\"dias_laborables\"]:checked');\r\n        userData.dias_laborables = Array.from(diasCheckboxes).map(cb => cb.value);\r\n    }\r\n\r\n    const passwordConfirm = document.getElementById('admin-usuario-password-confirm')?.value || '';\r\n\r\n    // Validaciones\r\n    if (!userData.email) {\r\n        errorEl.textContent = 'El email es requerido';\r\n        errorEl.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    if (!id && (!userData.password || userData.password.length < 6)) {\r\n        errorEl.textContent = 'La contrase├▒a debe tener al menos 6 caracteres';\r\n        errorEl.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    if (id && userData.password && userData.password.length > 0 && userData.password.length < 6) {\r\n        errorEl.textContent = 'La contrase├▒a debe tener al menos 6 caracteres';\r\n        errorEl.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    // Validar que las contrase├▒as coincidan (si hay contrase├▒a)\r\n    if (userData.password && userData.password !== passwordConfirm) {\r\n        errorEl.textContent = 'Las contrase├▒as no coinciden';\r\n        errorEl.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    // Si estamos editando y no hay contrase├▒a, no la enviamos\r\n    if (id && !userData.password) {\r\n        delete userData.password;\r\n    }\r\n\r\n    saveBtn.disabled = true;\r\n    saveBtn.innerHTML = `\r\n        <svg class=\"animate-spin h-4 w-4 mr-2\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n            <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\r\n            <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z\"></path>\r\n        </svg>\r\n        Guardando...\r\n    `;\r\n\r\n    try {\r\n        if (id) {\r\n            // Actualizar\r\n            userData.id = id;\r\n            await fetchAdminUsers('PUT', '', userData);\r\n        } else {\r\n            // Crear\r\n            await fetchAdminUsers('POST', '', userData);\r\n        }\r\n\r\n        closeUsuarioModal();\r\n        await loadUsuarios();\r\n\r\n    } catch (error) {\r\n        console.error('[AdminPanel] Error saving user:', error);\r\n        errorEl.textContent = error.message;\r\n        errorEl.classList.remove('hidden');\r\n    } finally {\r\n        saveBtn.disabled = false;\r\n        saveBtn.textContent = 'Guardar';\r\n    }\r\n}\r\n\r\n// Abrir modal de confirmaci├│n de eliminaci├│n\r\nfunction openUsuarioDeleteModal(id, nombre) {\r\n    const modal = document.getElementById('admin-usuario-delete-modal');\r\n    const backdrop = document.getElementById('admin-usuario-delete-backdrop');\r\n\r\n    document.getElementById('admin-usuario-delete-id').value = id;\r\n    document.getElementById('admin-usuario-delete-name').textContent = nombre;\r\n\r\n    modal?.classList.remove('hidden');\r\n    backdrop?.classList.remove('hidden');\r\n}\r\n\r\n// Cerrar modal de eliminaci├│n\r\nfunction closeUsuarioDeleteModal() {\r\n    const modal = document.getElementById('admin-usuario-delete-modal');\r\n    const backdrop = document.getElementById('admin-usuario-delete-backdrop');\r\n\r\n    modal?.classList.add('hidden');\r\n    backdrop?.classList.add('hidden');\r\n}\r\n\r\n// Confirmar eliminaci├│n de usuario\r\nasync function confirmDeleteUsuario() {\r\n    const id = document.getElementById('admin-usuario-delete-id').value;\r\n    const confirmBtn = document.getElementById('admin-usuario-delete-confirm-btn');\r\n\r\n    if (!id) return;\r\n\r\n    confirmBtn.disabled = true;\r\n    confirmBtn.innerHTML = `\r\n        <svg class=\"animate-spin h-4 w-4 mr-2 inline\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n            <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\r\n            <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z\"></path>\r\n        </svg>\r\n        Eliminando...\r\n    `;\r\n\r\n    try {\r\n        await fetchAdminUsers('DELETE', `?id=${id}`);\r\n        closeUsuarioDeleteModal();\r\n        await loadUsuarios();\r\n    } catch (error) {\r\n        console.error('[AdminPanel] Error deleting user:', error);\r\n        alert('Error al eliminar usuario: ' + error.message);\r\n    } finally {\r\n        confirmBtn.disabled = false;\r\n        confirmBtn.textContent = 'Eliminar';\r\n    }\r\n}\r\n\r\n// Bloquear/Desbloquear usuario\r\nasync function toggleBlockUsuario(id, shouldBlock, nombre) {\r\n    const action = shouldBlock ? 'bloquear' : 'desbloquear';\r\n\r\n    if (!confirm(`┬┐Est├ís seguro de que deseas ${action} al usuario \"${nombre}\"?`)) {\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const result = await fetchAdminUsers('PUT', '', {\r\n            id: id,\r\n            banned: shouldBlock\r\n        });\r\n\r\n        // El Edge Function retorna { message, user } en ├®xito, o { error } en fallo\r\n        if (result.error) {\r\n            alert('Error al ' + action + ' usuario: ' + result.error);\r\n        } else {\r\n            alert(shouldBlock ? 'Usuario bloqueado correctamente' : 'Usuario desbloqueado correctamente');\r\n            await loadUsuarios();\r\n        }\r\n    } catch (error) {\r\n        console.error('Error:', error);\r\n        alert('Error al ' + action + ' usuario');\r\n    }\r\n}\r\n\r\n// Enviar email de reset de contrase├▒a\r\nasync function sendPasswordReset(email, nombre) {\r\n    if (!confirm(`┬┐Enviar email de recuperaci├│n de contrase├▒a a \"${nombre}\" (${email})?`)) {\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const result = await fetchAdminUsers('PATCH', '', { email: email });\r\n\r\n        if (result.error) {\r\n            alert('Error: ' + result.error);\r\n        } else if (result.emailSent) {\r\n            // Email enviado exitosamente con Resend\r\n            alert(`Ô£à Email de recuperaci├│n enviado exitosamente a ${email}`);\r\n        } else if (result.recoveryLink) {\r\n            // Fallback: mostrar modal con el link (si Resend fall├│)\r\n            showRecoveryLinkModal(email, nombre, result.recoveryLink);\r\n        } else {\r\n            alert('Operaci├│n completada: ' + (result.message || 'OK'));\r\n        }\r\n    } catch (error) {\r\n        console.error('Error:', error);\r\n        alert('Error al enviar email de recuperaci├│n');\r\n    }\r\n}\r\n\r\n// Modal para mostrar el link de recuperaci├│n\r\nfunction showRecoveryLinkModal(email, nombre, link) {\r\n    // Crear modal din├ímicamente\r\n    const modalHtml = `\r\n        <div id=\"recovery-link-modal\" class=\"fixed inset-0 z-50 flex items-center justify-center\">\r\n            <div class=\"absolute inset-0 bg-black/50 backdrop-blur-sm\" onclick=\"closeRecoveryModal()\"></div>\r\n            <div class=\"relative bg-white rounded-2xl shadow-2xl max-w-xl w-full mx-4 p-6\">\r\n                <div class=\"flex items-center gap-3 mb-4\">\r\n                    <div class=\"w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center\">\r\n                        <svg class=\"w-6 h-6 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z\" />\r\n                        </svg>\r\n                    </div>\r\n                    <div>\r\n                        <h3 class=\"text-lg font-semibold text-gray-900\">Link de Recuperaci├│n</h3>\r\n                        <p class=\"text-sm text-gray-500\">Para: ${nombre} (${email})</p>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"bg-gray-50 rounded-lg p-4 mb-4\">\r\n                    <p class=\"text-xs text-gray-500 mb-2\">Copi├í este link y envialo al usuario:</p>\r\n                    <div class=\"flex gap-2\">\r\n                        <input type=\"text\" id=\"recovery-link-input\" readonly \r\n                               value=\"${link}\" \r\n                               class=\"flex-1 text-sm font-mono bg-white border border-gray-200 rounded-lg px-3 py-2 text-gray-700\">\r\n                        <button onclick=\"copyRecoveryLink()\" \r\n                                class=\"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2\">\r\n                            <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\r\n                            </svg>\r\n                            Copiar\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div class=\"bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4\">\r\n                    <p class=\"text-sm text-yellow-800\">\r\n                        <strong>ÔÜá´©Å Importante:</strong> Este link expira en 24 horas. El usuario debe usarlo para establecer una nueva contrase├▒a.\r\n                    </p>\r\n                </div>\r\n                \r\n                <div class=\"flex justify-end\">\r\n                    <button onclick=\"closeRecoveryModal()\" \r\n                            class=\"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors\">\r\n                        Cerrar\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    document.body.insertAdjacentHTML('beforeend', modalHtml);\r\n}\r\n\r\nfunction closeRecoveryModal() {\r\n    const modal = document.getElementById('recovery-link-modal');\r\n    if (modal) modal.remove();\r\n}\r\n\r\nfunction copyRecoveryLink() {\r\n    const input = document.getElementById('recovery-link-input');\r\n    if (input) {\r\n        input.select();\r\n        navigator.clipboard.writeText(input.value).then(() => {\r\n            alert('Link copiado al portapapeles!');\r\n        }).catch(() => {\r\n            // Fallback para navegadores que no soportan clipboard API\r\n            document.execCommand('copy');\r\n            alert('Link copiado!');\r\n        });\r\n    }\r\n}\r\n\r\n// Exponer funciones del modal de recovery\r\nwindow.closeRecoveryModal = closeRecoveryModal;\r\nwindow.copyRecoveryLink = copyRecoveryLink;\r\n\r\n// Exponer funciones globalmente para los onclick\r\nwindow.adminEditUsuario = openUsuarioEditModal;\r\nwindow.adminDeleteUsuario = openUsuarioDeleteModal;\r\nwindow.adminToggleBlockUsuario = toggleBlockUsuario;\r\nwindow.adminResetPassword = sendPasswordReset;\r\n\r\n// Event listeners espec├¡ficos de usuarios\r\nfunction bindUsuarioEventListeners() {\r\n    // Tabs del admin panel\r\n    document.querySelectorAll('.admin-tab-button').forEach(btn => {\r\n        btn.addEventListener('click', () => {\r\n            const tabId = btn.dataset.adminTab;\r\n\r\n            // Actualizar botones\r\n            document.querySelectorAll('.admin-tab-button').forEach(b => b.classList.remove('active'));\r\n            btn.classList.add('active');\r\n\r\n            // Mostrar/ocultar contenido\r\n            document.querySelectorAll('.admin-tab-content').forEach(content => {\r\n                content.classList.add('hidden');\r\n            });\r\n\r\n            const targetContent = document.getElementById(`admin-tab-${tabId}`);\r\n            targetContent?.classList.remove('hidden');\r\n\r\n            // Cargar datos seg├║n la pesta├▒a\r\n            if (tabId === 'usuarios') {\r\n                loadUsuarios();\r\n            } else if (tabId === 'sistemas') {\r\n                loadSistemas();\r\n            } else if (tabId === 'equipos') {\r\n                loadEquipos();\r\n            } else if (tabId === 'feedback') {\r\n                loadFeedback();\r\n            }\r\n        });\r\n    });\r\n\r\n    // Bot├│n nuevo usuario\r\n    const nuevoUsuarioBtn = document.getElementById('admin-usuario-nuevo-btn');\r\n    nuevoUsuarioBtn?.addEventListener('click', openUsuarioNewModal);\r\n\r\n    // Formulario de usuario\r\n    const usuarioForm = document.getElementById('admin-usuario-form');\r\n    usuarioForm?.addEventListener('submit', saveUsuario);\r\n\r\n    // Cancelar modal usuario\r\n    const usuarioCancelBtn = document.getElementById('admin-usuario-cancel-btn');\r\n    usuarioCancelBtn?.addEventListener('click', closeUsuarioModal);\r\n\r\n    // Backdrop modal usuario\r\n    const usuarioBackdrop = document.getElementById('admin-usuario-modal-backdrop');\r\n    usuarioBackdrop?.addEventListener('click', closeUsuarioModal);\r\n\r\n    // Modal eliminar usuario\r\n    const deleteCancelBtn = document.getElementById('admin-usuario-delete-cancel-btn');\r\n    deleteCancelBtn?.addEventListener('click', closeUsuarioDeleteModal);\r\n\r\n    const deleteConfirmBtn = document.getElementById('admin-usuario-delete-confirm-btn');\r\n    deleteConfirmBtn?.addEventListener('click', confirmDeleteUsuario);\r\n\r\n    const deleteBackdrop = document.getElementById('admin-usuario-delete-backdrop');\r\n    deleteBackdrop?.addEventListener('click', closeUsuarioDeleteModal);\r\n\r\n    // B├║squeda de usuarios\r\n    const usuariosSearch = document.getElementById('admin-usuarios-search');\r\n    let searchTimeout;\r\n    usuariosSearch?.addEventListener('input', (e) => {\r\n        clearTimeout(searchTimeout);\r\n        searchTimeout = setTimeout(() => {\r\n            usuarioFilters.search = e.target.value;\r\n            loadUsuarios();\r\n        }, 300);\r\n    });\r\n\r\n    // Filtro por rol\r\n    const usuariosFilterRol = document.getElementById('admin-usuarios-filter-rol');\r\n    usuariosFilterRol?.addEventListener('change', (e) => {\r\n        usuarioFilters.rol = e.target.value;\r\n        loadUsuarios();\r\n    });\r\n\r\n    // Cambio de rol en el formulario de usuario - mostrar/ocultar secci├│n t├®cnico\r\n    const usuarioRolSelect = document.getElementById('admin-usuario-rol');\r\n    usuarioRolSelect?.addEventListener('change', (e) => {\r\n        updateTecnicoSectionVisibility(e.target.value);\r\n    });\r\n\r\n    // Slider de puntuaci├│n - actualizar display en tiempo real\r\n    const scoreSlider = document.getElementById('admin-usuario-score');\r\n    const scoreDisplay = document.getElementById('admin-usuario-score-display');\r\n    scoreSlider?.addEventListener('input', (e) => {\r\n        if (scoreDisplay) scoreDisplay.textContent = e.target.value;\r\n    });\r\n\r\n    // ============================================\r\n    // Validaci├│n de contrase├▒a en tiempo real\r\n    // ============================================\r\n\r\n    const passwordInput = document.getElementById('admin-usuario-password');\r\n    const passwordConfirmInput = document.getElementById('admin-usuario-password-confirm');\r\n\r\n    // Toggle mostrar/ocultar contrase├▒a\r\n    const passwordToggle = document.getElementById('admin-usuario-password-toggle');\r\n    passwordToggle?.addEventListener('click', () => {\r\n        togglePasswordVisibility('admin-usuario-password', 'admin-usuario-password-eye', 'admin-usuario-password-eye-off');\r\n    });\r\n\r\n    const passwordConfirmToggle = document.getElementById('admin-usuario-password-confirm-toggle');\r\n    passwordConfirmToggle?.addEventListener('click', () => {\r\n        togglePasswordVisibility('admin-usuario-password-confirm', 'admin-usuario-password-confirm-eye', 'admin-usuario-password-confirm-eye-off');\r\n    });\r\n\r\n    // Validar contrase├▒a mientras escribe\r\n    passwordInput?.addEventListener('input', (e) => {\r\n        validatePasswordStrength(e.target.value);\r\n        validatePasswordMatch();\r\n    });\r\n\r\n    // Validar confirmaci├│n mientras escribe\r\n    passwordConfirmInput?.addEventListener('input', () => {\r\n        validatePasswordMatch();\r\n    });\r\n\r\n    // Mostrar requisitos al enfocar\r\n    passwordInput?.addEventListener('focus', () => {\r\n        const strengthDiv = document.getElementById('admin-usuario-password-strength');\r\n        const reqsDiv = document.getElementById('admin-usuario-password-requirements');\r\n        const isEditing = document.getElementById('admin-usuario-id')?.value;\r\n\r\n        // Solo mostrar si hay algo escrito o es usuario nuevo\r\n        if (passwordInput.value || !isEditing) {\r\n            strengthDiv?.classList.remove('hidden');\r\n            reqsDiv?.classList.remove('hidden');\r\n        }\r\n    });\r\n}\r\n\r\n// Toggle visibilidad de contrase├▒a\r\nfunction togglePasswordVisibility(inputId, eyeId, eyeOffId) {\r\n    const input = document.getElementById(inputId);\r\n    const eye = document.getElementById(eyeId);\r\n    const eyeOff = document.getElementById(eyeOffId);\r\n\r\n    if (input.type === 'password') {\r\n        input.type = 'text';\r\n        eye.classList.add('hidden');\r\n        eyeOff.classList.remove('hidden');\r\n    } else {\r\n        input.type = 'password';\r\n        eye.classList.remove('hidden');\r\n        eyeOff.classList.add('hidden');\r\n    }\r\n}\r\n\r\n// Validar fortaleza de contrase├▒a\r\nfunction validatePasswordStrength(password) {\r\n    const strengthDiv = document.getElementById('admin-usuario-password-strength');\r\n    const reqsDiv = document.getElementById('admin-usuario-password-requirements');\r\n    const strengthText = document.getElementById('admin-usuario-password-strength-text');\r\n\r\n    if (!password) {\r\n        strengthDiv?.classList.add('hidden');\r\n        reqsDiv?.classList.add('hidden');\r\n        return;\r\n    }\r\n\r\n    strengthDiv?.classList.remove('hidden');\r\n    reqsDiv?.classList.remove('hidden');\r\n\r\n    // Verificar requisitos\r\n    const requirements = {\r\n        length: password.length >= 6,\r\n        uppercase: /[A-Z]/.test(password),\r\n        lowercase: /[a-z]/.test(password),\r\n        number: /[0-9]/.test(password),\r\n        special: /[!@#$%^&*(),.?\":{}|<>_\\-+=[\\]\\\\/`~]/.test(password)\r\n    };\r\n\r\n    // Actualizar indicadores de requisitos\r\n    updateRequirement('req-length', requirements.length);\r\n    updateRequirement('req-uppercase', requirements.uppercase);\r\n    updateRequirement('req-lowercase', requirements.lowercase);\r\n    updateRequirement('req-number', requirements.number);\r\n    updateRequirement('req-special', requirements.special);\r\n\r\n    // Calcular puntaje\r\n    const score = Object.values(requirements).filter(Boolean).length;\r\n\r\n    // Actualizar barras de fortaleza\r\n    const bars = ['strength-bar-1', 'strength-bar-2', 'strength-bar-3', 'strength-bar-4'];\r\n    const colors = {\r\n        1: 'bg-red-500',\r\n        2: 'bg-orange-500',\r\n        3: 'bg-yellow-500',\r\n        4: 'bg-green-400',\r\n        5: 'bg-green-500'\r\n    };\r\n\r\n    bars.forEach((barId, index) => {\r\n        const bar = document.getElementById(barId);\r\n        if (!bar) return;\r\n\r\n        // Resetear clases\r\n        bar.className = 'h-1 flex-1 rounded-full';\r\n\r\n        if (index < score) {\r\n            bar.classList.add(colors[score] || 'bg-gray-200');\r\n        } else {\r\n            bar.classList.add('bg-gray-200');\r\n        }\r\n    });\r\n\r\n    // Actualizar texto de fortaleza\r\n    const strengthLabels = {\r\n        0: { text: 'Muy d├®bil', color: 'text-red-600' },\r\n        1: { text: 'D├®bil', color: 'text-red-500' },\r\n        2: { text: 'Regular', color: 'text-orange-500' },\r\n        3: { text: 'Buena', color: 'text-yellow-600' },\r\n        4: { text: 'Fuerte', color: 'text-green-500' },\r\n        5: { text: 'Muy fuerte', color: 'text-green-600' }\r\n    };\r\n\r\n    const label = strengthLabels[score];\r\n    if (strengthText) {\r\n        strengthText.textContent = `Fortaleza: ${label.text}`;\r\n        strengthText.className = `text-xs ${label.color}`;\r\n    }\r\n\r\n    return score;\r\n}\r\n\r\n// Actualizar indicador de requisito individual\r\nfunction updateRequirement(reqId, isMet) {\r\n    const reqEl = document.getElementById(reqId);\r\n    if (!reqEl) return;\r\n\r\n    const svg = reqEl.querySelector('svg');\r\n    const span = reqEl.querySelector('span');\r\n\r\n    if (isMet) {\r\n        svg.classList.remove('text-gray-300');\r\n        svg.classList.add('text-green-500');\r\n        span.classList.remove('text-gray-500');\r\n        span.classList.add('text-green-600');\r\n    } else {\r\n        svg.classList.remove('text-green-500');\r\n        svg.classList.add('text-gray-300');\r\n        span.classList.remove('text-green-600');\r\n        span.classList.add('text-gray-500');\r\n    }\r\n}\r\n\r\n// Validar que las contrase├▒as coincidan\r\nfunction validatePasswordMatch() {\r\n    const password = document.getElementById('admin-usuario-password')?.value || '';\r\n    const confirm = document.getElementById('admin-usuario-password-confirm')?.value || '';\r\n    const matchDiv = document.getElementById('admin-usuario-password-match');\r\n    const matchText = document.getElementById('admin-usuario-password-match-text');\r\n\r\n    if (!confirm) {\r\n        matchDiv?.classList.add('hidden');\r\n        return true;\r\n    }\r\n\r\n    matchDiv?.classList.remove('hidden');\r\n\r\n    if (password === confirm) {\r\n        matchText.innerHTML = `\r\n            <svg class=\"w-3 h-3 flex-shrink-0 text-green-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\r\n                <path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clip-rule=\"evenodd\" />\r\n            </svg>\r\n            <span class=\"text-green-600\">Las contrase├▒as coinciden</span>\r\n        `;\r\n        return true;\r\n    } else {\r\n        matchText.innerHTML = `\r\n            <svg class=\"w-3 h-3 flex-shrink-0 text-red-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\r\n                <path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\" clip-rule=\"evenodd\" />\r\n            </svg>\r\n            <span class=\"text-red-600\">Las contrase├▒as no coinciden</span>\r\n        `;\r\n        return false;\r\n    }\r\n}\r\n\r\n// Navegar al panel de admin\r\nfunction navigateToAdmin() {\r\n    if (!canAccessAdminPanel()) {\r\n        console.warn('[AdminPanel] User cannot access admin panel');\r\n        return;\r\n    }\r\n\r\n    // Ocultar otras vistas\r\n    document.querySelectorAll('.tab-content').forEach(el => {\r\n        el.classList.add('hidden');\r\n    });\r\n\r\n    // Quitar active de los tabs de navegaci├│n principal\r\n    document.querySelectorAll('.tab-button').forEach(btn => {\r\n        btn.classList.remove('active');\r\n    });\r\n\r\n    // Mostrar panel admin\r\n    const adminView = document.getElementById('admin-panel-view');\r\n    if (adminView) {\r\n        adminView.classList.remove('hidden');\r\n    }\r\n\r\n    // Actualizar t├¡tulo de secci├│n\r\n    const sectionTitle = document.getElementById('current-section-title');\r\n    if (sectionTitle) {\r\n        sectionTitle.textContent = 'Panel de Administraci├│n';\r\n    }\r\n\r\n    // Cargar datos\r\n    loadStats();\r\n    loadFilterOptions();\r\n    loadClientes(1);\r\n}\r\n\r\n// ============================================\r\n// GESTI├ôN DE FEEDBACK\r\n// ============================================\r\n\r\nlet feedbackCache = [];\r\nlet feedbackFilters = {\r\n    estado: '',\r\n    categoria: '',\r\n    impacto: ''\r\n};\r\n\r\n// Mapeos para display\r\nconst CATEGORIA_MAP = {\r\n    'bug': { label: 'Error/Bug', emoji: '­ƒÉø', color: 'bg-red-100 text-red-700' },\r\n    'mejora': { label: 'Mejora', emoji: '­ƒÆí', color: 'bg-green-100 text-green-700' },\r\n    'rendimiento': { label: 'Rendimiento', emoji: 'ÔÜí', color: 'bg-amber-100 text-amber-700' },\r\n    'otro': { label: 'Otro', emoji: '­ƒôØ', color: 'bg-gray-100 text-gray-700' }\r\n};\r\n\r\nconst IMPACTO_MAP = {\r\n    'bajo': { label: 'Bajo', color: 'bg-blue-100 text-blue-700' },\r\n    'medio': { label: 'Medio', color: 'bg-yellow-100 text-yellow-700' },\r\n    'alto': { label: 'Alto', color: 'bg-orange-100 text-orange-700' },\r\n    'critico': { label: 'Cr├¡tico', color: 'bg-red-100 text-red-700' }\r\n};\r\n\r\nconst ESTADO_MAP = {\r\n    'nuevo': { label: 'Nuevo', color: 'bg-amber-100 text-amber-700' },\r\n    'en_revision': { label: 'En Revisi├│n', color: 'bg-blue-100 text-blue-700' },\r\n    'resuelto': { label: 'Resuelto', color: 'bg-green-100 text-green-700' },\r\n    'cerrado': { label: 'Cerrado', color: 'bg-gray-100 text-gray-700' }\r\n};\r\n\r\n// Cargar feedback\r\nasync function loadFeedback() {\r\n    try {\r\n        let query = supabase\r\n            .from('feedback')\r\n            .select('*')\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (feedbackFilters.estado) {\r\n            query = query.eq('estado', feedbackFilters.estado);\r\n        }\r\n        if (feedbackFilters.categoria) {\r\n            query = query.eq('categoria', feedbackFilters.categoria);\r\n        }\r\n        if (feedbackFilters.impacto) {\r\n            query = query.eq('impacto', feedbackFilters.impacto);\r\n        }\r\n\r\n        const { data, error } = await query;\r\n\r\n        if (error) {\r\n            console.error('[AdminPanel] Error loading feedback:', error);\r\n            return;\r\n        }\r\n\r\n        feedbackCache = data || [];\r\n        renderFeedbackTable(feedbackCache);\r\n        updateFeedbackStats();\r\n    } catch (err) {\r\n        console.error('[AdminPanel] Error in loadFeedback:', err);\r\n    }\r\n}\r\n\r\n// Renderizar tabla de feedback\r\nfunction renderFeedbackTable(tickets) {\r\n    const tbody = document.getElementById('admin-feedback-tbody');\r\n    if (!tbody) return;\r\n\r\n    if (!tickets || tickets.length === 0) {\r\n        tbody.innerHTML = `\r\n            <tr>\r\n                <td colspan=\"7\" class=\"px-6 py-8 text-center text-gray-500\">\r\n                    No se encontraron tickets de feedback\r\n                </td>\r\n            </tr>\r\n        `;\r\n        return;\r\n    }\r\n\r\n    tbody.innerHTML = tickets.map(ticket => {\r\n        const cat = CATEGORIA_MAP[ticket.categoria] || CATEGORIA_MAP['otro'];\r\n        const imp = IMPACTO_MAP[ticket.impacto] || IMPACTO_MAP['bajo'];\r\n        const est = ESTADO_MAP[ticket.estado] || ESTADO_MAP['nuevo'];\r\n        const fecha = new Date(ticket.created_at).toLocaleDateString('es-AR', {\r\n            day: '2-digit',\r\n            month: '2-digit',\r\n            year: 'numeric',\r\n            hour: '2-digit',\r\n            minute: '2-digit'\r\n        });\r\n        const mensajeCorto = ticket.mensaje?.length > 60\r\n            ? ticket.mensaje.substring(0, 60) + '...'\r\n            : ticket.mensaje || '';\r\n\r\n        return `\r\n            <tr class=\"hover:bg-gray-50\">\r\n                <td class=\"px-6 py-4 text-sm text-gray-600\">${fecha}</td>\r\n                <td class=\"px-6 py-4\">\r\n                    <div class=\"text-sm font-medium text-gray-900\">${escapeHtml(ticket.user_email || 'An├│nimo')}</div>\r\n                </td>\r\n                <td class=\"px-6 py-4\">\r\n                    <span class=\"inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium ${cat.color}\">\r\n                        ${cat.emoji} ${cat.label}\r\n                    </span>\r\n                </td>\r\n                <td class=\"px-6 py-4\">\r\n                    <span class=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${imp.color}\">\r\n                        ${imp.label}\r\n                    </span>\r\n                </td>\r\n                <td class=\"px-6 py-4 text-sm text-gray-600 max-w-xs truncate\" title=\"${escapeHtml(ticket.mensaje || '')}\">\r\n                    ${escapeHtml(mensajeCorto)}\r\n                </td>\r\n                <td class=\"px-6 py-4\">\r\n                    <select \r\n                        onchange=\"window.adminUpdateFeedbackStatus('${ticket.id}', this.value)\"\r\n                        class=\"text-xs border border-gray-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-indigo-500\"\r\n                    >\r\n                        <option value=\"nuevo\" ${ticket.estado === 'nuevo' ? 'selected' : ''}>­ƒƒí Nuevo</option>\r\n                        <option value=\"en_revision\" ${ticket.estado === 'en_revision' ? 'selected' : ''}>­ƒöÁ En Revisi├│n</option>\r\n                        <option value=\"resuelto\" ${ticket.estado === 'resuelto' ? 'selected' : ''}>­ƒƒó Resuelto</option>\r\n                        <option value=\"cerrado\" ${ticket.estado === 'cerrado' ? 'selected' : ''}>ÔÜ½ Cerrado</option>\r\n                    </select>\r\n                </td>\r\n                <td class=\"px-6 py-4 text-right\">\r\n                    <button \r\n                        onclick=\"window.adminShowFeedbackDetail('${ticket.id}')\"\r\n                        class=\"text-indigo-600 hover:text-indigo-900 text-sm font-medium\"\r\n                    >\r\n                        Ver detalle\r\n                    </button>\r\n                </td>\r\n            </tr>\r\n        `;\r\n    }).join('');\r\n\r\n    // Actualizar info de paginaci├│n\r\n    const infoEl = document.getElementById('admin-feedback-info');\r\n    if (infoEl) {\r\n        infoEl.textContent = `Mostrando ${tickets.length} tickets`;\r\n    }\r\n}\r\n\r\n// Actualizar estad├¡sticas de feedback\r\nfunction updateFeedbackStats() {\r\n    const total = feedbackCache.length;\r\n    const nuevos = feedbackCache.filter(t => t.estado === 'nuevo').length;\r\n    const enRevision = feedbackCache.filter(t => t.estado === 'en_revision').length;\r\n    const resueltos = feedbackCache.filter(t => t.estado === 'resuelto').length;\r\n\r\n    const totalEl = document.getElementById('admin-feedback-total');\r\n    const nuevosEl = document.getElementById('admin-feedback-nuevos');\r\n    const revisionEl = document.getElementById('admin-feedback-revision');\r\n    const resueltosEl = document.getElementById('admin-feedback-resueltos');\r\n\r\n    if (totalEl) totalEl.textContent = total;\r\n    if (nuevosEl) nuevosEl.textContent = nuevos;\r\n    if (revisionEl) revisionEl.textContent = enRevision;\r\n    if (resueltosEl) resueltosEl.textContent = resueltos;\r\n}\r\n\r\n// Actualizar estado de un ticket\r\nasync function updateFeedbackStatus(ticketId, newStatus) {\r\n    try {\r\n        const { error } = await supabase\r\n            .from('feedback')\r\n            .update({ estado: newStatus })\r\n            .eq('id', ticketId);\r\n\r\n        if (error) {\r\n            console.error('[AdminPanel] Error updating feedback status:', error);\r\n            if (window.Swal) {\r\n                window.Swal.fire('Error', 'No se pudo actualizar el estado', 'error');\r\n            }\r\n            return;\r\n        }\r\n\r\n        // Actualizar cache local\r\n        const ticket = feedbackCache.find(t => t.id === ticketId);\r\n        if (ticket) {\r\n            ticket.estado = newStatus;\r\n        }\r\n        updateFeedbackStats();\r\n        console.log('[AdminPanel] Feedback status updated:', ticketId, newStatus);\r\n    } catch (err) {\r\n        console.error('[AdminPanel] Error in updateFeedbackStatus:', err);\r\n    }\r\n}\r\n\r\n// Mostrar detalle del ticket\r\nfunction showFeedbackDetail(ticketId) {\r\n    const ticket = feedbackCache.find(t => t.id === ticketId);\r\n    if (!ticket) return;\r\n\r\n    const cat = CATEGORIA_MAP[ticket.categoria] || CATEGORIA_MAP['otro'];\r\n    const imp = IMPACTO_MAP[ticket.impacto] || IMPACTO_MAP['bajo'];\r\n    const est = ESTADO_MAP[ticket.estado] || ESTADO_MAP['nuevo'];\r\n    const fecha = new Date(ticket.created_at).toLocaleString('es-AR', {\r\n        dateStyle: 'full',\r\n        timeStyle: 'short'\r\n    });\r\n\r\n    if (window.Swal) {\r\n        window.Swal.fire({\r\n            title: `${cat.emoji} Ticket de Feedback`,\r\n            html: `\r\n                <div class=\"text-left space-y-4\">\r\n                    <div class=\"grid grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <p class=\"text-xs text-gray-500 uppercase\">Usuario</p>\r\n                            <p class=\"text-sm font-medium\">${escapeHtml(ticket.user_email || 'An├│nimo')}</p>\r\n                        </div>\r\n                        <div>\r\n                            <p class=\"text-xs text-gray-500 uppercase\">Fecha</p>\r\n                            <p class=\"text-sm\">${fecha}</p>\r\n                        </div>\r\n                        <div>\r\n                            <p class=\"text-xs text-gray-500 uppercase\">Categor├¡a</p>\r\n                            <span class=\"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs ${cat.color}\">${cat.emoji} ${cat.label}</span>\r\n                        </div>\r\n                        <div>\r\n                            <p class=\"text-xs text-gray-500 uppercase\">Impacto</p>\r\n                            <span class=\"inline-flex items-center px-2 py-0.5 rounded-full text-xs ${imp.color}\">${imp.label}</span>\r\n                        </div>\r\n                    </div>\r\n                    <div>\r\n                        <p class=\"text-xs text-gray-500 uppercase mb-1\">Mensaje</p>\r\n                        <div class=\"bg-gray-50 rounded-lg p-3 text-sm text-gray-700 whitespace-pre-wrap\">${escapeHtml(ticket.mensaje || 'Sin mensaje')}</div>\r\n                    </div>\r\n                    ${ticket.contacto_info ? `\r\n                    <div>\r\n                        <p class=\"text-xs text-gray-500 uppercase mb-1\">Contacto adicional</p>\r\n                        <p class=\"text-sm\">${escapeHtml(ticket.contacto_info)}</p>\r\n                    </div>\r\n                    ` : ''}\r\n                    ${ticket.origen_url ? `\r\n                    <div>\r\n                        <p class=\"text-xs text-gray-500 uppercase mb-1\">Origen</p>\r\n                        <a href=\"${escapeHtml(ticket.origen_url)}\" target=\"_blank\" class=\"text-xs text-indigo-600 hover:underline break-all\">${escapeHtml(ticket.origen_url)}</a>\r\n                    </div>\r\n                    ` : ''}\r\n                    <div>\r\n                        <p class=\"text-xs text-gray-500 uppercase mb-1\">Estado actual</p>\r\n                        <span class=\"inline-flex items-center px-2 py-0.5 rounded-full text-xs ${est.color}\">${est.label}</span>\r\n                    </div>\r\n                </div>\r\n            `,\r\n            width: 500,\r\n            confirmButtonText: 'Cerrar',\r\n            confirmButtonColor: '#6366f1'\r\n        });\r\n    }\r\n}\r\n\r\n// Exponer funciones globales para eventos onclick en HTML\r\nif (typeof window !== 'undefined') {\r\n    window.adminUpdateFeedbackStatus = updateFeedbackStatus;\r\n    window.adminShowFeedbackDetail = showFeedbackDetail;\r\n}\r\n\r\n// Inicializaci├│n del m├│dulo\r\nexport function createAdminPanelModule() {\r\n    let initialized = false;\r\n\r\n    return {\r\n        init() {\r\n            if (initialized) return;\r\n\r\n            bindEventListeners();\r\n\r\n            // Escuchar navegaci├│n desde el men├║\r\n            document.addEventListener('auth:navigate', (e) => {\r\n                if (e.detail?.action === 'admin') {\r\n                    navigateToAdmin();\r\n                }\r\n            });\r\n\r\n            // Suscribirse a cambios de autenticaci├│n para actualizar visibilidad\r\n            supabase.auth.onAuthStateChange((event) => {\r\n                console.log('[AdminPanel] Auth state change:', event);\r\n                // Peque├▒o delay para asegurar que el storage se haya actualizado\r\n                setTimeout(() => {\r\n                    updateAdminMenuVisibility();\r\n                }, 100);\r\n            });\r\n\r\n            // Actualizar visibilidad inicial\r\n            updateAdminMenuVisibility();\r\n\r\n            initialized = true;\r\n            console.log('[AdminPanel] Module initialized');\r\n        },\r\n\r\n        isAdmin,\r\n        navigateToAdmin,\r\n        updateAdminMenuVisibility,\r\n        loadClientes,\r\n        loadStats\r\n    };\r\n}\r\n\r\nexport default createAdminPanelModule;\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\admin\\sistemasEquipos.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\admin\\userManagement.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'VALID_ROLES' is assigned a value but never used.","line":11,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * User Management Module\r\n * CRUD de usuarios para el panel de administraci├│n\r\n * Utiliza Edge Function admin-users para operaciones de usuario\r\n */\r\n\r\nimport { getCurrentToken } from '../login/auth.js';\r\n\r\n// Constantes\r\nconst SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL || 'https://hcefrvbazosnnynnlsfc.supabase.co';\r\nconst VALID_ROLES = ['admin', 'jefe_servicio', 'tecnico'];\r\nconst ROLE_LABELS = {\r\n    'admin': 'Administrador',\r\n    'jefe_servicio': 'Jefe de Servicio',\r\n    'tecnico': 'T├®cnico'\r\n};\r\n\r\n// Estado del m├│dulo\r\nlet usuariosCache = [];\r\nlet currentFilters = {\r\n    search: '',\r\n    rol: ''\r\n};\r\n\r\n// ============================================\r\n// API Functions\r\n// ============================================\r\n\r\nasync function fetchWithAuth(url, options = {}) {\r\n    const token = getCurrentToken();\r\n    if (!token) {\r\n        throw new Error('No hay sesi├│n activa');\r\n    }\r\n\r\n    const response = await fetch(url, {\r\n        ...options,\r\n        headers: {\r\n            'Content-Type': 'application/json',\r\n            'Authorization': `Bearer ${token}`,\r\n            ...options.headers\r\n        }\r\n    });\r\n\r\n    const data = await response.json();\r\n\r\n    if (!response.ok) {\r\n        throw new Error(data.error || `Error ${response.status}`);\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\nasync function listUsers() {\r\n    return fetchWithAuth(`${SUPABASE_URL}/functions/v1/admin-users`);\r\n}\r\n\r\nasync function createUser(userData) {\r\n    return fetchWithAuth(`${SUPABASE_URL}/functions/v1/admin-users`, {\r\n        method: 'POST',\r\n        body: JSON.stringify(userData)\r\n    });\r\n}\r\n\r\nasync function updateUser(userData) {\r\n    return fetchWithAuth(`${SUPABASE_URL}/functions/v1/admin-users`, {\r\n        method: 'PUT',\r\n        body: JSON.stringify(userData)\r\n    });\r\n}\r\n\r\nasync function deleteUser(userId) {\r\n    return fetchWithAuth(`${SUPABASE_URL}/functions/v1/admin-users?id=${userId}`, {\r\n        method: 'DELETE'\r\n    });\r\n}\r\n\r\nasync function sendPasswordReset(email) {\r\n    return fetchWithAuth(`${SUPABASE_URL}/functions/v1/admin-users`, {\r\n        method: 'PATCH',\r\n        body: JSON.stringify({ email })\r\n    });\r\n}\r\n\r\n// ============================================\r\n// Rendering Functions\r\n// ============================================\r\n\r\nfunction getRoleBadgeClass(rol) {\r\n    const classes = {\r\n        'admin': 'bg-purple-100 text-purple-800',\r\n        'administrador': 'bg-purple-100 text-purple-800',\r\n        'jefe_servicio': 'bg-blue-100 text-blue-800',\r\n        'tecnico': 'bg-green-100 text-green-800'\r\n    };\r\n    return classes[rol?.toLowerCase()] || 'bg-gray-100 text-gray-800';\r\n}\r\n\r\nfunction getRoleLabel(rol) {\r\n    const normalized = rol?.toLowerCase();\r\n    return ROLE_LABELS[normalized] || rol || 'Sin rol';\r\n}\r\n\r\nfunction formatDate(dateStr) {\r\n    if (!dateStr) return 'Nunca';\r\n    try {\r\n        return new Date(dateStr).toLocaleDateString('es-AR', {\r\n            day: '2-digit',\r\n            month: '2-digit',\r\n            year: 'numeric',\r\n            hour: '2-digit',\r\n            minute: '2-digit'\r\n        });\r\n    } catch {\r\n        return 'Fecha inv├ílida';\r\n    }\r\n}\r\n\r\nfunction escapeHtml(str) {\r\n    if (!str) return '';\r\n    const div = document.createElement('div');\r\n    div.textContent = str;\r\n    return div.innerHTML;\r\n}\r\n\r\nfunction getInitials(name) {\r\n    if (!name) return '?';\r\n    return name\r\n        .split(' ')\r\n        .slice(0, 2)\r\n        .map(word => word.charAt(0).toUpperCase())\r\n        .join('');\r\n}\r\n\r\nfunction renderUsuarios(usuarios) {\r\n    const tbody = document.getElementById('admin-usuarios-tbody');\r\n    if (!tbody) return;\r\n\r\n    if (!usuarios || usuarios.length === 0) {\r\n        tbody.innerHTML = `\r\n            <tr>\r\n                <td colspan=\"6\" class=\"px-6 py-8 text-center text-gray-500\">\r\n                    No se encontraron usuarios.\r\n                </td>\r\n            </tr>\r\n        `;\r\n        return;\r\n    }\r\n\r\n    tbody.innerHTML = usuarios.map(user => `\r\n        <tr class=\"hover:bg-gray-50 transition-colors\">\r\n            <td class=\"px-6 py-4\">\r\n                <div class=\"flex items-center gap-3\">\r\n                    <div class=\"h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0\">\r\n                        <span class=\"text-indigo-600 font-semibold text-sm\">\r\n                            ${getInitials(user.nombre || user.email)}\r\n                        </span>\r\n                    </div>\r\n                    <div>\r\n                        <p class=\"font-medium text-gray-900\">${escapeHtml(user.nombre || 'Sin nombre')}</p>\r\n                        <p class=\"text-sm text-gray-500\">${escapeHtml(user.cargo || '')}</p>\r\n                    </div>\r\n                </div>\r\n            </td>\r\n            <td class=\"px-6 py-4\">\r\n                <p class=\"text-gray-900\">${escapeHtml(user.email)}</p>\r\n            </td>\r\n            <td class=\"px-6 py-4\">\r\n                <span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getRoleBadgeClass(user.rol)}\">\r\n                    ${getRoleLabel(user.rol)}\r\n                </span>\r\n            </td>\r\n            <td class=\"px-6 py-4 text-sm text-gray-500\">\r\n                ${formatDate(user.last_sign_in_at)}\r\n            </td>\r\n            <td class=\"px-6 py-4\">\r\n                ${user.banned_until\r\n            ? '<span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800\">Bloqueado</span>'\r\n            : '<span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800\">Activo</span>'\r\n        }\r\n            </td>\r\n            <td class=\"px-6 py-4 text-right\">\r\n                <div class=\"flex items-center justify-end gap-2\">\r\n                    <button type=\"button\" class=\"user-edit-btn p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors\" \r\n                            title=\"Editar\" data-id=\"${user.id}\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" \r\n                                d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\r\n                        </svg>\r\n                    </button>\r\n                    <button type=\"button\" class=\"user-reset-btn p-2 text-gray-500 hover:text-amber-600 hover:bg-amber-50 rounded-lg transition-colors\" \r\n                            title=\"Enviar reset de contrase├▒a\" data-email=\"${user.email}\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" \r\n                                d=\"M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z\" />\r\n                        </svg>\r\n                    </button>\r\n                    <button type=\"button\" class=\"user-delete-btn p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors\" \r\n                            title=\"Eliminar\" data-id=\"${user.id}\" data-nombre=\"${escapeHtml(user.nombre || user.email)}\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" \r\n                                d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\r\n                        </svg>\r\n                    </button>\r\n                </div>\r\n            </td>\r\n        </tr>\r\n    `).join('');\r\n\r\n    // Bind event listeners\r\n    tbody.querySelectorAll('.user-edit-btn').forEach(btn => {\r\n        btn.addEventListener('click', () => openEditModal(btn.dataset.id));\r\n    });\r\n\r\n    tbody.querySelectorAll('.user-reset-btn').forEach(btn => {\r\n        btn.addEventListener('click', () => handleResetPassword(btn.dataset.email));\r\n    });\r\n\r\n    tbody.querySelectorAll('.user-delete-btn').forEach(btn => {\r\n        btn.addEventListener('click', () => handleDeleteUser(btn.dataset.id, btn.dataset.nombre));\r\n    });\r\n}\r\n\r\nfunction updateStats(usuarios) {\r\n    const total = usuarios.length;\r\n    const admins = usuarios.filter(u => (u.rol || '').toLowerCase() === 'admin' || (u.rol || '').toLowerCase() === 'administrador').length;\r\n    const tecnicos = usuarios.filter(u => (u.rol || '').toLowerCase() === 'tecnico').length;\r\n    const today = new Date().toDateString();\r\n    const activosHoy = usuarios.filter(u => {\r\n        if (!u.last_sign_in_at) return false;\r\n        return new Date(u.last_sign_in_at).toDateString() === today;\r\n    }).length;\r\n\r\n    const setElement = (id, value) => {\r\n        const el = document.getElementById(id);\r\n        if (el) el.textContent = value;\r\n    };\r\n\r\n    setElement('admin-stat-total-usuarios', total);\r\n    setElement('admin-stat-admins', admins);\r\n    setElement('admin-stat-tecnicos', tecnicos);\r\n    setElement('admin-stat-activos-hoy', activosHoy);\r\n}\r\n\r\n// ============================================\r\n// Modal Functions\r\n// ============================================\r\n\r\nfunction createUserModal() {\r\n    // Check if modal already exists\r\n    if (document.getElementById('admin-usuario-modal')) return;\r\n\r\n    const modal = document.createElement('div');\r\n    modal.id = 'admin-usuario-modal';\r\n    modal.className = 'fixed inset-0 z-50 hidden';\r\n    modal.innerHTML = `\r\n        <div id=\"admin-usuario-modal-backdrop\" class=\"fixed inset-0 bg-black/50 backdrop-blur-sm\"></div>\r\n        <div class=\"fixed inset-0 flex items-center justify-center p-4\">\r\n            <div class=\"bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-auto\">\r\n                <div class=\"p-6 border-b border-gray-200\">\r\n                    <h3 id=\"admin-usuario-modal-title\" class=\"text-xl font-bold text-gray-900\">Nuevo Usuario</h3>\r\n                </div>\r\n                <form id=\"admin-usuario-form\" class=\"p-6 space-y-4\">\r\n                    <input type=\"hidden\" id=\"admin-usuario-id\">\r\n                    \r\n                    <div id=\"admin-usuario-error\" class=\"hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm\"></div>\r\n                    \r\n                    <div class=\"grid grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label for=\"admin-usuario-nombre\" class=\"block text-sm font-medium text-gray-700 mb-1\">Nombre *</label>\r\n                            <input type=\"text\" id=\"admin-usuario-nombre\" required\r\n                                class=\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\"\r\n                                placeholder=\"Nombre completo\">\r\n                        </div>\r\n                        <div>\r\n                            <label for=\"admin-usuario-cargo\" class=\"block text-sm font-medium text-gray-700 mb-1\">Cargo</label>\r\n                            <input type=\"text\" id=\"admin-usuario-cargo\"\r\n                                class=\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\"\r\n                                placeholder=\"Cargo o posici├│n\">\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div>\r\n                        <label for=\"admin-usuario-email\" class=\"block text-sm font-medium text-gray-700 mb-1\">Email *</label>\r\n                        <input type=\"email\" id=\"admin-usuario-email\" required\r\n                            class=\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\"\r\n                            placeholder=\"email@ejemplo.com\">\r\n                    </div>\r\n                    \r\n                    <div id=\"admin-usuario-password-section\">\r\n                        <label for=\"admin-usuario-password\" class=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                            Contrase├▒a <span id=\"admin-usuario-password-required\">*</span>\r\n                        </label>\r\n                        <input type=\"password\" id=\"admin-usuario-password\"\r\n                            class=\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\"\r\n                            placeholder=\"M├¡nimo 6 caracteres\">\r\n                        <p id=\"admin-usuario-password-hint\" class=\"mt-1 text-xs text-gray-500 hidden\">Dej├í vac├¡o para mantener la contrase├▒a actual</p>\r\n                    </div>\r\n                    \r\n                    <div class=\"grid grid-cols-2 gap-4\">\r\n                        <div>\r\n                            <label for=\"admin-usuario-rol\" class=\"block text-sm font-medium text-gray-700 mb-1\">Rol *</label>\r\n                            <select id=\"admin-usuario-rol\" required\r\n                                class=\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\">\r\n                                <option value=\"\">Seleccionar rol...</option>\r\n                                <option value=\"admin\">Administrador</option>\r\n                                <option value=\"jefe_servicio\">Jefe de Servicio</option>\r\n                                <option value=\"tecnico\">T├®cnico</option>\r\n                            </select>\r\n                        </div>\r\n                        <div>\r\n                            <label for=\"admin-usuario-telefono\" class=\"block text-sm font-medium text-gray-700 mb-1\">Tel├®fono</label>\r\n                            <input type=\"tel\" id=\"admin-usuario-telefono\"\r\n                                class=\"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500\"\r\n                                placeholder=\"+54 11 1234-5678\">\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"flex justify-end gap-3 pt-4 border-t border-gray-200\">\r\n                        <button type=\"button\" id=\"admin-usuario-cancel-btn\"\r\n                            class=\"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors\">\r\n                            Cancelar\r\n                        </button>\r\n                        <button type=\"submit\" id=\"admin-usuario-save-btn\"\r\n                            class=\"px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors\">\r\n                            Guardar\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    document.body.appendChild(modal);\r\n\r\n    // Bind modal events\r\n    document.getElementById('admin-usuario-modal-backdrop')?.addEventListener('click', closeModal);\r\n    document.getElementById('admin-usuario-cancel-btn')?.addEventListener('click', closeModal);\r\n    document.getElementById('admin-usuario-form')?.addEventListener('submit', handleSaveUser);\r\n}\r\n\r\nfunction openNewModal() {\r\n    createUserModal();\r\n    const modal = document.getElementById('admin-usuario-modal');\r\n    const title = document.getElementById('admin-usuario-modal-title');\r\n    const form = document.getElementById('admin-usuario-form');\r\n    const passwordHint = document.getElementById('admin-usuario-password-hint');\r\n    const passwordRequired = document.getElementById('admin-usuario-password-required');\r\n    const passwordInput = document.getElementById('admin-usuario-password');\r\n    const emailInput = document.getElementById('admin-usuario-email');\r\n\r\n    if (!modal || !form) return;\r\n\r\n    title.textContent = 'Nuevo Usuario';\r\n    form.reset();\r\n    document.getElementById('admin-usuario-id').value = '';\r\n    document.getElementById('admin-usuario-error').classList.add('hidden');\r\n    passwordHint?.classList.add('hidden');\r\n    if (passwordRequired) passwordRequired.textContent = '*';\r\n    if (passwordInput) passwordInput.required = true;\r\n    if (emailInput) emailInput.disabled = false;\r\n\r\n    modal.classList.remove('hidden');\r\n    document.getElementById('admin-usuario-nombre')?.focus();\r\n}\r\n\r\nasync function openEditModal(userId) {\r\n    createUserModal();\r\n    const user = usuariosCache.find(u => u.id === userId);\r\n    if (!user) {\r\n        alert('Usuario no encontrado');\r\n        return;\r\n    }\r\n\r\n    const modal = document.getElementById('admin-usuario-modal');\r\n    const title = document.getElementById('admin-usuario-modal-title');\r\n    const passwordHint = document.getElementById('admin-usuario-password-hint');\r\n    const passwordRequired = document.getElementById('admin-usuario-password-required');\r\n    const passwordInput = document.getElementById('admin-usuario-password');\r\n    const emailInput = document.getElementById('admin-usuario-email');\r\n\r\n    title.textContent = 'Editar Usuario';\r\n    document.getElementById('admin-usuario-id').value = user.id;\r\n    document.getElementById('admin-usuario-nombre').value = user.nombre || '';\r\n    document.getElementById('admin-usuario-cargo').value = user.cargo || '';\r\n    document.getElementById('admin-usuario-email').value = user.email || '';\r\n    document.getElementById('admin-usuario-password').value = '';\r\n    document.getElementById('admin-usuario-rol').value = user.rol?.toLowerCase() || 'tecnico';\r\n    document.getElementById('admin-usuario-telefono').value = user.telefono || '';\r\n    document.getElementById('admin-usuario-error').classList.add('hidden');\r\n\r\n    passwordHint?.classList.remove('hidden');\r\n    if (passwordRequired) passwordRequired.textContent = '';\r\n    if (passwordInput) passwordInput.required = false;\r\n    if (emailInput) emailInput.disabled = true;\r\n\r\n    modal.classList.remove('hidden');\r\n}\r\n\r\nfunction closeModal() {\r\n    const modal = document.getElementById('admin-usuario-modal');\r\n    modal?.classList.add('hidden');\r\n}\r\n\r\n// ============================================\r\n// Event Handlers\r\n// ============================================\r\n\r\nasync function handleSaveUser(event) {\r\n    event.preventDefault();\r\n\r\n    const errorEl = document.getElementById('admin-usuario-error');\r\n    const saveBtn = document.getElementById('admin-usuario-save-btn');\r\n\r\n    const id = document.getElementById('admin-usuario-id').value;\r\n    const nombre = document.getElementById('admin-usuario-nombre').value.trim();\r\n    const email = document.getElementById('admin-usuario-email').value.trim();\r\n    const password = document.getElementById('admin-usuario-password').value;\r\n    const cargo = document.getElementById('admin-usuario-cargo').value.trim();\r\n    const rol = document.getElementById('admin-usuario-rol').value;\r\n    const telefono = document.getElementById('admin-usuario-telefono').value.trim();\r\n\r\n    // Validation\r\n    if (!nombre) {\r\n        errorEl.textContent = 'El nombre es obligatorio';\r\n        errorEl.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    if (!email) {\r\n        errorEl.textContent = 'El email es obligatorio';\r\n        errorEl.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    if (!id && (!password || password.length < 6)) {\r\n        errorEl.textContent = 'La contrase├▒a debe tener al menos 6 caracteres';\r\n        errorEl.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    if (id && password && password.length > 0 && password.length < 6) {\r\n        errorEl.textContent = 'La contrase├▒a debe tener al menos 6 caracteres';\r\n        errorEl.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    if (!rol) {\r\n        errorEl.textContent = 'Seleccion├í un rol';\r\n        errorEl.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    saveBtn.disabled = true;\r\n    saveBtn.textContent = 'Guardando...';\r\n\r\n    try {\r\n        const userData = { nombre, cargo, rol, telefono };\r\n\r\n        if (id) {\r\n            userData.id = id;\r\n            if (password) userData.password = password;\r\n            await updateUser(userData);\r\n        } else {\r\n            userData.email = email;\r\n            userData.password = password;\r\n            await createUser(userData);\r\n        }\r\n\r\n        closeModal();\r\n        await loadUsuarios();\r\n    } catch (error) {\r\n        console.error('[UserManagement] Error saving user:', error);\r\n        errorEl.textContent = error.message || 'Error al guardar el usuario';\r\n        errorEl.classList.remove('hidden');\r\n    } finally {\r\n        saveBtn.disabled = false;\r\n        saveBtn.textContent = 'Guardar';\r\n    }\r\n}\r\n\r\nasync function handleDeleteUser(userId, nombre) {\r\n    if (!confirm(`┬┐Est├ís seguro de eliminar al usuario \"${nombre}\"? Esta acci├│n no se puede deshacer.`)) {\r\n        return;\r\n    }\r\n\r\n    try {\r\n        await deleteUser(userId);\r\n        await loadUsuarios();\r\n    } catch (error) {\r\n        console.error('[UserManagement] Error deleting user:', error);\r\n        alert('Error al eliminar el usuario: ' + error.message);\r\n    }\r\n}\r\n\r\nasync function handleResetPassword(email) {\r\n    if (!confirm(`┬┐Enviar email de recuperaci├│n de contrase├▒a a ${email}?`)) {\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const result = await sendPasswordReset(email);\r\n\r\n        if (result.emailSent) {\r\n            alert(`Ô£à Email de recuperaci├│n enviado a ${email}`);\r\n        } else if (result.recoveryLink) {\r\n            // Fallback: mostrar el link\r\n            const copyLink = confirm(`No se pudo enviar el email autom├íticamente.\\n\\n┬┐Copiar el link de recuperaci├│n al portapapeles?`);\r\n            if (copyLink) {\r\n                await navigator.clipboard.writeText(result.recoveryLink);\r\n                alert('Link copiado al portapapeles');\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.error('[UserManagement] Error sending reset:', error);\r\n        alert('Error al enviar email de recuperaci├│n: ' + error.message);\r\n    }\r\n}\r\n\r\n// ============================================\r\n// Main Functions\r\n// ============================================\r\n\r\nexport async function loadUsuarios() {\r\n    const tbody = document.getElementById('admin-usuarios-tbody');\r\n\r\n    if (tbody) {\r\n        tbody.innerHTML = `\r\n            <tr>\r\n                <td colspan=\"6\" class=\"px-6 py-8 text-center text-gray-500\">\r\n                    <div class=\"flex items-center justify-center gap-2\">\r\n                        <svg class=\"animate-spin h-5 w-5 text-indigo-600\" fill=\"none\" viewBox=\"0 0 24 24\">\r\n                            <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\r\n                            <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z\"></path>\r\n                        </svg>\r\n                        Cargando usuarios...\r\n                    </div>\r\n                </td>\r\n            </tr>\r\n        `;\r\n    }\r\n\r\n    try {\r\n        const { users } = await listUsers();\r\n        usuariosCache = users || [];\r\n\r\n        // Apply filters\r\n        let filtered = [...usuariosCache];\r\n\r\n        if (currentFilters.search) {\r\n            const term = currentFilters.search.toLowerCase();\r\n            filtered = filtered.filter(u =>\r\n                (u.nombre || '').toLowerCase().includes(term) ||\r\n                (u.email || '').toLowerCase().includes(term) ||\r\n                (u.cargo || '').toLowerCase().includes(term)\r\n            );\r\n        }\r\n\r\n        if (currentFilters.rol) {\r\n            filtered = filtered.filter(u => (u.rol || '').toLowerCase() === currentFilters.rol.toLowerCase());\r\n        }\r\n\r\n        renderUsuarios(filtered);\r\n        updateStats(usuariosCache);\r\n\r\n    } catch (error) {\r\n        console.error('[UserManagement] Error loading users:', error);\r\n        if (tbody) {\r\n            tbody.innerHTML = `\r\n                <tr>\r\n                    <td colspan=\"6\" class=\"px-6 py-8 text-center text-red-500\">\r\n                        Error al cargar usuarios: ${escapeHtml(error.message)}\r\n                    </td>\r\n                </tr>\r\n            `;\r\n        }\r\n    }\r\n}\r\n\r\nfunction debounce(fn, delay) {\r\n    let timeoutId;\r\n    return function (...args) {\r\n        clearTimeout(timeoutId);\r\n        timeoutId = setTimeout(() => fn.apply(this, args), delay);\r\n    };\r\n}\r\n\r\nexport function bindEventListeners() {\r\n    // Nuevo usuario\r\n    const nuevoBtn = document.getElementById('admin-usuario-nuevo-btn');\r\n    nuevoBtn?.addEventListener('click', openNewModal);\r\n\r\n    // B├║squeda\r\n    const searchInput = document.getElementById('admin-usuarios-search');\r\n    searchInput?.addEventListener('input', debounce((e) => {\r\n        currentFilters.search = e.target.value;\r\n        loadUsuarios();\r\n    }, 300));\r\n\r\n    // Filtro por rol\r\n    const rolFilter = document.getElementById('admin-usuarios-filter-rol');\r\n    rolFilter?.addEventListener('change', (e) => {\r\n        currentFilters.rol = e.target.value;\r\n        loadUsuarios();\r\n    });\r\n}\r\n\r\nexport function initialize() {\r\n    console.log('[UserManagement] Initializing...');\r\n    bindEventListeners();\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\ai\\aiAssistant.js","messages":[{"ruleId":"no-unreachable","severity":2,"message":"Unreachable code.","line":271,"column":9,"nodeType":"ExpressionStatement","messageId":"unreachableCode","endLine":271,"endColumn":35}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { marked } from 'https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js';\r\nimport { supabase } from '../../supabaseClient.js';\r\nimport { checkSoftenerRules, buildSummaryPrompt } from './softenerRules.js';\r\n\r\nconst GOOGLE_API_KEY = import.meta.env.VITE_GEMINI_API_KEY;\r\n\r\n\r\n/**\r\n * M├│dulo de Asistente IA para Reportes\r\n */\r\nexport class AIAssistant {\r\n    constructor(config = {}) {\r\n        this.context = config.context || {}; // { cliente: '...', equipo: '...' }\r\n        this.formId = config.formId;\r\n        this.container = null;\r\n        this.messages = [];\r\n        this.isProcessing = false;\r\n        this.memoryContext = []; // Reglas aprendidas cargadas\r\n        this.debounceTimer = null;\r\n        this.shownAlerts = new Set(); // Para no repetir alertas\r\n        this.lastFormData = null;\r\n    }\r\n\r\n    async initialize() {\r\n        if (!GOOGLE_API_KEY) {\r\n            console.warn('AI Assistant: No API Key found. Disabled.');\r\n            return;\r\n        }\r\n        this.createUI();\r\n        await this.loadMemory();\r\n        this.addWelcomeMessage();\r\n    }\r\n\r\n    createUI() {\r\n        // Crear contenedor flotante\r\n        const div = document.createElement('div');\r\n        div.id = 'ai-assistant-widget';\r\n        div.className = 'fixed bottom-6 left-6 z-50 flex flex-col items-start pointer-events-none';\r\n\r\n        div.innerHTML = `\r\n            <!-- Chat Panel (Hidden by default) -->\r\n            <div id=\"ai-chat-panel\" class=\"bg-white dark:bg-gray-800 shadow-2xl rounded-2xl w-80 mb-4 border border-gray-200 dark:border-gray-700 transform transition-all duration-300 origin-bottom-right scale-0 opacity-0 pointer-events-auto overflow-hidden flex flex-col h-96\">\r\n                <!-- Header -->\r\n                <div class=\"bg-gradient-to-r from-blue-600 to-indigo-600 p-4 flex justify-between items-center text-white\">\r\n                    <div class=\"flex items-center gap-2\">\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 10V3L4 14h7v7l9-11h-7z\"/></svg>\r\n                        <span class=\"font-semibold\">Asistente OBM</span>\r\n                    </div>\r\n                    <button id=\"ai-close-chat\" class=\"hover:bg-white/20 rounded p-1\"><svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"/></svg></button>\r\n                </div>\r\n                \r\n                <!-- Messages Area -->\r\n                <div id=\"ai-messages-area\" class=\"flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900/50\">\r\n                    <!-- Messages will appear here -->\r\n                </div>\r\n\r\n                <!-- Input Area (Visual only for now, or for corrections) -->\r\n                <div class=\"p-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700\">\r\n                    <div class=\"relative\">\r\n                        <input type=\"text\" id=\"ai-user-input\" placeholder=\"Escribe para corregir o preguntar...\" class=\"w-full pl-3 pr-10 py-2 rounded-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500\">\r\n                        <button id=\"ai-send-btn\" class=\"absolute right-2 top-1.5 p-1 text-blue-600 dark:text-blue-400 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-full\">\r\n                            <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 19l9 2-9-18-9 18 9-2zm0 0v-8\"/></svg>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Toggle Button -->\r\n            <button id=\"ai-toggle-btn\" class=\"pointer-events-auto group relative flex items-center justify-center w-14 h-14 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 focus:outline-none ring-4 ring-blue-500/20\">\r\n                <svg class=\"w-8 h-8\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z\"/></svg>\r\n                \r\n                <!-- Notification Badge -->\r\n                <span id=\"ai-notification-badge\" class=\"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center transform scale-0 transition-transform\">0</span>\r\n            </button>\r\n        `;\r\n\r\n        document.body.appendChild(div);\r\n\r\n        // Event Listeners\r\n        this.container = div;\r\n        const toggleBtn = div.querySelector('#ai-toggle-btn');\r\n        const closeBtn = div.querySelector('#ai-close-chat');\r\n        const sendBtn = div.querySelector('#ai-send-btn');\r\n        const input = div.querySelector('#ai-user-input');\r\n\r\n        toggleBtn.addEventListener('click', () => this.toggleChat());\r\n        closeBtn.addEventListener('click', () => this.toggleChat(false));\r\n\r\n        const handleSend = () => {\r\n            const text = input.value.trim();\r\n            if (text) {\r\n                this.handleUserInteraction(text);\r\n                input.value = '';\r\n            }\r\n        };\r\n\r\n        sendBtn.addEventListener('click', handleSend);\r\n        input.addEventListener('keypress', (e) => {\r\n            if (e.key === 'Enter') handleSend();\r\n        });\r\n    }\r\n\r\n    toggleChat(forceOpen = null) {\r\n        const panel = this.container.querySelector('#ai-chat-panel');\r\n        const isOpen = !panel.classList.contains('scale-0');\r\n        const shouldOpen = forceOpen !== null ? forceOpen : !isOpen;\r\n\r\n        if (shouldOpen) {\r\n            panel.classList.remove('scale-0', 'opacity-0');\r\n            this.clearNotifications();\r\n        } else {\r\n            panel.classList.add('scale-0', 'opacity-0');\r\n        }\r\n    }\r\n\r\n    addMessage(text, type = 'ai') {\r\n        const area = this.container.querySelector('#ai-messages-area');\r\n        const msgDiv = document.createElement('div');\r\n        msgDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;\r\n\r\n        const bubbleColor = type === 'user'\r\n            ? 'bg-blue-600 text-white rounded-br-none'\r\n            : 'bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-100 dark:border-gray-600 rounded-bl-none shadow-sm';\r\n\r\n        msgDiv.innerHTML = `\r\n            <div class=\"${bubbleColor} max-w-[85%] rounded-2xl px-4 py-2 text-sm leading-relaxed\">\r\n                ${marked.parse(text)} <!-- Asumimos que marked est├í disponible o lo usamos simple -->\r\n            </div>\r\n        `;\r\n\r\n        area.appendChild(msgDiv);\r\n        area.scrollTop = area.scrollHeight;\r\n\r\n        if (type === 'ai' && this.container.querySelector('#ai-chat-panel').classList.contains('scale-0')) {\r\n            this.showNotification();\r\n        }\r\n    }\r\n\r\n    addWelcomeMessage() {\r\n        const memoryCount = this.memoryContext.length;\r\n        let msg = \"Hola, soy tu asistente OBM.\";\r\n        if (memoryCount > 0) {\r\n            msg += ` He cargado ${memoryCount} reglas espec├¡ficas para este cliente/equipo.`;\r\n        }\r\n        msg += \" Estoy monitoreando el reporte para ayudarte.\";\r\n        this.addMessage(msg, 'ai');\r\n    }\r\n\r\n    showNotification() {\r\n        const badge = this.container.querySelector('#ai-notification-badge');\r\n        badge.textContent = '1'; // Simplificado\r\n        badge.classList.remove('scale-0');\r\n        this.container.querySelector('#ai-toggle-btn').classList.add('animate-bounce');\r\n        setTimeout(() => this.container.querySelector('#ai-toggle-btn').classList.remove('animate-bounce'), 2000);\r\n    }\r\n\r\n    clearNotifications() {\r\n        const badge = this.container.querySelector('#ai-notification-badge');\r\n        badge.classList.add('scale-0');\r\n    }\r\n\r\n    /**\r\n     * Carga memoria desde Supabase basada en el contexto actual\r\n     */\r\n    async loadMemory() {\r\n        if (!this.context.cliente && !this.context.equipo) return;\r\n\r\n        try {\r\n            // Construir tags de b├║squeda\r\n            const tags = ['general'];\r\n            if (this.context.cliente) tags.push(`client:${this.context.cliente}`);\r\n            if (this.context.equipo) tags.push(`equipment:${this.context.equipo}`);\r\n            if (this.context.modelo) tags.push(`model:${this.context.modelo}`);\r\n\r\n            const { data, error } = await supabase\r\n                .from('ai_learning_base')\r\n                .select('knowledge_snippet')\r\n                .in('context_tag', tags);\r\n\r\n            if (!error && data) {\r\n                this.memoryContext = data.map(row => row.knowledge_snippet);\r\n                console.log('AI Memory Loaded:', this.memoryContext);\r\n            }\r\n        } catch (e) {\r\n            console.error('Error loading AI memory:', e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Guarda un nuevo aprendizaje\r\n     */\r\n    async learn(snippet, tag = 'general') {\r\n        const { error } = await supabase.from('ai_learning_base').insert({\r\n            context_tag: tag,\r\n            knowledge_snippet: snippet,\r\n            source: 'user_interaction'\r\n        });\r\n        if (!error) {\r\n            this.memoryContext.push(snippet);\r\n            this.addMessage(`<i>He aprendido esto para la pr├│xima: \"${snippet}\"</i>`, 'ai');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Llamado cuando el formulario cambia. Valida reglas locales.\r\n     */\r\n    observe(formData) {\r\n        if (!formData) return;\r\n\r\n        this.lastFormData = formData;\r\n\r\n        // Ejecutar reglas de negocio LOCALES (sin API)\r\n        const alerts = checkSoftenerRules(formData);\r\n\r\n        // Mostrar nuevas alertas (evitar repetir las mismas)\r\n        for (const alert of alerts) {\r\n            const alertKey = `${alert.type}:${alert.field}:${alert.message.substring(0, 30)}`;\r\n\r\n            if (!this.shownAlerts.has(alertKey)) {\r\n                this.shownAlerts.add(alertKey);\r\n                this.showAlert(alert);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Muestra una alerta en el chat\r\n     */\r\n    showAlert(alert) {\r\n        const icons = {\r\n            'error': '­ƒÜ¿',\r\n            'warning': 'ÔÜá´©Å',\r\n            'tip': '­ƒÆí'\r\n        };\r\n        const icon = icons[alert.type] || '­ƒôó';\r\n        const message = `${icon} **${alert.type === 'error' ? 'Error' : alert.type === 'warning' ? 'Atenci├│n' : 'Tip'}**: ${alert.message}`;\r\n\r\n        this.addMessage(message, 'ai');\r\n        this.showNotification();\r\n    }\r\n\r\n    /**\r\n     * Genera resumen autom├ítico usando IA\r\n     */\r\n    async generateSummary() {\r\n        if (!this.lastFormData) {\r\n            this.addMessage('No hay datos del formulario para generar el resumen.', 'ai');\r\n            return null;\r\n        }\r\n\r\n        this.isProcessing = true;\r\n        const thinkingId = 'thinking-' + Date.now();\r\n        this.addMessage('<span id=\"' + thinkingId + '\" class=\"animate-pulse\">Generando resumen...</span>', 'ai');\r\n\r\n        const prompt = buildSummaryPrompt(this.lastFormData, this.memoryContext);\r\n        const response = await this.callGemini(prompt);\r\n\r\n        // Remover mensaje de thinking\r\n        const thinkingEl = document.getElementById(thinkingId);\r\n        if (thinkingEl) thinkingEl.parentElement.remove();\r\n\r\n        if (response && !response.startsWith('Error')) {\r\n            this.addMessage('**Resumen generado:**\\n' + response, 'ai');\r\n            return response;\r\n        } else {\r\n            this.addMessage('No pude generar el resumen: ' + response, 'ai');\r\n            return null;\r\n        }\r\n\r\n        this.isProcessing = false;\r\n    }\r\n\r\n    /**\r\n     * Limpia las alertas mostradas (para nuevo reporte)\r\n     */\r\n    resetAlerts() {\r\n        this.shownAlerts.clear();\r\n    }\r\n\r\n    async analyze(formData) {\r\n        this.isProcessing = true;\r\n        // Feedback visual de \"pensando\"\r\n        const thinkingId = 'thinking-' + Date.now();\r\n        this.addMessage('<span id=\"' + thinkingId + '\" class=\"animate-pulse\">Analizando reporte...</span>', 'ai');\r\n\r\n        const prompt = this.buildPrompt(formData);\r\n        const response = await this.callGemini(prompt);\r\n\r\n        // Remover mensaje de thinking\r\n        const thinkingEl = document.getElementById(thinkingId);\r\n        if (thinkingEl) thinkingEl.parentElement.remove(); // Hacky removal\r\n\r\n        if (response) {\r\n            this.addMessage(response, 'ai');\r\n        }\r\n        this.isProcessing = false;\r\n    }\r\n\r\n    async callGemini(prompt) {\r\n        try {\r\n            const body = {\r\n                contents: [{\r\n                    parts: [{ text: prompt }]\r\n                }]\r\n            };\r\n\r\n            if (!GOOGLE_API_KEY) {\r\n                console.error('AI: No API Key found. Check VITE_GEMINI_API_KEY in .env');\r\n                return \"Error: No hay API Key configurada. Revis├í el archivo .env\";\r\n            }\r\n\r\n            console.log('AI: Calling Gemini with key starting with:', GOOGLE_API_KEY.substring(0, 10) + '...');\r\n\r\n            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GOOGLE_API_KEY}`;\r\n\r\n            const res = await fetch(url, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(body)\r\n            });\r\n\r\n            const data = await res.json();\r\n\r\n            if (!res.ok) {\r\n                console.error('Gemini API Error:', res.status, data);\r\n                return `Error de API (${res.status}): ${data.error?.message || 'Desconocido'}`;\r\n            }\r\n\r\n            if (!data.candidates || !data.candidates[0]) {\r\n                console.warn('Gemini returned no candidates:', data);\r\n                return \"La IA no pudo generar una respuesta.\";\r\n            }\r\n\r\n            return data.candidates[0].content.parts[0].text;\r\n        } catch (e) {\r\n            console.error('Gemini Error:', e);\r\n            return \"Tuve un error contactando a mi cerebro en la nube: \" + e.message;\r\n        }\r\n    }\r\n\r\n    buildPrompt(formData) {\r\n        // Construir contexto con datos y memoria\r\n        let memoryText = \"\";\r\n        if (this.memoryContext.length > 0) {\r\n            memoryText = \"TEN EN CUENTA LAS SIGUIENTES REGLAS APRENDIDAS PREVIAMENTE:\\n\" +\r\n                this.memoryContext.map(m => `- ${m}`).join('\\n') + \"\\n\\n\";\r\n        }\r\n\r\n        return `\r\n            Act├║a como un supervisor experto de mantenimiento de tratamiento de aguas.\r\n            Est├ís revisando un reporte t├®cnico en tiempo real.\r\n            \r\n            ${memoryText}\r\n            \r\n            DATOS DEL REPORTE ACTUAL:\r\n            ${JSON.stringify(formData, null, 2)}\r\n            \r\n            TAREA:\r\n            1. Detecta inconsistencias graves (ej: dureza alta con autonom├¡a baja).\r\n            2. Detecta campos faltantes cr├¡ticos (ej: autonom├¡as vac├¡as).\r\n            3. Si todo parece bien, responde brevemente con un tip ├║til o aprobaci├│n.\r\n            4. Se conciso, amable y profesional.\r\n            5. Si detectas que se us├│ un filtro incorrecto seg├║n la memoria, av├¡salo.\r\n        `;\r\n    }\r\n\r\n    async handleUserInteraction(text) {\r\n        this.addMessage(text, 'user');\r\n\r\n        // Detectar intenci├│n de \"aprender\"\r\n        if (text.toLowerCase().startsWith('aprende:') || text.toLowerCase().startsWith('recuerda:')) {\r\n            const rule = text.replace(/^(aprende|recuerda):/i, '').trim();\r\n            // Determinar tag (default al cliente actual si existe)\r\n            const tag = this.context.cliente ? `client:${this.context.cliente}` : 'general';\r\n            await this.learn(rule, tag);\r\n            return;\r\n        }\r\n\r\n        // Chat normal\r\n        const prompt = `\r\n            El t├®cnico me dice: \"${text}\".\r\n            Contexto del reporte: ${JSON.stringify(this.context)}\r\n            Knowledge Base: ${JSON.stringify(this.memoryContext)}\r\n            \r\n            Respondele como un asistente t├®cnico senior.\r\n        `;\r\n\r\n        const response = await this.callGemini(prompt);\r\n        this.addMessage(response, 'ai');\r\n    }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\ai\\softenerRules.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\busqueda\\busqueda.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\busqueda\\search.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\dashboard\\dashboard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\equipmentHistory\\equipmentHistory.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\feedback\\feedback.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\login\\auth.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'isPasswordRecoveryMode' is assigned a value but never used.","line":1084,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":1084,"endColumn":27}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../../supabaseClient.js';\r\nimport {\r\n    THEME_DARK,\r\n    THEME_LIGHT,\r\n    getCurrentTheme,\r\n    onThemeChange,\r\n    setTheme,\r\n} from '../theme/theme.js';\r\n\r\nconst STORAGE_KEY = 'reportesOBM.user';\r\nconst REMEMBER_KEY = 'reportesOBM.remember';\r\n\r\nlet cachedSession = null;\r\nlet useLocalStorage = true; // Por defecto usa localStorage\r\nlet listenersBound = false;\r\nlet pendingAuth = null;\r\nlet menuIsOpen = false;\r\nlet documentMenuHandlersActive = false;\r\nlet unsubscribeThemeChange = null;\r\n\r\nfunction getStorage() {\r\n    if (typeof window === 'undefined') {\r\n        return null;\r\n    }\r\n\r\n    // Si \"recordarme\" est├í activo, usar localStorage (persiste al cerrar navegador)\r\n    // Si no, usar sessionStorage (se limpia al cerrar pesta├▒a/navegador)\r\n    if (useLocalStorage) {\r\n        return window.localStorage || null;\r\n    }\r\n    return window.sessionStorage || null;\r\n}\r\n\r\n// Siempre usa localStorage para la preferencia de \"recordarme\"\r\nfunction getRememberStorage() {\r\n    if (typeof window !== 'undefined' && window.localStorage) {\r\n        return window.localStorage;\r\n    }\r\n    return null;\r\n}\r\n\r\nfunction loadRememberPreference() {\r\n    const storage = getRememberStorage();\r\n    if (!storage) return true; // Por defecto recordar\r\n    const value = storage.getItem(REMEMBER_KEY);\r\n    return value !== 'false'; // Si no existe o es 'true', recordar\r\n}\r\n\r\nfunction saveRememberPreference(remember) {\r\n    const storage = getRememberStorage();\r\n    if (storage) {\r\n        storage.setItem(REMEMBER_KEY, remember ? 'true' : 'false');\r\n    }\r\n    useLocalStorage = remember;\r\n}\r\n\r\nfunction normalizeUser(user) {\r\n    if (!user || typeof user !== 'object') {\r\n        return null;\r\n    }\r\n\r\n    const nombre = typeof user.nombre === 'string'\r\n        ? user.nombre.trim()\r\n        : typeof user.Nombre === 'string'\r\n            ? user.Nombre.trim()\r\n            : '';\r\n\r\n    const cargo = typeof user.cargo === 'string'\r\n        ? user.cargo.trim()\r\n        : typeof user.Cargo === 'string'\r\n            ? user.Cargo.trim()\r\n            : '';\r\n\r\n    const rol = typeof user.rol === 'string'\r\n        ? user.rol.trim()\r\n        : typeof user.Rol === 'string'\r\n            ? user.Rol.trim()\r\n            : '';\r\n\r\n    if (!nombre || !rol) {\r\n        return null;\r\n    }\r\n\r\n    return { nombre, cargo, rol };\r\n}\r\n\r\nfunction normalizeToken(token) {\r\n    return typeof token === 'string' ? token.trim() : '';\r\n}\r\n\r\nfunction normalizeExpiresAt(value) {\r\n    if (value === undefined || value === null) {\r\n        return { value: null, valid: true };\r\n    }\r\n    if (value instanceof Date) {\r\n        return Number.isNaN(value.getTime())\r\n            ? { value: null, valid: false }\r\n            : { value: value.toISOString(), valid: true };\r\n    }\r\n    if (typeof value === 'number') {\r\n        if (!Number.isFinite(value)) {\r\n            return { value: null, valid: false };\r\n        }\r\n        const asDate = new Date(value);\r\n        return Number.isNaN(asDate.getTime())\r\n            ? { value: null, valid: false }\r\n            : { value: asDate.toISOString(), valid: true };\r\n    }\r\n    if (typeof value === 'string') {\r\n        const trimmed = value.trim();\r\n        if (!trimmed) {\r\n            return { value: null, valid: true };\r\n        }\r\n        return { value: trimmed, valid: true };\r\n    }\r\n    return { value: null, valid: false };\r\n}\r\n\r\nfunction isTokenActive(token, expiresAt) {\r\n    if (!token) {\r\n        return false;\r\n    }\r\n    if (!expiresAt) {\r\n        return true;\r\n    }\r\n\r\n    const expiration = new Date(expiresAt);\r\n    if (Number.isNaN(expiration.getTime())) {\r\n        return false;\r\n    }\r\n\r\n    return expiration.getTime() > Date.now();\r\n}\r\n\r\nfunction buildSession({ user, token, expiresAt }) {\r\n    const normalizedUser = normalizeUser(user);\r\n    const normalizedToken = normalizeToken(token);\r\n    const { value: normalizedExpiresAt, valid: expiresAtValid } = normalizeExpiresAt(expiresAt);\r\n\r\n    if (!normalizedUser || !normalizedToken || !expiresAtValid) {\r\n        return null;\r\n    }\r\n\r\n    if (!isTokenActive(normalizedToken, normalizedExpiresAt)) {\r\n        return null;\r\n    }\r\n\r\n    return {\r\n        user: normalizedUser,\r\n        token: normalizedToken,\r\n        expiresAt: normalizedExpiresAt,\r\n    };\r\n}\r\n\r\nfunction loadStoredAuth() {\r\n    if (cachedSession && isTokenActive(cachedSession.token, cachedSession.expiresAt)) {\r\n        return cachedSession;\r\n    }\r\n\r\n    cachedSession = null;\r\n\r\n    // Intentar cargar de localStorage primero, luego sessionStorage\r\n    const storages = typeof window !== 'undefined'\r\n        ? [window.localStorage, window.sessionStorage].filter(Boolean)\r\n        : [];\r\n\r\n    for (const storage of storages) {\r\n        const raw = storage.getItem(STORAGE_KEY);\r\n        if (!raw) continue;\r\n\r\n        try {\r\n            const parsed = JSON.parse(raw);\r\n            const normalized = buildSession({\r\n                user: parsed?.user ?? parsed?.usuario ?? parsed,\r\n                token: parsed?.token,\r\n                expiresAt: parsed?.expiresAt,\r\n            });\r\n\r\n            if (normalized) {\r\n                cachedSession = normalized;\r\n                // Detectar qu├® storage ten├¡a la sesi├│n v├ílida\r\n                useLocalStorage = (storage === window.localStorage);\r\n                return cachedSession;\r\n            }\r\n        } catch (error) {\r\n            console.warn('[auth] No se pudo leer la sesi├│n almacenada:', error);\r\n        }\r\n\r\n        storage.removeItem(STORAGE_KEY);\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\nfunction persistAuth(auth) {\r\n    const normalized = buildSession({\r\n        user: auth?.user ?? auth?.usuario,\r\n        token: auth?.token,\r\n        expiresAt: auth?.expiresAt,\r\n    });\r\n\r\n    if (!normalized) {\r\n        throw new Error('Los datos de sesi├│n son inv├ílidos.');\r\n    }\r\n\r\n    cachedSession = normalized;\r\n    const storage = getStorage();\r\n    if (storage) {\r\n        storage.setItem(STORAGE_KEY, JSON.stringify(normalized));\r\n    }\r\n    updateUserPanel(normalized.user);\r\n}\r\n\r\nfunction clearStoredAuth() {\r\n    cachedSession = null;\r\n    // Limpiar de ambos storages para asegurar logout completo\r\n    if (typeof window !== 'undefined') {\r\n        window.localStorage?.removeItem(STORAGE_KEY);\r\n        window.sessionStorage?.removeItem(STORAGE_KEY);\r\n    }\r\n    updateUserPanel(null);\r\n}\r\n\r\nfunction getElements() {\r\n    if (typeof document === 'undefined') {\r\n        return {};\r\n    }\r\n\r\n    const panel = document.getElementById('auth-user-panel');\r\n    const menu = document.getElementById('user-menu');\r\n    let userNameDisplay = null;\r\n    let helpLink = null;\r\n    let settingsLink = null;\r\n    let themeToggleState = null;\r\n\r\n    if (menu && typeof menu.querySelector === 'function') {\r\n        userNameDisplay = menu.querySelector('[data-user-name]')\r\n            || menu.querySelector('.user-menu__user-name')\r\n            || null;\r\n        helpLink = menu.querySelector('[data-auth-action=\"help\"]');\r\n        settingsLink = menu.querySelector('[data-auth-action=\"settings\"]');\r\n        themeToggleState = menu.querySelector('[data-theme-state]');\r\n    }\r\n\r\n    if (menu && typeof menu.querySelectorAll === 'function') {\r\n        const normalizeText = value => (typeof value === 'string' ? value.trim().toLowerCase() : '');\r\n        const items = Array.from(menu.querySelectorAll('[role=\"menuitem\"]') || []);\r\n\r\n        if (!helpLink) {\r\n            helpLink = items.find(item => normalizeText(item?.textContent) === 'ayuda') || null;\r\n        }\r\n        if (!settingsLink) {\r\n            settingsLink = items.find(item => normalizeText(item?.textContent) === 'configuraci├│n') || null;\r\n        }\r\n        if (!userNameDisplay) {\r\n            userNameDisplay = items.find(item => item?.dataset?.userName) || null;\r\n        }\r\n    }\r\n\r\n    return {\r\n        mainView: document.getElementById('main-view'),\r\n        loginContainer: document.getElementById('login-container'),\r\n        form: document.getElementById('login-form'),\r\n        error: document.getElementById('login-error'),\r\n        mailInput: document.getElementById('login-mail'),\r\n        passwordInput: document.getElementById('login-password'),\r\n        rememberCheckbox: document.getElementById('login-remember'),\r\n        // Password reset elements\r\n        forgotPasswordLink: document.getElementById('forgot-password-link'),\r\n        resetPasswordForm: document.getElementById('reset-password-form'),\r\n        resetEmailInput: document.getElementById('reset-email'),\r\n        resetError: document.getElementById('reset-error'),\r\n        backToLoginLink: document.getElementById('back-to-login-link'),\r\n        // Email sent confirmation\r\n        resetEmailSent: document.getElementById('reset-email-sent'),\r\n        backToLoginFromSent: document.getElementById('back-to-login-from-sent'),\r\n        // New password form elements (after clicking email link)\r\n        newPasswordForm: document.getElementById('new-password-form'),\r\n        newPasswordInput: document.getElementById('new-password'),\r\n        confirmPasswordInput: document.getElementById('confirm-password'),\r\n        newPasswordError: document.getElementById('new-password-error'),\r\n        newPasswordSuccess: document.getElementById('new-password-success'),\r\n        loginCardHeader: document.querySelector('.login-card__header'),\r\n        logoutButton: document.getElementById('logout-button'),\r\n        panel,\r\n        menuButton: document.getElementById('user-menu-toggle'),\r\n        menu,\r\n        helpLink,\r\n        settingsLink,\r\n        userNameDisplay,\r\n        themeToggle: document.getElementById('theme-toggle'),\r\n        themeToggleState,\r\n    };\r\n}\r\n\r\nfunction updateThemeToggleUI(theme) {\r\n    const { themeToggle, themeToggleState } = getElements();\r\n    if (!themeToggle) {\r\n        return;\r\n    }\r\n\r\n    const isDark = theme === THEME_DARK;\r\n    themeToggle.checked = isDark;\r\n    themeToggle.setAttribute?.('aria-checked', isDark ? 'true' : 'false');\r\n\r\n    if (themeToggleState) {\r\n        themeToggleState.textContent = isDark ? 'Activado' : 'Desactivado';\r\n    }\r\n}\r\n\r\nfunction handleThemeToggleChange(event) {\r\n    event?.stopPropagation?.();\r\n    const isChecked = Boolean(event?.target?.checked);\r\n    setTheme(isChecked ? THEME_DARK : THEME_LIGHT);\r\n}\r\n\r\nfunction showLoginModal() {\r\n    const { loginContainer, error, mailInput, rememberCheckbox } = getElements();\r\n    if (loginContainer) {\r\n        loginContainer.classList.remove('hidden');\r\n    }\r\n    if (error) {\r\n        error.textContent = '';\r\n        error.classList.add('hidden');\r\n    }\r\n    // Restaurar preferencia de \"recordarme\"\r\n    if (rememberCheckbox) {\r\n        rememberCheckbox.checked = loadRememberPreference();\r\n    }\r\n    if (mailInput) {\r\n        mailInput.focus();\r\n    }\r\n}\r\n\r\nfunction hideLoginModal() {\r\n    const { loginContainer, form, error } = getElements();\r\n    if (loginContainer) {\r\n        loginContainer.classList.add('hidden');\r\n    }\r\n    if (form) {\r\n        form.reset();\r\n    }\r\n    if (error) {\r\n        error.textContent = '';\r\n        error.classList.add('hidden');\r\n    }\r\n}\r\n\r\nfunction setMainViewVisible(isVisible) {\r\n    const { mainView, loginContainer } = getElements();\r\n    if (mainView) {\r\n        if (isVisible) {\r\n            mainView.classList.remove('hidden');\r\n        } else {\r\n            mainView.classList.add('hidden');\r\n        }\r\n    }\r\n\r\n    if (loginContainer) {\r\n        if (isVisible) {\r\n            loginContainer.classList.add('hidden');\r\n        } else {\r\n            loginContainer.classList.remove('hidden');\r\n        }\r\n    }\r\n}\r\n\r\nfunction setFormLoading(form, isLoading) {\r\n    if (!form) {\r\n        return;\r\n    }\r\n    const inputs = form.querySelectorAll('input');\r\n    inputs.forEach(input => {\r\n        input.disabled = isLoading;\r\n    });\r\n\r\n    const submitButton = form.querySelector('button[type=\"submit\"]');\r\n    if (submitButton) {\r\n        if (isLoading) {\r\n            submitButton.dataset.originalText = submitButton.textContent;\r\n            submitButton.textContent = 'Ingresando...';\r\n            submitButton.disabled = true;\r\n        } else {\r\n            submitButton.textContent = submitButton.dataset.originalText || 'Iniciar sesi├│n';\r\n            submitButton.disabled = false;\r\n            delete submitButton.dataset.originalText;\r\n        }\r\n    }\r\n}\r\n\r\nfunction displayError(message) {\r\n    const { error } = getElements();\r\n    if (!error) {\r\n        return;\r\n    }\r\n    error.textContent = message;\r\n    error.classList.remove('hidden');\r\n}\r\n\r\nfunction isTargetWithinMenu(target, ...elements) {\r\n    if (!target) {\r\n        return false;\r\n    }\r\n\r\n    return elements.some(element => {\r\n        if (!element) {\r\n            return false;\r\n        }\r\n        if (target === element) {\r\n            return true;\r\n        }\r\n        if (typeof element.contains === 'function') {\r\n            try {\r\n                return element.contains(target);\r\n            } catch (error) {\r\n                return false;\r\n            }\r\n        }\r\n        return false;\r\n    });\r\n}\r\n\r\nfunction activateDocumentHandlers() {\r\n    if (documentMenuHandlersActive || typeof document === 'undefined' || typeof document.addEventListener !== 'function') {\r\n        return;\r\n    }\r\n    document.addEventListener('click', handleDocumentClick);\r\n    document.addEventListener('keydown', handleDocumentKeydown);\r\n    documentMenuHandlersActive = true;\r\n}\r\n\r\nfunction deactivateDocumentHandlers() {\r\n    if (!documentMenuHandlersActive || typeof document === 'undefined' || typeof document.removeEventListener !== 'function') {\r\n        return;\r\n    }\r\n    document.removeEventListener('click', handleDocumentClick);\r\n    document.removeEventListener('keydown', handleDocumentKeydown);\r\n    documentMenuHandlersActive = false;\r\n}\r\n\r\nfunction openUserMenu() {\r\n    const { menuButton, menu } = getElements();\r\n    if (!menuButton || menuButton.disabled || !menu) {\r\n        return;\r\n    }\r\n\r\n    if (menu.classList?.remove) {\r\n        menu.classList.remove('hidden');\r\n    }\r\n    if (typeof menu.setAttribute === 'function') {\r\n        menu.setAttribute('aria-hidden', 'false');\r\n    }\r\n    if (typeof menuButton.setAttribute === 'function') {\r\n        menuButton.setAttribute('aria-expanded', 'true');\r\n    }\r\n\r\n    menuIsOpen = true;\r\n    activateDocumentHandlers();\r\n}\r\n\r\nfunction closeUserMenu(options = {}) {\r\n    const { focusButton = false } = options;\r\n    const { menuButton, menu } = getElements();\r\n\r\n    menuIsOpen = false;\r\n\r\n    if (menu?.classList?.add) {\r\n        menu.classList.add('hidden');\r\n    }\r\n    if (typeof menu?.setAttribute === 'function') {\r\n        menu.setAttribute('aria-hidden', 'true');\r\n    }\r\n    if (typeof menuButton?.setAttribute === 'function') {\r\n        menuButton.setAttribute('aria-expanded', 'false');\r\n    }\r\n\r\n    deactivateDocumentHandlers();\r\n\r\n    if (focusButton && typeof menuButton?.focus === 'function') {\r\n        menuButton.focus();\r\n    }\r\n}\r\n\r\nfunction handleDocumentClick(event) {\r\n    if (!menuIsOpen) {\r\n        return;\r\n    }\r\n\r\n    const { panel, menuButton, menu } = getElements();\r\n    if (isTargetWithinMenu(event?.target, panel, menuButton, menu)) {\r\n        return;\r\n    }\r\n\r\n    closeUserMenu();\r\n}\r\n\r\nfunction handleDocumentKeydown(event) {\r\n    if (!menuIsOpen) {\r\n        return;\r\n    }\r\n\r\n    const key = event?.key || event?.code;\r\n    if (key === 'Escape' || key === 'Esc') {\r\n        closeUserMenu({ focusButton: true });\r\n    }\r\n}\r\n\r\nfunction handleMenuButtonClick(event) {\r\n    if (event) {\r\n        event.preventDefault?.();\r\n        event.stopPropagation?.();\r\n    }\r\n\r\n    const { menuButton } = getElements();\r\n    if (!menuButton || menuButton.disabled) {\r\n        return;\r\n    }\r\n\r\n    if (menuIsOpen) {\r\n        closeUserMenu();\r\n    } else {\r\n        openUserMenu();\r\n    }\r\n}\r\n\r\nfunction emitAuthNavigation(action) {\r\n    if (typeof document === 'undefined' || typeof document.dispatchEvent !== 'function') {\r\n        return;\r\n    }\r\n\r\n    const detail = { action };\r\n    let eventConstructor = null;\r\n\r\n    if (typeof window !== 'undefined' && typeof window.CustomEvent === 'function') {\r\n        eventConstructor = window.CustomEvent;\r\n    } else if (typeof CustomEvent === 'function') {\r\n        eventConstructor = CustomEvent;\r\n    }\r\n\r\n    if (eventConstructor) {\r\n        document.dispatchEvent(new eventConstructor('auth:navigate', { detail }));\r\n        return;\r\n    }\r\n\r\n    if (typeof Event === 'function') {\r\n        const fallbackEvent = new Event('auth:navigate');\r\n        fallbackEvent.detail = detail;\r\n        document.dispatchEvent(fallbackEvent);\r\n        return;\r\n    }\r\n\r\n    document.dispatchEvent({ type: 'auth:navigate', detail });\r\n}\r\n\r\nfunction handleMenuNavigation(event, action) {\r\n    if (event) {\r\n        event.preventDefault?.();\r\n        event.stopPropagation?.();\r\n    }\r\n    closeUserMenu();\r\n    emitAuthNavigation(action);\r\n}\r\n\r\nfunction handleHelpClick(event) {\r\n    handleMenuNavigation(event, 'help');\r\n}\r\n\r\nfunction handleSettingsClick(event) {\r\n    handleMenuNavigation(event, 'settings');\r\n}\r\n\r\nfunction updateUserPanel(auth) {\r\n    const {\r\n        panel,\r\n        menuButton,\r\n        menu,\r\n        logoutButton,\r\n        userNameDisplay,\r\n    } = getElements();\r\n\r\n    const displayName = typeof auth?.usuario === 'string'\r\n        ? auth.usuario.trim()\r\n        : typeof auth?.nombre === 'string'\r\n            ? auth.nombre.trim()\r\n            : '';\r\n    const isAuthenticated = Boolean(displayName);\r\n\r\n    if (!panel && !menuButton && !menu && !logoutButton && !userNameDisplay) {\r\n        return;\r\n    }\r\n\r\n    if (isAuthenticated) {\r\n        panel?.classList?.remove?.('hidden');\r\n        if (menuButton) {\r\n            menuButton.disabled = false;\r\n            menuButton.setAttribute?.('aria-expanded', menuIsOpen ? 'true' : 'false');\r\n\r\n            // Mostrar iniciales del usuario en el avatar\r\n            const initials = getInitials(displayName);\r\n            menuButton.innerHTML = `\r\n                <span class=\"sr-only\">Abrir men├║ de usuario</span>\r\n                <span class=\"user-avatar-initials\">${initials}</span>\r\n            `;\r\n        }\r\n        if (menu) {\r\n            if (menuIsOpen) {\r\n                menu.classList?.remove?.('hidden');\r\n                menu.setAttribute?.('aria-hidden', 'false');\r\n            } else {\r\n                menu.classList?.add?.('hidden');\r\n                menu.setAttribute?.('aria-hidden', 'true');\r\n            }\r\n        }\r\n        if (logoutButton) {\r\n            logoutButton.disabled = false;\r\n        }\r\n        if (userNameDisplay) {\r\n            userNameDisplay.textContent = displayName;\r\n            userNameDisplay.classList?.remove?.('hidden');\r\n        }\r\n    } else {\r\n        if (userNameDisplay) {\r\n            userNameDisplay.textContent = '';\r\n            userNameDisplay.classList?.add?.('hidden');\r\n        }\r\n        closeUserMenu();\r\n        panel?.classList?.add?.('hidden');\r\n        if (menuButton) {\r\n            menuButton.disabled = true;\r\n            menuButton.setAttribute?.('aria-expanded', 'false');\r\n            // Restaurar ├¡cono gen├®rico cuando no hay sesi├│n\r\n            menuButton.innerHTML = `\r\n                <span class=\"sr-only\">Abrir men├║ de usuario</span>\r\n                <svg class=\"h-5 w-5\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M15.75 7.5a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z\" />\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M4.5 20.25a8.25 8.25 0 0 1 15 0\" />\r\n                </svg>\r\n            `;\r\n        }\r\n        menu?.setAttribute?.('aria-hidden', 'true');\r\n        if (logoutButton) {\r\n            logoutButton.disabled = true;\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Obtiene las iniciales de un nombre (m├íximo 2 caracteres)\r\n * @param {string} name - Nombre completo\r\n * @returns {string} Iniciales en may├║sculas\r\n */\r\nfunction getInitials(name) {\r\n    if (!name || typeof name !== 'string') return '??';\r\n\r\n    const parts = name.trim().split(/\\s+/).filter(Boolean);\r\n\r\n    if (parts.length === 0) return '??';\r\n    if (parts.length === 1) {\r\n        // Solo un nombre, tomar las primeras 2 letras\r\n        return parts[0].substring(0, 2).toUpperCase();\r\n    }\r\n\r\n    // Tomar primera letra del primer y ├║ltimo nombre\r\n    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();\r\n}\r\n\r\nfunction createPendingAuthPromise() {\r\n    if (pendingAuth) {\r\n        return pendingAuth.promise;\r\n    }\r\n\r\n    let resolveFn;\r\n    let rejectFn;\r\n    const promise = new Promise((resolve, reject) => {\r\n        resolveFn = resolve;\r\n        rejectFn = reject;\r\n    });\r\n\r\n    pendingAuth = {\r\n        promise,\r\n        resolve: resolveFn,\r\n        reject: rejectFn,\r\n    };\r\n\r\n    return promise;\r\n}\r\n\r\nfunction resolvePendingAuth(session) {\r\n    if (pendingAuth && typeof pendingAuth.resolve === 'function') {\r\n        pendingAuth.resolve(session);\r\n    }\r\n    pendingAuth = null;\r\n}\r\n\r\nfunction buildSessionFromSupabase(data) {\r\n    if (!data || !data.session) {\r\n        return null;\r\n    }\r\n\r\n    const supabaseUser = data.session.user || data.user;\r\n    if (!supabaseUser) {\r\n        return null;\r\n    }\r\n\r\n    const profile = extractUserProfileFromSupabase(supabaseUser);\r\n    const expiresAt = typeof data.session.expires_at === 'number'\r\n        ? new Date(data.session.expires_at * 1000)\r\n        : null;\r\n\r\n    return buildSession({\r\n        user: profile,\r\n        token: data.session.access_token,\r\n        expiresAt,\r\n    });\r\n}\r\n\r\nfunction extractUserProfileFromSupabase(user) {\r\n    const metadata = (user && user.user_metadata) || {};\r\n    const appMetadata = (user && user.app_metadata) || {};\r\n\r\n    const nombre = [metadata.nombre, metadata.full_name, metadata.fullName, metadata.name, user?.email]\r\n        .find(value => typeof value === 'string' && value.trim());\r\n\r\n    const cargo = [metadata.cargo, metadata.position]\r\n        .find(value => typeof value === 'string' && value.trim());\r\n\r\n    const rol = [metadata.rol, metadata.role, appMetadata.role, appMetadata.rol]\r\n        .find(value => typeof value === 'string' && value.trim()) || 'tecnico';\r\n\r\n    return {\r\n        nombre: (nombre || 'Usuario').trim(),\r\n        cargo: (cargo || '').trim(),\r\n        rol: rol.trim(),\r\n    };\r\n}\r\n\r\nasync function syncSupabaseSession() {\r\n    const { data, error } = await supabase.auth.getSession();\r\n    if (error) {\r\n        console.warn('[auth] No se pudo verificar la sesi├│n de Supabase', error);\r\n        clearStoredAuth();\r\n        return null;\r\n    }\r\n\r\n    const session = buildSessionFromSupabase(data);\r\n    if (session) {\r\n        persistAuth(session);\r\n        return session;\r\n    }\r\n\r\n    clearStoredAuth();\r\n    return null;\r\n}\r\n\r\nasync function requestAuthentication({ mail, password }) {\r\n    const { data, error } = await supabase.auth.signInWithPassword({\r\n        email: typeof mail === 'string' ? mail.trim() : '',\r\n        password: typeof password === 'string' ? password.trim() : '',\r\n    });\r\n\r\n    if (error) {\r\n        console.warn('[auth] Supabase login failed', error);\r\n        throw new Error('Credenciales inv├ílidas. Verific├í tu mail y contrase├▒a.');\r\n    }\r\n\r\n    const session = buildSessionFromSupabase(data);\r\n    if (!session) {\r\n        throw new Error('No se pudo iniciar sesi├│n.');\r\n    }\r\n\r\n    return session;\r\n}\r\n\r\nasync function handleLoginSubmit(event) {\r\n    event.preventDefault();\r\n\r\n    const { form, mailInput, passwordInput, rememberCheckbox } = getElements();\r\n    if (!form || !(form instanceof HTMLFormElement)) {\r\n        return;\r\n    }\r\n\r\n    const mail = mailInput?.value || '';\r\n    const password = passwordInput?.value || '';\r\n    const remember = rememberCheckbox?.checked ?? true;\r\n\r\n    if (!mail.trim() || !password.trim()) {\r\n        displayError('Completa el mail y la contrase├▒a.');\r\n        return;\r\n    }\r\n\r\n    // Guardar preferencia de \"recordarme\" y configurar storage\r\n    saveRememberPreference(remember);\r\n\r\n    setFormLoading(form, true);\r\n    try {\r\n        const session = await requestAuthentication({ mail, password });\r\n        persistAuth(session);\r\n        setMainViewVisible(true);\r\n        hideLoginModal();\r\n        resolvePendingAuth(session);\r\n    } catch (error) {\r\n        displayError(error?.message || 'No se pudo iniciar sesi├│n.');\r\n    } finally {\r\n        setFormLoading(form, false);\r\n    }\r\n}\r\n\r\nasync function handleLogout(event) {\r\n    if (event) {\r\n        event.preventDefault();\r\n    }\r\n\r\n    try {\r\n        await supabase.auth.signOut();\r\n    } catch (error) {\r\n        console.warn('[auth] Error al cerrar sesi├│n en Supabase', error);\r\n    } finally {\r\n        // Limpiar el estado de recovery mode\r\n        isPasswordRecoveryMode = false;\r\n\r\n        closeUserMenu();\r\n        clearStoredAuth();\r\n        setMainViewVisible(false);\r\n\r\n        // Mostrar el formulario de login normal (no el de nueva contrase├▒a)\r\n        showLoginForm();\r\n        createPendingAuthPromise();\r\n    }\r\n\r\n}\r\n\r\nfunction clearErrorOnInput() {\r\n    const { error } = getElements();\r\n    if (error && !error.classList.contains('hidden')) {\r\n        error.textContent = '';\r\n        error.classList.add('hidden');\r\n    }\r\n}\r\n\r\nfunction clearResetMessages() {\r\n    const { resetError, resetSuccess } = getElements();\r\n    if (resetError) {\r\n        resetError.textContent = '';\r\n        resetError.classList.add('hidden');\r\n    }\r\n    if (resetSuccess) {\r\n        resetSuccess.textContent = '';\r\n        resetSuccess.classList.add('hidden');\r\n    }\r\n}\r\n\r\nfunction showForgotPasswordForm() {\r\n    const { form, resetPasswordForm, resetEmailInput } = getElements();\r\n    if (form) {\r\n        form.classList.add('hidden');\r\n    }\r\n    if (resetPasswordForm) {\r\n        resetPasswordForm.classList.remove('hidden');\r\n    }\r\n    clearResetMessages();\r\n    if (resetEmailInput) {\r\n        resetEmailInput.value = '';\r\n        resetEmailInput.focus();\r\n    }\r\n}\r\n\r\nfunction showLoginForm() {\r\n    const { form, resetPasswordForm, newPasswordForm, resetEmailSent, loginCardHeader, loginContainer, mailInput } = getElements();\r\n\r\n    // Mostrar el container de login\r\n    if (loginContainer) {\r\n        loginContainer.classList.remove('hidden');\r\n    }\r\n\r\n    // Mostrar el header\r\n    if (loginCardHeader) {\r\n        loginCardHeader.classList.remove('hidden');\r\n    }\r\n\r\n    // Ocultar otros formularios y pantallas\r\n    if (resetPasswordForm) {\r\n        resetPasswordForm.classList.add('hidden');\r\n    }\r\n    if (newPasswordForm) {\r\n        newPasswordForm.classList.add('hidden');\r\n    }\r\n    if (resetEmailSent) {\r\n        resetEmailSent.classList.add('hidden');\r\n    }\r\n\r\n    // Mostrar el formulario de login\r\n    if (form) {\r\n        form.classList.remove('hidden');\r\n    }\r\n\r\n    clearResetMessages();\r\n    clearNewPasswordMessages();\r\n\r\n    if (mailInput) {\r\n        mailInput.focus();\r\n    }\r\n}\r\n\r\nfunction displayResetError(message) {\r\n    const { resetError, resetSuccess } = getElements();\r\n    if (resetSuccess) {\r\n        resetSuccess.classList.add('hidden');\r\n    }\r\n    if (resetError) {\r\n        resetError.textContent = message;\r\n        resetError.classList.remove('hidden');\r\n    }\r\n}\r\n\r\nfunction showEmailSentConfirmation() {\r\n    const { resetPasswordForm, resetEmailSent, loginCardHeader } = getElements();\r\n\r\n    // Ocultar el formulario de reset\r\n    if (resetPasswordForm) {\r\n        resetPasswordForm.classList.add('hidden');\r\n    }\r\n\r\n    // Ocultar el header original\r\n    if (loginCardHeader) {\r\n        loginCardHeader.classList.add('hidden');\r\n    }\r\n\r\n    // Mostrar la confirmaci├│n\r\n    if (resetEmailSent) {\r\n        resetEmailSent.classList.remove('hidden');\r\n    }\r\n}\r\n\r\nasync function handlePasswordReset(email) {\r\n    // Construir la URL de redirecci├│n (misma app, sin hash para que Supabase pueda agregar los tokens)\r\n    const redirectUrl = `${window.location.origin}${window.location.pathname}`;\r\n\r\n    const { error } = await supabase.auth.resetPasswordForEmail(email.trim(), {\r\n        redirectTo: redirectUrl,\r\n    });\r\n\r\n    if (error) {\r\n        throw new Error('No se pudo enviar el correo. Verific├í que el email sea correcto.');\r\n    }\r\n}\r\n\r\nasync function handleResetFormSubmit(event) {\r\n    event.preventDefault();\r\n\r\n    const { resetPasswordForm, resetEmailInput } = getElements();\r\n    if (!resetPasswordForm) return;\r\n\r\n    const email = resetEmailInput?.value || '';\r\n    if (!email.trim()) {\r\n        displayResetError('Ingresa tu email.');\r\n        return;\r\n    }\r\n\r\n    setFormLoading(resetPasswordForm, true);\r\n    try {\r\n        await handlePasswordReset(email);\r\n        // Mostrar pantalla de confirmaci├│n\r\n        showEmailSentConfirmation();\r\n        if (resetEmailInput) {\r\n            resetEmailInput.value = '';\r\n        }\r\n    } catch (error) {\r\n        displayResetError(error?.message || 'No se pudo enviar el correo.');\r\n    } finally {\r\n        setFormLoading(resetPasswordForm, false);\r\n    }\r\n}\r\n\r\n// === NUEVA CONTRASE├æA (despu├®s de clic en email) ===\r\n\r\nfunction showNewPasswordForm() {\r\n    const { form, resetPasswordForm, newPasswordForm, loginCardHeader, newPasswordInput } = getElements();\r\n\r\n    // Ocultar otros formularios\r\n    if (form) form.classList.add('hidden');\r\n    if (resetPasswordForm) resetPasswordForm.classList.add('hidden');\r\n    if (loginCardHeader) loginCardHeader.classList.add('hidden');\r\n\r\n    // Mostrar formulario de nueva contrase├▒a\r\n    if (newPasswordForm) {\r\n        newPasswordForm.classList.remove('hidden');\r\n    }\r\n\r\n    clearNewPasswordMessages();\r\n    if (newPasswordInput) {\r\n        newPasswordInput.value = '';\r\n        newPasswordInput.focus();\r\n    }\r\n}\r\n\r\nfunction clearNewPasswordMessages() {\r\n    const { newPasswordError, newPasswordSuccess } = getElements();\r\n    if (newPasswordError) {\r\n        newPasswordError.textContent = '';\r\n        newPasswordError.classList.add('hidden');\r\n    }\r\n    if (newPasswordSuccess) {\r\n        newPasswordSuccess.textContent = '';\r\n        newPasswordSuccess.classList.add('hidden');\r\n    }\r\n}\r\n\r\nfunction displayNewPasswordError(message) {\r\n    const { newPasswordError, newPasswordSuccess } = getElements();\r\n    if (newPasswordSuccess) newPasswordSuccess.classList.add('hidden');\r\n    if (newPasswordError) {\r\n        newPasswordError.textContent = message;\r\n        newPasswordError.classList.remove('hidden');\r\n    }\r\n}\r\n\r\nfunction displayNewPasswordSuccess(message) {\r\n    const { newPasswordError, newPasswordSuccess } = getElements();\r\n    if (newPasswordError) newPasswordError.classList.add('hidden');\r\n    if (newPasswordSuccess) {\r\n        newPasswordSuccess.textContent = message;\r\n        newPasswordSuccess.classList.remove('hidden');\r\n    }\r\n}\r\n\r\nasync function handleNewPasswordSubmit(event) {\r\n    event.preventDefault();\r\n\r\n    const { newPasswordForm, newPasswordInput, confirmPasswordInput } = getElements();\r\n    if (!newPasswordForm) return;\r\n\r\n    const newPassword = newPasswordInput?.value || '';\r\n    const confirmPassword = confirmPasswordInput?.value || '';\r\n\r\n    if (!newPassword.trim()) {\r\n        displayNewPasswordError('Ingresa tu nueva contrase├▒a.');\r\n        return;\r\n    }\r\n\r\n    if (newPassword.length < 6) {\r\n        displayNewPasswordError('La contrase├▒a debe tener al menos 6 caracteres.');\r\n        return;\r\n    }\r\n\r\n    if (newPassword !== confirmPassword) {\r\n        displayNewPasswordError('Las contrase├▒as no coinciden.');\r\n        return;\r\n    }\r\n\r\n    setFormLoading(newPasswordForm, true);\r\n    try {\r\n        const { error } = await supabase.auth.updateUser({ password: newPassword });\r\n\r\n        if (error) {\r\n            throw new Error(error.message || 'No se pudo actualizar la contrase├▒a.');\r\n        }\r\n\r\n        displayNewPasswordSuccess('┬íContrase├▒a actualizada correctamente! Ingresando...');\r\n\r\n        // Limpiar el hash de la URL\r\n        if (window.history?.replaceState) {\r\n            window.history.replaceState(null, '', window.location.pathname);\r\n        }\r\n\r\n        // Esperar un momento y luego sincronizar sesi├│n para entrar al dashboard\r\n        setTimeout(async () => {\r\n            const session = await syncSupabaseSession();\r\n            if (session) {\r\n                setMainViewVisible(true);\r\n                hideLoginModal();\r\n                resolvePendingAuth(session);\r\n            }\r\n        }, 1500);\r\n\r\n    } catch (error) {\r\n        displayNewPasswordError(error?.message || 'No se pudo actualizar la contrase├▒a.');\r\n    } finally {\r\n        setFormLoading(newPasswordForm, false);\r\n    }\r\n}\r\n\r\n// Escuchar eventos de autenticaci├│n de Supabase (PASSWORD_RECOVERY)\r\nlet authStateListenerSetup = false;\r\nlet isPasswordRecoveryMode = false;\r\n\r\nfunction setupAuthStateListener() {\r\n    if (authStateListenerSetup) return;\r\n    authStateListenerSetup = true;\r\n\r\n    supabase.auth.onAuthStateChange((event, session) => {\r\n        console.log('[auth] Auth state change:', event, session ? 'with session' : 'no session');\r\n\r\n        if (event === 'PASSWORD_RECOVERY') {\r\n            console.log('[auth] PASSWORD_RECOVERY event detected');\r\n            isPasswordRecoveryMode = true;\r\n            // El usuario hizo clic en el link del email de recuperaci├│n\r\n            showNewPasswordForm();\r\n        }\r\n    });\r\n}\r\n\r\n// Detectar si la URL tiene fragmento de recovery (type=recovery en el hash o query params)\r\nfunction checkUrlForPasswordRecovery() {\r\n    if (typeof window === 'undefined') return false;\r\n\r\n    const hash = window.location.hash;\r\n    const search = window.location.search;\r\n\r\n    // Supabase puede a├▒adir tokens en el hash o en query params\r\n    const isRecoveryHash = hash.includes('type=recovery') || hash.includes('type%3Drecovery');\r\n    const isRecoveryQuery = search.includes('type=recovery');\r\n    const hasErrorDescription = hash.includes('error_description') || search.includes('error_description');\r\n\r\n    // Tambi├®n detectar si hay access_token (indica que Supabase proces├│ el recovery)\r\n    const hasAccessToken = hash.includes('access_token') || search.includes('access_token');\r\n\r\n    const isRecovery = isRecoveryHash || isRecoveryQuery || (hasAccessToken && (isRecoveryHash || isRecoveryQuery));\r\n\r\n    if (isRecovery || hasAccessToken) {\r\n        console.log('[auth] Password recovery detected - hash:', isRecoveryHash, 'query:', isRecoveryQuery, 'hasToken:', hasAccessToken);\r\n        isPasswordRecoveryMode = true;\r\n        return true;\r\n    }\r\n\r\n    // Verificar si hay error en el hash (token expirado, etc.)\r\n    if (hasErrorDescription) {\r\n        console.log('[auth] Error in recovery URL detected');\r\n        return true; // Mostrar el form de recovery para que puedan pedir otro link\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\n// Extraer tokens del hash o query params de la URL para establecer la sesi├│n\r\nasync function processRecoveryTokenFromUrl() {\r\n    if (typeof window === 'undefined') return null;\r\n\r\n    const fullHash = window.location.hash;\r\n    const fullSearch = window.location.search;\r\n    console.log('[auth] Full hash:', fullHash);\r\n    console.log('[auth] Full search:', fullSearch);\r\n\r\n    // Combinar hash y query params para buscar tokens\r\n    let searchString = '';\r\n\r\n    // Primero intentar del hash (sin el #)\r\n    if (fullHash && fullHash.length > 1) {\r\n        searchString = fullHash.substring(1);\r\n        if (searchString.startsWith('/')) {\r\n            searchString = searchString.substring(1);\r\n        }\r\n    }\r\n\r\n    // Si no hay nada en el hash, intentar de los query params\r\n    if (!searchString && fullSearch && fullSearch.length > 1) {\r\n        searchString = fullSearch.substring(1);\r\n    }\r\n\r\n    if (!searchString) {\r\n        console.log('[auth] No hash or search params to parse');\r\n        return null;\r\n    }\r\n\r\n    // Intentar parsear como query string\r\n    const params = new URLSearchParams(searchString);\r\n    let accessToken = params.get('access_token');\r\n    let refreshToken = params.get('refresh_token');\r\n    let type = params.get('type');\r\n\r\n    // Si no funcion├│, intentar parseo manual\r\n    if (!accessToken && searchString.includes('access_token=')) {\r\n        const tokenMatch = searchString.match(/access_token=([^&]+)/);\r\n        if (tokenMatch) {\r\n            accessToken = decodeURIComponent(tokenMatch[1]);\r\n        }\r\n    }\r\n\r\n    if (!refreshToken && searchString.includes('refresh_token=')) {\r\n        const refreshMatch = searchString.match(/refresh_token=([^&]+)/);\r\n        if (refreshMatch) {\r\n            refreshToken = decodeURIComponent(refreshMatch[1]);\r\n        }\r\n    }\r\n\r\n    if (!type && searchString.includes('type=')) {\r\n        const typeMatch = searchString.match(/type=([^&]+)/);\r\n        if (typeMatch) {\r\n            type = decodeURIComponent(typeMatch[1]);\r\n        }\r\n    }\r\n\r\n    console.log('[auth] Parsed - type:', type, 'has access_token:', !!accessToken, 'token length:', accessToken?.length);\r\n\r\n    // Verificar si hay un error en la URL (token expirado, etc.)\r\n    const errorDescription = params.get('error_description');\r\n    if (errorDescription) {\r\n        console.error('[auth] Recovery error:', errorDescription);\r\n        return { error: decodeURIComponent(errorDescription) };\r\n    }\r\n\r\n    if (accessToken) {\r\n        try {\r\n            // Establecer la sesi├│n usando los tokens del URL\r\n            const { data, error } = await supabase.auth.setSession({\r\n                access_token: accessToken,\r\n                refresh_token: refreshToken || '',\r\n            });\r\n\r\n            if (error) {\r\n                console.error('[auth] Error setting session from recovery token:', error);\r\n                return null;\r\n            }\r\n\r\n            console.log('[auth] Session established from recovery token');\r\n            return data.session;\r\n        } catch (err) {\r\n            console.error('[auth] Exception setting recovery session:', err);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\nfunction bindEventListeners() {\r\n    if (listenersBound) {\r\n        return;\r\n    }\r\n\r\n    const { form, logoutButton, menuButton, helpLink, settingsLink, themeToggle, mailInput, passwordInput } = getElements();\r\n    if (form) {\r\n        form.addEventListener('submit', handleLoginSubmit);\r\n    }\r\n    // Limpiar error cuando el usuario empieza a escribir\r\n    if (mailInput) {\r\n        mailInput.addEventListener('input', clearErrorOnInput);\r\n    }\r\n    if (passwordInput) {\r\n        passwordInput.addEventListener('input', clearErrorOnInput);\r\n    }\r\n    // Password reset event listeners\r\n    const { forgotPasswordLink, resetPasswordForm, resetEmailInput, backToLoginLink } = getElements();\r\n    if (forgotPasswordLink) {\r\n        forgotPasswordLink.addEventListener('click', showForgotPasswordForm);\r\n    }\r\n    if (resetPasswordForm) {\r\n        resetPasswordForm.addEventListener('submit', handleResetFormSubmit);\r\n    }\r\n    if (resetEmailInput) {\r\n        resetEmailInput.addEventListener('input', clearResetMessages);\r\n    }\r\n    if (backToLoginLink) {\r\n        backToLoginLink.addEventListener('click', showLoginForm);\r\n    }\r\n    // Email sent confirmation - back button\r\n    const { backToLoginFromSent } = getElements();\r\n    if (backToLoginFromSent) {\r\n        backToLoginFromSent.addEventListener('click', showLoginForm);\r\n    }\r\n    // New password form event listeners\r\n    const { newPasswordForm, newPasswordInput, confirmPasswordInput } = getElements();\r\n    if (newPasswordForm) {\r\n        newPasswordForm.addEventListener('submit', handleNewPasswordSubmit);\r\n    }\r\n    if (newPasswordInput) {\r\n        newPasswordInput.addEventListener('input', clearNewPasswordMessages);\r\n    }\r\n    if (confirmPasswordInput) {\r\n        confirmPasswordInput.addEventListener('input', clearNewPasswordMessages);\r\n    }\r\n    if (logoutButton) {\r\n        logoutButton.addEventListener('click', handleLogout);\r\n    }\r\n    if (menuButton) {\r\n        menuButton.addEventListener('click', handleMenuButtonClick);\r\n    }\r\n    if (helpLink) {\r\n        helpLink.addEventListener('click', handleHelpClick);\r\n    }\r\n    if (settingsLink) {\r\n        settingsLink.addEventListener('click', handleSettingsClick);\r\n    }\r\n    if (themeToggle) {\r\n        themeToggle.addEventListener('change', handleThemeToggleChange);\r\n        if (!unsubscribeThemeChange) {\r\n            unsubscribeThemeChange = onThemeChange(updateThemeToggleUI);\r\n        } else {\r\n            updateThemeToggleUI(getCurrentTheme());\r\n        }\r\n    }\r\n\r\n    listenersBound = true;\r\n}\r\n\r\nexport function getCurrentUser() {\r\n    const session = loadStoredAuth();\r\n    return session?.user || null;\r\n}\r\n\r\nexport function getCurrentUserName() {\r\n    const session = loadStoredAuth();\r\n    return session?.user?.nombre || '';\r\n}\r\n\r\nexport function getCurrentUserRole() {\r\n    const session = loadStoredAuth();\r\n    return session?.user?.rol || '';\r\n}\r\n\r\n/**\r\n * Verifica si el usuario actual tiene rol de Administrador\r\n * @returns {boolean} true si el rol es 'admin' o 'Administrador'\r\n */\r\nexport function isAdmin() {\r\n    const role = getCurrentUserRole();\r\n    if (!role) return false;\r\n    const normalizedRole = role.toLowerCase().trim();\r\n    return normalizedRole === 'admin' || normalizedRole === 'administrador';\r\n}\r\n\r\n/**\r\n * Verifica si el usuario actual tiene permisos elevados (delete/update datos)\r\n * Incluye: admin, ventas, coordinador, jefe_servicio\r\n * @returns {boolean}\r\n */\r\nexport function hasElevatedPermissions() {\r\n    const role = getCurrentUserRole();\r\n    if (!role) return false;\r\n    const normalizedRole = role.toLowerCase().trim();\r\n    return ['admin', 'administrador', 'ventas', 'coordinador', 'jefe_servicio'].includes(normalizedRole);\r\n}\r\n\r\n/**\r\n * Verifica si el usuario puede acceder al panel de administraci├│n\r\n * Incluye: admin, ventas, coordinador, jefe_servicio\r\n * @returns {boolean}\r\n */\r\nexport function canAccessAdminPanel() {\r\n    const role = getCurrentUserRole();\r\n    if (!role) return false;\r\n    const normalizedRole = role.toLowerCase().trim();\r\n    return ['admin', 'administrador', 'ventas', 'coordinador', 'jefe_servicio'].includes(normalizedRole);\r\n}\r\n\r\n/**\r\n * Verifica si el usuario puede coordinar (asignar/desasignar) en la agenda\r\n * Solo: admin, coordinador\r\n * @returns {boolean}\r\n */\r\nexport function canCoordinateAgenda() {\r\n    const role = getCurrentUserRole();\r\n    if (!role) return false;\r\n    const normalizedRole = role.toLowerCase().trim();\r\n    return ['admin', 'administrador', 'coordinador'].includes(normalizedRole);\r\n}\r\n\r\n/**\r\n * Verifica si el usuario puede crear Work Orders\r\n * Incluye: admin, ventas, coordinador, jefe_servicio\r\n * @returns {boolean}\r\n */\r\nexport function canCreateWorkOrders() {\r\n    const role = getCurrentUserRole();\r\n    if (!role) return false;\r\n    const normalizedRole = role.toLowerCase().trim();\r\n    return ['admin', 'administrador', 'ventas', 'coordinador', 'jefe_servicio'].includes(normalizedRole);\r\n}\r\n\r\n/**\r\n * Verifica si el usuario tiene acceso de solo lectura a la agenda\r\n * (puede ver pero no puede coordinar ni crear WOs)\r\n * Aplica a: tecnico, jefe_servicio\r\n * @returns {boolean}\r\n */\r\nexport function isAgendaViewOnly() {\r\n    const role = getCurrentUserRole();\r\n    if (!role) return true; // Sin rol = solo lectura\r\n    const normalizedRole = role.toLowerCase().trim();\r\n    return ['tecnico', 'jefe_servicio'].includes(normalizedRole);\r\n}\r\n\r\n// ÔÜá´©Å SOLO PARA DESARROLLO - Token mock cuando el login est├í desactivado\r\n// IMPORTANTE: Para que funcione correctamente con el backend, debes:\r\n// 1. Establecer DEV_MODE = false (RECOMENDADO)\r\n// 2. O modificar el backend para aceptar peticiones sin token\r\nconst DEV_MODE = false; // Activar solo si se necesita modo desarrollo sin autenticaci├│n real\r\nconst DEV_USER = {\r\n    nombre: 'Modo desarrollo',\r\n    cargo: 'UI Preview',\r\n    rol: 'Administrador',\r\n};\r\nconst DEV_TOKEN = 'dev-token-' + Date.now();\r\n\r\nexport function isDevMode() {\r\n    return DEV_MODE;\r\n}\r\n\r\nexport function getCurrentToken() {\r\n    // Si estamos en modo desarrollo, retornar token mock\r\n    if (DEV_MODE) {\r\n        return DEV_TOKEN;\r\n    }\r\n\r\n    const session = loadStoredAuth();\r\n    const token = typeof session?.token === 'string' ? session.token.trim() : '';\r\n    return token || null;\r\n}\r\n\r\nexport async function initializeAuth() {\r\n    // Cargar preferencia de \"recordarme\" antes de cualquier operaci├│n de storage\r\n    useLocalStorage = loadRememberPreference();\r\n\r\n    // IMPORTANTE: Configurar el listener ANTES de cualquier operaci├│n de sesi├│n\r\n    // para capturar el evento PASSWORD_RECOVERY que Supabase dispara autom├íticamente\r\n    setupAuthStateListener();\r\n\r\n    // Verificar si la URL indica que es un flujo de password recovery\r\n    const isRecoveryUrl = checkUrlForPasswordRecovery();\r\n\r\n    bindEventListeners();\r\n\r\n    // En modo desarrollo, omitir el inicio de sesi├│n y mostrar la app inmediatamente\r\n    if (DEV_MODE) {\r\n        const devSession = buildSession({\r\n            user: DEV_USER,\r\n            token: DEV_TOKEN,\r\n            expiresAt: null,\r\n        });\r\n        if (devSession) {\r\n            persistAuth(devSession);\r\n            setMainViewVisible(true);\r\n            hideLoginModal();\r\n            return devSession;\r\n        }\r\n    }\r\n\r\n    // Si es un recovery URL, procesar el token y mostrar el formulario\r\n    if (isRecoveryUrl) {\r\n        console.log('[auth] Recovery URL detected, processing token...');\r\n\r\n        // Mostrar el login container\r\n        setMainViewVisible(false);\r\n        const { loginContainer } = getElements();\r\n        if (loginContainer) {\r\n            loginContainer.classList.remove('hidden');\r\n        }\r\n\r\n        // Procesar el token del hash para establecer la sesi├│n\r\n        const recoveryResult = await processRecoveryTokenFromUrl();\r\n\r\n        // Si hay un error (token expirado, etc.), mostrar el mensaje\r\n        if (recoveryResult && recoveryResult.error) {\r\n            console.log('[auth] Recovery token error:', recoveryResult.error);\r\n            showForgotPasswordForm();\r\n            displayResetError('El enlace ha expirado. Solicit├í uno nuevo.');\r\n            return createPendingAuthPromise();\r\n        }\r\n\r\n        if (recoveryResult) {\r\n            console.log('[auth] Recovery session established, showing password form');\r\n            isPasswordRecoveryMode = true;\r\n        } else {\r\n            console.log('[auth] Could not establish recovery session, but showing form anyway');\r\n        }\r\n\r\n        // Limpiar la URL del hash/query params\r\n        if (window.history?.replaceState) {\r\n            window.history.replaceState(null, '', window.location.pathname);\r\n        }\r\n\r\n        // Mostrar el formulario de nueva contrase├▒a\r\n        showNewPasswordForm();\r\n        return createPendingAuthPromise();\r\n    }\r\n\r\n    const activeSession = await syncSupabaseSession();\r\n    if (activeSession) {\r\n        updateUserPanel(activeSession.user);\r\n        setMainViewVisible(true);\r\n        hideLoginModal();\r\n        return activeSession;\r\n    }\r\n\r\n    clearStoredAuth();\r\n    setMainViewVisible(false);\r\n\r\n    updateUserPanel(null);\r\n\r\n    showLoginModal();\r\n    return createPendingAuthPromise();\r\n}\r\n\r\nexport function logout() {\r\n    return handleLogout();\r\n}\r\n\r\nexport async function handleSessionExpiration() {\r\n    await handleLogout();\r\n    displayError('Tu sesi├│n ha expirado. Por favor, ingres├í de nuevo.');\r\n}\r\n\r\nexport async function requireAuthentication() {\r\n    if (DEV_MODE) {\r\n        return loadStoredAuth() || buildSession({ user: DEV_USER, token: DEV_TOKEN, expiresAt: null });\r\n    }\r\n\r\n    const session = await syncSupabaseSession();\r\n    if (session) {\r\n        return session;\r\n    }\r\n\r\n    setMainViewVisible(false);\r\n    showLoginModal();\r\n    return createPendingAuthPromise();\r\n}\r\n\r\nexport const __testables__ = {\r\n    loadStoredAuth,\r\n    persistAuth,\r\n    clearStoredAuth,\r\n    requestAuthentication,\r\n    updateUserPanel,\r\n    bindEventListeners,\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\mantenimiento-ablandador\\ablandador.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'canSaveForm' is defined but never used.","line":12,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":45},{"ruleId":"no-unused-vars","severity":2,"message":"'showBlockingErrors' is defined but never used.","line":12,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":65},{"ruleId":"no-unused-vars","severity":2,"message":"'CLIENT_OPTION_ATTRIBUTE' is assigned a value but never used.","line":99,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":99,"endColumn":30},{"ruleId":"no-unused-vars","severity":2,"message":"'clienteSelectChangeHandler' is assigned a value but never used.","line":139,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":139,"endColumn":31},{"ruleId":"no-unused-vars","severity":2,"message":"'lastSavedMaintenanceId' is assigned a value but never used.","line":143,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":143,"endColumn":27},{"ruleId":"no-unused-vars","severity":2,"message":"'configureClientDetailFieldInteractions' is defined but never used.","line":422,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":422,"endColumn":48},{"ruleId":"no-unused-vars","severity":2,"message":"'updateClientDetailsFromSelect' is defined but never used.","line":440,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":440,"endColumn":39},{"ruleId":"no-unused-vars","severity":2,"message":"'saveButton' is defined but never used.","line":2935,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":2935,"endColumn":46}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n    guardarMantenimientoAblandador as guardarMantenimientoAblandadorApi,\r\n    obtenerClientes as obtenerClientesApi,\r\n    obtenerEquiposAblandadorPorCliente,\r\n    obtenerEquipoAblandadorPorSerie,\r\n    crearEquipoAblandador,\r\n    actualizarEquipoAblandador,\r\n    detectarCambiosEquipo,\r\n} from '../../api.js';\r\nimport { SignatureModal } from '../signature/signaturePad.js';\r\nimport { getCurrentUserName } from '../login/auth.js';\r\nimport { initSoftenerValidation, canSaveForm, showBlockingErrors } from './softenerValidationUI.js';\r\n\r\nconst SOFTENER_VIEW_ID = 'tab-ablandador';\r\nconst FORM_ID = 'softener-maintenance-form';\r\nconst SAVE_BUTTON_ID = 'softener-save-button';\r\nconst RESET_BUTTON_ID = 'softener-reset-button';\r\nconst AUTOFILL_BUTTON_ID = 'softener-autofill-button';\r\nconst REMITO_BUTTON_ID = 'softener-generar-remito-btn';\r\nconst REPORT_NUMBER_DISPLAY_ID = 'softener-report-number-display';\r\nconst AUTONOMIA_RECOMENDADA_ID = 'softener-autonomia-recomendada';\r\nconst AUTONOMIA_SETEO_ACTUAL_ID = 'softener-autonomia-seteo-actual';\r\nconst AUTONOMIA_AJUSTADA_ID = 'softener-autonomia-ajustada';\r\nconst VOLUMEN_RESINA_ID = 'softener-volumen-resina';\r\nconst FACTOR_PROTECCION_ID = 'softener-factor-proteccion';\r\nconst DUREZA_AGUA_CRUDA_ID = 'softener-dureza-agua-cruda';\r\nconst AUTONOMIA_RESTANTE_ID = 'softener-autonomia-restante';\r\nconst AUTONOMIA_RESTANTE_INFO_BTN_ID = 'softener-autonomia-restante-info-btn';\r\nconst AUTONOMIA_RESTANTE_INFO_POPUP_ID = 'softener-autonomia-restante-info-popup';\r\n// IDs para la nueva secci├│n: Configuraci├│n del cabezal\r\nconst CABEZAL_HORA_CABEZAL_FOUND_ID = 'softener-cabezal-hora-cabezal-found';\r\nconst CABEZAL_HORA_CABEZAL_LEFT_ID = 'softener-cabezal-hora-cabezal-left';\r\nconst CABEZAL_HORA_REGENERACION_FOUND_ID = 'softener-cabezal-hora-regeneracion-found';\r\nconst CABEZAL_HORA_REGENERACION_LEFT_ID = 'softener-cabezal-hora-regeneracion-left';\r\n\r\nconst CABEZAL_P1_FOUND_ID = 'softener-cabezal-p1-found';\r\nconst CABEZAL_P1_LEFT_ID = 'softener-cabezal-p1-left';\r\nconst CABEZAL_P2_FOUND_ID = 'softener-cabezal-p2-found';\r\nconst CABEZAL_P2_LEFT_ID = 'softener-cabezal-p2-left';\r\nconst CABEZAL_P3_FOUND_ID = 'softener-cabezal-p3-found';\r\nconst CABEZAL_P3_LEFT_ID = 'softener-cabezal-p3-left';\r\nconst CABEZAL_P4_FOUND_ID = 'softener-cabezal-p4-found';\r\nconst CABEZAL_P4_LEFT_ID = 'softener-cabezal-p4-left';\r\n\r\n// Tipo de regeneraci├│n (secci├│n B): Por Volumen | Por Tiempo\r\nconst SECCION_B_TIPO_REGENERACION_ID = 'softener-equipo-regeneracion-tipo';\r\nconst CABEZAL_FRECUENCIA_DIAS_FOUND_ID = 'softener-cabezal-frecuencia-dias-found';\r\nconst CABEZAL_FRECUENCIA_DIAS_LEFT_ID = 'softener-cabezal-frecuencia-dias-left';\r\nconst CABEZAL_FRECUENCIA_CONTAINER_ID = 'softener-cabezal-frecuencia-container';\r\n// IDs para el popup de informaci├│n del prefiltro\r\nconst PREFILTER_SELECT_ID = 'softener-equipo-prefiltro';\r\nconst PREFILTER_INFO_BTN_ID = 'softener-prefilter-info-btn';\r\nconst PREFILTER_INFO_POPUP_ID = 'softener-prefilter-info-popup';\r\nconst PREFILTRACION_SECTION_ID = 'softener-prefiltracion-section';\r\nconst CAMBIO_FILTRO_CONTAINER_ID = 'softener-cambio-filtro-container';\r\nconst CHECK_CAMBIO_FILTRO_ID = 'softener-check-cambio-filtro';\r\nconst DETALLE_CAMBIO_FILTRO_ID = 'softener-detalle-cambio-filtro';\r\nconst FILTRO_TIPO_INSTALADO_ID = 'softener-filtro-tipo-instalado';\r\nconst FILTRO_LOTE_SERIE_ID = 'softener-filtro-lote-serie';\r\n// IDs para tren de prefiltrado\r\nconst PREFILTRO_TREN_CHECKBOX_ID = 'softener-prefiltro-tren';\r\nconst PREFILTRO_TREN_CONTAINER_ID = 'softener-prefiltro-tren-container';\r\nconst PREFILTRO_SIMPLE_CONTAINER_ID = 'softener-prefiltro-simple-container';\r\nconst PREFILTRO_ETAPAS_INPUT_ID = 'softener-prefiltro-etapas';\r\nconst PREFILTRO_ETAPAS_CONTAINER_ID = 'softener-prefiltro-etapas-container';\r\n\r\n// IDs para cambio de filtro en checklist (Secci├│n D) - modo simple y tren\r\nconst CAMBIO_FILTRO_TREN_CONTAINER_ID = 'softener-cambio-filtro-tren-container';\r\nconst CAMBIO_FILTRO_TREN_ETAPAS_ID = 'softener-cambio-filtro-tren-etapas';\r\nconst DETALLE_CAMBIO_FILTRO_TREN_ID = 'softener-detalle-cambio-filtro-tren';\r\nconst LOTES_TREN_CONTAINER_ID = 'softener-lotes-tren-container';\r\n\r\nconst PROTECTION_INFO_BTN_ID = 'softener-protection-info-btn';\r\nconst PROTECTION_INFO_POPUP_ID = 'softener-protection-info-popup';\r\nconst PROTECCION_ENTRADA_ID = 'softener-equipo-proteccion-entrada';\r\n// Man├│metros\r\nconst MANOMETRO_INFO_BTN_ID = 'softener-manometro-info-btn';\r\nconst MANOMETRO_INFO_POPUP_ID = 'softener-manometro-info-popup';\r\nconst MANOMETRO_SELECT_ID = 'softener-equipo-manometros';\r\n\r\n// IDs de campos Secci├│n B (Informaci├│n del Equipo)\r\nconst EQUIPO_TIPO_ID = 'softener-equipo-tipo';\r\nconst EQUIPO_MODELO_ID = 'softener-equipo-modelo';\r\nconst EQUIPO_NUMERO_SERIE_ID = 'softener-equipo-numero-serie';\r\nconst EQUIPO_UBICACION_ID = 'softener-equipo-ubicacion';\r\nconst EQUIPO_NOTAS_ID = 'softener-equipo-notas';\r\n\r\n// Estado de equipo precargado\r\nlet equipoActualCargado = null; // Equipo cargado desde BD\r\nlet equiposDelCliente = []; // Lista de equipos del cliente\r\nlet seccionBEditada = false; // Flag para detectar ediciones manuales\r\nlet seccionBDesbloqueada = false; // Flag para modo edici├│n\r\n\r\nconst CLIENT_SELECT_ID = 'softener-cliente-nombre'; // Hidden input now\r\nconst CLIENT_SEARCH_ID = 'softener-cliente-search';\r\nconst CLIENT_DROPDOWN_ID = 'softener-cliente-dropdown';\r\nconst CLIENT_CLEAR_BTN_ID = 'softener-cliente-clear-btn';\r\nconst CLIENT_CONTAINER_ID = 'softener-cliente-autocomplete-container';\r\nconst CLIENT_OPTION_ATTRIBUTE = 'data-softener-client-option';\r\nconst CLIENT_KEY_ATTRIBUTE = 'data-softener-client-key';\r\nconst CLIENT_DETAIL_FIELD_IDS = Object.freeze([\r\n    'softener-cliente-direccion',\r\n    'softener-cliente-telefono',\r\n    'softener-cliente-email',\r\n    'softener-cliente-cuit',\r\n]);\r\nconst CLIENT_DETAIL_EMPTY_CLASS = 'client-detail-empty';\r\nconst CLIENT_DETAIL_LOCKED_CLASS = 'client-detail-locked';\r\n\r\nconst CLIENT_NAME_FIELDS = Object.freeze([\r\n    'nombre',\r\n    'Nombre',\r\n    'cliente',\r\n    'Cliente',\r\n    'razon_social',\r\n    'RazonSocial',\r\n]);\r\n\r\nconst CLIENT_ID_FIELDS = Object.freeze([\r\n    'id',\r\n    'ID',\r\n    'id_cliente',\r\n    'IdCliente',\r\n    'codigo',\r\n    'Codigo',\r\n    'cuit',\r\n    'CUIT',\r\n]);\r\n\r\nconst CLIENT_FIELD_ALIASES = Object.freeze({\r\n    direccion: ['direccion', 'Direccion', 'domicilio', 'Domicilio'],\r\n    telefono: ['telefono', 'Telefono', 'tel', 'Tel'],\r\n    email: ['email', 'Email', 'mail', 'Mail', 'correo', 'Correo'],\r\n    cuit: ['cuit', 'CUIT'],\r\n});\r\n\r\nconst clienteDataMap = new Map();\r\nconst clientDetailInputsWithListener = new WeakSet();\r\nlet clienteSelectChangeHandler = null;\r\nlet clientesLoaded = false;\r\nlet clientesLoadingPromise = null;\r\nlet clientAutocompleteInitialized = false;\r\nlet lastSavedMaintenanceId = null;\r\n\r\n// Autocomplete state\r\nlet clientesListCache = [];\r\nlet selectedClientIndex = -1;\r\n\r\n// Signature modal state\r\nlet signatureModal = null;\r\nlet pendingFormData = null;\r\n\r\nfunction getElement(id) {\r\n    return typeof document !== 'undefined' ? document.getElementById(id) : null;\r\n}\r\n\r\n// ===== Form Locked Overlay Functions =====\r\nfunction showFormLockedOverlay() {\r\n    const form = getElement(FORM_ID);\r\n    if (!form) return;\r\n\r\n    const formCards = form.querySelectorAll('.form-card');\r\n    formCards.forEach(card => {\r\n        // Verificar si ya tiene overlay\r\n        if (card.querySelector('.form-card-overlay')) return;\r\n\r\n        card.style.position = 'relative';\r\n        const overlay = document.createElement('div');\r\n        overlay.className = 'form-card-overlay';\r\n        card.appendChild(overlay);\r\n    });\r\n\r\n    // Mostrar mensaje flotante\r\n    let message = getElement('softener-form-locked-message');\r\n    if (!message) {\r\n        message = document.createElement('div');\r\n        message.id = 'softener-form-locked-message';\r\n        message.className = 'form-locked-floating-message';\r\n        message.innerHTML = `\r\n            <svg class=\"w-6 h-6 text-green-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"/>\r\n            </svg>\r\n            <span>Reporte guardado - Continu├í con el remito o cre├í uno nuevo</span>\r\n        `;\r\n        form.insertBefore(message, form.firstChild);\r\n    }\r\n    message.classList.remove('hidden');\r\n}\r\n\r\nfunction hideFormLockedOverlay() {\r\n    const form = getElement(FORM_ID);\r\n    if (!form) return;\r\n\r\n    const overlays = form.querySelectorAll('.form-card-overlay');\r\n    overlays.forEach(overlay => overlay.remove());\r\n\r\n    const message = getElement('softener-form-locked-message');\r\n    if (message) {\r\n        message.classList.add('hidden');\r\n    }\r\n}\r\n// ===== End Form Locked Overlay =====\r\n\r\nfunction schedulePostReset(callback) {\r\n    if (typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function') {\r\n        window.requestAnimationFrame(callback);\r\n        return;\r\n    }\r\n    setTimeout(callback, 0);\r\n}\r\n\r\nfunction parseNumber(value) {\r\n    if (value === null || value === undefined) {\r\n        return null;\r\n    }\r\n    if (typeof value === 'number' && Number.isFinite(value)) {\r\n        return value;\r\n    }\r\n    const normalized = String(value).replace(',', '.').trim();\r\n    if (!normalized) {\r\n        return null;\r\n    }\r\n    const parsed = Number(normalized);\r\n    return Number.isFinite(parsed) ? parsed : null;\r\n}\r\n\r\nfunction getInputValue(id) {\r\n    const element = getElement(id);\r\n    if (!element) {\r\n        return '';\r\n    }\r\n    if (element instanceof HTMLInputElement || element instanceof HTMLTextAreaElement || element instanceof HTMLSelectElement) {\r\n        return element.value.trim();\r\n    }\r\n    return '';\r\n}\r\n\r\nfunction getNumberValue(id) {\r\n    return parseNumber(getInputValue(id));\r\n}\r\n\r\nfunction getCheckboxValue(id) {\r\n    const element = getElement(id);\r\n    if (element instanceof HTMLInputElement) {\r\n        return Boolean(element.checked);\r\n    }\r\n    return false;\r\n}\r\n\r\nfunction setNumericFieldValue(id, value) {\r\n    const element = getElement(id);\r\n    if (!(element instanceof HTMLInputElement)) {\r\n        return;\r\n    }\r\n    if (value === null || value === undefined || Number.isNaN(value)) {\r\n        element.value = '';\r\n        return;\r\n    }\r\n    const rounded = Math.round((value + Number.EPSILON) * 100) / 100;\r\n    element.value = Number.isFinite(rounded) ? rounded.toString() : '';\r\n}\r\n\r\nfunction setInputValue(id, value) {\r\n    const element = getElement(id);\r\n    if (!element) {\r\n        return;\r\n    }\r\n    if (element instanceof HTMLInputElement || element instanceof HTMLTextAreaElement) {\r\n        element.value = value !== null && value !== undefined ? String(value) : '';\r\n        element.dispatchEvent(new Event('input', { bubbles: true }));\r\n    }\r\n}\r\n\r\nfunction setSelectValue(id, value) {\r\n    const element = getElement(id);\r\n    if (!(element instanceof HTMLSelectElement)) {\r\n        return;\r\n    }\r\n    element.value = value !== null && value !== undefined ? String(value) : '';\r\n    element.dispatchEvent(new Event('change', { bubbles: true }));\r\n}\r\n\r\nfunction setCheckboxValue(id, checked) {\r\n    const element = getElement(id);\r\n    if (!(element instanceof HTMLInputElement) || element.type !== 'checkbox') {\r\n        return;\r\n    }\r\n    element.checked = Boolean(checked);\r\n    element.dispatchEvent(new Event('change', { bubbles: true }));\r\n}\r\n\r\nfunction generateSoftenerReportNumber() {\r\n    const now = new Date();\r\n    const padZero = (num) => String(num).padStart(2, '0');\r\n    const year = now.getFullYear().toString().slice(-2);\r\n    const month = padZero(now.getMonth() + 1);\r\n    const day = padZero(now.getDate());\r\n    const hours = padZero(now.getHours());\r\n    const minutes = padZero(now.getMinutes());\r\n    const seconds = padZero(now.getSeconds());\r\n    return `ABL-${year}${month}${day}-${hours}${minutes}${seconds}`;\r\n}\r\n\r\nfunction setReportNumber(reportNumber) {\r\n    const display = getElement(REPORT_NUMBER_DISPLAY_ID);\r\n    if (display) {\r\n        display.textContent = reportNumber || 'ABL-PENDIENTE';\r\n    }\r\n}\r\n\r\nfunction getClientSelection() {\r\n    // Ahora usamos autocomplete: hidden input para ID, search input para nombre\r\n    const hiddenInput = getElement(CLIENT_SELECT_ID);\r\n    const searchInput = getElement(CLIENT_SEARCH_ID);\r\n\r\n    const id = (hiddenInput?.value || '').trim();\r\n    const name = (searchInput?.value || '').trim();\r\n\r\n    return {\r\n        id: id || name, // Si no hay ID, usar el nombre como fallback\r\n        name: name || id,\r\n    };\r\n}\r\n\r\nfunction normalizeString(value) {\r\n    if (value === null || value === undefined) {\r\n        return '';\r\n    }\r\n    return String(value).trim();\r\n}\r\n\r\nfunction getFirstAvailableField(source, fieldNames) {\r\n    if (!source || typeof source !== 'object') {\r\n        return '';\r\n    }\r\n\r\n    for (const field of fieldNames) {\r\n        if (Object.prototype.hasOwnProperty.call(source, field)) {\r\n            const normalized = normalizeString(source[field]);\r\n            if (normalized) {\r\n                return normalized;\r\n            }\r\n        }\r\n    }\r\n\r\n    return '';\r\n}\r\n\r\nfunction extractClientName(cliente) {\r\n    return getFirstAvailableField(cliente, CLIENT_NAME_FIELDS);\r\n}\r\n\r\nfunction extractClientId(cliente) {\r\n    return getFirstAvailableField(cliente, CLIENT_ID_FIELDS);\r\n}\r\n\r\nfunction createClientDetails(cliente) {\r\n    return {\r\n        direccion: getFirstAvailableField(cliente, CLIENT_FIELD_ALIASES.direccion),\r\n        telefono: getFirstAvailableField(cliente, CLIENT_FIELD_ALIASES.telefono),\r\n        email: getFirstAvailableField(cliente, CLIENT_FIELD_ALIASES.email),\r\n        cuit: getFirstAvailableField(cliente, CLIENT_FIELD_ALIASES.cuit),\r\n    };\r\n}\r\n\r\nfunction refreshClientDetailFieldState(element, { lockWhenFilled = false } = {}) {\r\n    if (!(element instanceof HTMLInputElement)) {\r\n        return;\r\n    }\r\n\r\n    const hasValue = normalizeString(element.value) !== '';\r\n\r\n    if (lockWhenFilled && hasValue) {\r\n        element.readOnly = true;\r\n        element.disabled = false;\r\n    } else if (!hasValue) {\r\n        element.readOnly = false;\r\n        element.disabled = false;\r\n    }\r\n\r\n    if (hasValue) {\r\n        element.classList.remove(CLIENT_DETAIL_EMPTY_CLASS);\r\n        if (lockWhenFilled) {\r\n            element.classList.add(CLIENT_DETAIL_LOCKED_CLASS);\r\n        }\r\n    } else {\r\n        element.classList.add(CLIENT_DETAIL_EMPTY_CLASS);\r\n        element.classList.remove(CLIENT_DETAIL_LOCKED_CLASS);\r\n    }\r\n}\r\n\r\nfunction setClientDetailValue(fieldId, value, options = {}) {\r\n    const element = getElement(fieldId);\r\n    if (!element) {\r\n        return;\r\n    }\r\n\r\n    const normalizedValue = normalizeString(value);\r\n\r\n    if ('value' in element) {\r\n        element.value = normalizedValue;\r\n    }\r\n\r\n    if (element instanceof HTMLInputElement) {\r\n        refreshClientDetailFieldState(element, { lockWhenFilled: Boolean(options.lockWhenFilled) });\r\n    }\r\n}\r\n\r\nfunction applyClientDetails(details = {}) {\r\n    setClientDetailValue('softener-cliente-direccion', details.direccion, { lockWhenFilled: true });\r\n    setClientDetailValue('softener-cliente-telefono', details.telefono, { lockWhenFilled: true });\r\n    setClientDetailValue('softener-cliente-email', details.email, { lockWhenFilled: true });\r\n    setClientDetailValue('softener-cliente-cuit', details.cuit, { lockWhenFilled: true });\r\n}\r\n\r\nfunction clearClientDetails() {\r\n    CLIENT_DETAIL_FIELD_IDS.forEach(fieldId => {\r\n        setClientDetailValue(fieldId, '', { lockWhenFilled: false });\r\n    });\r\n}\r\n\r\nfunction configureClientDetailFieldInteractions() {\r\n    CLIENT_DETAIL_FIELD_IDS.forEach(fieldId => {\r\n        const element = getElement(fieldId);\r\n        if (!(element instanceof HTMLInputElement)) {\r\n            return;\r\n        }\r\n\r\n        refreshClientDetailFieldState(element);\r\n\r\n        if (!clientDetailInputsWithListener.has(element)) {\r\n            element.addEventListener('input', () => {\r\n                refreshClientDetailFieldState(element);\r\n            });\r\n            clientDetailInputsWithListener.add(element);\r\n        }\r\n    });\r\n}\r\n\r\nfunction updateClientDetailsFromSelect(selectElement) {\r\n    if (!(selectElement instanceof HTMLSelectElement)) {\r\n        clearClientDetails();\r\n        return;\r\n    }\r\n\r\n    let selectedDetails = null;\r\n\r\n    const selectedOption = selectElement.selectedOptions && selectElement.selectedOptions[0];\r\n    if (selectedOption) {\r\n        const optionKey = selectedOption.getAttribute(CLIENT_KEY_ATTRIBUTE);\r\n        if (optionKey) {\r\n            selectedDetails = clienteDataMap.get(optionKey) || null;\r\n        }\r\n    }\r\n\r\n    if (!selectedDetails && typeof selectElement.selectedIndex === 'number' && selectElement.selectedIndex >= 0) {\r\n        const optionByIndex = selectElement.options[selectElement.selectedIndex];\r\n        if (optionByIndex) {\r\n            const keyByIndex = optionByIndex.getAttribute(CLIENT_KEY_ATTRIBUTE);\r\n            if (keyByIndex) {\r\n                selectedDetails = clienteDataMap.get(keyByIndex) || null;\r\n            }\r\n        }\r\n    }\r\n\r\n    if (!selectedDetails) {\r\n        selectedDetails = clienteDataMap.get(selectElement.value) || null;\r\n    }\r\n\r\n    if (selectedDetails) {\r\n        applyClientDetails(selectedDetails);\r\n    } else {\r\n        clearClientDetails();\r\n    }\r\n}\r\n\r\nfunction resetClientSelection() {\r\n    // Limpiar el input de b├║squeda del autocomplete\r\n    const searchInput = getElement(CLIENT_SEARCH_ID);\r\n    if (searchInput) {\r\n        searchInput.value = '';\r\n        searchInput.classList.remove('has-selection');\r\n    }\r\n\r\n    // Limpiar el input hidden con el ID del cliente\r\n    const hiddenInput = getElement(CLIENT_SELECT_ID);\r\n    if (hiddenInput) {\r\n        hiddenInput.value = '';\r\n    }\r\n\r\n    // Ocultar bot├│n de limpiar\r\n    const clearBtn = getElement(CLIENT_CLEAR_BTN_ID);\r\n    if (clearBtn) {\r\n        clearBtn.classList.add('hidden');\r\n    }\r\n\r\n    // Ocultar el dropdown si est├í visible\r\n    hideDropdown();\r\n\r\n    clearClientDetails();\r\n}\r\n\r\n// ===== Autocomplete Functions =====\r\nfunction normalizeForSearch(text) {\r\n    if (!text) return '';\r\n    return text\r\n        .toLowerCase()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, '') // Remove accents\r\n        .trim();\r\n}\r\n\r\nfunction highlightMatch(text, query) {\r\n    if (!query || !text) return text;\r\n    const normalizedText = normalizeForSearch(text);\r\n    const normalizedQuery = normalizeForSearch(query);\r\n    const index = normalizedText.indexOf(normalizedQuery);\r\n    if (index === -1) return text;\r\n\r\n    const before = text.slice(0, index);\r\n    const match = text.slice(index, index + query.length);\r\n    const after = text.slice(index + query.length);\r\n    return `${before}<mark>${match}</mark>${after}`;\r\n}\r\n\r\nfunction filterClientes(query) {\r\n    if (!query || query.length < 1) {\r\n        return clientesListCache.slice(0, 10);\r\n    }\r\n\r\n    const normalizedQuery = normalizeForSearch(query);\r\n\r\n    return clientesListCache\r\n        .filter(cliente => {\r\n            const name = normalizeForSearch(extractClientName(cliente));\r\n            const direccion = normalizeForSearch(cliente.direccion || '');\r\n            const cuit = normalizeForSearch(cliente.cuit || '');\r\n\r\n            return name.includes(normalizedQuery) ||\r\n                direccion.includes(normalizedQuery) ||\r\n                cuit.includes(normalizedQuery);\r\n        })\r\n        .slice(0, 15);\r\n}\r\n\r\nfunction renderDropdown(clientes, query) {\r\n    const dropdown = getElement(CLIENT_DROPDOWN_ID);\r\n    if (!dropdown) return;\r\n\r\n    if (clientes.length === 0) {\r\n        dropdown.innerHTML = `\r\n            <div class=\"cliente-dropdown-empty\">\r\n                No se encontraron clientes con \"${query}\"\r\n            </div>\r\n        `;\r\n        dropdown.classList.remove('hidden');\r\n        return;\r\n    }\r\n\r\n    dropdown.innerHTML = clientes.map((cliente, index) => {\r\n        const name = extractClientName(cliente);\r\n        const direccion = cliente.direccion || '';\r\n        const highlightedName = highlightMatch(name, query);\r\n        const highlightedDireccion = highlightMatch(direccion, query);\r\n        const clientKey = `softener-cliente-${clientesListCache.indexOf(cliente)}`;\r\n\r\n        return `\r\n            <div class=\"cliente-dropdown-item ${index === selectedClientIndex ? 'selected' : ''}\" \r\n                 data-cliente-key=\"${clientKey}\"\r\n                 data-cliente-index=\"${index}\"\r\n                 role=\"option\"\r\n                 tabindex=\"-1\">\r\n                <div class=\"cliente-dropdown-item-name\">${highlightedName}</div>\r\n                ${direccion ? `<div class=\"cliente-dropdown-item-detail\">${highlightedDireccion}</div>` : ''}\r\n            </div>\r\n        `;\r\n    }).join('');\r\n\r\n    dropdown.classList.remove('hidden');\r\n}\r\n\r\nfunction hideDropdown() {\r\n    const dropdown = getElement(CLIENT_DROPDOWN_ID);\r\n    if (dropdown) {\r\n        dropdown.classList.add('hidden');\r\n    }\r\n    selectedClientIndex = -1;\r\n}\r\n\r\nasync function selectClient(clientKey) {\r\n    const index = parseInt(clientKey.replace('softener-cliente-', ''), 10);\r\n    const cliente = clientesListCache[index];\r\n    if (!cliente) return;\r\n\r\n    const searchInput = getElement(CLIENT_SEARCH_ID);\r\n    const hiddenInput = getElement(CLIENT_SELECT_ID);\r\n    const clearBtn = getElement(CLIENT_CLEAR_BTN_ID);\r\n\r\n    const clientId = extractClientId(cliente) || extractClientName(cliente);\r\n    const clientName = extractClientName(cliente);\r\n\r\n    // Obtener el UUID real del cliente para buscar equipos\r\n    const clienteUUID = cliente.id || null;\r\n\r\n    if (hiddenInput) {\r\n        hiddenInput.value = clientId;\r\n        // Guardar tambi├®n el UUID para uso posterior\r\n        hiddenInput.dataset.clienteUuid = clienteUUID || '';\r\n    }\r\n\r\n    if (searchInput) {\r\n        searchInput.value = clientName;\r\n        searchInput.classList.add('has-selection');\r\n    }\r\n\r\n    if (clearBtn) {\r\n        clearBtn.classList.remove('hidden');\r\n    }\r\n\r\n    // Store client details and apply them\r\n    clienteDataMap.set(clientKey, createClientDetails(cliente));\r\n    applyClientDetails(createClientDetails(cliente));\r\n\r\n    hideDropdown();\r\n\r\n    // Buscar y cargar equipos del cliente\r\n    if (clienteUUID) {\r\n        await cargarEquiposDelCliente(clienteUUID);\r\n    }\r\n}\r\n\r\nfunction clearClientSelection() {\r\n    const searchInput = getElement(CLIENT_SEARCH_ID);\r\n    const hiddenInput = getElement(CLIENT_SELECT_ID);\r\n    const clearBtn = getElement(CLIENT_CLEAR_BTN_ID);\r\n\r\n    if (searchInput) {\r\n        searchInput.value = '';\r\n        searchInput.classList.remove('has-selection');\r\n        searchInput.focus();\r\n    }\r\n\r\n    if (hiddenInput) {\r\n        hiddenInput.value = '';\r\n    }\r\n\r\n    if (clearBtn) {\r\n        clearBtn.classList.add('hidden');\r\n    }\r\n\r\n    clearClientDetails();\r\n    hideDropdown();\r\n\r\n    // Limpiar tambi├®n los datos del equipo\r\n    limpiarSeccionB();\r\n}\r\n\r\n// ============================================================================\r\n// GESTI├ôN DE EQUIPOS ABLANDADOR - Secci├│n B\r\n// ============================================================================\r\n\r\n/**\r\n * Carga los equipos asociados a un cliente y muestra selector si hay m├ís de uno\r\n */\r\nasync function cargarEquiposDelCliente(clienteUUID) {\r\n    try {\r\n        equiposDelCliente = await obtenerEquiposAblandadorPorCliente(clienteUUID);\r\n\r\n        if (equiposDelCliente.length === 0) {\r\n            // No hay equipos registrados - formulario vac├¡o para nuevo equipo\r\n            limpiarSeccionB();\r\n            mostrarMensajeNuevoEquipo();\r\n        } else if (equiposDelCliente.length === 1) {\r\n            // Un solo equipo - autocompletar directamente\r\n            cargarDatosEquipoEnFormulario(equiposDelCliente[0]);\r\n        } else {\r\n            // M├║ltiples equipos - mostrar selector\r\n            mostrarSelectorEquipos(equiposDelCliente);\r\n        }\r\n    } catch (error) {\r\n        console.error('Error cargando equipos del cliente:', error);\r\n        limpiarSeccionB();\r\n    }\r\n}\r\n\r\n/**\r\n * Muestra un mensaje indicando que es un equipo nuevo\r\n */\r\nfunction mostrarMensajeNuevoEquipo() {\r\n    const seccionB = getElement('softener-section-b');\r\n    if (!seccionB) return;\r\n\r\n    // Remover banner existente si hay\r\n    const bannerExistente = seccionB.querySelector('.equipo-status-banner');\r\n    if (bannerExistente) bannerExistente.remove();\r\n\r\n    const banner = document.createElement('div');\r\n    banner.className = 'equipo-status-banner mt-4 p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg flex items-center gap-3';\r\n    banner.innerHTML = `\r\n        <svg class=\"w-5 h-5 text-blue-500 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"/>\r\n        </svg>\r\n        <div class=\"text-sm text-blue-700 dark:text-blue-300\">\r\n            <strong>Nuevo equipo:</strong> Este cliente no tiene equipos registrados. Los datos que cargues en esta secci├│n se guardar├ín para futuros mantenimientos.\r\n        </div>\r\n    `;\r\n\r\n    const titulo = seccionB.querySelector('h2');\r\n    if (titulo) {\r\n        titulo.parentNode.insertBefore(banner, titulo.nextSibling.nextSibling);\r\n    }\r\n\r\n    // Habilitar edici├│n de campos\r\n    habilitarEdicionSeccionB(true);\r\n    seccionBDesbloqueada = true;\r\n}\r\n\r\n/**\r\n * Muestra un selector cuando el cliente tiene m├║ltiples equipos\r\n */\r\nfunction mostrarSelectorEquipos(equipos) {\r\n    const seccionB = getElement('softener-section-b');\r\n    if (!seccionB) return;\r\n\r\n    // Remover selector/banner existente\r\n    const existente = seccionB.querySelector('.equipo-selector-container, .equipo-status-banner');\r\n    if (existente) existente.remove();\r\n\r\n    const container = document.createElement('div');\r\n    container.className = 'equipo-selector-container mt-4 p-4 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-lg';\r\n\r\n    const opciones = equipos.map((eq, idx) => {\r\n        const serie = eq.numero_serie || 'Sin n├║mero de serie';\r\n        const tipo = eq.tipo_ablandador || 'Custom';\r\n        const ubicacion = eq.ubicacion || 'Sin ubicaci├│n';\r\n        return `<option value=\"${idx}\">${serie} - ${tipo} (${ubicacion})</option>`;\r\n    }).join('');\r\n\r\n    container.innerHTML = `\r\n        <div class=\"flex items-center gap-3 mb-3\">\r\n            <svg class=\"w-5 h-5 text-amber-500 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10\"/>\r\n            </svg>\r\n            <span class=\"text-sm font-medium text-amber-700 dark:text-amber-300\">Este cliente tiene ${equipos.length} equipos registrados. Seleccion├í uno:</span>\r\n        </div>\r\n        <div class=\"flex gap-3 items-center\">\r\n            <select id=\"softener-equipo-selector\" class=\"flex-1 rounded-md border border-amber-300 dark:border-amber-600 bg-white dark:bg-gray-800 p-2 text-gray-900 dark:text-gray-100\">\r\n                <option value=\"\">-- Seleccionar equipo --</option>\r\n                ${opciones}\r\n                <option value=\"nuevo\">Ô×ò Registrar nuevo equipo</option>\r\n            </select>\r\n        </div>\r\n    `;\r\n\r\n    const titulo = seccionB.querySelector('h2');\r\n    if (titulo) {\r\n        titulo.parentNode.insertBefore(container, titulo.nextSibling.nextSibling);\r\n    }\r\n\r\n    // Event listener para el selector\r\n    const selector = container.querySelector('#softener-equipo-selector');\r\n    selector.addEventListener('change', (e) => {\r\n        const valor = e.target.value;\r\n        if (valor === '') {\r\n            limpiarSeccionB(false); // No remover el selector\r\n        } else if (valor === 'nuevo') {\r\n            limpiarSeccionB(false);\r\n            habilitarEdicionSeccionB(true);\r\n            seccionBDesbloqueada = true;\r\n            equipoActualCargado = null;\r\n        } else {\r\n            const idx = parseInt(valor, 10);\r\n            cargarDatosEquipoEnFormulario(equipos[idx]);\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Carga los datos de un equipo en los campos de la secci├│n B\r\n */\r\nfunction cargarDatosEquipoEnFormulario(equipo) {\r\n    if (!equipo) return;\r\n\r\n    equipoActualCargado = equipo;\r\n    seccionBEditada = false;\r\n\r\n    // Mapeo de campos BD -> formulario\r\n    setSelectValue(EQUIPO_TIPO_ID, equipo.tipo_ablandador);\r\n    setInputValue(EQUIPO_MODELO_ID, equipo.modelo || '');\r\n    setInputValue(VOLUMEN_RESINA_ID, equipo.volumen_resina || 25);\r\n    setInputValue(EQUIPO_NUMERO_SERIE_ID, equipo.numero_serie || '');\r\n    setSelectValue(EQUIPO_UBICACION_ID, equipo.ubicacion || '');\r\n    setSelectValue(SECCION_B_TIPO_REGENERACION_ID, equipo.tipo_regeneracion || 'Por Volumen');\r\n\r\n    // Cargar prefiltro - verificar si es tren\r\n    let trenData = null;\r\n    try {\r\n        if (equipo.prefiltro && equipo.prefiltro.startsWith('{')) {\r\n            trenData = JSON.parse(equipo.prefiltro);\r\n        }\r\n    } catch (e) {\r\n        // No es JSON, es prefiltro simple\r\n    }\r\n\r\n    if (trenData && trenData.es_tren) {\r\n        cargarTrenPrefiltrado(trenData);\r\n    } else {\r\n        cargarTrenPrefiltrado(null); // Reset a modo simple\r\n        setSelectValue(PREFILTER_SELECT_ID, equipo.prefiltro || 'No Aplica');\r\n    }\r\n\r\n    setSelectValue(PROTECCION_ENTRADA_ID, equipo.proteccion_entrada || 'No Aplica');\r\n    setSelectValue(MANOMETRO_SELECT_ID, equipo.manometros || 'No cuenta con man├│metros');\r\n    setInputValue(EQUIPO_NOTAS_ID, equipo.notas_equipo || '');\r\n\r\n    // Actualizar c├ílculo de autonom├¡a\r\n    updateAutonomia();\r\n\r\n    // Mostrar banner de equipo cargado\r\n    mostrarBannerEquipoCargado(equipo);\r\n\r\n    // Bloquear campos y agregar listeners de cambio\r\n    habilitarEdicionSeccionB(false);\r\n    attachSeccionBChangeListeners();\r\n}\r\n\r\n/**\r\n * Muestra banner indicando que los datos fueron precargados\r\n */\r\nfunction mostrarBannerEquipoCargado(equipo) {\r\n    const seccionB = getElement('softener-section-b');\r\n    if (!seccionB) return;\r\n\r\n    // Remover banner/selector existente\r\n    const existente = seccionB.querySelector('.equipo-status-banner, .equipo-selector-container');\r\n    if (existente) existente.remove();\r\n\r\n    const banner = document.createElement('div');\r\n    banner.className = 'equipo-status-banner mt-4 p-3 bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-700 rounded-lg';\r\n    banner.innerHTML = `\r\n        <div class=\"flex items-center justify-between\">\r\n            <div class=\"flex items-center gap-3\">\r\n                <svg class=\"w-5 h-5 text-emerald-500 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"/>\r\n                </svg>\r\n                <div class=\"text-sm text-emerald-700 dark:text-emerald-300\">\r\n                    <strong>Equipo cargado:</strong> ${equipo.numero_serie || 'Sin serie'} - ${equipo.tipo_ablandador || 'Custom'}\r\n                    <span class=\"text-xs text-emerald-600 dark:text-emerald-400 ml-2\">(├Ültima actualizaci├│n: ${formatearFecha(equipo.updated_at)})</span>\r\n                </div>\r\n            </div>\r\n            <button type=\"button\" id=\"softener-editar-equipo-btn\" class=\"px-3 py-1 text-xs font-medium text-emerald-700 dark:text-emerald-300 bg-emerald-100 dark:bg-emerald-800 hover:bg-emerald-200 dark:hover:bg-emerald-700 rounded-md transition-colors\">\r\n                Ô£Å´©Å Editar configuraci├│n\r\n            </button>\r\n        </div>\r\n    `;\r\n\r\n    const titulo = seccionB.querySelector('h2');\r\n    if (titulo) {\r\n        titulo.parentNode.insertBefore(banner, titulo.nextSibling.nextSibling);\r\n    }\r\n\r\n    // Event listener para bot├│n de editar\r\n    const btnEditar = banner.querySelector('#softener-editar-equipo-btn');\r\n    btnEditar.addEventListener('click', () => {\r\n        habilitarEdicionSeccionB(true);\r\n        seccionBDesbloqueada = true;\r\n        btnEditar.textContent = '­ƒöô Modo edici├│n activo';\r\n        btnEditar.disabled = true;\r\n        btnEditar.classList.add('opacity-50', 'cursor-not-allowed');\r\n    });\r\n}\r\n\r\n/**\r\n * Formatea una fecha ISO a formato legible\r\n */\r\nfunction formatearFecha(fechaISO) {\r\n    if (!fechaISO) return 'N/A';\r\n    try {\r\n        const fecha = new Date(fechaISO);\r\n        return fecha.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });\r\n    } catch {\r\n        return 'N/A';\r\n    }\r\n}\r\n\r\n/**\r\n * Habilita o deshabilita la edici├│n de campos de la secci├│n B\r\n */\r\nfunction habilitarEdicionSeccionB(habilitar) {\r\n    const campos = [\r\n        EQUIPO_TIPO_ID,\r\n        EQUIPO_MODELO_ID,\r\n        VOLUMEN_RESINA_ID,\r\n        EQUIPO_NUMERO_SERIE_ID,\r\n        EQUIPO_UBICACION_ID,\r\n        SECCION_B_TIPO_REGENERACION_ID,\r\n        PREFILTER_SELECT_ID,\r\n        PROTECCION_ENTRADA_ID,\r\n        MANOMETRO_SELECT_ID,\r\n        EQUIPO_NOTAS_ID,\r\n    ];\r\n\r\n    campos.forEach(id => {\r\n        const el = getElement(id);\r\n        if (el) {\r\n            if (habilitar) {\r\n                el.removeAttribute('readonly');\r\n                el.disabled = false;\r\n                el.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed', 'opacity-75');\r\n            } else {\r\n                // Para selects, usamos disabled; para inputs, readonly\r\n                if (el.tagName === 'SELECT') {\r\n                    el.disabled = true;\r\n                } else {\r\n                    el.readOnly = true;\r\n                }\r\n                el.classList.add('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed', 'opacity-75');\r\n            }\r\n        }\r\n    });\r\n\r\n    // El n├║mero de serie siempre debe ser editable si es nuevo equipo\r\n    if (habilitar && !equipoActualCargado) {\r\n        const serieInput = getElement(EQUIPO_NUMERO_SERIE_ID);\r\n        if (serieInput) {\r\n            serieInput.classList.remove('opacity-75');\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Limpia los campos de la secci├│n B\r\n */\r\nfunction limpiarSeccionB(removerBanner = true) {\r\n    equipoActualCargado = null;\r\n    equiposDelCliente = [];\r\n    seccionBEditada = false;\r\n    seccionBDesbloqueada = false;\r\n\r\n    // Limpiar campos\r\n    setSelectValue(EQUIPO_TIPO_ID, 'Custom');\r\n    setInputValue(EQUIPO_MODELO_ID, '');\r\n    setInputValue(VOLUMEN_RESINA_ID, 25);\r\n    setInputValue(EQUIPO_NUMERO_SERIE_ID, '');\r\n    setSelectValue(EQUIPO_UBICACION_ID, '');\r\n    setSelectValue(SECCION_B_TIPO_REGENERACION_ID, 'Por Volumen');\r\n    setSelectValue(PREFILTER_SELECT_ID, 'No Aplica');\r\n    setSelectValue(PROTECCION_ENTRADA_ID, 'No Aplica');\r\n    setSelectValue(MANOMETRO_SELECT_ID, 'No cuenta con man├│metros');\r\n    setInputValue(EQUIPO_NOTAS_ID, '');\r\n\r\n    // Reset tren de prefiltrado\r\n    cargarTrenPrefiltrado(null);\r\n\r\n    // Remover banner/selector si corresponde\r\n    if (removerBanner) {\r\n        const seccionB = getElement('softener-section-b');\r\n        if (seccionB) {\r\n            const banner = seccionB.querySelector('.equipo-status-banner, .equipo-selector-container');\r\n            if (banner) banner.remove();\r\n        }\r\n    }\r\n\r\n    // Habilitar edici├│n\r\n    habilitarEdicionSeccionB(true);\r\n}\r\n\r\n/**\r\n * Adjunta listeners para detectar cambios en la secci├│n B\r\n */\r\nfunction attachSeccionBChangeListeners() {\r\n    const campos = [\r\n        EQUIPO_TIPO_ID,\r\n        EQUIPO_MODELO_ID,\r\n        VOLUMEN_RESINA_ID,\r\n        EQUIPO_UBICACION_ID,\r\n        SECCION_B_TIPO_REGENERACION_ID,\r\n        PREFILTER_SELECT_ID,\r\n        PROTECCION_ENTRADA_ID,\r\n        MANOMETRO_SELECT_ID,\r\n        EQUIPO_NOTAS_ID,\r\n    ];\r\n\r\n    campos.forEach(id => {\r\n        const el = getElement(id);\r\n        if (el && !el.dataset.seccionBListener) {\r\n            el.addEventListener('change', () => {\r\n                if (seccionBDesbloqueada) {\r\n                    seccionBEditada = true;\r\n                }\r\n            });\r\n            el.addEventListener('input', () => {\r\n                if (seccionBDesbloqueada) {\r\n                    seccionBEditada = true;\r\n                }\r\n            });\r\n            el.dataset.seccionBListener = 'true';\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Obtiene los datos actuales de la secci├│n B del formulario\r\n */\r\nfunction obtenerDatosSeccionB() {\r\n    // Verificar si es tren de prefiltrado\r\n    const trenData = obtenerValoresTrenPrefiltrado();\r\n\r\n    return {\r\n        tipo_ablandador: getSelectValue(EQUIPO_TIPO_ID) || 'Custom',\r\n        modelo: getInputValue(EQUIPO_MODELO_ID) || '',\r\n        volumen_resina: parseFloat(getInputValue(VOLUMEN_RESINA_ID)) || 25,\r\n        numero_serie: getInputValue(EQUIPO_NUMERO_SERIE_ID)?.trim() || '',\r\n        ubicacion: getSelectValue(EQUIPO_UBICACION_ID) || '',\r\n        tipo_regeneracion: getSelectValue(SECCION_B_TIPO_REGENERACION_ID) || 'Por Volumen',\r\n        prefiltro: trenData ? JSON.stringify(trenData) : (getSelectValue(PREFILTER_SELECT_ID) || 'No Aplica'),\r\n        prefiltro_tren: trenData, // Datos estructurados del tren (null si no es tren)\r\n        proteccion_entrada: getSelectValue(PROTECCION_ENTRADA_ID) || 'No Aplica',\r\n        manometros: getSelectValue(MANOMETRO_SELECT_ID) || 'No cuenta con man├│metros',\r\n        notas_equipo: getInputValue(EQUIPO_NOTAS_ID) || '',\r\n    };\r\n}\r\n\r\n/**\r\n * Verifica y maneja cambios en la configuraci├│n del equipo al guardar\r\n * @returns {Promise<{continuar: boolean, equipoId: string|null}>}\r\n */\r\nasync function verificarYGuardarEquipo() {\r\n    const hiddenInput = getElement(CLIENT_SELECT_ID);\r\n    const clienteUUID = hiddenInput?.dataset?.clienteUuid;\r\n\r\n    if (!clienteUUID) {\r\n        // No hay cliente seleccionado con UUID v├ílido\r\n        return { continuar: true, equipoId: null };\r\n    }\r\n\r\n    const datosFormulario = obtenerDatosSeccionB();\r\n    const numeroSerie = datosFormulario.numero_serie;\r\n\r\n    if (!numeroSerie) {\r\n        alert('ÔÜá´©Å El n├║mero de serie es obligatorio para registrar el equipo.');\r\n        return { continuar: false, equipoId: null };\r\n    }\r\n\r\n    const tecnicoActual = getCurrentUserName() || 'Sistema';\r\n\r\n    // Caso 1: Es un equipo nuevo (no hab├¡a equipo cargado)\r\n    if (!equipoActualCargado) {\r\n        try {\r\n            // Verificar si ya existe un equipo con ese n├║mero de serie para este cliente\r\n            const equipoExistente = await obtenerEquipoAblandadorPorSerie(clienteUUID, numeroSerie);\r\n\r\n            if (equipoExistente) {\r\n                alert(`ÔÜá´©Å Ya existe un equipo con el n├║mero de serie \"${numeroSerie}\" para este cliente.\\n\\nSi es el mismo equipo, seleccionalo de la lista.`);\r\n                return { continuar: false, equipoId: null };\r\n            }\r\n\r\n            // Crear nuevo equipo\r\n            const nuevoEquipo = await crearEquipoAblandador({\r\n                cliente_id: clienteUUID,\r\n                ...datosFormulario,\r\n                created_by: tecnicoActual,\r\n            });\r\n\r\n            console.log('Ô£à Nuevo equipo creado:', nuevoEquipo.id);\r\n            return { continuar: true, equipoId: nuevoEquipo.id };\r\n        } catch (error) {\r\n            console.error('Error creando equipo:', error);\r\n            alert(`ÔØî Error al registrar el equipo: ${error.message}`);\r\n            return { continuar: false, equipoId: null };\r\n        }\r\n    }\r\n\r\n    // Caso 2: Hay equipo cargado - verificar si hubo cambios\r\n    if (seccionBEditada && seccionBDesbloqueada) {\r\n        const { hayCambios, cambios } = detectarCambiosEquipo(equipoActualCargado, datosFormulario);\r\n\r\n        if (hayCambios) {\r\n            // Mostrar modal de confirmaci├│n\r\n            const detallesCambios = Object.entries(cambios)\r\n                .map(([campo, { anterior, nuevo }]) => `ÔÇó ${formatearNombreCampo(campo)}: \"${anterior || '(vac├¡o)'}\" ÔåÆ \"${nuevo || '(vac├¡o)'}\"`)\r\n                .join('\\n');\r\n\r\n            const mensaje = `Se detectaron cambios en la configuraci├│n del equipo:\\n\\n${detallesCambios}\\n\\n┬┐Desea actualizar la ficha del equipo para futuros mantenimientos?`;\r\n\r\n            const actualizarFicha = confirm(mensaje);\r\n\r\n            if (actualizarFicha) {\r\n                try {\r\n                    await actualizarEquipoAblandador(equipoActualCargado.id, {\r\n                        ...datosFormulario,\r\n                        updated_by: tecnicoActual,\r\n                    });\r\n                    console.log('Ô£à Equipo actualizado:', equipoActualCargado.id);\r\n                } catch (error) {\r\n                    console.error('Error actualizando equipo:', error);\r\n                    alert(`ÔÜá´©Å No se pudo actualizar la ficha del equipo: ${error.message}\\n\\nEl mantenimiento se guardar├í de todas formas.`);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return { continuar: true, equipoId: equipoActualCargado?.id || null };\r\n}\r\n\r\n/**\r\n * Formatea el nombre de un campo para mostrar al usuario\r\n */\r\nfunction formatearNombreCampo(campo) {\r\n    const nombres = {\r\n        tipo_ablandador: 'Tipo de ablandador',\r\n        modelo: 'Modelo',\r\n        volumen_resina: 'Volumen de resina',\r\n        ubicacion: 'Ubicaci├│n',\r\n        tipo_regeneracion: 'Tipo de regeneraci├│n',\r\n        prefiltro: 'Prefiltro',\r\n        proteccion_entrada: 'Protecci├│n de entrada',\r\n        manometros: 'Man├│metros',\r\n        notas_equipo: 'Notas del equipo',\r\n    };\r\n    return nombres[campo] || campo;\r\n}\r\n\r\n/**\r\n * Helper para obtener valor de un select\r\n */\r\nfunction getSelectValue(id) {\r\n    const el = getElement(id);\r\n    return el?.value || '';\r\n}\r\n\r\nfunction initializeClientAutocomplete() {\r\n    if (clientAutocompleteInitialized) return;\r\n\r\n    const searchInput = getElement(CLIENT_SEARCH_ID);\r\n    const dropdown = getElement(CLIENT_DROPDOWN_ID);\r\n    const clearBtn = getElement(CLIENT_CLEAR_BTN_ID);\r\n\r\n    if (!searchInput || !dropdown) return;\r\n\r\n    // Input event - filter as user types\r\n    searchInput.addEventListener('input', (e) => {\r\n        const query = e.target.value;\r\n        searchInput.classList.remove('has-selection');\r\n\r\n        // Clear hidden input when user modifies search\r\n        const hiddenInput = getElement(CLIENT_SELECT_ID);\r\n        if (hiddenInput) {\r\n            hiddenInput.value = '';\r\n        }\r\n\r\n        if (clearBtn) {\r\n            clearBtn.classList.toggle('hidden', !query);\r\n        }\r\n\r\n        const filtered = filterClientes(query);\r\n        selectedClientIndex = -1;\r\n        renderDropdown(filtered, query);\r\n    });\r\n\r\n    // Focus event - show dropdown\r\n    searchInput.addEventListener('focus', () => {\r\n        const query = searchInput.value;\r\n        if (!searchInput.classList.contains('has-selection')) {\r\n            const filtered = filterClientes(query);\r\n            renderDropdown(filtered, query);\r\n        }\r\n    });\r\n\r\n    // Keyboard navigation\r\n    searchInput.addEventListener('keydown', (e) => {\r\n        const items = dropdown.querySelectorAll('.cliente-dropdown-item');\r\n\r\n        if (e.key === 'ArrowDown') {\r\n            e.preventDefault();\r\n            selectedClientIndex = Math.min(selectedClientIndex + 1, items.length - 1);\r\n            updateDropdownSelection(items);\r\n        } else if (e.key === 'ArrowUp') {\r\n            e.preventDefault();\r\n            selectedClientIndex = Math.max(selectedClientIndex - 1, 0);\r\n            updateDropdownSelection(items);\r\n        } else if (e.key === 'Enter') {\r\n            e.preventDefault();\r\n            if (selectedClientIndex >= 0 && items[selectedClientIndex]) {\r\n                const clientKey = items[selectedClientIndex].dataset.clienteKey;\r\n                selectClient(clientKey);\r\n            }\r\n        } else if (e.key === 'Escape') {\r\n            hideDropdown();\r\n        }\r\n    });\r\n\r\n    // Click on dropdown item\r\n    dropdown.addEventListener('click', (e) => {\r\n        const item = e.target.closest('.cliente-dropdown-item');\r\n        if (item) {\r\n            const clientKey = item.dataset.clienteKey;\r\n            selectClient(clientKey);\r\n        }\r\n    });\r\n\r\n    // Clear button\r\n    if (clearBtn) {\r\n        clearBtn.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            clearClientSelection();\r\n        });\r\n    }\r\n\r\n    // Click outside to close\r\n    document.addEventListener('click', (e) => {\r\n        const container = getElement(CLIENT_CONTAINER_ID);\r\n        if (container && !container.contains(e.target)) {\r\n            hideDropdown();\r\n        }\r\n    });\r\n\r\n    clientAutocompleteInitialized = true;\r\n}\r\n\r\nfunction updateDropdownSelection(items) {\r\n    items.forEach((item, index) => {\r\n        item.classList.toggle('selected', index === selectedClientIndex);\r\n        if (index === selectedClientIndex) {\r\n            item.scrollIntoView({ block: 'nearest' });\r\n        }\r\n    });\r\n}\r\n\r\nfunction populateClientSelect(clientes = []) {\r\n    // Store clients for autocomplete\r\n    clientesListCache = Array.isArray(clientes) ? clientes : [];\r\n\r\n    // Clear and rebuild the data map\r\n    clienteDataMap.clear();\r\n    clientesListCache.forEach((cliente, index) => {\r\n        if (!cliente || typeof cliente !== 'object') return;\r\n        const clientKey = `softener-cliente-${index}`;\r\n        clienteDataMap.set(clientKey, createClientDetails(cliente));\r\n    });\r\n\r\n    // Initialize autocomplete if not already done\r\n    initializeClientAutocomplete();\r\n\r\n    // If there was a previous selection, try to restore it\r\n    const hiddenInput = getElement(CLIENT_SELECT_ID);\r\n    const searchInput = getElement(CLIENT_SEARCH_ID);\r\n\r\n    if (hiddenInput && hiddenInput.value && searchInput) {\r\n        // Find the client by ID\r\n        const existingClient = clientesListCache.find(c => {\r\n            const id = extractClientId(c) || extractClientName(c);\r\n            return id === hiddenInput.value;\r\n        });\r\n\r\n        if (existingClient) {\r\n            searchInput.value = extractClientName(existingClient);\r\n            searchInput.classList.add('has-selection');\r\n            const clearBtn = getElement(CLIENT_CLEAR_BTN_ID);\r\n            if (clearBtn) clearBtn.classList.remove('hidden');\r\n        }\r\n    }\r\n}\r\n\r\nasync function loadClientes(obtenerClientesFn) {\r\n    if (clientesLoaded) {\r\n        return;\r\n    }\r\n\r\n    if (clientesLoadingPromise) {\r\n        await clientesLoadingPromise;\r\n        return;\r\n    }\r\n\r\n    if (typeof obtenerClientesFn !== 'function') {\r\n        return;\r\n    }\r\n\r\n    clientesLoadingPromise = (async () => {\r\n        let retries = 3;\r\n        let delay = 500;\r\n\r\n        for (let attempt = 1; attempt <= retries; attempt++) {\r\n            try {\r\n                const clientes = await obtenerClientesFn({ forceRefresh: false });\r\n                populateClientSelect(clientes);\r\n                clientesLoaded = true;\r\n                return; // ├ëxito, salir\r\n            } catch (error) {\r\n                console.warn(`Intento ${attempt}/${retries} de cargar clientes fall├│:`, error);\r\n\r\n                if (attempt < retries) {\r\n                    // Esperar antes del pr├│ximo intento\r\n                    await new Promise(resolve => setTimeout(resolve, delay));\r\n                    delay *= 2; // Incrementar delay exponencialmente\r\n                } else {\r\n                    // ├Ültimo intento fall├│, mostrar error\r\n                    console.error('Error al cargar clientes para ablandador despu├®s de varios intentos:', error);\r\n                    populateClientSelect([]);\r\n                    // No mostrar alert para mejor UX - los campos siguen siendo editables\r\n                }\r\n            }\r\n        }\r\n        clientesLoadingPromise = null;\r\n    })();\r\n\r\n    await clientesLoadingPromise;\r\n}\r\n\r\nfunction setDefaultServiceDate() {\r\n    const dateInput = getElement('softener-fecha-servicio');\r\n    if (dateInput instanceof HTMLInputElement && !dateInput.value) {\r\n        const today = new Date();\r\n        const iso = new Date(today.getTime() - today.getTimezoneOffset() * 60000)\r\n            .toISOString()\r\n            .slice(0, 10);\r\n        dateInput.value = iso;\r\n\r\n        // Setear pr├│ximo servicio a +365 d├¡as\r\n        setDefaultNextServiceDate(iso);\r\n    }\r\n}\r\n\r\nfunction setDefaultNextServiceDate(serviceDateIso) {\r\n    const nextServiceInput = getElement('softener-resumen-proximo-servicio');\r\n    if (nextServiceInput instanceof HTMLInputElement && !nextServiceInput.value) {\r\n        const serviceDate = new Date(serviceDateIso);\r\n        serviceDate.setFullYear(serviceDate.getFullYear() + 1); // +365 d├¡as aprox\r\n        const nextIso = serviceDate.toISOString().slice(0, 10);\r\n        nextServiceInput.value = nextIso;\r\n    }\r\n}\r\n\r\nfunction setDefaultResinVolume() {\r\n    const volumenInput = getElement(VOLUMEN_RESINA_ID);\r\n    if (volumenInput instanceof HTMLInputElement && !volumenInput.value) {\r\n        volumenInput.value = '25';\r\n    }\r\n}\r\n\r\nfunction normalizeDateValue(value) {\r\n    if (!value) {\r\n        return '';\r\n    }\r\n    const date = new Date(value);\r\n    if (Number.isNaN(date.getTime())) {\r\n        return value;\r\n    }\r\n    const iso = new Date(date.getTime() - date.getTimezoneOffset() * 60000)\r\n        .toISOString()\r\n        .slice(0, 10);\r\n    return iso;\r\n}\r\n\r\nfunction buildSection(entries) {\r\n    const section = {};\r\n    entries.forEach(([key, value, options]) => {\r\n        const includeEmpty = Boolean(options && options.includeEmpty);\r\n        if (value === undefined) {\r\n            return;\r\n        }\r\n        if (value === '' && !includeEmpty) {\r\n            return;\r\n        }\r\n        if (value === null && !includeEmpty) {\r\n            return;\r\n        }\r\n        section[key] = value;\r\n    });\r\n    return section;\r\n}\r\n\r\nfunction setElementDisabled(id, disabled) {\r\n    const el = getElement(id);\r\n    if (!el) return;\r\n    if ('disabled' in el) el.disabled = Boolean(disabled);\r\n}\r\n\r\nfunction updateCabezalFrequencyState() {\r\n    // Mostrar/habilitar la frecuencia s├│lo si en la Secci├│n B se seleccion├│ 'Por Tiempo'\r\n    const tipo = getInputValue(SECCION_B_TIPO_REGENERACION_ID);\r\n    const enabled = tipo === 'Por Tiempo';\r\n\r\n    // ocultar/mostrar todo el contenedor de frecuencia\r\n    const container = getElement(CABEZAL_FRECUENCIA_CONTAINER_ID);\r\n    if (container && container.style) {\r\n        container.style.display = enabled ? '' : 'none';\r\n    }\r\n\r\n    // controlar disabled de los inputs tambi├®n por seguridad\r\n    setElementDisabled(CABEZAL_FRECUENCIA_DIAS_FOUND_ID, !enabled);\r\n    setElementDisabled(CABEZAL_FRECUENCIA_DIAS_LEFT_ID, !enabled);\r\n\r\n    // si qued├│ deshabilitado, limpiamos valores\r\n    if (!enabled) {\r\n        const ef = getElement(CABEZAL_FRECUENCIA_DIAS_FOUND_ID);\r\n        if (ef && 'value' in ef) ef.value = '';\r\n        const el = getElement(CABEZAL_FRECUENCIA_DIAS_LEFT_ID);\r\n        if (el && 'value' in el) el.value = '';\r\n    }\r\n}\r\n\r\nfunction attachCabezalListeners() {\r\n    const tipoSeccionB = getElement(SECCION_B_TIPO_REGENERACION_ID);\r\n    if (tipoSeccionB instanceof HTMLSelectElement) {\r\n        tipoSeccionB.addEventListener('change', updateCabezalFrequencyState);\r\n    }\r\n}\r\n\r\n// --- Popup de ayuda para Prefiltro ---\r\nfunction hidePrefilterInfo() {\r\n    const btn = getElement(PREFILTER_INFO_BTN_ID);\r\n    const popup = getElement(PREFILTER_INFO_POPUP_ID);\r\n    if (popup && popup.classList) popup.classList.add('hidden');\r\n    if (btn) btn.setAttribute('aria-expanded', 'false');\r\n    if (popup) popup.setAttribute('aria-hidden', 'true');\r\n}\r\n\r\nfunction showPrefilterInfo() {\r\n    const btn = getElement(PREFILTER_INFO_BTN_ID);\r\n    const popup = getElement(PREFILTER_INFO_POPUP_ID);\r\n    if (popup && popup.classList) popup.classList.remove('hidden');\r\n    if (btn) btn.setAttribute('aria-expanded', 'true');\r\n    if (popup) popup.setAttribute('aria-hidden', 'false');\r\n}\r\n\r\nfunction attachPrefilterInfoListeners() {\r\n    const btn = getElement(PREFILTER_INFO_BTN_ID);\r\n    const popup = getElement(PREFILTER_INFO_POPUP_ID);\r\n\r\n    if (!(btn instanceof HTMLButtonElement) || !popup) return;\r\n\r\n    btn.addEventListener('click', event => {\r\n        event.stopPropagation();\r\n        const isHidden = popup.classList.contains('hidden');\r\n        if (isHidden) {\r\n            showPrefilterInfo();\r\n        } else {\r\n            hidePrefilterInfo();\r\n        }\r\n    });\r\n\r\n    // Cerrar al hacer click fuera\r\n    document.addEventListener('click', (ev) => {\r\n        if (!popup.classList.contains('hidden')) {\r\n            const target = ev.target;\r\n            if (!(popup.contains(target) || btn.contains(target))) {\r\n                hidePrefilterInfo();\r\n            }\r\n        }\r\n    });\r\n\r\n    // Esc para cerrar\r\n    document.addEventListener('keydown', (ev) => {\r\n        if (ev.key === 'Escape') {\r\n            hidePrefilterInfo();\r\n        }\r\n    });\r\n}\r\n\r\n// ============================================================================\r\n// TREN DE PREFILTRADO - M├║ltiples etapas de filtraci├│n\r\n// ============================================================================\r\n\r\nconst PREFILTRO_OPTIONS = [\r\n    { value: 'No Aplica', label: 'No Aplica' },\r\n    { value: 'Particulas - Mini Blue (10\"x2.5\")', label: 'Part├¡culas - Mini Blue (10\"x2.5\")' },\r\n    { value: 'Particulas - XL (20\"x2.5\")', label: 'Part├¡culas - XL (20\"x2.5\")' },\r\n    { value: 'Particulas - Jumbo (10\"x4.5\")', label: 'Part├¡culas - Jumbo (10\"x4.5\")' },\r\n    { value: 'Particulas - Big Blue (20\"x4.5\")', label: 'Part├¡culas - Big Blue (20\"x4.5\")' },\r\n    { value: 'CAB - Mini Blue (10\"x2.5\")', label: 'CAB - Mini Blue (10\"x2.5\")' },\r\n    { value: 'CAB - XL (20\"x2.5\")', label: 'CAB - XL (20\"x2.5\")' },\r\n    { value: 'CAB - Jumbo (10\"x4.5\")', label: 'CAB - Jumbo (10\"x4.5\")' },\r\n    { value: 'CAB - Big Blue (20\"x4.5\")', label: 'CAB - Big Blue (20\"x4.5\")' },\r\n    { value: 'GAC - Mini Blue (10\"x2.5\")', label: 'GAC - Mini Blue (10\"x2.5\")' },\r\n    { value: 'GAC - XL (20\"x2.5\")', label: 'GAC - XL (20\"x2.5\")' },\r\n    { value: 'GAC - Jumbo (10\"x4.5\")', label: 'GAC - Jumbo (10\"x4.5\")' },\r\n    { value: 'GAC - Big Blue (20\"x4.5\")', label: 'GAC - Big Blue (20\"x4.5\")' },\r\n];\r\n\r\n/**\r\n * Genera los selectores din├ímicos para cada etapa del tren de prefiltrado\r\n */\r\nfunction generarSelectoresEtapas(numEtapas) {\r\n    const container = getElement(PREFILTRO_ETAPAS_CONTAINER_ID);\r\n    if (!container) return;\r\n\r\n    container.innerHTML = '';\r\n\r\n    for (let i = 1; i <= numEtapas; i++) {\r\n        const etapaDiv = document.createElement('div');\r\n        etapaDiv.className = 'flex items-center gap-2';\r\n\r\n        const label = document.createElement('label');\r\n        label.className = 'text-xs font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0';\r\n        label.textContent = `Etapa ${i}:`;\r\n        label.setAttribute('for', `softener-prefiltro-etapa-${i}`);\r\n\r\n        const select = document.createElement('select');\r\n        select.id = `softener-prefiltro-etapa-${i}`;\r\n        select.name = `prefiltro_etapa_${i}`;\r\n        select.className = 'flex-1 rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 p-1.5 text-sm text-gray-900 dark:text-gray-100 focus:border-emerald-500 focus:outline-none';\r\n\r\n        PREFILTRO_OPTIONS.forEach(opt => {\r\n            const option = document.createElement('option');\r\n            option.value = opt.value;\r\n            option.textContent = opt.label;\r\n            select.appendChild(option);\r\n        });\r\n\r\n        etapaDiv.appendChild(label);\r\n        etapaDiv.appendChild(select);\r\n        container.appendChild(etapaDiv);\r\n    }\r\n}\r\n\r\n/**\r\n * Obtiene los valores de todas las etapas del tren\r\n */\r\nfunction obtenerValoresTrenPrefiltrado() {\r\n    const checkbox = getElement(PREFILTRO_TREN_CHECKBOX_ID);\r\n    if (!checkbox || !checkbox.checked) {\r\n        return null; // No es tren\r\n    }\r\n\r\n    const numEtapas = parseInt(getInputValue(PREFILTRO_ETAPAS_INPUT_ID)) || 0;\r\n    const etapas = [];\r\n\r\n    for (let i = 1; i <= numEtapas; i++) {\r\n        const select = getElement(`softener-prefiltro-etapa-${i}`);\r\n        if (select) {\r\n            etapas.push({\r\n                etapa: i,\r\n                tipo: select.value\r\n            });\r\n        }\r\n    }\r\n\r\n    return {\r\n        es_tren: true,\r\n        num_etapas: numEtapas,\r\n        etapas: etapas\r\n    };\r\n}\r\n\r\n/**\r\n * Carga los valores del tren de prefiltrado desde la BD\r\n */\r\nfunction cargarTrenPrefiltrado(trenData) {\r\n    const checkbox = getElement(PREFILTRO_TREN_CHECKBOX_ID);\r\n    const etapasInput = getElement(PREFILTRO_ETAPAS_INPUT_ID);\r\n    const trenContainer = getElement(PREFILTRO_TREN_CONTAINER_ID);\r\n    const simpleContainer = getElement(PREFILTRO_SIMPLE_CONTAINER_ID);\r\n\r\n    if (!trenData || !trenData.es_tren) {\r\n        // No es tren - mostrar selector simple\r\n        if (checkbox) checkbox.checked = false;\r\n        if (trenContainer) trenContainer.classList.add('hidden');\r\n        if (simpleContainer) simpleContainer.classList.remove('hidden');\r\n        // Actualizar la secci├│n de cambio de filtros\r\n        updatePrefiltroCambioVisibility();\r\n        return;\r\n    }\r\n\r\n    // Es tren - configurar\r\n    if (checkbox) checkbox.checked = true;\r\n    if (trenContainer) trenContainer.classList.remove('hidden');\r\n    if (simpleContainer) simpleContainer.classList.add('hidden');\r\n\r\n    if (etapasInput) {\r\n        etapasInput.value = trenData.num_etapas || 2;\r\n    }\r\n\r\n    // Generar selectores y cargar valores\r\n    generarSelectoresEtapas(trenData.num_etapas || 2);\r\n\r\n    // Cargar valores de cada etapa\r\n    if (trenData.etapas && Array.isArray(trenData.etapas)) {\r\n        trenData.etapas.forEach(etapa => {\r\n            const select = getElement(`softener-prefiltro-etapa-${etapa.etapa}`);\r\n            if (select) {\r\n                select.value = etapa.tipo;\r\n            }\r\n        });\r\n    }\r\n\r\n    // Actualizar la secci├│n de cambio de filtros despu├®s de cargar el tren\r\n    updatePrefiltroCambioVisibility();\r\n}\r\n\r\n/**\r\n * Inicializa los listeners para el tren de prefiltrado\r\n */\r\nfunction attachTrenPrefiltradoListeners() {\r\n    const checkbox = getElement(PREFILTRO_TREN_CHECKBOX_ID);\r\n    const etapasInput = getElement(PREFILTRO_ETAPAS_INPUT_ID);\r\n    const trenContainer = getElement(PREFILTRO_TREN_CONTAINER_ID);\r\n    const simpleContainer = getElement(PREFILTRO_SIMPLE_CONTAINER_ID);\r\n\r\n    if (!checkbox) return;\r\n\r\n    // Toggle tren on/off\r\n    checkbox.addEventListener('change', () => {\r\n        if (checkbox.checked) {\r\n            if (trenContainer) trenContainer.classList.remove('hidden');\r\n            if (simpleContainer) simpleContainer.classList.add('hidden');\r\n            // Generar selectores iniciales\r\n            const numEtapas = parseInt(etapasInput?.value) || 2;\r\n            generarSelectoresEtapas(numEtapas);\r\n        } else {\r\n            if (trenContainer) trenContainer.classList.add('hidden');\r\n            if (simpleContainer) simpleContainer.classList.remove('hidden');\r\n        }\r\n\r\n        // Actualizar la secci├│n de cambio de filtros en checklist\r\n        updatePrefiltroCambioVisibility();\r\n\r\n        // Marcar secci├│n B como editada\r\n        if (seccionBDesbloqueada) {\r\n            seccionBEditada = true;\r\n        }\r\n    });\r\n\r\n    // Cambio en n├║mero de etapas\r\n    if (etapasInput) {\r\n        etapasInput.addEventListener('change', () => {\r\n            const numEtapas = parseInt(etapasInput.value) || 2;\r\n            // Limitar entre 2 y 6\r\n            const limitado = Math.max(2, Math.min(6, numEtapas));\r\n            etapasInput.value = limitado;\r\n            generarSelectoresEtapas(limitado);\r\n\r\n            // Actualizar checkboxes de cambio de filtro despu├®s de generar selectores\r\n            setTimeout(() => {\r\n                generarCheckboxesCambioFiltroTren();\r\n            }, 50);\r\n\r\n            if (seccionBDesbloqueada) {\r\n                seccionBEditada = true;\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction hideProtectionInfo() {\r\n    const btn = getElement(PROTECTION_INFO_BTN_ID);\r\n    const popup = getElement(PROTECTION_INFO_POPUP_ID);\r\n    if (popup && popup.classList) popup.classList.add('hidden');\r\n    if (btn) btn.setAttribute('aria-expanded', 'false');\r\n    if (popup) popup.setAttribute('aria-hidden', 'true');\r\n}\r\n\r\nfunction showProtectionInfo() {\r\n    const btn = getElement(PROTECTION_INFO_BTN_ID);\r\n    const popup = getElement(PROTECTION_INFO_POPUP_ID);\r\n    if (popup && popup.classList) popup.classList.remove('hidden');\r\n    if (btn) btn.setAttribute('aria-expanded', 'true');\r\n    if (popup) popup.setAttribute('aria-hidden', 'false');\r\n}\r\n\r\nfunction attachProtectionInfoListeners() {\r\n    const btn = getElement(PROTECTION_INFO_BTN_ID);\r\n    const popup = getElement(PROTECTION_INFO_POPUP_ID);\r\n\r\n    if (!(btn instanceof HTMLButtonElement) || !popup) return;\r\n\r\n    btn.addEventListener('click', event => {\r\n        event.stopPropagation();\r\n        const isHidden = popup.classList.contains('hidden');\r\n        if (isHidden) {\r\n            showProtectionInfo();\r\n        } else {\r\n            hideProtectionInfo();\r\n        }\r\n    });\r\n\r\n    document.addEventListener('click', (ev) => {\r\n        if (!popup.classList.contains('hidden')) {\r\n            const target = ev.target;\r\n            if (!(popup.contains(target) || btn.contains(target))) {\r\n                hideProtectionInfo();\r\n            }\r\n        }\r\n    });\r\n\r\n    document.addEventListener('keydown', (ev) => {\r\n        if (ev.key === 'Escape') {\r\n            hideProtectionInfo();\r\n        }\r\n    });\r\n}\r\n\r\n// --- Man├│metros: popup + state ---\r\nfunction hideManometroInfo() {\r\n    const btn = getElement(MANOMETRO_INFO_BTN_ID);\r\n    const popup = getElement(MANOMETRO_INFO_POPUP_ID);\r\n    if (popup && popup.classList) popup.classList.add('hidden');\r\n    if (btn) btn.setAttribute('aria-expanded', 'false');\r\n    if (popup) popup.setAttribute('aria-hidden', 'true');\r\n}\r\n\r\nfunction showManometroInfo() {\r\n    const btn = getElement(MANOMETRO_INFO_BTN_ID);\r\n    const popup = getElement(MANOMETRO_INFO_POPUP_ID);\r\n    if (popup && popup.classList) popup.classList.remove('hidden');\r\n    if (btn) btn.setAttribute('aria-expanded', 'true');\r\n    if (popup) popup.setAttribute('aria-hidden', 'false');\r\n}\r\n\r\nfunction attachManometroInfoListeners() {\r\n    const btn = getElement(MANOMETRO_INFO_BTN_ID);\r\n    const popup = getElement(MANOMETRO_INFO_POPUP_ID);\r\n    if (!(btn instanceof HTMLButtonElement) || !popup) return;\r\n\r\n    btn.addEventListener('click', event => {\r\n        event.stopPropagation();\r\n        const isHidden = popup.classList.contains('hidden');\r\n        if (isHidden) {\r\n            showManometroInfo();\r\n        } else {\r\n            hideManometroInfo();\r\n        }\r\n    });\r\n\r\n    document.addEventListener('click', (ev) => {\r\n        if (!popup.classList.contains('hidden')) {\r\n            const target = ev.target;\r\n            if (!(popup.contains(target) || btn.contains(target))) {\r\n                hideManometroInfo();\r\n            }\r\n        }\r\n    });\r\n\r\n    document.addEventListener('keydown', (ev) => {\r\n        if (ev.key === 'Escape') {\r\n            hideManometroInfo();\r\n        }\r\n    });\r\n}\r\n\r\nfunction hideAutonomiaRestanteInfo() {\r\n    const popup = getElement(AUTONOMIA_RESTANTE_INFO_POPUP_ID);\r\n    const btn = getElement(AUTONOMIA_RESTANTE_INFO_BTN_ID);\r\n    if (popup && popup.classList) popup.classList.add('hidden');\r\n    if (btn) btn.setAttribute('aria-expanded', 'false');\r\n    if (popup) popup.setAttribute('aria-hidden', 'true');\r\n}\r\n\r\nfunction showAutonomiaRestanteInfo() {\r\n    const popup = getElement(AUTONOMIA_RESTANTE_INFO_POPUP_ID);\r\n    const btn = getElement(AUTONOMIA_RESTANTE_INFO_BTN_ID);\r\n    if (popup && popup.classList) popup.classList.remove('hidden');\r\n    if (btn) btn.setAttribute('aria-expanded', 'true');\r\n    if (popup) popup.setAttribute('aria-hidden', 'false');\r\n}\r\n\r\nfunction attachAutonomiaRestanteInfoListeners() {\r\n    const btn = getElement(AUTONOMIA_RESTANTE_INFO_BTN_ID);\r\n    const popup = getElement(AUTONOMIA_RESTANTE_INFO_POPUP_ID);\r\n    if (!(btn instanceof HTMLButtonElement) || !popup) return;\r\n\r\n    btn.addEventListener('click', event => {\r\n        event.stopPropagation();\r\n        const isHidden = popup.classList.contains('hidden');\r\n        if (isHidden) {\r\n            showAutonomiaRestanteInfo();\r\n        } else {\r\n            hideAutonomiaRestanteInfo();\r\n        }\r\n    });\r\n\r\n    document.addEventListener('click', (ev) => {\r\n        if (!popup.classList.contains('hidden')) {\r\n            const target = ev.target;\r\n            if (!(popup.contains(target) || btn.contains(target))) {\r\n                hideAutonomiaRestanteInfo();\r\n            }\r\n        }\r\n    });\r\n\r\n    document.addEventListener('keydown', (ev) => {\r\n        if (ev.key === 'Escape') {\r\n            hideAutonomiaRestanteInfo();\r\n        }\r\n    });\r\n}\r\n\r\nfunction updatePrefiltroCambioVisibility() {\r\n    const prefiltroValue = getInputValue(PREFILTER_SELECT_ID);\r\n    const section = getElement(PREFILTRACION_SECTION_ID);\r\n    const containerSimple = getElement(CAMBIO_FILTRO_CONTAINER_ID);\r\n    const containerTren = getElement(CAMBIO_FILTRO_TREN_CONTAINER_ID);\r\n    const tipoFiltroInput = getElement(FILTRO_TIPO_INSTALADO_ID);\r\n    const trenCheckbox = getElement(PREFILTRO_TREN_CHECKBOX_ID);\r\n\r\n    // Verificar si est├í en modo tren\r\n    const esTren = trenCheckbox instanceof HTMLInputElement && trenCheckbox.checked;\r\n\r\n    // En modo tren, verificar si hay etapas configuradas\r\n    const etapasTren = esTren ? obtenerEtapasTrenConfiguradas() : [];\r\n    const tieneTrenConfigurado = esTren && etapasTren.length > 0;\r\n\r\n    // Mostrar toda la secci├│n si hay prefiltro simple configurado O si hay tren con etapas\r\n    const tienePrefiltroSimple = !esTren && prefiltroValue && prefiltroValue.trim() !== '' && prefiltroValue !== 'No Aplica';\r\n    const tienePrefiltro = tienePrefiltroSimple || tieneTrenConfigurado;\r\n\r\n    // Controlar visibilidad de toda la secci├│n\r\n    if (section) {\r\n        if (tienePrefiltro) {\r\n            section.classList.remove('hidden');\r\n        } else {\r\n            section.classList.add('hidden');\r\n        }\r\n    }\r\n\r\n    // Si no hay prefiltro, ocultar ambos containers\r\n    if (!tienePrefiltro) {\r\n        if (containerSimple) containerSimple.classList.add('hidden');\r\n        if (containerTren) containerTren.classList.add('hidden');\r\n        // Limpiar campos cuando se oculta\r\n        const checkCambio = getElement(CHECK_CAMBIO_FILTRO_ID);\r\n        if (checkCambio instanceof HTMLInputElement) {\r\n            checkCambio.checked = false;\r\n        }\r\n        updateDetalleCambioFiltro();\r\n        return;\r\n    }\r\n\r\n    // Determinar qu├® container mostrar seg├║n modo\r\n    if (esTren) {\r\n        // Modo tren: ocultar simple, mostrar tren y generar checkboxes din├ímicos\r\n        if (containerSimple) containerSimple.classList.add('hidden');\r\n        if (containerTren) {\r\n            containerTren.classList.remove('hidden');\r\n            generarCheckboxesCambioFiltroTren();\r\n        }\r\n    } else {\r\n        // Modo simple: mostrar simple, ocultar tren\r\n        if (containerSimple) {\r\n            containerSimple.classList.remove('hidden');\r\n            // Heredar el tipo de filtro configurado\r\n            if (tipoFiltroInput) {\r\n                tipoFiltroInput.value = prefiltroValue;\r\n            }\r\n        }\r\n        if (containerTren) containerTren.classList.add('hidden');\r\n    }\r\n}\r\n\r\n/**\r\n * Genera los checkboxes din├ímicos para el cambio de filtros en modo tren\r\n * Basado en las etapas configuradas en la Secci├│n B\r\n */\r\nfunction generarCheckboxesCambioFiltroTren() {\r\n    const etapasContainer = getElement(CAMBIO_FILTRO_TREN_ETAPAS_ID);\r\n    if (!etapasContainer) return;\r\n\r\n    // Obtener las etapas configuradas en Secci├│n B\r\n    const etapas = obtenerEtapasTrenConfiguradas();\r\n\r\n    if (etapas.length === 0) {\r\n        etapasContainer.innerHTML = `\r\n            <p class=\"text-sm text-gray-500 dark:text-gray-400 italic\">\r\n                No hay etapas de tren configuradas en la Secci├│n B\r\n            </p>\r\n        `;\r\n        return;\r\n    }\r\n\r\n    // Generar checkboxes para cada etapa\r\n    let html = '';\r\n    etapas.forEach((etapa, index) => {\r\n        const checkboxId = `softener-cambio-filtro-etapa-${index}`;\r\n        html += `\r\n            <label class=\"flex items-start gap-3 rounded-lg border border-gray-200 bg-white p-2 shadow-sm dark:border-gray-600 dark:bg-gray-800\">\r\n                <input type=\"checkbox\" \r\n                       id=\"${checkboxId}\" \r\n                       data-etapa-index=\"${index}\"\r\n                       data-etapa-nombre=\"${etapa}\"\r\n                       class=\"cambio-filtro-etapa-checkbox mt-1 h-5 w-5 rounded border-gray-300 text-amber-600 focus:ring-amber-500 dark:border-gray-500\">\r\n                <span class=\"text-sm text-gray-700 dark:text-gray-300\">\r\n                    <strong>Etapa ${index + 1}:</strong> ${etapa}\r\n                </span>\r\n            </label>\r\n        `;\r\n    });\r\n\r\n    etapasContainer.innerHTML = html;\r\n\r\n    // Agregar listeners a los checkboxes generados\r\n    attachCambioFiltroTrenListeners();\r\n}\r\n\r\n/**\r\n * Obtiene las etapas de tren configuradas en la Secci├│n B\r\n * @returns {string[]} Array con los nombres de las etapas\r\n */\r\nfunction obtenerEtapasTrenConfiguradas() {\r\n    const etapas = [];\r\n    const selectoresEtapas = document.querySelectorAll('#' + PREFILTRO_ETAPAS_CONTAINER_ID + ' select');\r\n\r\n    selectoresEtapas.forEach((select) => {\r\n        if (select instanceof HTMLSelectElement && select.value) {\r\n            etapas.push(select.value);\r\n        }\r\n    });\r\n\r\n    return etapas;\r\n}\r\n\r\n/**\r\n * Agrega listeners a los checkboxes de cambio de filtro en modo tren\r\n */\r\nfunction attachCambioFiltroTrenListeners() {\r\n    const checkboxes = document.querySelectorAll('.cambio-filtro-etapa-checkbox');\r\n    checkboxes.forEach(checkbox => {\r\n        checkbox.addEventListener('change', () => {\r\n            updateDetalleCambioFiltroTren();\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * Actualiza la visibilidad del detalle de lotes/series para modo tren\r\n * Solo muestra los inputs de lote para las etapas que tienen checkbox marcado\r\n */\r\nfunction updateDetalleCambioFiltroTren() {\r\n    const detalleContainer = getElement(DETALLE_CAMBIO_FILTRO_TREN_ID);\r\n    const lotesContainer = getElement(LOTES_TREN_CONTAINER_ID);\r\n\r\n    if (!detalleContainer || !lotesContainer) return;\r\n\r\n    // Obtener checkboxes marcados\r\n    const checkboxesMarcados = document.querySelectorAll('.cambio-filtro-etapa-checkbox:checked');\r\n\r\n    if (checkboxesMarcados.length === 0) {\r\n        detalleContainer.classList.add('hidden');\r\n        lotesContainer.innerHTML = '';\r\n        return;\r\n    }\r\n\r\n    // Mostrar container de detalle\r\n    detalleContainer.classList.remove('hidden');\r\n\r\n    // Generar inputs de lote/serie para cada etapa marcada\r\n    let html = '';\r\n    checkboxesMarcados.forEach((checkbox) => {\r\n        if (checkbox instanceof HTMLInputElement) {\r\n            const index = checkbox.dataset.etapaIndex;\r\n            const nombre = checkbox.dataset.etapaNombre;\r\n            const inputId = `softener-lote-etapa-${index}`;\r\n\r\n            html += `\r\n                <div class=\"flex flex-col sm:flex-row sm:items-center gap-2\">\r\n                    <label class=\"text-xs font-medium text-gray-600 dark:text-gray-400 min-w-[120px]\">\r\n                        Etapa ${parseInt(index) + 1} (${nombre}):\r\n                    </label>\r\n                    <input type=\"text\" \r\n                           id=\"${inputId}\" \r\n                           data-etapa-index=\"${index}\"\r\n                           class=\"lote-etapa-input flex-1 rounded-md border border-gray-300 bg-white p-2 text-sm text-gray-900 shadow-sm focus:border-amber-500 focus:outline-none focus:ring-amber-200 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100\" \r\n                           placeholder=\"Lote o serie del filtro\">\r\n                </div>\r\n            `;\r\n        }\r\n    });\r\n\r\n    lotesContainer.innerHTML = html;\r\n}\r\n\r\n/**\r\n * Obtiene los datos del cambio de filtros para modo tren\r\n * @returns {Object} Objeto con los datos del cambio de filtros en modo tren\r\n */\r\nfunction obtenerDatosCambioFiltroTren() {\r\n    const trenCheckbox = getElement(PREFILTRO_TREN_CHECKBOX_ID);\r\n    const esTren = trenCheckbox instanceof HTMLInputElement && trenCheckbox.checked;\r\n\r\n    if (!esTren) {\r\n        return null;\r\n    }\r\n\r\n    const etapas = obtenerEtapasTrenConfiguradas();\r\n    const filtrosCambiados = [];\r\n\r\n    // Obtener checkboxes marcados\r\n    const checkboxes = document.querySelectorAll('.cambio-filtro-etapa-checkbox:checked');\r\n\r\n    checkboxes.forEach((checkbox) => {\r\n        if (checkbox instanceof HTMLInputElement) {\r\n            const index = parseInt(checkbox.dataset.etapaIndex || '0', 10);\r\n            const nombre = checkbox.dataset.etapaNombre || '';\r\n\r\n            // Buscar el input de lote correspondiente\r\n            const loteInput = document.getElementById(`softener-lote-etapa-${index}`);\r\n            const lote = loteInput instanceof HTMLInputElement ? loteInput.value : '';\r\n\r\n            filtrosCambiados.push({\r\n                etapa: index + 1,\r\n                tipo: nombre,\r\n                lote_serie: lote\r\n            });\r\n        }\r\n    });\r\n\r\n    return {\r\n        es_tren: true,\r\n        total_etapas: etapas.length,\r\n        etapas_configuradas: etapas,\r\n        filtros_cambiados: filtrosCambiados\r\n    };\r\n}\r\n\r\nfunction updateDetalleCambioFiltro() {\r\n    const checkCambio = getElement(CHECK_CAMBIO_FILTRO_ID);\r\n    const detalleContainer = getElement(DETALLE_CAMBIO_FILTRO_ID);\r\n\r\n    if (!detalleContainer) return;\r\n\r\n    const isChecked = checkCambio instanceof HTMLInputElement && checkCambio.checked;\r\n\r\n    if (isChecked) {\r\n        detalleContainer.classList.remove('hidden');\r\n    } else {\r\n        detalleContainer.classList.add('hidden');\r\n        // Limpiar campo de lote/serie cuando se oculta\r\n        const loteSerieInput = getElement(FILTRO_LOTE_SERIE_ID);\r\n        if (loteSerieInput instanceof HTMLInputElement) {\r\n            loteSerieInput.value = '';\r\n        }\r\n    }\r\n}\r\n\r\nfunction attachPrefiltroCambioListeners() {\r\n    // Listener para cambios en el select de prefiltro\r\n    const prefiltroSelect = getElement(PREFILTER_SELECT_ID);\r\n    if (prefiltroSelect instanceof HTMLSelectElement) {\r\n        prefiltroSelect.addEventListener('change', () => {\r\n            updatePrefiltroCambioVisibility();\r\n        });\r\n    }\r\n\r\n    // Listener para el checkbox de \"┬┐Realiz├│ cambio de filtro?\" (modo simple)\r\n    const checkCambio = getElement(CHECK_CAMBIO_FILTRO_ID);\r\n    if (checkCambio instanceof HTMLInputElement) {\r\n        checkCambio.addEventListener('change', () => {\r\n            updateDetalleCambioFiltro();\r\n        });\r\n    }\r\n\r\n    // Listener para cambios en el checkbox \"Tren\" de Secci├│n B\r\n    const trenCheckbox = getElement(PREFILTRO_TREN_CHECKBOX_ID);\r\n    if (trenCheckbox instanceof HTMLInputElement) {\r\n        trenCheckbox.addEventListener('change', () => {\r\n            updatePrefiltroCambioVisibility();\r\n        });\r\n    }\r\n\r\n    // Listener para cambios en la cantidad de etapas del tren\r\n    const etapasInput = getElement(PREFILTRO_ETAPAS_INPUT_ID);\r\n    if (etapasInput instanceof HTMLInputElement) {\r\n        etapasInput.addEventListener('change', () => {\r\n            // Peque├▒o delay para que se generen los selectores primero\r\n            setTimeout(() => {\r\n                updatePrefiltroCambioVisibility();\r\n            }, 100);\r\n        });\r\n    }\r\n\r\n    // Observer para detectar cambios en los selectores de etapas del tren\r\n    const etapasContainer = getElement(PREFILTRO_ETAPAS_CONTAINER_ID);\r\n    if (etapasContainer) {\r\n        // Usar MutationObserver para detectar cuando se agregan/cambian selectores\r\n        const observer = new MutationObserver(() => {\r\n            // Actualizar los checkboxes de cambio de filtro cuando cambian las etapas\r\n            const trenCheckbox = getElement(PREFILTRO_TREN_CHECKBOX_ID);\r\n            if (trenCheckbox instanceof HTMLInputElement && trenCheckbox.checked) {\r\n                setTimeout(() => {\r\n                    generarCheckboxesCambioFiltroTren();\r\n                }, 100);\r\n            }\r\n        });\r\n\r\n        observer.observe(etapasContainer, { childList: true, subtree: true });\r\n\r\n        // Tambi├®n agregar listener de cambio a los selectores existentes\r\n        etapasContainer.addEventListener('change', (e) => {\r\n            if (e.target instanceof HTMLSelectElement) {\r\n                generarCheckboxesCambioFiltroTren();\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction updateManometroState() {\r\n    const val = getInputValue(MANOMETRO_SELECT_ID);\r\n\r\n    // Solo mostrar secci├│n y campos de presi├│n si tiene \"Man├│metros IN / OUT\"\r\n    const showPressure = val === 'Man├│metros IN / OUT';\r\n\r\n    // Controlar visibilidad de toda la secci├│n de presiones\r\n    const presionesSection = getElement('softener-presiones-section');\r\n    if (presionesSection) {\r\n        if (showPressure) {\r\n            presionesSection.classList.remove('hidden');\r\n        } else {\r\n            presionesSection.classList.add('hidden');\r\n        }\r\n    }\r\n\r\n    const containerIds = [\r\n        'softener-presion-entrada-found-container',\r\n        'softener-presion-salida-found-container',\r\n        'softener-deltaP-found-container',\r\n        'softener-presion-entrada-left-container',\r\n        'softener-presion-salida-left-container',\r\n        'softener-deltaP-left-container'\r\n    ];\r\n\r\n    containerIds.forEach(id => {\r\n        const container = getElement(id);\r\n        if (container && container.style) {\r\n            container.style.display = showPressure ? '' : 'none';\r\n        }\r\n    });\r\n\r\n    // Si ocultamos, limpiamos valores\r\n    if (!showPressure) {\r\n        const inputIds = [\r\n            'softener-presion-entrada-as-found',\r\n            'softener-presion-salida-as-found',\r\n            'softener-presion-entrada-as-left',\r\n            'softener-presion-salida-as-left'\r\n        ];\r\n        inputIds.forEach(id => {\r\n            const el = getElement(id);\r\n            if (el && 'value' in el) el.value = '';\r\n        });\r\n        // Limpiar badges deltaP\r\n        clearDeltaBadge('softener-deltaP-found');\r\n        clearDeltaBadge('softener-deltaP-left');\r\n    }\r\n}\r\n\r\nfunction attachManometroListeners() {\r\n    const select = getElement(MANOMETRO_SELECT_ID);\r\n    if (select instanceof HTMLSelectElement) {\r\n        select.addEventListener('change', updateManometroState);\r\n    }\r\n    // inicializar estado seg├║n valor por defecto\r\n    updateManometroState();\r\n}\r\n\r\n// --- DeltaP (presi├│n diferencial) ---\r\nfunction formatBar(value) {\r\n    if (value === null || value === undefined || Number.isNaN(value)) return '--';\r\n    return `${Number(value).toFixed(2)} bar`;\r\n}\r\n\r\nfunction clearDeltaBadge(id) {\r\n    const el = getElement(id);\r\n    if (!el) return;\r\n    el.textContent = '--';\r\n    el.className = 'inline-block rounded-full px-4 py-2 text-sm font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100';\r\n}\r\n\r\nfunction setDeltaBadge(id, value, level) {\r\n    // level: 'green' | 'yellow' | 'red' | 'neutral'\r\n    const el = getElement(id);\r\n    if (!el) return;\r\n    if (value === null || value === undefined || Number.isNaN(value)) {\r\n        clearDeltaBadge(id);\r\n        return;\r\n    }\r\n    el.textContent = formatBar(value);\r\n\r\n    // reset to base then add color\r\n    const base = 'inline-block rounded-full px-4 py-2 text-sm font-semibold';\r\n    let classes = base;\r\n    switch (level) {\r\n        case 'green':\r\n            classes += ' bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100';\r\n            break;\r\n        case 'yellow':\r\n            classes += ' bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100';\r\n            break;\r\n        case 'red':\r\n            classes += ' bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100';\r\n            break;\r\n        default:\r\n            classes += ' bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100';\r\n    }\r\n    el.className = classes;\r\n}\r\n\r\nfunction updateDeltaP() {\r\n    const entradaFound = getNumberValue('softener-presion-entrada-as-found');\r\n    const salidaFound = getNumberValue('softener-presion-salida-as-found');\r\n    const entradaLeft = getNumberValue('softener-presion-entrada-as-left');\r\n    const salidaLeft = getNumberValue('softener-presion-salida-as-left');\r\n\r\n    // compute delta = entrada - salida (positive when entrada > salida). Use absolute value for coloring.\r\n    const deltaFound = (entradaFound === null || salidaFound === null) ? null : Math.abs(entradaFound - salidaFound);\r\n    const deltaLeft = (entradaLeft === null || salidaLeft === null) ? null : Math.abs(entradaLeft - salidaLeft);\r\n\r\n    // thresholds: <0.3 green, 0.3-0.5 yellow, >=0.5 red\r\n    function levelFor(delta) {\r\n        if (delta === null) return 'neutral';\r\n        if (delta < 0.3) return 'green';\r\n        if (delta < 0.5) return 'yellow';\r\n        return 'red';\r\n    }\r\n\r\n    if (deltaFound === null) {\r\n        clearDeltaBadge('softener-deltaP-found');\r\n    } else {\r\n        setDeltaBadge('softener-deltaP-found', deltaFound, levelFor(deltaFound));\r\n    }\r\n\r\n    if (deltaLeft === null) {\r\n        clearDeltaBadge('softener-deltaP-left');\r\n    } else {\r\n        setDeltaBadge('softener-deltaP-left', deltaLeft, levelFor(deltaLeft));\r\n    }\r\n}\r\n\r\nfunction attachDeltaPListeners() {\r\n    const ids = [\r\n        'softener-presion-entrada-as-found',\r\n        'softener-presion-entrada-as-left',\r\n        'softener-presion-salida-as-found',\r\n        'softener-presion-salida-as-left'\r\n    ];\r\n    ids.forEach(id => {\r\n        const el = getElement(id);\r\n        if (el instanceof HTMLInputElement) {\r\n            el.addEventListener('input', updateDeltaP);\r\n        }\r\n    });\r\n    // initialize\r\n    updateDeltaP();\r\n}\r\n\r\nfunction resetCabezalSection() {\r\n    // establecer valores por defecto y estado inicial\r\n    // Hora actual del cabezal (As Found) -> ahora (HH:MM)\r\n    const now = new Date();\r\n    const hh = String(now.getHours()).padStart(2, '0');\r\n    const mm = String(now.getMinutes()).padStart(2, '0');\r\n    const nowTime = `${hh}:${mm}`;\r\n\r\n    const horaFound = getElement(CABEZAL_HORA_CABEZAL_FOUND_ID);\r\n    if (horaFound && 'value' in horaFound) horaFound.value = nowTime;\r\n\r\n\r\n    // Aplicar los mismos defaults tambi├®n a As Left (seg├║n requerimiento)\r\n    const horaLeft = getElement(CABEZAL_HORA_CABEZAL_LEFT_ID);\r\n    if (horaLeft && 'value' in horaLeft) horaLeft.value = nowTime;\r\n\r\n    // Hora de regeneraci├│n por defecto 02:00\r\n    const regenFound = getElement(CABEZAL_HORA_REGENERACION_FOUND_ID);\r\n    if (regenFound && 'value' in regenFound) regenFound.value = '02:00';\r\n    const regenLeft = getElement(CABEZAL_HORA_REGENERACION_LEFT_ID);\r\n    if (regenLeft && 'value' in regenLeft) regenLeft.value = '02:00';\r\n\r\n    // Ciclos por defecto\r\n    const defaults = {\r\n        [CABEZAL_P1_FOUND_ID]: '15',\r\n        [CABEZAL_P2_FOUND_ID]: '60',\r\n        [CABEZAL_P3_FOUND_ID]: '10',\r\n        [CABEZAL_P4_FOUND_ID]: '5',\r\n        [CABEZAL_P1_LEFT_ID]: '15',\r\n        [CABEZAL_P2_LEFT_ID]: '60',\r\n        [CABEZAL_P3_LEFT_ID]: '10',\r\n        [CABEZAL_P4_LEFT_ID]: '5',\r\n    };\r\n    Object.keys(defaults).forEach(id => {\r\n        const el = getElement(id);\r\n        if (el && 'value' in el) el.value = defaults[id];\r\n    });\r\n\r\n    // frecuencia por defecto vac├¡a y estado seg├║n Secci├│n B\r\n    updateCabezalFrequencyState();\r\n}\r\n\r\nfunction autoFillSoftenerForm() {\r\n    // Datos de clientes de ejemplo\r\n    const clientes = [\r\n        'Industria La Plata S.A.',\r\n        'Laboratorio Farmac├®utico del Norte',\r\n        'Hotel & Spa Las Termas',\r\n        'Edificio Residencial Torres del Mar',\r\n        'Complejo Deportivo Municipal'\r\n    ];\r\n    const direcciones = [\r\n        'Av. Principal 1234',\r\n        'Calle Independencia 567',\r\n        'Boulevard San Mart├¡n 890',\r\n        'Ruta Nacional 9 Km 45',\r\n        'Parque Industrial Sector B'\r\n    ];\r\n    const localidades = [\r\n        'La Plata, Buenos Aires',\r\n        'Rosario, Santa Fe',\r\n        'C├│rdoba Capital',\r\n        'Mendoza, Mendoza',\r\n        'Mar del Plata, Buenos Aires'\r\n    ];\r\n\r\n    const idx = Math.floor(Math.random() * clientes.length);\r\n\r\n    // Secci├│n A - Cliente y Servicio\r\n    // El campo cliente ahora es un autocomplete\r\n    const clienteValue = clientes[idx];\r\n    const searchInput = getElement(CLIENT_SEARCH_ID);\r\n    const hiddenInput = getElement(CLIENT_SELECT_ID);\r\n    const clearBtn = getElement(CLIENT_CLEAR_BTN_ID);\r\n\r\n    if (searchInput) {\r\n        searchInput.value = clienteValue;\r\n        searchInput.classList.add('has-selection');\r\n    }\r\n    if (hiddenInput) {\r\n        hiddenInput.value = clienteValue;\r\n    }\r\n    if (clearBtn) {\r\n        clearBtn.classList.remove('hidden');\r\n    }\r\n\r\n    setInputValue('softener-cliente-direccion', direcciones[idx]);\r\n    setInputValue('softener-cliente-localidad', localidades[idx]);\r\n    setInputValue('softener-cliente-contacto', 'Juan P├®rez');\r\n    setInputValue('softener-cliente-telefono', '011-4567-8900');\r\n    setInputValue('softener-cliente-email', 'contacto@cliente.com.ar');\r\n    setInputValue('softener-cliente-cuit', '30-12345678-9');\r\n\r\n    // Fecha de servicio: hoy\r\n    const today = new Date().toISOString().split('T')[0];\r\n    setInputValue('softener-fecha-servicio', today);\r\n\r\n    // T├®cnico responsable (es un input text, no select)\r\n    const tecnicos = ['Carlos Rodr├¡guez', 'Miguel Fern├índez', 'Roberto Garc├¡a', 'Fernando L├│pez'];\r\n    setInputValue('softener-tecnico', tecnicos[Math.floor(Math.random() * tecnicos.length)]);\r\n\r\n    // Secci├│n B - Equipo\r\n    const tipos = ['Todo en uno', 'Custom', 'Industrial'];\r\n    const modelos = ['ECO-SOFT-50', 'ULTRA-SOFT-75', 'DUPLEX-SOFT-100', 'PREMIUM-SOFT-60'];\r\n    const ubicaciones = ['Lavadero', 'Patio', 'Terraza', 'Gabinete', 'Sala de M├íquinas'];\r\n\r\n    setSelectValue('softener-equipo-tipo', tipos[Math.floor(Math.random() * tipos.length)]);\r\n    setInputValue('softener-equipo-modelo', modelos[Math.floor(Math.random() * modelos.length)]);\r\n    setInputValue('softener-equipo-numero-serie', 'ABL-2024-' + Math.floor(Math.random() * 9000 + 1000));\r\n    setSelectValue('softener-equipo-ubicacion', ubicaciones[Math.floor(Math.random() * ubicaciones.length)]);\r\n    setInputValue(VOLUMEN_RESINA_ID, (Math.floor(Math.random() * 8) + 3) * 10); // 30-100L\r\n\r\n    setSelectValue(SECCION_B_TIPO_REGENERACION_ID, Math.random() > 0.5 ? 'Por Volumen' : 'Por Tiempo');\r\n\r\n    // Prefiltro con opciones variadas\r\n    const prefiltros = [\r\n        'No Aplica',\r\n        'Particulas - Mini Blue (10\"x2.5\")',\r\n        'Particulas - XL (20\"x2.5\")',\r\n        'CAB - Mini Blue (10\"x2.5\")',\r\n        'CAB - Jumbo (10\"x4.5\")',\r\n        'GAC - Mini Blue (10\"x2.5\")'\r\n    ];\r\n    setSelectValue(PREFILTER_SELECT_ID, prefiltros[Math.floor(Math.random() * prefiltros.length)]);\r\n\r\n    // Protecci├│n de entrada\r\n    const protecciones = ['No Aplica', 'Sin Protecci├│n', 'VRP', 'VA', 'VRP + VA'];\r\n    setSelectValue(PROTECCION_ENTRADA_ID, protecciones[Math.floor(Math.random() * protecciones.length)]);\r\n\r\n    // Man├│metros - valores correctos seg├║n el HTML\r\n    const manometrosOpciones = ['No cuenta con man├│metros', 'Man├│metro IN', 'Man├│metros IN / OUT'];\r\n    setSelectValue(MANOMETRO_SELECT_ID, manometrosOpciones[Math.floor(Math.random() * manometrosOpciones.length)]);\r\n\r\n    setInputValue('softener-equipo-notas', 'Equipo en operaci├│n normal. Sin novedades reportadas.');\r\n\r\n    // Secci├│n C - Par├ímetros\r\n    const durezaValues = [450, 520, 680, 750, 820, 550, 620];\r\n    setInputValue(DUREZA_AGUA_CRUDA_ID, durezaValues[Math.floor(Math.random() * durezaValues.length)]);\r\n    setInputValue(AUTONOMIA_RESTANTE_ID, Math.floor(Math.random() * 200) + 50);\r\n    setInputValue(AUTONOMIA_SETEO_ACTUAL_ID, Math.floor(Math.random() * 150) + 100);\r\n\r\n    const aplicarProteccion = Math.random() > 0.5;\r\n    const checkProteccion = getElement(FACTOR_PROTECCION_ID);\r\n    if (checkProteccion instanceof HTMLInputElement) {\r\n        checkProteccion.checked = aplicarProteccion;\r\n    }\r\n\r\n    // Configuraci├│n del Cabezal\r\n    const horaActual = new Date().toTimeString().slice(0, 5);\r\n    setInputValue(CABEZAL_HORA_CABEZAL_FOUND_ID, horaActual);\r\n    setInputValue(CABEZAL_HORA_CABEZAL_LEFT_ID, horaActual);\r\n    setInputValue(CABEZAL_HORA_REGENERACION_FOUND_ID, '02:00');\r\n    setInputValue(CABEZAL_HORA_REGENERACION_LEFT_ID, '02:00');\r\n\r\n    setInputValue(CABEZAL_P1_FOUND_ID, 10);\r\n    setInputValue(CABEZAL_P1_LEFT_ID, 10);\r\n    setInputValue(CABEZAL_P2_FOUND_ID, 60);\r\n    setInputValue(CABEZAL_P2_LEFT_ID, 60);\r\n    setInputValue(CABEZAL_P3_FOUND_ID, 10);\r\n    setInputValue(CABEZAL_P3_LEFT_ID, 10);\r\n    setInputValue(CABEZAL_P4_FOUND_ID, 5);\r\n    setInputValue(CABEZAL_P4_LEFT_ID, 5);\r\n\r\n    // Frecuencia solo si \"Por Tiempo\"\r\n    const tipoRegen = getInputValue(SECCION_B_TIPO_REGENERACION_ID);\r\n    if (tipoRegen === 'Por Tiempo') {\r\n        setInputValue(CABEZAL_FRECUENCIA_DIAS_FOUND_ID, Math.floor(Math.random() * 5) + 2);\r\n        setInputValue(CABEZAL_FRECUENCIA_DIAS_LEFT_ID, Math.floor(Math.random() * 5) + 2);\r\n    }\r\n\r\n    // Secci├│n D - Checklist\r\n    setCheckboxValue('softener-check-fugas', Math.random() > 0.8);\r\n\r\n    // Cambio de filtro\r\n    const cambioFiltro = Math.random() > 0.6;\r\n    setCheckboxValue(CHECK_CAMBIO_FILTRO_ID, cambioFiltro);\r\n    if (cambioFiltro) {\r\n        const prefiltroValue = getInputValue(PREFILTER_SELECT_ID);\r\n        setInputValue(FILTRO_TIPO_INSTALADO_ID, prefiltroValue);\r\n        setInputValue(FILTRO_LOTE_SERIE_ID, 'LOTE-' + Math.floor(Math.random() * 9000 + 1000));\r\n    }\r\n\r\n    setCheckboxValue('softener-check-limpieza-tanque', Math.random() > 0.7);\r\n    setCheckboxValue('softener-check-nivel-agua', Math.random() > 0.3);\r\n    setCheckboxValue('softener-check-carga-sal', Math.random() > 0.4);\r\n    setCheckboxValue('softener-check-hora-correcta', Math.random() > 0.2);\r\n    setCheckboxValue('softener-check-parametros-ciclo', Math.random() > 0.3);\r\n    setCheckboxValue('softener-check-ajuste-autonomia', Math.random() > 0.5);\r\n    setCheckboxValue('softener-check-regeneracion-manual', Math.random() > 0.8);\r\n\r\n    setInputValue('softener-check-otros', '');\r\n    setInputValue('softener-check-observaciones', 'Sistema funcionando correctamente. Par├ímetros dentro de rango normal.');\r\n\r\n    // Secci├│n E - Resumen\r\n    const trabajos = [\r\n        'Mantenimiento preventivo completo. Verificaci├│n de ciclos y par├ímetros.',\r\n        'Cambio de prefiltro y ajuste de autonom├¡a seg├║n dureza detectada.',\r\n        'Servicio de rutina. Carga de sal y limpieza de tanque salero.',\r\n        'Calibraci├│n de cabezal y verificaci├│n de presiones del sistema.'\r\n    ];\r\n    setInputValue('softener-resumen-trabajo', trabajos[Math.floor(Math.random() * trabajos.length)]);\r\n\r\n    const recomendaciones = [\r\n        'Monitorear dureza de salida semanalmente.',\r\n        'Verificar nivel de sal mensualmente.',\r\n        'Pr├│ximo mantenimiento en 6 meses o seg├║n autonom├¡a.',\r\n        'Controlar presiones de entrada peri├│dicamente.'\r\n    ];\r\n    setInputValue('softener-resumen-recomendaciones', recomendaciones[Math.floor(Math.random() * recomendaciones.length)]);\r\n\r\n    // Pr├│ximo servicio: 6 meses\r\n    const nextService = new Date();\r\n    nextService.setMonth(nextService.getMonth() + 6);\r\n    setInputValue('softener-resumen-proximo-servicio', nextService.toISOString().split('T')[0]);\r\n\r\n    setInputValue('softener-resumen-materiales', 'Sal pellets x 25kg, Cartucho prefiltro 5┬Ám');\r\n    setInputValue('softener-resumen-notas-cliente', 'Cliente conforme con el servicio realizado.');\r\n\r\n    // Secci├│n F - Condiciones de Operaci├│n\r\n    const manometros = getInputValue(MANOMETRO_SELECT_ID);\r\n    if (manometros === 'Man├│metros IN/OUT') {\r\n        setInputValue('softener-presion-entrada-as-found', (Math.random() * 2 + 2).toFixed(2));\r\n        setInputValue('softener-presion-entrada-as-left', (Math.random() * 2 + 2).toFixed(2));\r\n        setInputValue('softener-presion-salida-as-found', (Math.random() * 1.5 + 1.5).toFixed(2));\r\n        setInputValue('softener-presion-salida-as-left', (Math.random() * 1.5 + 1.5).toFixed(2));\r\n    }\r\n\r\n    setSelectValue('softener-nivel-sal-as-found', ['Adecuado', 'Bajo', 'Alto'][Math.floor(Math.random() * 3)]);\r\n    setSelectValue('softener-nivel-sal-as-left', 'Adecuado');\r\n    setSelectValue('softener-temperatura-ambiente', ['Controlada', 'Alta (>30┬░C)', 'Variable'][Math.floor(Math.random() * 3)]);\r\n    setSelectValue('softener-estado-gabinete', ['├ôptimo', 'Bueno', 'Regular'][Math.floor(Math.random() * 3)]);\r\n\r\n    setInputValue('softener-param-test-cloro-found', (Math.random() * 2).toFixed(2));\r\n    setInputValue('softener-param-test-cloro-left', (Math.random() * 2).toFixed(2));\r\n    setInputValue('softener-param-dureza-salida-found', Math.floor(Math.random() * 30));\r\n    setInputValue('softener-param-dureza-salida-left', Math.floor(Math.random() * 20));\r\n\r\n    setInputValue('softener-condiciones-observaciones', 'Ambiente controlado. Sin exposici├│n a humedad excesiva.');\r\n\r\n    // Secci├│n G - Cierre\r\n    setSelectValue('softener-conformidad-cliente', ['Conforme', 'Con observaciones'][Math.floor(Math.random() * 2)]);\r\n    setInputValue('softener-representante-cliente', 'Responsable de Mantenimiento');\r\n    setSelectValue('softener-medio-confirmacion', ['Firma en sitio', 'Correo electr├│nico'][Math.floor(Math.random() * 2)]);\r\n    setCheckboxValue('softener-requiere-seguimiento', Math.random() > 0.7);\r\n    setInputValue('softener-observaciones-finales', 'Servicio completado satisfactoriamente.');\r\n\r\n    // Actualizar c├ílculos\r\n    updateAutonomia();\r\n    updateCabezalFrequencyState();\r\n    updatePrefiltroCambioVisibility();\r\n    updateManometroState();\r\n    updateDeltaP('found');\r\n    updateDeltaP('left');\r\n}\r\n\r\nfunction collectFormData() {\r\n    const reportNumber = generateSoftenerReportNumber();\r\n    const { id: clientId, name: clientName } = getClientSelection();\r\n\r\n    const metadata = {\r\n        formulario: 'mantenimiento_ablandador',\r\n        version: '3.1',\r\n        generado_en: new Date().toISOString(),\r\n        numero_reporte: reportNumber,\r\n    };\r\n\r\n    const seccionA = buildSection([\r\n        ['nombre', clientName],\r\n        ['direccion', getInputValue('softener-cliente-direccion')],\r\n        ['localidad', getInputValue('softener-cliente-localidad')],\r\n        ['contacto', getInputValue('softener-cliente-contacto')],\r\n        ['telefono', getInputValue('softener-cliente-telefono')],\r\n        ['email', getInputValue('softener-cliente-email')],\r\n        ['cuit', getInputValue('softener-cliente-cuit')],\r\n        ['fecha_servicio', normalizeDateValue(getInputValue('softener-fecha-servicio'))],\r\n        ['tecnico', getInputValue('softener-tecnico')],\r\n    ]);\r\n\r\n    const volumenResina = getNumberValue(VOLUMEN_RESINA_ID);\r\n    const durezaAguaCruda = getNumberValue(DUREZA_AGUA_CRUDA_ID);\r\n    const autonomiaRestante = getNumberValue(AUTONOMIA_RESTANTE_ID);\r\n    const autonomiaRecomendada = getNumberValue(AUTONOMIA_RECOMENDADA_ID);\r\n    const seteoActualAutonomia = getNumberValue(AUTONOMIA_SETEO_ACTUAL_ID);\r\n    const aplicarProteccion = getCheckboxValue(FACTOR_PROTECCION_ID);\r\n    const autonomiaAjustada = getCheckboxValue(AUTONOMIA_AJUSTADA_ID);\r\n\r\n    const presionEntradaAsFound = getNumberValue('softener-param-presion-entrada-found');\r\n    const presionEntradaAsLeft = getNumberValue('softener-param-presion-entrada-left');\r\n    const testCloroAsFound = getNumberValue('softener-param-test-cloro-found');\r\n    const testCloroAsLeft = getNumberValue('softener-param-test-cloro-left');\r\n    const durezaSalidaAsFound = getNumberValue('softener-param-dureza-salida-found');\r\n    const durezaSalidaAsLeft = getNumberValue('softener-param-dureza-salida-left');\r\n\r\n    // Obtener datos del tren de prefiltrado si est├í configurado\r\n    const trenPrefiltradoConfig = obtenerValoresTrenPrefiltrado();\r\n\r\n    const seccionB = buildSection([\r\n        ['tipo', getInputValue('softener-equipo-tipo')],\r\n        ['modelo', getInputValue('softener-equipo-modelo')],\r\n        ['numero_serie', getInputValue('softener-equipo-numero-serie')],\r\n        ['ubicacion', getInputValue('softener-equipo-ubicacion')],\r\n        ['volumen_resina', volumenResina],\r\n        ['notas_equipo', getInputValue('softener-equipo-notas')],\r\n        ['tipo_regeneracion', getInputValue(SECCION_B_TIPO_REGENERACION_ID)],\r\n        ['prefiltro', trenPrefiltradoConfig ? null : getInputValue('softener-equipo-prefiltro')],\r\n        ['tren_prefiltrado', trenPrefiltradoConfig],\r\n        ['proteccion_entrada', getInputValue(PROTECCION_ENTRADA_ID)],\r\n        ['manometros', getInputValue(MANOMETRO_SELECT_ID)],\r\n    ]);\r\n\r\n    const seccionBParametrosOperacion = buildSection([\r\n        ['presion_entrada_as_found', presionEntradaAsFound],\r\n        ['presion_entrada_as_left', presionEntradaAsLeft],\r\n        ['test_cloro_entrada_as_found', testCloroAsFound],\r\n        ['test_cloro_entrada_as_left', testCloroAsLeft],\r\n        ['dureza_salida_as_found', durezaSalidaAsFound],\r\n        ['dureza_salida_as_left', durezaSalidaAsLeft],\r\n    ]);\r\n\r\n    const seccionC = buildSection([\r\n        ['dureza_agua_cruda', durezaAguaCruda],\r\n        ['autonomia_restante', autonomiaRestante],\r\n        ['seteo_actual_autonomia', seteoActualAutonomia],\r\n        ['aplicar_proteccion_20', aplicarProteccion],\r\n        ['autonomia_recomendada', autonomiaRecomendada],\r\n        ['autonomia_ajustada_valor_calculado', autonomiaAjustada],\r\n    ]);\r\n\r\n    // Obtener datos de cambio de filtro (modo simple o tren)\r\n    const datosCambioFiltroTren = obtenerDatosCambioFiltroTren();\r\n    const esTrenPrefiltrado = datosCambioFiltroTren !== null;\r\n\r\n    const seccionD = buildSection([\r\n        // Inspecci├│n General\r\n        ['inspeccion_fugas', getCheckboxValue('softener-check-fugas')],\r\n        // Sistema de Prefiltraci├│n - modo simple\r\n        ['cambio_filtro_realizado', esTrenPrefiltrado ? false : getCheckboxValue(CHECK_CAMBIO_FILTRO_ID)],\r\n        ['filtro_tipo_instalado', esTrenPrefiltrado ? '' : getInputValue(FILTRO_TIPO_INSTALADO_ID)],\r\n        ['filtro_lote_serie', esTrenPrefiltrado ? '' : getInputValue(FILTRO_LOTE_SERIE_ID)],\r\n        // Sistema de Prefiltraci├│n - modo tren\r\n        ['tren_prefiltrado', datosCambioFiltroTren],\r\n        // Tanque Salero\r\n        ['limpieza_tanque_sal', getCheckboxValue('softener-check-limpieza-tanque')],\r\n        ['verificacion_nivel_agua', getCheckboxValue('softener-check-nivel-agua')],\r\n        ['carga_sal', getCheckboxValue('softener-check-carga-sal')],\r\n        // Cabezal (V├ílvula)\r\n        ['regeneracion_manual', getCheckboxValue('softener-check-regeneracion-manual')],\r\n        // Campos adicionales\r\n        ['otros', getInputValue('softener-check-otros')],\r\n        ['observaciones', getInputValue('softener-check-observaciones')],\r\n    ]);\r\n\r\n    const seccionE = buildSection([\r\n        ['trabajo_realizado', getInputValue('softener-resumen-trabajo')],\r\n        ['recomendaciones', getInputValue('softener-resumen-recomendaciones')],\r\n        ['proximo_servicio', normalizeDateValue(getInputValue('softener-resumen-proximo-servicio'))],\r\n        ['materiales', getInputValue('softener-resumen-materiales')],\r\n        ['comentarios_cliente', getInputValue('softener-resumen-notas-cliente')],\r\n    ]);\r\n\r\n    const seccionF = buildSection([\r\n        ['presion_entrada_as_found', getNumberValue('softener-presion-entrada-as-found')],\r\n        ['presion_entrada_as_left', getNumberValue('softener-presion-entrada-as-left')],\r\n        ['presion_salida_as_found', getNumberValue('softener-presion-salida-as-found')],\r\n        ['presion_salida_as_left', getNumberValue('softener-presion-salida-as-left')],\r\n        ['nivel_sal_as_found', getInputValue('softener-nivel-sal-as-found')],\r\n        ['nivel_sal_as_left', getInputValue('softener-nivel-sal-as-left')],\r\n        ['temperatura_ambiente', getInputValue('softener-temperatura-ambiente')],\r\n        ['estado_gabinete', getInputValue('softener-estado-gabinete')],\r\n        ['observaciones', getInputValue('softener-condiciones-observaciones')],\r\n    ]);\r\n\r\n    const seccionG = buildSection([\r\n        ['conformidad_cliente', getInputValue('softener-conformidad-cliente')],\r\n        ['representante_cliente', getInputValue('softener-representante-cliente')],\r\n        ['medio_confirmacion', getInputValue('softener-medio-confirmacion')],\r\n        ['requiere_seguimiento', getCheckboxValue('softener-requiere-seguimiento')],\r\n        ['observaciones_finales', getInputValue('softener-observaciones-finales')],\r\n    ]);\r\n\r\n    const payload = {\r\n        metadata,\r\n        // Campos en nivel superior para compatibilidad con remito\r\n        cliente: clientName,\r\n        direccion: seccionA.direccion,\r\n        cliente_telefono: seccionA.telefono,\r\n        cliente_email: seccionA.email,\r\n        cliente_cuit: seccionA.cuit,\r\n        numero_reporte: reportNumber,\r\n        // Secciones estructuradas\r\n        seccion_A_cliente: { ...seccionA, id: clientId },\r\n        seccion_B_equipo: seccionB,\r\n        seccion_C_parametros: seccionC,\r\n        seccion_D_checklist: seccionD,\r\n        seccion_E_resumen: seccionE,\r\n        seccion_F_condiciones: seccionF,\r\n        seccion_G_cierre: seccionG,\r\n    };\r\n\r\n    if (Object.keys(seccionBParametrosOperacion).length > 0) {\r\n        payload.seccion_B_parametros_operacion = seccionBParametrosOperacion;\r\n    }\r\n\r\n    const seccionCabezal = buildSection([\r\n        ['hora_cabezal_as_found', getInputValue(CABEZAL_HORA_CABEZAL_FOUND_ID)],\r\n        ['hora_cabezal_as_left', getInputValue(CABEZAL_HORA_CABEZAL_LEFT_ID)],\r\n        ['hora_regeneracion_as_found', getInputValue(CABEZAL_HORA_REGENERACION_FOUND_ID)],\r\n        ['hora_regeneracion_as_left', getInputValue(CABEZAL_HORA_REGENERACION_LEFT_ID)],\r\n\r\n        ['p1_retrolavado_min_found', getNumberValue(CABEZAL_P1_FOUND_ID)],\r\n        ['p1_retrolavado_min_left', getNumberValue(CABEZAL_P1_LEFT_ID)],\r\n        ['p2_salmuera_min_found', getNumberValue(CABEZAL_P2_FOUND_ID)],\r\n        ['p2_salmuera_min_left', getNumberValue(CABEZAL_P2_LEFT_ID)],\r\n        ['p3_enjuague_min_found', getNumberValue(CABEZAL_P3_FOUND_ID)],\r\n        ['p3_enjuague_min_left', getNumberValue(CABEZAL_P3_LEFT_ID)],\r\n        ['p4_llenado_salero_min_found', getNumberValue(CABEZAL_P4_FOUND_ID)],\r\n        ['p4_llenado_salero_min_left', getNumberValue(CABEZAL_P4_LEFT_ID)],\r\n        ['frecuencia_dias_found', getNumberValue(CABEZAL_FRECUENCIA_DIAS_FOUND_ID)],\r\n        ['frecuencia_dias_left', getNumberValue(CABEZAL_FRECUENCIA_DIAS_LEFT_ID)],\r\n    ]);\r\n\r\n    if (Object.keys(seccionCabezal).length > 0) {\r\n        payload.seccion_C_cabezal = seccionCabezal;\r\n    }\r\n\r\n    if (clientId) {\r\n        payload.client_id = clientId;\r\n        payload.clienteId = clientId;\r\n    }\r\n\r\n    return payload;\r\n}\r\n\r\nfunction updateAutonomia() {\r\n    const volumenResina = getNumberValue(VOLUMEN_RESINA_ID);\r\n    const durezaEntrada = getNumberValue(DUREZA_AGUA_CRUDA_ID);\r\n    const aplicarFactor = getCheckboxValue(FACTOR_PROTECCION_ID);\r\n\r\n    let autonomiaRecomendada = null;\r\n\r\n    if (volumenResina !== null && durezaEntrada !== null && durezaEntrada > 0) {\r\n        const durezaNormalizada = durezaEntrada / 10;\r\n        if (durezaNormalizada > 0) {\r\n            const resultado = (volumenResina * 6) / durezaNormalizada;\r\n            if (Number.isFinite(resultado)) {\r\n                autonomiaRecomendada = aplicarFactor ? resultado * 0.8 : resultado;\r\n            }\r\n        }\r\n    }\r\n\r\n    setNumericFieldValue(AUTONOMIA_RECOMENDADA_ID, autonomiaRecomendada);\r\n\r\n    // Validar dureza del agua cruda\r\n    validateDurezaAguaCruda(durezaEntrada);\r\n}\r\n\r\nfunction validateDurezaAguaCruda(dureza) {\r\n    const input = getElement(DUREZA_AGUA_CRUDA_ID);\r\n    const warning = getElement('softener-dureza-warning');\r\n\r\n    if (!input) return;\r\n\r\n    const isHigh = dureza !== null && dureza >= 650;\r\n\r\n    // Cambiar color del input\r\n    if (isHigh) {\r\n        input.classList.remove('border-gray-300', 'focus:border-emerald-500', 'focus:ring-emerald-200');\r\n        input.classList.add('border-red-500', 'focus:border-red-600', 'focus:ring-red-200', 'bg-red-50', 'dark:bg-red-900/20');\r\n    } else {\r\n        input.classList.remove('border-red-500', 'focus:border-red-600', 'focus:ring-red-200', 'bg-red-50', 'dark:bg-red-900/20');\r\n        input.classList.add('border-gray-300', 'focus:border-emerald-500', 'focus:ring-emerald-200');\r\n    }\r\n\r\n    // Mostrar/ocultar advertencia\r\n    if (warning) {\r\n        if (isHigh) {\r\n            warning.classList.remove('hidden');\r\n        } else {\r\n            warning.classList.add('hidden');\r\n        }\r\n    }\r\n}\r\n\r\n\r\nexport function createSoftenerModule(deps = {}) {\r\n    const {\r\n        showView,\r\n        guardarMantenimientoAblandador: guardarAblandadorCustom,\r\n        obtenerClientes: obtenerClientesCustom,\r\n        remitoModule,\r\n        onMaintenanceSaved,\r\n    } = deps;\r\n    let initialized = false;\r\n    let lastSavedPayload = null;\r\n    let isReportSaved = false; // Nuevo: controlar si el reporte est├í guardado\r\n    const guardarMantenimientoFn = typeof guardarAblandadorCustom === 'function'\r\n        ? guardarAblandadorCustom\r\n        : guardarMantenimientoAblandadorApi;\r\n    const obtenerClientesFn = typeof obtenerClientesCustom === 'function'\r\n        ? obtenerClientesCustom\r\n        : obtenerClientesApi;\r\n\r\n    // ===== CONTROL DE FLUJO DE BOTONES =====\r\n    function setButtonsToInitialState() {\r\n        // Estado inicial: formulario nuevo\r\n        const autofillButton = getElement(AUTOFILL_BUTTON_ID);\r\n        const resetButton = getElement(RESET_BUTTON_ID);\r\n        const saveButton = getElement(SAVE_BUTTON_ID);\r\n        const remitoButton = getElement(REMITO_BUTTON_ID);\r\n\r\n        if (autofillButton instanceof HTMLButtonElement) {\r\n            autofillButton.disabled = false;\r\n        }\r\n        if (resetButton instanceof HTMLButtonElement) {\r\n            resetButton.disabled = false;\r\n            resetButton.textContent = 'Limpiar Formulario';\r\n        }\r\n        if (saveButton instanceof HTMLButtonElement) {\r\n            saveButton.disabled = false;\r\n            saveButton.textContent = 'Guardar Mantenimiento';\r\n            saveButton.style.cursor = '';\r\n        }\r\n        if (remitoButton instanceof HTMLButtonElement) {\r\n            remitoButton.disabled = true;\r\n        }\r\n\r\n        isReportSaved = false;\r\n        lastSavedPayload = null;\r\n        lastSavedMaintenanceId = null;\r\n    }\r\n\r\n    function setButtonsToSavedState() {\r\n        // Estado guardado: reporte ya guardado\r\n        const autofillButton = getElement(AUTOFILL_BUTTON_ID);\r\n        const resetButton = getElement(RESET_BUTTON_ID);\r\n        const saveButton = getElement(SAVE_BUTTON_ID);\r\n        const remitoButton = getElement(REMITO_BUTTON_ID);\r\n\r\n        if (autofillButton instanceof HTMLButtonElement) {\r\n            autofillButton.disabled = true;\r\n        }\r\n        if (resetButton instanceof HTMLButtonElement) {\r\n            resetButton.disabled = false;\r\n            resetButton.textContent = 'Nuevo Reporte';\r\n        }\r\n        if (saveButton instanceof HTMLButtonElement) {\r\n            saveButton.disabled = true;\r\n            saveButton.textContent = 'Guardar Mantenimiento';\r\n            saveButton.style.cursor = 'not-allowed';\r\n        }\r\n        if (remitoButton instanceof HTMLButtonElement) {\r\n            remitoButton.disabled = false;\r\n        }\r\n\r\n        isReportSaved = true;\r\n    }\r\n    // ===== FIN CONTROL DE FLUJO =====\r\n\r\n\r\n    function attachAutonomiaListeners() {\r\n        const triggerIds = [\r\n            VOLUMEN_RESINA_ID,\r\n            DUREZA_AGUA_CRUDA_ID,\r\n        ];\r\n        triggerIds.forEach(id => {\r\n            const element = getElement(id);\r\n            if (element instanceof HTMLInputElement) {\r\n                element.addEventListener('input', updateAutonomia);\r\n            }\r\n        });\r\n\r\n        const factorCheckbox = getElement(FACTOR_PROTECCION_ID);\r\n        if (factorCheckbox instanceof HTMLInputElement) {\r\n            factorCheckbox.addEventListener('change', updateAutonomia);\r\n        }\r\n    }\r\n\r\n    function attachFormHandlers() {\r\n        const form = getElement(FORM_ID);\r\n        if (!(form instanceof HTMLFormElement)) {\r\n            return;\r\n        }\r\n\r\n        form.addEventListener('reset', () => {\r\n            schedulePostReset(() => {\r\n                resetClientSelection();\r\n                setDefaultServiceDate();\r\n                setDefaultResinVolume();\r\n                resetCabezalSection();\r\n                updateAutonomia();\r\n                updatePrefiltroCambioVisibility();\r\n            });\r\n        });\r\n\r\n        const saveButton = getElement(SAVE_BUTTON_ID);\r\n        if (saveButton instanceof HTMLButtonElement) {\r\n            saveButton.addEventListener('click', async event => {\r\n                event.preventDefault();\r\n                await handleSaveClick(saveButton);\r\n            });\r\n        }\r\n\r\n        const resetButton = getElement(RESET_BUTTON_ID);\r\n        if (resetButton instanceof HTMLButtonElement) {\r\n            resetButton.addEventListener('click', event => {\r\n                event.preventDefault();\r\n                handleResetOrNewReport();\r\n            });\r\n        }\r\n\r\n        const autofillButton = getElement(AUTOFILL_BUTTON_ID);\r\n        if (autofillButton instanceof HTMLButtonElement) {\r\n            autofillButton.addEventListener('click', event => {\r\n                event.preventDefault();\r\n                autoFillSoftenerForm();\r\n            });\r\n        }\r\n\r\n        const remitoButton = getElement(REMITO_BUTTON_ID);\r\n        if (remitoButton instanceof HTMLButtonElement) {\r\n            remitoButton.addEventListener('click', event => {\r\n                event.preventDefault();\r\n                handleRemitoClick();\r\n            });\r\n        }\r\n    }\r\n\r\n    function performFormReset() {\r\n        const form = getElement(FORM_ID);\r\n        if (!(form instanceof HTMLFormElement)) {\r\n            return;\r\n        }\r\n\r\n        // Ocultar overlay de formulario bloqueado\r\n        hideFormLockedOverlay();\r\n\r\n        // Limpiar formulario\r\n        form.reset();\r\n\r\n        setTimeout(() => {\r\n            setTechnicianFromLogin(); // Re-establecer t├®cnico desde login\r\n            resetClientSelection();\r\n            limpiarSeccionB(); // Limpiar secci├│n B y estado de equipos\r\n            setDefaultServiceDate();\r\n            setDefaultResinVolume();\r\n            resetCabezalSection();\r\n            updateAutonomia();\r\n            updatePrefiltroCambioVisibility();\r\n            setReportNumber('ABL-PENDIENTE');\r\n\r\n            // Volver al estado inicial\r\n            setButtonsToInitialState();\r\n        }, 0);\r\n    }\r\n\r\n    function handleResetOrNewReport() {\r\n        const form = getElement(FORM_ID);\r\n        if (!(form instanceof HTMLFormElement)) {\r\n            return;\r\n        }\r\n\r\n        if (isReportSaved) {\r\n            // Si el reporte est├í guardado, preguntar si quiere crear uno nuevo\r\n            const confirmNew = confirm('┬┐Quer├®s crear un nuevo reporte?\\n\\nSe limpiar├í el formulario actual.');\r\n            if (!confirmNew) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        performFormReset();\r\n    }\r\n\r\n    // Reset silencioso para usar al cambiar de tab\r\n    function silentReset() {\r\n        performFormReset();\r\n    }\r\n\r\n    function handleRemitoClick() {\r\n        if (!lastSavedPayload) {\r\n            alert('ÔÜá´©Å Primero deb├®s guardar el mantenimiento antes de generar el remito.');\r\n            return;\r\n        }\r\n\r\n        // Llamar directamente al m├®todo del m├│dulo de remito\r\n        if (remitoModule && typeof remitoModule.handleGenerarRemitoClick === 'function') {\r\n            remitoModule.handleGenerarRemitoClick();\r\n        } else {\r\n            alert('ÔÜá´©Å El m├│dulo de remito no est├í disponible.');\r\n        }\r\n    }\r\n\r\n    async function handleSaveClick(saveButton) {\r\n        const form = getElement(FORM_ID);\r\n        if (!(form instanceof HTMLFormElement)) {\r\n            alert('El formulario de mantenimiento de ablandador no est├í disponible.');\r\n            return;\r\n        }\r\n\r\n        updateAutonomia();\r\n\r\n        // Verificar y guardar/actualizar equipo antes de continuar\r\n        const { continuar, equipoId } = await verificarYGuardarEquipo();\r\n        if (!continuar) {\r\n            return; // El usuario cancel├│ o hubo un error con el equipo\r\n        }\r\n\r\n        const payload = collectFormData();\r\n\r\n        // Agregar referencia al equipo si existe\r\n        if (equipoId) {\r\n            payload.equipo_ablandador_id = equipoId;\r\n        }\r\n\r\n        if (typeof guardarMantenimientoFn !== 'function') {\r\n            alert('Servicio de mantenimiento de ablandador no disponible.');\r\n            return;\r\n        }\r\n\r\n        // Guardar datos pendientes y abrir modal de firmas\r\n        pendingFormData = payload;\r\n\r\n        // Obtener nombre del t├®cnico del formulario si existe\r\n        const tecnicoInput = getElement('softener-tecnico') || document.querySelector('[name=\"tecnico\"]');\r\n        const technicianName = tecnicoInput?.value || '';\r\n\r\n        // Crear o abrir modal de firmas\r\n        if (!signatureModal) {\r\n            signatureModal = new SignatureModal({\r\n                onComplete: handleSignaturesComplete,\r\n                onCancel: handleSignaturesCancel,\r\n                technicianName: technicianName\r\n            });\r\n        }\r\n\r\n        signatureModal.open(technicianName);\r\n    }\r\n\r\n    async function handleSignaturesComplete(signatures) {\r\n        const saveButton = getElement(SAVE_BUTTON_ID);\r\n        if (!saveButton || !pendingFormData) {\r\n            return;\r\n        }\r\n\r\n        const originalText = saveButton.textContent;\r\n        saveButton.textContent = 'Guardando...';\r\n        saveButton.disabled = true;\r\n\r\n        try {\r\n            // Agregar firmas a los datos del formulario\r\n            pendingFormData.firmas = {\r\n                tecnico: {\r\n                    imagen: signatures.technician.image,\r\n                    nombre: signatures.technician.name,\r\n                    fecha: signatures.technician.timestamp\r\n                },\r\n                cliente: {\r\n                    imagen: signatures.client.image,\r\n                    nombre: signatures.client.name,\r\n                    fecha: signatures.client.timestamp\r\n                }\r\n            };\r\n\r\n            const result = await guardarMantenimientoFn({ payload: pendingFormData });\r\n            const maintenanceId = result?.maintenanceId || result?.id || result?.data?.id || null;\r\n            if (maintenanceId) {\r\n                pendingFormData.maintenanceId = maintenanceId;\r\n                lastSavedMaintenanceId = maintenanceId;\r\n            }\r\n\r\n            // Actualizar el n├║mero de reporte en pantalla\r\n            const reportNumber = pendingFormData.metadata?.numero_reporte || 'ABL-PENDIENTE';\r\n            setReportNumber(reportNumber);\r\n\r\n            // Guardar el payload para poder generar el PDF\r\n            lastSavedPayload = pendingFormData;\r\n\r\n            // Notificar al m├│dulo de remito que hay un nuevo reporte guardado\r\n            if (typeof onMaintenanceSaved === 'function') {\r\n                onMaintenanceSaved(pendingFormData);\r\n            }\r\n\r\n            // Limpiar datos pendientes\r\n            pendingFormData = null;\r\n\r\n            // Restaurar texto del bot├│n antes de cambiar al estado guardado\r\n            saveButton.textContent = originalText;\r\n\r\n            // Cambiar al estado \"guardado\"\r\n            setButtonsToSavedState();\r\n\r\n            // Mostrar overlay de formulario bloqueado\r\n            showFormLockedOverlay();\r\n\r\n            alert(`Ô£à Mantenimiento de ablandador guardado correctamente con firmas.\\n\\nReporte N┬░: ${reportNumber}\\n\\nAhora pod├®s generar el PDF o el Remito.\\nPara crear un nuevo reporte, hac├® clic en \"Nuevo Reporte\".`);\r\n        } catch (error) {\r\n            console.error('Error al guardar mantenimiento de ablandador:', error);\r\n            const message = error?.message || 'No se pudieron guardar los datos del mantenimiento.';\r\n            alert(`ÔØî Error al guardar los datos: ${message}`);\r\n            // Restaurar el bot├│n solo si hubo error\r\n            saveButton.disabled = false;\r\n            saveButton.textContent = originalText;\r\n        }\r\n    }\r\n\r\n    function handleSignaturesCancel() {\r\n        pendingFormData = null;\r\n        // El usuario cancel├│, no hacer nada m├ís\r\n    }\r\n\r\n    // Establecer el t├®cnico asignado desde el usuario logueado\r\n    function setTechnicianFromLogin() {\r\n        const tecnicoInput = getElement('softener-tecnico');\r\n        if (tecnicoInput && tecnicoInput instanceof HTMLInputElement) {\r\n            const userName = getCurrentUserName();\r\n            if (userName) {\r\n                tecnicoInput.value = userName;\r\n                // Hacer el campo readonly para evitar edici├│n manual\r\n                tecnicoInput.readOnly = true;\r\n                tecnicoInput.classList.add('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed');\r\n            }\r\n        }\r\n    }\r\n\r\n    function ensureInitialized() {\r\n        if (initialized) {\r\n            return;\r\n        }\r\n        const form = getElement(FORM_ID);\r\n        if (!(form instanceof HTMLFormElement)) {\r\n            return;\r\n        }\r\n        setTechnicianFromLogin();\r\n        setDefaultServiceDate();\r\n        setDefaultResinVolume();\r\n        updateAutonomia();\r\n        updatePrefiltroCambioVisibility();\r\n\r\n        // Cargar clientes y luego inicializar autocomplete\r\n        loadClientes(obtenerClientesFn).then(() => {\r\n            initializeClientAutocomplete();\r\n        });\r\n\r\n        attachAutonomiaListeners();\r\n        attachCabezalListeners();\r\n        attachPrefilterInfoListeners();\r\n        attachTrenPrefiltradoListeners();\r\n        attachProtectionInfoListeners();\r\n        attachManometroInfoListeners();\r\n        attachAutonomiaRestanteInfoListeners();\r\n        attachPrefiltroCambioListeners();\r\n        attachManometroListeners();\r\n        attachDeltaPListeners();\r\n        resetCabezalSection();\r\n        attachFormHandlers();\r\n\r\n        // Establecer estado inicial de botones\r\n        setButtonsToInitialState();\r\n\r\n        // Inicializar Sistema de Validaci├│n Est├ítica\r\n        initSoftenerValidation(FORM_ID);\r\n\r\n        initialized = true;\r\n    }\r\n\r\n    function initialize() {\r\n        ensureInitialized();\r\n    }\r\n\r\n    function show() {\r\n        ensureInitialized();\r\n        if (typeof showView === 'function') {\r\n            showView(SOFTENER_VIEW_ID);\r\n        }\r\n    }\r\n\r\n    return {\r\n        initialize,\r\n        show,\r\n        reset: handleResetOrNewReport,\r\n        silentReset,\r\n    };\r\n}\r\n\r\nexport default createSoftenerModule;\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\mantenimiento-ablandador\\ablandador.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\mantenimiento-ablandador\\collectForm.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\mantenimiento-ablandador\\softenerValidationUI.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\mantenimiento-ablandador\\softenerValidator.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'isElementVisible' is defined but never used.","line":30,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":26},{"ruleId":"no-unused-vars","severity":2,"message":"'checkFugas' is assigned a value but never used.","line":522,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":522,"endColumn":21}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Sistema de Validaci├│n Est├ítica para Formulario de Ablandadores\r\n * Lee campos directamente del DOM y retorna alertas en tiempo real.\r\n */\r\n\r\n// =========================================================================\r\n// UTILIDADES\r\n// =========================================================================\r\n\r\nfunction getInputValue(id) {\r\n    const el = document.getElementById(id);\r\n    return el?.value?.trim() || '';\r\n}\r\n\r\nfunction getNumberValue(id) {\r\n    const val = parseFloat(getInputValue(id));\r\n    return isNaN(val) ? null : val;\r\n}\r\n\r\nfunction getSelectValue(id) {\r\n    const el = document.getElementById(id);\r\n    return el?.value || '';\r\n}\r\n\r\nfunction isCheckboxChecked(id) {\r\n    const el = document.getElementById(id);\r\n    return el instanceof HTMLInputElement && el.checked;\r\n}\r\n\r\nfunction isElementVisible(id) {\r\n    const el = document.getElementById(id);\r\n    if (!el) return false;\r\n    // Verificar si est├í visible (no tiene clase hidden y no est├í oculto por CSS)\r\n    const container = el.closest('[class*=\"hidden\"]');\r\n    return !container;\r\n}\r\n\r\n// =========================================================================\r\n// REGLAS DE VALIDACI├ôN\r\n// =========================================================================\r\n\r\n/**\r\n * Ejecuta todas las reglas y retorna un array de alertas\r\n * @returns {Array<{type: 'error'|'warning'|'tip', message: string, fieldId?: string}>}\r\n */\r\nexport function validateSoftenerForm() {\r\n    const alerts = [];\r\n\r\n    // -------------------------------------------------------------------------\r\n    // ­ƒÜ¿ ERRORES CR├ìTICOS (Bloquean guardado)\r\n    // -------------------------------------------------------------------------\r\n\r\n    // 1. Cliente obligatorio\r\n    const clienteNombre = getInputValue('softener-cliente-nombre') || getInputValue('softener-cliente-search');\r\n    if (!clienteNombre) {\r\n        alerts.push({\r\n            type: 'error',\r\n            message: 'Seleccion├í un cliente antes de guardar.',\r\n            fieldId: 'softener-cliente-search'\r\n        });\r\n    }\r\n\r\n    // 2. Fecha de servicio obligatoria\r\n    const fechaServicio = getInputValue('softener-fecha-servicio');\r\n    if (!fechaServicio) {\r\n        alerts.push({\r\n            type: 'error',\r\n            message: 'Indic├í la fecha del servicio.',\r\n            fieldId: 'softener-fecha-servicio'\r\n        });\r\n    }\r\n\r\n    // 3. Presi├│n salida > entrada (solo si hay man├│metros)\r\n    const tieneManometros = getSelectValue('softener-equipo-manometros');\r\n    const presionesVisibles = tieneManometros && tieneManometros !== 'No cuenta con man├│metros';\r\n\r\n    if (presionesVisibles) {\r\n        const presionEntradaLeft = getNumberValue('softener-presion-entrada-as-left');\r\n        const presionSalidaLeft = getNumberValue('softener-presion-salida-as-left');\r\n\r\n        if (presionEntradaLeft !== null && presionSalidaLeft !== null) {\r\n            if (presionSalidaLeft > presionEntradaLeft) {\r\n                alerts.push({\r\n                    type: 'error',\r\n                    message: `La presi├│n de salida (${presionSalidaLeft} bar) no puede ser mayor que la de entrada (${presionEntradaLeft} bar).`,\r\n                    fieldId: 'softener-presion-salida-as-left'\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // ÔÜá´©Å ADVERTENCIAS (Alertan pero no bloquean)\r\n    // -------------------------------------------------------------------------\r\n\r\n    // 4. Nivel de sal bajo al irse\r\n    const nivelSalLeft = getSelectValue('softener-nivel-sal-as-left');\r\n    if (nivelSalLeft === 'Bajo' || nivelSalLeft === 'Cr├¡tico') {\r\n        alerts.push({\r\n            type: 'warning',\r\n            message: `El nivel de sal qued├│ \"${nivelSalLeft}\". Record├í al cliente que debe reponer.`,\r\n            fieldId: 'softener-nivel-sal-as-left'\r\n        });\r\n    }\r\n\r\n    // 5. Dureza de salida alta\r\n    const durezaSalidaLeft = getNumberValue('softener-param-dureza-salida-left');\r\n    if (durezaSalidaLeft !== null && durezaSalidaLeft > 10) {\r\n        alerts.push({\r\n            type: 'warning',\r\n            message: `La dureza de salida (${durezaSalidaLeft} ppm) es alta. El ablandador podr├¡a no estar regenerando correctamente.`,\r\n            fieldId: 'softener-param-dureza-salida-left'\r\n        });\r\n    }\r\n\r\n    // 6. Alta ca├¡da de presi├│n (╬öP > 1 bar)\r\n    if (presionesVisibles) {\r\n        const pEntrada = getNumberValue('softener-presion-entrada-as-left');\r\n        const pSalida = getNumberValue('softener-presion-salida-as-left');\r\n\r\n        if (pEntrada !== null && pSalida !== null && pEntrada > pSalida) {\r\n            const deltaP = pEntrada - pSalida;\r\n            if (deltaP > 1.0) {\r\n                alerts.push({\r\n                    type: 'warning',\r\n                    message: `La ca├¡da de presi├│n (╬öP = ${deltaP.toFixed(2)} bar) es alta. Puede indicar obstrucci├│n.`,\r\n                    fieldId: 'softener-deltaP-left'\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    // 7. Dureza de entrada muy alta (l├¡mite de aplicaci├│n para ablandadores)\r\n    const durezaEntrada = getNumberValue('softener-dureza-agua-cruda');\r\n    if (durezaEntrada !== null && durezaEntrada >= 650) {\r\n        alerts.push({\r\n            type: 'error',\r\n            message: `ÔÜá´©Å Dureza del agua (${durezaEntrada} ppm) EXCEDE el l├¡mite de aplicaci├│n para ablandadores (650 ppm). El sistema puede no funcionar correctamente.`,\r\n            fieldId: 'softener-dureza-agua-cruda'\r\n        });\r\n    }\r\n\r\n    // 8. Seteo de autonom├¡a debe coincidir con la recomendada (con o sin factor 20%)\r\n    const autonomiaRecomendada = getNumberValue('softener-autonomia-recomendada');\r\n    const autonomiaSeteo = getNumberValue('softener-autonomia-seteo-actual');\r\n    const factorProteccion = isCheckboxChecked('softener-factor-proteccion');\r\n\r\n    if (autonomiaSeteo !== null && autonomiaRecomendada !== null && autonomiaRecomendada > 0) {\r\n        // Calcular los valores v├ílidos (con y sin factor de protecci├│n)\r\n        // Nota: autonomiaRecomendada ya tiene aplicado el factor si est├í tildado\r\n        // Necesitamos calcular el valor sin factor si est├í aplicado, y viceversa\r\n        const valorConFactor = factorProteccion ? autonomiaRecomendada : autonomiaRecomendada * 0.8;\r\n        const valorSinFactor = factorProteccion ? autonomiaRecomendada / 0.8 : autonomiaRecomendada;\r\n\r\n        // Tolerancia del 5% para redondeos\r\n        const tolerancia = 0.05;\r\n        const matchSinFactor = Math.abs(autonomiaSeteo - valorSinFactor) / valorSinFactor <= tolerancia;\r\n        const matchConFactor = Math.abs(autonomiaSeteo - valorConFactor) / valorConFactor <= tolerancia;\r\n\r\n        if (!matchSinFactor && !matchConFactor) {\r\n            alerts.push({\r\n                type: 'warning',\r\n                message: `El seteo actual (${autonomiaSeteo} m┬│) no coincide con la autonom├¡a recomendada. Esperado: ~${autonomiaRecomendada.toFixed(1)} m┬│${factorProteccion ? '' : ` o ~${valorConFactor.toFixed(1)} m┬│ (con 20% protecci├│n)`}.`,\r\n                fieldId: 'softener-autonomia-seteo-actual'\r\n            });\r\n        }\r\n    }\r\n\r\n    // 9. Configuraci├│n del cabezal modificada (As Found Ôëá As Left) - Requiere justificaci├│n\r\n    // Excluye: hora del cabezal y hora de regeneraci├│n (esos son ajustes normales)\r\n    // Incluye: P1-P4 y frecuencia en d├¡as\r\n    const observacionesAdicionales = getInputValue('softener-condiciones-observaciones');\r\n    const cambiosCabezal = [];\r\n\r\n    // Verificar tiempos de ciclo P1-P4\r\n    const ciclosNames = ['P1 Retrolavado', 'P2 Salmuera', 'P3 Enjuague', 'P4 Llenado salero'];\r\n    for (let i = 1; i <= 4; i++) {\r\n        const found = getNumberValue(`softener-cabezal-p${i}-found`);\r\n        const left = getNumberValue(`softener-cabezal-p${i}-left`);\r\n        if (found !== null && left !== null && found !== left) {\r\n            cambiosCabezal.push(`${ciclosNames[i - 1]}: ${found} ÔåÆ ${left} min`);\r\n        }\r\n    }\r\n\r\n    // Verificar frecuencia en d├¡as (solo si regeneraci├│n por tiempo)\r\n    const tipoRegeneracion = getSelectValue('softener-equipo-regeneracion-tipo');\r\n    if (tipoRegeneracion === 'Por Tiempo') {\r\n        const frecFound = getNumberValue('softener-cabezal-frecuencia-dias-found');\r\n        const frecLeft = getNumberValue('softener-cabezal-frecuencia-dias-left');\r\n        if (frecFound !== null && frecLeft !== null && frecFound !== frecLeft) {\r\n            cambiosCabezal.push(`Frecuencia: ${frecFound} ÔåÆ ${frecLeft} d├¡as`);\r\n        }\r\n    }\r\n\r\n    // Si hay cambios en la configuraci├│n del cabezal\r\n    if (cambiosCabezal.length > 0) {\r\n        if (!observacionesAdicionales) {\r\n            // Error si no hay observaciones\r\n            alerts.push({\r\n                type: 'error',\r\n                message: `Se modific├│ la configuraci├│n del cabezal (${cambiosCabezal.join(', ')}). Justific├í el cambio en \"F. Observaciones adicionales\".`,\r\n                fieldId: 'softener-condiciones-observaciones'\r\n            });\r\n        } else {\r\n            // Solo informativo si ya hay observaciones\r\n            alerts.push({\r\n                type: 'tip',\r\n                message: `Cambios en cabezal: ${cambiosCabezal.join(', ')}. Verific├í que est├® documentado.`,\r\n                fieldId: 'softener-cabezal-p1-left'\r\n            });\r\n        }\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // ­ƒÆí TIPS / SUGERENCIAS\r\n    // -------------------------------------------------------------------------\r\n\r\n    // 10. Trabajo realizado vac├¡o\r\n    const trabajoRealizado = getInputValue('softener-resumen-trabajo');\r\n    if (!trabajoRealizado) {\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: 'Complet├í el campo \"Trabajo realizado\" antes de guardar.',\r\n            fieldId: 'softener-resumen-trabajo'\r\n        });\r\n    }\r\n\r\n    // 11. Sin checklist marcado\r\n    const checkboxIds = [\r\n        'softener-check-fugas',\r\n        'softener-check-limpieza-tanque',\r\n        'softener-check-nivel-agua',\r\n        'softener-check-carga-sal',\r\n        'softener-check-regeneracion-manual',\r\n        'softener-check-cambio-filtro'\r\n    ];\r\n    const algunoMarcado = checkboxIds.some(id => isCheckboxChecked(id));\r\n    if (!algunoMarcado) {\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: '┬┐No realizaste ninguna tarea? Marc├í al menos un ├¡tem del checklist.',\r\n            fieldId: 'softener-check-fugas'\r\n        });\r\n    }\r\n\r\n    // 12. Regeneraci├│n manual sin observaciones\r\n    const regeneracionManual = isCheckboxChecked('softener-check-regeneracion-manual');\r\n    const observaciones = getInputValue('softener-condiciones-observaciones');\r\n    if (regeneracionManual && !observaciones) {\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: 'Indicaste regeneraci├│n manual. Consider├í agregar el motivo en observaciones.',\r\n            fieldId: 'softener-condiciones-observaciones'\r\n        });\r\n    }\r\n\r\n    // 13. Pr├│ximo servicio sin fecha\r\n    const proximoServicio = getInputValue('softener-resumen-proximo-servicio');\r\n    if (!proximoServicio) {\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: 'Consider├í programar la fecha del pr├│ximo servicio.',\r\n            fieldId: 'softener-resumen-proximo-servicio'\r\n        });\r\n    }\r\n\r\n    // =========================================================================\r\n    // SECCI├ôN A: Cliente y Servicio\r\n    // =========================================================================\r\n\r\n    // 14. Email con formato inv├ílido\r\n    const email = getInputValue('softener-cliente-email');\r\n    if (email && !email.match(/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/)) {\r\n        alerts.push({\r\n            type: 'warning',\r\n            message: 'El formato del correo electr├│nico parece incorrecto.',\r\n            fieldId: 'softener-cliente-email'\r\n        });\r\n    }\r\n\r\n    // 15. CUIT con formato inv├ílido (XX-XXXXXXXX-X)\r\n    const cuit = getInputValue('softener-cliente-cuit');\r\n    if (cuit && !cuit.match(/^\\d{2}-\\d{7,8}-\\d$/)) {\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: 'El CUIT deber├¡a tener formato XX-XXXXXXXX-X.',\r\n            fieldId: 'softener-cliente-cuit'\r\n        });\r\n    }\r\n\r\n    // 16. T├®cnico no asignado\r\n    const tecnico = getInputValue('softener-tecnico');\r\n    if (!tecnico) {\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: 'Indic├í el t├®cnico responsable del servicio.',\r\n            fieldId: 'softener-tecnico'\r\n        });\r\n    }\r\n\r\n    // =========================================================================\r\n    // SECCI├ôN B: Informaci├│n del Ablandador\r\n    // =========================================================================\r\n\r\n    // 17. Volumen de resina fuera de rango t├¡pico\r\n    const volumenResina = getNumberValue('softener-volumen-resina');\r\n    if (volumenResina !== null) {\r\n        if (volumenResina < 5) {\r\n            alerts.push({\r\n                type: 'warning',\r\n                message: `El volumen de resina (${volumenResina}L) es muy bajo. ┬┐Es correcto?`,\r\n                fieldId: 'softener-volumen-resina'\r\n            });\r\n        } else if (volumenResina > 500) {\r\n            alerts.push({\r\n                type: 'warning',\r\n                message: `El volumen de resina (${volumenResina}L) es muy alto. Verific├í el valor.`,\r\n                fieldId: 'softener-volumen-resina'\r\n            });\r\n        }\r\n    }\r\n\r\n    // 18. Prefiltro seleccionado pero sin cambio de filtro marcado\r\n    const prefiltro = getSelectValue('softener-equipo-prefiltro');\r\n    const cambioFiltro = isCheckboxChecked('softener-check-cambio-filtro');\r\n    if (prefiltro && prefiltro !== 'No Aplica' && !cambioFiltro) {\r\n        // Solo sugerir si el equipo tiene prefiltro pero no se marc├│ cambio\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: 'El equipo tiene prefiltro configurado. ┬┐Corresponde cambiar el filtro?',\r\n            fieldId: 'softener-check-cambio-filtro'\r\n        });\r\n    }\r\n\r\n    // 19. Sin protecci├│n de entrada instalada\r\n    const proteccionEntrada = getSelectValue('softener-equipo-proteccion-entrada');\r\n    if (proteccionEntrada === 'Sin Protecci├│n') {\r\n        alerts.push({\r\n            type: 'warning',\r\n            message: 'El equipo no tiene protecci├│n de entrada. Recomend├í instalar VRP.',\r\n            fieldId: 'softener-equipo-proteccion-entrada'\r\n        });\r\n    }\r\n\r\n    // =========================================================================\r\n    // SECCI├ôN C: Cabezal y Autonom├¡a\r\n    // =========================================================================\r\n\r\n    // 20. Hora del cabezal no configurada (As Left)\r\n    const horaCabezalLeft = getInputValue('softener-cabezal-hora-cabezal-left');\r\n    const horaRegenLeft = getInputValue('softener-cabezal-hora-regeneracion-left');\r\n    if (!horaCabezalLeft || !horaRegenLeft) {\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: 'Complet├í las horas del cabezal (As Left) para documentar la configuraci├│n final.',\r\n            fieldId: 'softener-cabezal-hora-cabezal-left'\r\n        });\r\n    }\r\n\r\n    // 21. Hora de regeneraci├│n en horario pico (6-22hs)\r\n    if (horaRegenLeft) {\r\n        const [hora] = horaRegenLeft.split(':').map(Number);\r\n        if (hora >= 6 && hora <= 22) {\r\n            alerts.push({\r\n                type: 'tip',\r\n                message: `La regeneraci├│n est├í programada a las ${horaRegenLeft}. Considerar horario nocturno (02:00-04:00).`,\r\n                fieldId: 'softener-cabezal-hora-regeneracion-left'\r\n            });\r\n        }\r\n    }\r\n\r\n    // 22. Tiempos de ciclo fuera de rango t├¡pico\r\n    for (let i = 1; i <= 4; i++) {\r\n        const left = getNumberValue(`softener-cabezal-p${i}-left`);\r\n        if (left !== null) {\r\n            const limites = {\r\n                1: { min: 5, max: 30, nombre: 'Retrolavado' },\r\n                2: { min: 30, max: 90, nombre: 'Salmuera' },\r\n                3: { min: 5, max: 20, nombre: 'Enjuague' },\r\n                4: { min: 3, max: 15, nombre: 'Llenado salero' }\r\n            };\r\n            const limite = limites[i];\r\n            if (left < limite.min || left > limite.max) {\r\n                alerts.push({\r\n                    type: 'warning',\r\n                    message: `P${i} ${limite.nombre} (${left} min) est├í fuera del rango t├¡pico (${limite.min}-${limite.max} min).`,\r\n                    fieldId: `softener-cabezal-p${i}-left`\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    // 23. Autonom├¡a restante muy baja con dureza alta encontrada\r\n    const autonomiaRestante = getNumberValue('softener-autonomia-restante');\r\n    const durezaSalidaFound = getNumberValue('softener-param-dureza-salida-found');\r\n    if (autonomiaRestante !== null && autonomiaRestante > 5 && durezaSalidaFound !== null && durezaSalidaFound > 20) {\r\n        alerts.push({\r\n            type: 'warning',\r\n            message: `Dureza de salida alta (${durezaSalidaFound} ppm) con autonom├¡a restante (${autonomiaRestante} m┬│). Posible problema con la resina.`,\r\n            fieldId: 'softener-param-dureza-salida-found'\r\n        });\r\n    }\r\n\r\n    // 24. Se ajust├│ autonom├¡a pero no se marc├│ el checkbox\r\n    const autonomiaAjustada = isCheckboxChecked('softener-autonomia-ajustada');\r\n    if (autonomiaRecomendada !== null && autonomiaSeteo !== null &&\r\n        Math.abs(autonomiaRecomendada - autonomiaSeteo) > 0.5 && !autonomiaAjustada) {\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: 'El seteo difiere de la recomendaci├│n. ┬┐Ajustaste la autonom├¡a en el cabezal?',\r\n            fieldId: 'softener-autonomia-ajustada'\r\n        });\r\n    }\r\n\r\n    // =========================================================================\r\n    // SECCI├ôN F: Condiciones de Operaci├│n\r\n    // =========================================================================\r\n\r\n    // 25. Cloro alto en entrada (problema para la resina)\r\n    const cloroFound = getNumberValue('softener-param-test-cloro-found');\r\n    if (cloroFound !== null && cloroFound > 0.5) {\r\n        alerts.push({\r\n            type: 'warning',\r\n            message: `El cloro de entrada (${cloroFound} ppm) es alto. Puede da├▒ar la resina. Verificar prefiltro de carb├│n.`,\r\n            fieldId: 'softener-param-test-cloro-found'\r\n        });\r\n    }\r\n\r\n    // 26. Estado del gabinete cr├¡tico\r\n    const estadoGabinete = getSelectValue('softener-estado-gabinete');\r\n    if (estadoGabinete === 'Cr├¡tico' || estadoGabinete === 'Regular') {\r\n        alerts.push({\r\n            type: 'warning',\r\n            message: `El estado del gabinete es \"${estadoGabinete}\". Document├í las condiciones en observaciones.`,\r\n            fieldId: 'softener-estado-gabinete'\r\n        });\r\n    }\r\n\r\n    // 27. Presiones As Found sin completar (si hay man├│metros)\r\n    if (presionesVisibles) {\r\n        const presionEntradaFound = getNumberValue('softener-presion-entrada-as-found');\r\n        const presionSalidaFound = getNumberValue('softener-presion-salida-as-found');\r\n        if (presionEntradaFound === null || presionSalidaFound === null) {\r\n            alerts.push({\r\n                type: 'tip',\r\n                message: 'Complet├í las presiones \"As Found\" antes del mantenimiento.',\r\n                fieldId: 'softener-presion-entrada-as-found'\r\n            });\r\n        }\r\n    }\r\n\r\n    // =========================================================================\r\n    // SECCI├ôN G: Cierre y Confirmaci├│n\r\n    // =========================================================================\r\n\r\n    // 28. Conformidad del cliente no indicada\r\n    const conformidad = getSelectValue('softener-conformidad-cliente');\r\n    if (!conformidad) {\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: 'Indic├í la conformidad del cliente antes de cerrar el servicio.',\r\n            fieldId: 'softener-conformidad-cliente'\r\n        });\r\n    }\r\n\r\n    // 29. Firma en sitio sin representante\r\n    const medioConfirmacion = getSelectValue('softener-medio-confirmacion');\r\n    const representante = getInputValue('softener-representante-cliente');\r\n    if (medioConfirmacion === 'Firma en sitio' && !representante) {\r\n        alerts.push({\r\n            type: 'warning',\r\n            message: 'Seleccionaste \"Firma en sitio\" pero no indicaste el nombre del representante.',\r\n            fieldId: 'softener-representante-cliente'\r\n        });\r\n    }\r\n\r\n    // 30. Cliente no conforme sin observaciones\r\n    const observacionesFinales = getInputValue('softener-observaciones-finales');\r\n    if ((conformidad === 'Con observaciones' || conformidad === 'No conforme') && !observacionesFinales) {\r\n        alerts.push({\r\n            type: 'error',\r\n            message: `El cliente est├í \"${conformidad}\". Document├í el motivo en observaciones finales.`,\r\n            fieldId: 'softener-observaciones-finales'\r\n        });\r\n    }\r\n\r\n    // 31. Requiere seguimiento sin especificar qu├®\r\n    const requiereSeguimiento = isCheckboxChecked('softener-requiere-seguimiento');\r\n    if (requiereSeguimiento && !observacionesFinales) {\r\n        alerts.push({\r\n            type: 'warning',\r\n            message: 'Marcaste que requiere seguimiento. Especific├í qu├® acciones en observaciones finales.',\r\n            fieldId: 'softener-observaciones-finales'\r\n        });\r\n    }\r\n\r\n    // =========================================================================\r\n    // REGLAS DE COHERENCIA ENTRE SECCIONES\r\n    // =========================================================================\r\n\r\n    // 32. Cambio de filtro marcado pero sin materiales\r\n    const materiales = getInputValue('softener-resumen-materiales');\r\n    if (cambioFiltro && !materiales) {\r\n        alerts.push({\r\n            type: 'tip',\r\n            message: 'Marcaste cambio de filtro. Registr├í el material usado en \"Materiales/repuestos\".',\r\n            fieldId: 'softener-resumen-materiales'\r\n        });\r\n    }\r\n\r\n    // 33. Carga de sal marcada pero nivel sigue bajo\r\n    const cargaSal = isCheckboxChecked('softener-check-carga-sal');\r\n    if (cargaSal && (nivelSalLeft === 'Bajo' || nivelSalLeft === 'Cr├¡tico')) {\r\n        alerts.push({\r\n            type: 'warning',\r\n            message: 'Marcaste \"Carga de sal\" pero el nivel qued├│ bajo. ┬┐Fue suficiente?',\r\n            fieldId: 'softener-nivel-sal-as-left'\r\n        });\r\n    }\r\n\r\n    // 34. Inspecci├│n de fugas marcada - verificar que no haya fugas left\r\n    const checkFugas = isCheckboxChecked('softener-check-fugas');\r\n    // (No hay campo de fugas As Left en el form actual, pero se podr├¡a agregar)\r\n\r\n    return alerts;\r\n}\r\n\r\n/**\r\n * Verifica si hay errores cr├¡ticos (bloquean guardado)\r\n */\r\nexport function hasBlockingErrors() {\r\n    const alerts = validateSoftenerForm();\r\n    return alerts.some(a => a.type === 'error');\r\n}\r\n\r\n/**\r\n * Obtiene solo los errores cr├¡ticos\r\n */\r\nexport function getBlockingErrors() {\r\n    const alerts = validateSoftenerForm();\r\n    return alerts.filter(a => a.type === 'error');\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\mantenimiento\\forms.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'CLIENT_OPTION_ATTRIBUTE' is assigned a value but never used.","line":11,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":30},{"ruleId":"no-unused-vars","severity":2,"message":"'clienteSelectChangeHandler' is assigned a value but never used.","line":106,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":106,"endColumn":31},{"ruleId":"no-unused-vars","severity":2,"message":"'updateClientDetailsFromSelect' is defined but never used.","line":497,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":497,"endColumn":39}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as config from '../../config.js';\r\nimport { getCurrentUserName } from '../login/auth.js';\r\nimport { getEquiposByCliente } from '../admin/sistemasEquipos.js';\r\nconst { LMIN_TO_GPD = (60 * 24) / 3.78541, LMIN_TO_LPH = 60 } = config;\r\nimport { COMPONENT_STAGES, resetComponentStages } from './templates.js';\r\n\r\nfunction getElement(id) {\r\n\treturn document.getElementById(id);\r\n}\r\n\r\nconst CLIENT_OPTION_ATTRIBUTE = 'data-cliente-option';\r\nconst CLIENT_NAME_FIELDS = Object.freeze([\r\n\t'nombre',\r\n\t'Nombre',\r\n\t'cliente',\r\n\t'Cliente',\r\n\t'razon_social',\r\n\t'RazonSocial',\r\n]);\r\nconst CLIENT_ID_FIELDS = Object.freeze([\r\n\t'id',\r\n\t'ID',\r\n\t'id_cliente',\r\n\t'IdCliente',\r\n\t'codigo',\r\n\t'Codigo',\r\n\t'cuit',\r\n\t'CUIT',\r\n]);\r\nconst CLIENT_FIELD_ALIASES = Object.freeze({\r\n\tdireccion: ['direccion', 'Direccion', 'domicilio', 'Domicilio'],\r\n\ttelefono: ['telefono', 'Telefono', 'tel', 'Tel'],\r\n\temail: ['email', 'Email', 'mail', 'Mail', 'correo', 'Correo'],\r\n\tcuit: ['cuit', 'CUIT'],\r\n});\r\n\r\nconst CLIENT_DETAIL_FIELD_IDS = Object.freeze(['direccion', 'cliente_telefono', 'cliente_email', 'cliente_cuit']);\r\nconst CLIENT_DETAIL_EMPTY_CLASS = 'client-detail-empty';\r\nconst CLIENT_DETAIL_LOCKED_CLASS = 'client-detail-locked';\r\n\r\nconst AUTO_RESIZE_ATTRIBUTE = 'data-auto-resize';\r\nconst AUTO_RESIZE_DATASET_KEY = 'autoResizeBaseWidth';\r\nconst AUTO_RESIZE_CHAR_WIDTH = 8;\r\nconst AUTO_RESIZE_BUFFER_PX = 6;\r\nconst AUTO_RESIZE_DEFAULT_MIN_WIDTH = 48;\r\nconst autoResizeInputsWithListener = new WeakSet();\r\nconst clientDetailInputsWithListener = new WeakSet();\r\n\r\nfunction isAutoResizeCandidate(element) {\r\n\treturn element instanceof HTMLInputElement && element.hasAttribute(AUTO_RESIZE_ATTRIBUTE);\r\n}\r\n\r\nexport function autoResizeInput(element) {\r\n\tif (!isAutoResizeCandidate(element)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (!element.dataset[AUTO_RESIZE_DATASET_KEY]) {\r\n\t\tconst initialWidth = Math.max(element.clientWidth || 0, element.offsetWidth || 0);\r\n\t\telement.dataset[AUTO_RESIZE_DATASET_KEY] = String(\r\n\t\t\tinitialWidth > 0 ? initialWidth : AUTO_RESIZE_DEFAULT_MIN_WIDTH,\r\n\t\t);\r\n\t}\r\n\r\n\tconst baseWidth = Number(element.dataset[AUTO_RESIZE_DATASET_KEY]) || AUTO_RESIZE_DEFAULT_MIN_WIDTH;\r\n\tconst placeholderLength = typeof element.placeholder === 'string' ? element.placeholder.length : 0;\r\n\tconst valueLength = typeof element.value === 'string' ? element.value.length : 0;\r\n\tconst effectiveLength = Math.max(valueLength, placeholderLength, 1);\r\n\r\n\telement.style.width = 'auto';\r\n\r\n\tlet measuredWidth = element.scrollWidth;\r\n\r\n\tif (!measuredWidth || Number.isNaN(measuredWidth)) {\r\n\t\tconst approxCharWidth = Number(element.dataset.autoResizeCharWidth) || AUTO_RESIZE_CHAR_WIDTH;\r\n\t\tmeasuredWidth = approxCharWidth * effectiveLength;\r\n\t}\r\n\r\n\tconst finalWidth = Math.max(baseWidth, measuredWidth + AUTO_RESIZE_BUFFER_PX);\r\n\telement.style.width = `${finalWidth}px`;\r\n}\r\n\r\nfunction getAutoResizeInputs() {\r\n\tif (typeof document === 'undefined') {\r\n\t\treturn [];\r\n\t}\r\n\treturn Array.from(document.querySelectorAll(`input[${AUTO_RESIZE_ATTRIBUTE}]`));\r\n}\r\n\r\nfunction configureAutoResizeInputs() {\r\n\tconst inputs = getAutoResizeInputs();\r\n\tinputs.forEach(input => {\r\n\t\tautoResizeInput(input);\r\n\t\tif (!autoResizeInputsWithListener.has(input)) {\r\n\t\t\tinput.addEventListener('input', () => autoResizeInput(input));\r\n\t\t\tautoResizeInputsWithListener.add(input);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction resizeAutoResizeInputs() {\r\n\tgetAutoResizeInputs().forEach(autoResizeInput);\r\n}\r\n\r\nconst clienteDataMap = new Map();\r\nlet clienteSelectChangeHandler = null;\r\n\r\n// === Equipos por Cliente ===\r\nlet equiposPorCliente = [];\r\nlet equipoSeleccionado = null;\r\nlet categoriaReporteActual = 'osmosis'; // Por defecto ├│smosis, puede ser 'osmosis' o 'ablandador'\r\n\r\n// Funci├│n para establecer la categor├¡a del reporte actual (llamada desde main.js al cambiar de tab)\r\nexport function setCategoriaReporte(categoria) {\r\n\tcategoriaReporteActual = categoria;\r\n}\r\n\r\nasync function cargarEquiposParaCliente(clientId) {\r\n\tconst todosEquipos = await getEquiposByCliente(clientId);\r\n\t// Filtrar por la categor├¡a del reporte actual\r\n\tequiposPorCliente = todosEquipos.filter(eq => {\r\n\t\tconst cat = (eq.sistema_categoria || '').toLowerCase();\r\n\t\tif (categoriaReporteActual === 'osmosis') {\r\n\t\t\treturn cat === 'osmosis' || cat === '├│smosis';\r\n\t\t} else if (categoriaReporteActual === 'ablandador') {\r\n\t\t\treturn cat === 'ablandador' || cat === 'softener';\r\n\t\t}\r\n\t\treturn true; // Si no hay categor├¡a definida, mostrar todos\r\n\t});\r\n\tequipoSeleccionado = null;\r\n\trenderEquiposSelector();\r\n}\r\n\r\nfunction renderEquiposSelector() {\r\n\tconst container = document.getElementById('equipos-selector-container');\r\n\tif (!container) return;\r\n\tcontainer.innerHTML = '';\r\n\tif (!equiposPorCliente || equiposPorCliente.length === 0) {\r\n\t\tcontainer.innerHTML = '<div class=\"text-gray-500\">No hay equipos asociados a este cliente.</div>';\r\n\t\treturn;\r\n\t}\r\n\tif (equiposPorCliente.length === 1) {\r\n\t\tequipoSeleccionado = equiposPorCliente[0];\r\n\t\tautocompletarCamposEquipo(equipoSeleccionado);\r\n\t\tcontainer.innerHTML = `<div class=\"text-green-600\">Equipo: ${equiposPorCliente[0].modelo || ''} (${equiposPorCliente[0].serie || ''})</div>`;\r\n\t\treturn;\r\n\t}\r\n\t// Si hay m├ís de uno, mostrar selector\r\n\tconst select = document.createElement('select');\r\n\tselect.id = 'equipo-selector';\r\n\tselect.className = 'form-select px-2 py-1 rounded border';\r\n\tselect.innerHTML = equiposPorCliente.map((eq, idx) =>\r\n\t\t`<option value=\"${idx}\">${eq.modelo || 'Equipo'} - ${eq.serie || ''} (${eq.sistema_nombre || ''})</option>`\r\n\t).join('');\r\n\tselect.addEventListener('change', e => {\r\n\t\tequipoSeleccionado = equiposPorCliente[parseInt(e.target.value)];\r\n\t\tautocompletarCamposEquipo(equipoSeleccionado);\r\n\t});\r\n\tcontainer.appendChild(select);\r\n\t// Autocompletar el primero por defecto\r\n\tequipoSeleccionado = equiposPorCliente[0];\r\n\tautocompletarCamposEquipo(equipoSeleccionado);\r\n}\r\n\r\nfunction autocompletarCamposEquipo(equipo) {\r\n\tif (!equipo) return;\r\n\tsetInputValue('modelo', equipo.modelo || '');\r\n\tsetInputValue('n_serie', equipo.serie || '');\r\n\tsetInputValue('id_interna', equipo.tag_id || '');\r\n\tsetInputValue('sistema', equipo.sistema_nombre || '');\r\n\tsetInputValue('sistema_categoria', equipo.sistema_categoria || '');\r\n\tif (equipo.fecha_instalacion) setInputValue('fecha_instalacion', equipo.fecha_instalacion);\r\n\tif (equipo.notas) setInputValue('notas', equipo.notas);\r\n\tif (equipo.sistema_descripcion) {\r\n\t\tconst descEl = document.getElementById('sistema_descripcion');\r\n\t\tif (descEl) descEl.textContent = equipo.sistema_descripcion;\r\n\t}\r\n\tif (equipo.vida_util_dias) setInputValue('vida_util_dias', equipo.vida_util_dias);\r\n}\r\n\r\nfunction normalizeStringValue(value) {\r\n\tif (value === null || value === undefined) {\r\n\t\treturn '';\r\n\t}\r\n\r\n\tconst stringValue = String(value);\r\n\treturn stringValue.trim();\r\n}\r\n\r\nfunction getFirstAvailableField(source, fieldNames) {\r\n\tif (!source || typeof source !== 'object') {\r\n\t\treturn '';\r\n\t}\r\n\r\n\tfor (const key of fieldNames) {\r\n\t\tif (Object.prototype.hasOwnProperty.call(source, key)) {\r\n\t\t\tconst normalized = normalizeStringValue(source[key]);\r\n\t\t\tif (normalized) {\r\n\t\t\t\treturn normalized;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\treturn '';\r\n}\r\n\r\nfunction extractClientName(cliente) {\r\n\treturn getFirstAvailableField(cliente, CLIENT_NAME_FIELDS);\r\n}\r\n\r\nfunction extractClientId(cliente) {\r\n\treturn getFirstAvailableField(cliente, CLIENT_ID_FIELDS);\r\n}\r\n\r\nfunction createClientDetails(cliente) {\r\n\treturn {\r\n\t\tdireccion: getFirstAvailableField(cliente, CLIENT_FIELD_ALIASES.direccion),\r\n\t\ttelefono: getFirstAvailableField(cliente, CLIENT_FIELD_ALIASES.telefono),\r\n\t\temail: getFirstAvailableField(cliente, CLIENT_FIELD_ALIASES.email),\r\n\t\tcuit: getFirstAvailableField(cliente, CLIENT_FIELD_ALIASES.cuit),\r\n\t};\r\n}\r\n\r\nfunction refreshClientDetailFieldState(element, { lockWhenFilled = false } = {}) {\r\n\tif (!(element instanceof HTMLInputElement)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (!CLIENT_DETAIL_FIELD_IDS.includes(element.id)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst hasValue = normalizeStringValue(element.value) !== '';\r\n\r\n\tif (lockWhenFilled) {\r\n\t\telement.readOnly = hasValue;\r\n\t\telement.disabled = hasValue;\r\n\t} else if (!hasValue) {\r\n\t\telement.readOnly = false;\r\n\t\telement.disabled = false;\r\n\t}\r\n\r\n\tconst isLocked = hasValue && (element.disabled || element.readOnly);\r\n\r\n\tif (isLocked) {\r\n\t\telement.classList.add(CLIENT_DETAIL_LOCKED_CLASS);\r\n\t} else {\r\n\t\telement.classList.remove(CLIENT_DETAIL_LOCKED_CLASS);\r\n\t}\r\n\r\n\tif (hasValue) {\r\n\t\telement.classList.remove(CLIENT_DETAIL_EMPTY_CLASS);\r\n\t} else {\r\n\t\telement.classList.add(CLIENT_DETAIL_EMPTY_CLASS);\r\n\t}\r\n}\r\n\r\nfunction configureClientDetailFieldInteractions() {\r\n\tCLIENT_DETAIL_FIELD_IDS.forEach(fieldId => {\r\n\t\tconst element = getElement(fieldId);\r\n\t\tif (!(element instanceof HTMLInputElement)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\trefreshClientDetailFieldState(element);\r\n\r\n\t\tif (!clientDetailInputsWithListener.has(element)) {\r\n\t\t\telement.addEventListener('input', () => {\r\n\t\t\t\trefreshClientDetailFieldState(element);\r\n\t\t\t});\r\n\t\t\tclientDetailInputsWithListener.add(element);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nconst VALIDATION_FIELD_SELECTOR =\r\n\t\"input:not([type='hidden']):not([type='radio']):not([type='checkbox']), select, textarea\";\r\nconst validationFieldsWithListener = new WeakSet();\r\n\r\nfunction isValidatableField(element) {\r\n\treturn (\r\n\t\telement instanceof HTMLInputElement ||\r\n\t\telement instanceof HTMLTextAreaElement ||\r\n\t\telement instanceof HTMLSelectElement\r\n\t);\r\n}\r\n\r\nfunction getValidatableFields() {\r\n\tconst form = getElement('maintenance-form');\r\n\tif (!(form instanceof HTMLFormElement)) {\r\n\t\treturn [];\r\n\t}\r\n\r\n\treturn Array.from(form.querySelectorAll(VALIDATION_FIELD_SELECTOR)).filter(isValidatableField);\r\n}\r\n\r\nfunction shouldValidateField(field) {\r\n\tconst value = normalizeStringValue(field.value);\r\n\tconst hasValue = value !== '';\r\n\tconst touched = field.dataset.validationTouched === 'true';\r\n\tconst mode = field.dataset.validationMode || '';\r\n\r\n\tif (mode === 'immediate') {\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn touched || hasValue;\r\n}\r\n\r\nfunction determineValidationState(field) {\r\n\tif (!isValidatableField(field) || field.disabled) {\r\n\t\treturn 'neutral';\r\n\t}\r\n\r\n\tconst value = normalizeStringValue(field.value);\r\n\tconst hasValue = value !== '';\r\n\tconst shouldEvaluate = shouldValidateField(field);\r\n\r\n\tif (!shouldEvaluate) {\r\n\t\treturn 'neutral';\r\n\t}\r\n\r\n\tconst isRequired = field.required || field.dataset.validationMode === 'required';\r\n\tif (!isRequired && !hasValue) {\r\n\t\treturn 'neutral';\r\n\t}\r\n\r\n\treturn field.checkValidity() ? 'valid' : 'error';\r\n}\r\n\r\nfunction applyValidationClasses(field, state) {\r\n\tif (!isValidatableField(field)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tfield.classList.remove('input-status', 'input-status--valid', 'input-status--error');\r\n\tfield.removeAttribute('aria-invalid');\r\n\r\n\tif (state === 'neutral') {\r\n\t\treturn;\r\n\t}\r\n\r\n\tfield.classList.add('input-status');\r\n\tif (state === 'valid') {\r\n\t\tfield.classList.add('input-status--valid');\r\n\t\tfield.setAttribute('aria-invalid', 'false');\r\n\t\treturn;\r\n\t}\r\n\r\n\tfield.classList.add('input-status--error');\r\n\tfield.setAttribute('aria-invalid', 'true');\r\n}\r\n\r\nfunction updateFieldValidation(field, { forceTouched = false } = {}) {\r\n\tif (!isValidatableField(field)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (forceTouched) {\r\n\t\tfield.dataset.validationTouched = 'true';\r\n\t}\r\n\r\n\tconst state = determineValidationState(field);\r\n\tapplyValidationClasses(field, state);\r\n}\r\n\r\nfunction handleValidationEvent(event) {\r\n\tconst field = event.target;\r\n\tif (!isValidatableField(field)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tfield.dataset.validationTouched = 'true';\r\n\tupdateFieldValidation(field);\r\n}\r\n\r\nfunction configureFieldValidation() {\r\n\tconst fields = getValidatableFields();\r\n\tfields.forEach(field => {\r\n\t\tif (!validationFieldsWithListener.has(field)) {\r\n\t\t\t['input', 'change', 'blur'].forEach(eventType => {\r\n\t\t\t\tfield.addEventListener(eventType, handleValidationEvent);\r\n\t\t\t});\r\n\t\t\tvalidationFieldsWithListener.add(field);\r\n\t\t}\r\n\t\tupdateFieldValidation(field);\r\n\t});\r\n}\r\n\r\nfunction resetValidationStates() {\r\n\tgetValidatableFields().forEach(field => {\r\n\t\tdelete field.dataset.validationTouched;\r\n\t\tapplyValidationClasses(field, 'neutral');\r\n\t});\r\n}\r\n\r\nconst PERFORMANCE_GROUPS = Object.freeze({\r\n\tfound: {\r\n\t\tfields: ['cond_red_found', 'cond_perm_found', 'caudal_perm_found', 'caudal_rech_found', 'rechazo_found'],\r\n\t},\r\n\tleft: {\r\n\t\tfields: ['cond_red_left', 'cond_perm_left', 'caudal_perm_left', 'caudal_rech_left', 'rechazo_left'],\r\n\t},\r\n});\r\n\r\nconst REJECTION_SUCCESS_THRESHOLD = 90;\r\n\r\nfunction evaluateRejectionState(value) {\r\n\tif (typeof value !== 'number' || Number.isNaN(value)) {\r\n\t\treturn 'neutral';\r\n\t}\r\n\r\n\treturn value >= REJECTION_SUCCESS_THRESHOLD ? 'valid' : 'error';\r\n}\r\n\r\nfunction setMetricState(element, state) {\r\n\tif (!(element instanceof HTMLElement)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\telement.classList.remove('metric-status', 'metric-status--valid', 'metric-status--error');\r\n\tif (state === 'neutral') {\r\n\t\treturn;\r\n\t}\r\n\r\n\telement.classList.add('metric-status');\r\n\tif (state === 'valid') {\r\n\t\telement.classList.add('metric-status--valid');\r\n\t\treturn;\r\n\t}\r\n\r\n\telement.classList.add('metric-status--error');\r\n}\r\n\r\nfunction applyPerformanceFeedback(rejectionValues = {}) {\r\n\tObject.entries(PERFORMANCE_GROUPS).forEach(([key, group]) => {\r\n\t\tconst state = evaluateRejectionState(rejectionValues[key]);\r\n\t\tgroup.fields.forEach(fieldId => {\r\n\t\t\tconst field = getElement(fieldId);\r\n\t\t\tif (field) {\r\n\t\t\t\tsetMetricState(field, state);\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction resetMetricStates() {\r\n\tObject.values(PERFORMANCE_GROUPS).forEach(group => {\r\n\t\tgroup.fields.forEach(fieldId => {\r\n\t\t\tconst field = getElement(fieldId);\r\n\t\t\tif (field) {\r\n\t\t\t\tfield.classList.remove('metric-status', 'metric-status--valid', 'metric-status--error');\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction setClientDetailValue(fieldId, value, options = {}) {\r\n\tconst element = getElement(fieldId);\r\n\tif (!element) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst normalizedValue = normalizeStringValue(value);\r\n\r\n\tif ('value' in element) {\r\n\t\telement.value = normalizedValue;\r\n\t}\r\n\r\n\tif (element instanceof HTMLInputElement) {\r\n\t\tautoResizeInput(element);\r\n\t\trefreshClientDetailFieldState(element, {\r\n\t\t\tlockWhenFilled: Boolean(options.lockWhenFilled),\r\n\t\t});\r\n\t}\r\n\r\n\tupdateFieldValidation(element);\r\n}\r\n\r\nfunction applyClientDetails(details = {}) {\r\n\tconst detailMap = {\r\n\t\tdireccion: details.direccion,\r\n\t\tcliente_telefono: details.telefono,\r\n\t\tcliente_email: details.email,\r\n\t\tcliente_cuit: details.cuit,\r\n\t};\r\n\r\n\tObject.entries(detailMap).forEach(([fieldId, fieldValue]) => {\r\n\t\tsetClientDetailValue(fieldId, fieldValue, { lockWhenFilled: true });\r\n\t});\r\n}\r\n\r\nfunction clearClientDetails() {\r\n\tapplyClientDetails({});\r\n}\r\n\r\nfunction updateClientDetailsFromSelect(selectElement) {\r\n\tif (!selectElement) {\r\n\t\tclearClientDetails();\r\n\t\treturn;\r\n\t}\r\n\r\n\tlet selectedDetails = null;\r\n\tconst optionFromCollection =\r\n\t\tselectElement.selectedOptions && selectElement.selectedOptions.length > 0\r\n\t\t\t? selectElement.selectedOptions[0]\r\n\t\t\t: null;\r\n\tconst optionFromIndex =\r\n\t\ttypeof selectElement.selectedIndex === 'number' && selectElement.selectedIndex >= 0\r\n\t\t\t? selectElement.options[selectElement.selectedIndex]\r\n\t\t\t: null;\r\n\r\n\tif (optionFromCollection) {\r\n\t\tconst keyFromCollection = optionFromCollection.getAttribute('data-cliente-key');\r\n\t\tif (keyFromCollection) {\r\n\t\t\tselectedDetails = clienteDataMap.get(keyFromCollection) || null;\r\n\t\t}\r\n\t}\r\n\r\n\tconst shouldCheckIndex =\r\n\t\t!selectedDetails || (optionFromIndex && optionFromCollection && optionFromCollection !== optionFromIndex);\r\n\r\n\tif (shouldCheckIndex && optionFromIndex) {\r\n\t\tconst keyFromIndex = optionFromIndex.getAttribute('data-cliente-key');\r\n\t\tif (keyFromIndex) {\r\n\t\t\tconst detailsFromIndex = clienteDataMap.get(keyFromIndex);\r\n\t\t\tif (detailsFromIndex) {\r\n\t\t\t\tselectedDetails = detailsFromIndex;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (!selectedDetails) {\r\n\t\tselectedDetails = clienteDataMap.get(selectElement.value);\r\n\t}\r\n\r\n\tif (selectedDetails) {\r\n\t\tapplyClientDetails(selectedDetails);\r\n\t} else {\r\n\t\tclearClientDetails();\r\n\t}\r\n}\r\n\r\nfunction resetClientSelection() {\r\n\t// Limpiar el input de b├║squeda del autocomplete\r\n\tconst searchInput = getElement('cliente-search');\r\n\tif (searchInput) {\r\n\t\tsearchInput.value = '';\r\n\t\tsearchInput.classList.remove('has-selection');\r\n\t}\r\n\r\n\t// Limpiar el input hidden con el ID del cliente\r\n\tconst hiddenInput = getElement('cliente');\r\n\tif (hiddenInput) {\r\n\t\thiddenInput.value = '';\r\n\t}\r\n\r\n\t// Ocultar el bot├│n de clear\r\n\tconst clearBtn = getElement('cliente-clear-btn');\r\n\tif (clearBtn) {\r\n\t\tclearBtn.classList.add('hidden');\r\n\t}\r\n\r\n\t// Ocultar el dropdown si est├í visible\r\n\thideDropdown();\r\n\r\n\tclearClientDetails();\r\n}\r\n\r\nfunction padWithZero(value) {\r\n\treturn String(value).padStart(2, '0');\r\n}\r\n\r\nfunction isDateInstance(value) {\r\n\treturn Object.prototype.toString.call(value) === '[object Date]';\r\n}\r\n\r\nfunction isValidDate(value) {\r\n\treturn isDateInstance(value) && !Number.isNaN(value.getTime());\r\n}\r\n\r\nfunction toDateFromParts(year, monthIndex, day) {\r\n\tconst date = new Date(year, monthIndex, day);\r\n\tif (Number.isNaN(date.getTime())) {\r\n\t\treturn null;\r\n\t}\r\n\r\n\tif (date.getFullYear() !== year || date.getMonth() !== monthIndex || date.getDate() !== day) {\r\n\t\treturn null;\r\n\t}\r\n\r\n\treturn date;\r\n}\r\n\r\nfunction formatDateToISO(date) {\r\n\tif (!isValidDate(date)) {\r\n\t\treturn '';\r\n\t}\r\n\r\n\treturn `${date.getFullYear()}-${padWithZero(date.getMonth() + 1)}-${padWithZero(date.getDate())}`;\r\n}\r\n\r\nexport function normalizeDateToISO(value) {\r\n\tif (value === null || value === undefined || value === '') {\r\n\t\treturn '';\r\n\t}\r\n\r\n\tif (isValidDate(value)) {\r\n\t\treturn formatDateToISO(value);\r\n\t}\r\n\r\n\tif (typeof value === 'number') {\r\n\t\treturn formatDateToISO(new Date(value));\r\n\t}\r\n\r\n\tif (typeof value === 'string') {\r\n\t\tconst trimmed = value.trim();\r\n\t\tif (!trimmed) {\r\n\t\t\treturn '';\r\n\t\t}\r\n\r\n\t\tlet match = trimmed.match(/^(\\d{4})-(\\d{2})-(\\d{2})(?:$|T)/);\r\n\t\tif (match) {\r\n\t\t\tconst year = Number(match[1]);\r\n\t\t\tconst month = Number(match[2]);\r\n\t\t\tconst day = Number(match[3]);\r\n\t\t\tconst isoDate = toDateFromParts(year, month - 1, day);\r\n\t\t\treturn isoDate ? formatDateToISO(isoDate) : '';\r\n\t\t}\r\n\r\n\t\tmatch = trimmed.match(/^(\\d{4})[-/](\\d{1,2})[-/](\\d{1,2})$/);\r\n\t\tif (match) {\r\n\t\t\tconst year = Number(match[1]);\r\n\t\t\tconst month = Number(match[2]);\r\n\t\t\tconst day = Number(match[3]);\r\n\t\t\tconst yearFirstDate = toDateFromParts(year, month - 1, day);\r\n\t\t\treturn yearFirstDate ? formatDateToISO(yearFirstDate) : '';\r\n\t\t}\r\n\r\n\t\tmatch = trimmed.match(/^(\\d{1,2})[-/](\\d{1,2})[-/](\\d{4})$/);\r\n\t\tif (match) {\r\n\t\t\tconst day = Number(match[1]);\r\n\t\t\tconst month = Number(match[2]);\r\n\t\t\tconst year = Number(match[3]);\r\n\t\t\tconst dayFirstDate = toDateFromParts(year, month - 1, day);\r\n\t\t\treturn dayFirstDate ? formatDateToISO(dayFirstDate) : '';\r\n\t\t}\r\n\r\n\t\tconst parsedDate = new Date(trimmed);\r\n\t\treturn formatDateToISO(parsedDate);\r\n\t}\r\n\r\n\tif (typeof value === 'object') {\r\n\t\tconst candidate = new Date(value);\r\n\t\treturn formatDateToISO(candidate);\r\n\t}\r\n\r\n\treturn '';\r\n}\r\n\r\nfunction formatDateForDisplayFromISO(isoDate) {\r\n\tif (!isoDate) {\r\n\t\treturn '';\r\n\t}\r\n\r\n\tconst [yearStr, monthStr, dayStr] = isoDate.split('-');\r\n\tif (!yearStr || !monthStr || !dayStr) {\r\n\t\treturn '';\r\n\t}\r\n\r\n\tconst year = Number(yearStr);\r\n\tconst month = Number(monthStr);\r\n\tconst day = Number(dayStr);\r\n\r\n\tif (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) {\r\n\t\treturn '';\r\n\t}\r\n\r\n\tconst displayDate = new Date(year, month - 1, day);\r\n\tif (Number.isNaN(displayDate.getTime())) {\r\n\t\treturn '';\r\n\t}\r\n\r\n\treturn displayDate.toLocaleDateString('es-AR', {\r\n\t\tyear: 'numeric',\r\n\t\tmonth: '2-digit',\r\n\t\tday: '2-digit',\r\n\t});\r\n}\r\n\r\nfunction setServiceDateValue(value) {\r\n\tconst isoDate = normalizeDateToISO(value);\r\n\tconst fechaInput = getElement('fecha');\r\n\tif (fechaInput) {\r\n\t\tfechaInput.value = isoDate;\r\n\t}\r\n\r\n\tconst fechaDisplayInput = getElement('fecha_display');\r\n\tif (fechaDisplayInput) {\r\n\t\tfechaDisplayInput.value = formatDateForDisplayFromISO(isoDate);\r\n\t\tautoResizeInput(fechaDisplayInput);\r\n\t}\r\n}\r\n\r\nexport function serializeForm(formElement) {\r\n\tif (!(formElement instanceof HTMLFormElement)) {\r\n\t\treturn {};\r\n\t}\r\n\r\n\tconst formData = new FormData(formElement);\r\n\tconst data = {};\r\n\r\n\tformData.forEach((value, key) => {\r\n\t\tif (Object.prototype.hasOwnProperty.call(data, key)) {\r\n\t\t\tif (!Array.isArray(data[key])) {\r\n\t\t\t\tdata[key] = [data[key]];\r\n\t\t\t}\r\n\t\t\tdata[key].push(value);\r\n\t\t} else {\r\n\t\t\tdata[key] = value;\r\n\t\t}\r\n\t});\r\n\r\n\tconst radioNames = new Set();\r\n\tformElement\r\n\t\t.querySelectorAll('input[type=\"radio\"][name]')\r\n\t\t.forEach(radio => radioNames.add(radio.name));\r\n\r\n\tradioNames.forEach(name => {\r\n\t\tif (!Object.prototype.hasOwnProperty.call(data, name)) {\r\n\t\t\tdata[name] = '';\r\n\t\t}\r\n\t});\r\n\r\n\treturn data;\r\n}\r\n\r\nfunction setDefaultDate() {\r\n\tsetServiceDateValue(new Date());\r\n}\r\n\r\nfunction calculateAll() {\r\n\tconst condRedFound = parseFloat(getElement('cond_red_found')?.value) || 0;\r\n\tconst condPermFound = parseFloat(getElement('cond_perm_found')?.value) || 0;\r\n\tconst condRedLeft = parseFloat(getElement('cond_red_left')?.value) || 0;\r\n\tconst condPermLeft = parseFloat(getElement('cond_perm_left')?.value) || 0;\r\n\r\n\tconst caudalPermFound = parseFloat(getElement('caudal_perm_found')?.value) || 0;\r\n\tconst caudalRechFound = parseFloat(getElement('caudal_rech_found')?.value) || 0;\r\n\tconst caudalPermLeft = parseFloat(getElement('caudal_perm_left')?.value) || 0;\r\n\tconst caudalRechLeft = parseFloat(getElement('caudal_rech_left')?.value) || 0;\r\n\r\n\r\n\r\n\tconst rechazoFound = condRedFound > 0 ? ((1 - (condPermFound / condRedFound)) * 100).toFixed(2) : '';\r\n\tconst rechazoLeft = condRedLeft > 0 ? ((1 - (condPermLeft / condRedLeft)) * 100).toFixed(2) : '';\r\n\r\n\tconst rechazoFoundValue = rechazoFound ? `${rechazoFound} %` : '';\r\n\tconst rechazoLeftValue = rechazoLeft ? `${rechazoLeft} %` : '';\r\n\r\n\tconst rechazoFoundInput = getElement('rechazo_found');\r\n\tconst rechazoFoundHiddenInput = getElement('rechazo_found_hidden');\r\n\tconst rechazoLeftInput = getElement('rechazo_left');\r\n\tconst rechazoLeftHiddenInput = getElement('rechazo_left_hidden');\r\n\tif (rechazoFoundInput) {\r\n\t\trechazoFoundInput.value = rechazoFoundValue;\r\n\t}\r\n\tif (rechazoFoundHiddenInput) {\r\n\t\trechazoFoundHiddenInput.value = rechazoFoundValue;\r\n\t}\r\n\tif (rechazoLeftInput) {\r\n\t\trechazoLeftInput.value = rechazoLeftValue;\r\n\t}\r\n\tif (rechazoLeftHiddenInput) {\r\n\t\trechazoLeftHiddenInput.value = rechazoLeftValue;\r\n\t}\r\n\tconst relacionFound = caudalPermFound > 0 ? (caudalRechFound / caudalPermFound).toFixed(1) : '';\r\n\tconst relacionLeft = caudalPermLeft > 0 ? (caudalRechLeft / caudalPermLeft).toFixed(1) : '';\r\n\r\n\tconst relacionFoundValue = relacionFound ? `${relacionFound}:1` : '';\r\n\tconst relacionLeftValue = relacionLeft ? `${relacionLeft}:1` : '';\r\n\tconst relacionFoundInput = getElement('relacion_found');\r\n\tconst relacionFoundHiddenInput = getElement('relacion_found_hidden');\r\n\tconst relacionLeftInput = getElement('relacion_left');\r\n\tconst relacionLeftHiddenInput = getElement('relacion_left_hidden');\r\n\tif (relacionFoundInput) {\r\n\t\trelacionFoundInput.value = relacionFoundValue;\r\n\t}\r\n\tif (relacionFoundHiddenInput) {\r\n\t\trelacionFoundHiddenInput.value = relacionFoundValue;\r\n\t}\r\n\tif (relacionLeftInput) {\r\n\t\trelacionLeftInput.value = relacionLeftValue;\r\n\t}\r\n\tif (relacionLeftHiddenInput) {\r\n\t\trelacionLeftHiddenInput.value = relacionLeftValue;\r\n\t}\r\n\r\n\tconst rejectionValues = {\r\n\t\tfound: rechazoFound ? parseFloat(rechazoFound) : Number.NaN,\r\n\t\tleft: rechazoLeft ? parseFloat(rechazoLeft) : Number.NaN,\r\n\t};\r\n\tapplyPerformanceFeedback(rejectionValues);\r\n}\r\n\r\nfunction updateConversions(inputEl, outputEl) {\r\n\tconst lmin = parseFloat(inputEl.value);\r\n\tif (!Number.isNaN(lmin) && lmin >= 0) {\r\n\t\tconst lph = lmin * LMIN_TO_LPH;\r\n\t\tconst gpd = lmin * LMIN_TO_GPD;\r\n\t\toutputEl.textContent = `(${lph.toFixed(1)} l/h | ${gpd.toFixed(0)} GPD)`;\r\n\t} else {\r\n\t\toutputEl.textContent = '';\r\n\t}\r\n}\r\n\r\nfunction configureConversionInputs() {\r\n\tconst conversionPairs = [\r\n\t\t['caudal_perm_found', 'caudal_perm_found_conv'],\r\n\t\t['caudal_perm_left', 'caudal_perm_left_conv'],\r\n\t\t['caudal_rech_found', 'caudal_rech_found_conv'],\r\n\t\t['caudal_rech_left', 'caudal_rech_left_conv'],\r\n\t];\r\n\r\n\tconversionPairs.forEach(([inputId, outputId]) => {\r\n\t\tconst input = getElement(inputId);\r\n\t\tconst output = getElement(outputId);\r\n\t\tif (input && output) {\r\n\t\t\tinput.addEventListener('input', () => updateConversions(input, output));\r\n\t\t}\r\n\t});\r\n}\r\nconst STATUS_SELECT_SELECTOR = 'select[id$=\"_found\"], select[id$=\"_left\"]';\r\n\r\nconst STATUS_CLASS_BY_VALUE = {\r\n\tpasa: 'status-pass',\r\n\tno: 'status-pass',\r\n\tfalla: 'status-fail',\r\n\t'no pasa': 'status-fail',\r\n\ts├¡: 'status-fail',\r\n\tsi: 'status-fail',\r\n\t'n/a': 'status-na',\r\n\t'no aplica': 'status-na',\r\n\tna: 'status-na',\r\n\t'': 'status-na',\r\n};\r\n\r\nfunction setStatusColor(selectElement) {\r\n\tselectElement.classList.remove('status-pass', 'status-fail', 'status-na');\r\n\tconst normalizedValue = String(selectElement.value ?? '').trim().toLowerCase();\r\n\tconst statusClass = STATUS_CLASS_BY_VALUE[normalizedValue] || 'status-na';\r\n\tselectElement.classList.add(statusClass);\r\n}\r\n\r\nfunction applyStatusColorsToSelects() {\r\n\tconst statusSelects = document.querySelectorAll(STATUS_SELECT_SELECTOR);\r\n\tstatusSelects.forEach(select => {\r\n\t\tselect.classList.add('status-select');\r\n\t\tsetStatusColor(select);\r\n\t});\r\n}\r\n\r\nfunction configureStatusSelects() {\r\n\r\n\tconst statusSelects = document.querySelectorAll(STATUS_SELECT_SELECTOR);\r\n\r\n\tstatusSelects.forEach(select => {\r\n\t\tselect.classList.add('status-select');\r\n\t\tsetStatusColor(select);\r\n\t\tselect.addEventListener('change', () => setStatusColor(select));\r\n\t});\r\n}\r\n\r\nconst SANITIZACION_STATUS_MAP = {\r\n\tRealizada: 'success',\r\n\t'No Realizada': 'danger',\r\n\t'N/A': 'neutral',\r\n};\r\n\r\nfunction configureSanitizacionRadios() {\r\n\tconst container = document.querySelector('.sanitizacion-card-group');\r\n\tif (!container) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst radios = container.querySelectorAll('input[type=\"radio\"][name=\"sanitizacion\"]');\r\n\tif (!radios.length) {\r\n\t\tcontainer.dataset.status = 'neutral';\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst updateStatus = () => {\r\n\t\tconst checked = container.querySelector('input[type=\"radio\"][name=\"sanitizacion\"]:checked');\r\n\t\tconst statusKey = checked?.value || 'N/A';\r\n\t\tcontainer.dataset.status = SANITIZACION_STATUS_MAP[statusKey] || 'neutral';\r\n\t};\r\n\r\n\tradios.forEach(radio => {\r\n\t\tif (!radio.dataset.sanitizacionConfigured) {\r\n\t\t\tradio.addEventListener('change', updateStatus);\r\n\t\t\tradio.dataset.sanitizacionConfigured = 'true';\r\n\t\t}\r\n\t});\r\n\r\n\tupdateStatus();\r\n}\r\n\r\nfunction configureNumberInputs() {\r\n\tconst inputs = document.querySelectorAll('input[type=\"number\"]');\r\n\tinputs.forEach(input => {\r\n\t\tinput.addEventListener('input', calculateAll);\r\n\t});\r\n}\r\n\r\nfunction clearDerivedFields() {\r\n\t[\r\n\t\t'rechazo_found',\r\n\t\t'rechazo_found_hidden',\r\n\t\t'rechazo_left',\r\n\t\t'rechazo_left_hidden',\r\n\t\t'relacion_found',\r\n\t\t'relacion_found_hidden',\r\n\t\t'relacion_left',\r\n\t\t'relacion_left_hidden',\r\n\t].forEach(id => {\r\n\t\tconst element = getElement(id);\r\n\t\tif (element) {\r\n\t\t\telement.value = '';\r\n\t\t}\r\n\t});\r\n\r\n\tresetMetricStates();\r\n}\r\n\r\nfunction clearConversionOutputs() {\r\n\t['caudal_perm_found_conv', 'caudal_perm_left_conv', 'caudal_rech_found_conv', 'caudal_rech_left_conv'].forEach(id => {\r\n\t\tconst element = getElement(id);\r\n\t\tif (element) {\r\n\t\t\telement.textContent = '';\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction addDays(date, days) {\r\n\tconst clone = new Date(date.getTime());\r\n\tclone.setDate(clone.getDate() + days);\r\n\treturn clone;\r\n}\r\n\r\nfunction setInputValue(id, value) {\r\n\tconst element = getElement(id);\r\n\tif (!(element instanceof HTMLInputElement) && !(element instanceof HTMLTextAreaElement)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\telement.value = value;\r\n\tconst inputEvent = new Event('input', { bubbles: true });\r\n\telement.dispatchEvent(inputEvent);\r\n\r\n\tif (element instanceof HTMLInputElement) {\r\n\t\tautoResizeInput(element);\r\n\t}\r\n}\r\n\r\nfunction setSelectValue(id, value) {\r\n\tconst element = getElement(id);\r\n\tif (!(element instanceof HTMLSelectElement)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\telement.value = value;\r\n\tconst changeEvent = new Event('change', { bubbles: true });\r\n\telement.dispatchEvent(changeEvent);\r\n}\r\n\r\nexport function autoFillForm() {\r\n\tconst now = new Date();\r\n\tsetServiceDateValue(now);\r\n\r\n\tsetInputValue('tecnico', 'Equipo T├®cnico Pruebas');\r\n\tsetInputValue('modelo', 'Sistema RO Residencial 6 etapas');\r\n\tsetInputValue('id_interna', 'ACT-PRUEBA-042');\r\n\tsetInputValue('n_serie', 'SN-PRB-998877');\r\n\r\n\tconst nextMaintenance = addDays(now, 180);\r\n\tconst proximoMantInput = getElement('proximo_mant');\r\n\tif (proximoMantInput instanceof HTMLInputElement) {\r\n\t\tproximoMantInput.value = normalizeDateToISO(nextMaintenance);\r\n\t\tproximoMantInput.dispatchEvent(new Event('input', { bubbles: true }));\r\n\t}\r\n\r\n\tconst numericValues = {\r\n\t\tcond_red_found: 480,\r\n\t\tcond_red_left: 460,\r\n\t\tcond_perm_found: 28,\r\n\t\tcond_perm_left: 16,\r\n\t\tpresion_found: 2.6,\r\n\t\tpresion_left: 3.9,\r\n\t\tcaudal_perm_found: 1.9,\r\n\t\tcaudal_perm_left: 2.5,\r\n\t\tcaudal_rech_found: 3.8,\r\n\t\tcaudal_rech_left: 4.3,\r\n\t\tprecarga_found: 1.1,\r\n\t\tprecarga_left: 1.5,\r\n\t};\r\n\r\n\tObject.entries(numericValues).forEach(([id, value]) => {\r\n\t\tconst element = getElement(id);\r\n\t\tif (element instanceof HTMLInputElement) {\r\n\t\t\telement.value = value;\r\n\t\t\telement.dispatchEvent(new Event('input', { bubbles: true }));\r\n\t\t}\r\n\t});\r\n\r\n\tsetSelectValue('fugas_found', 'S├¡');\r\n\tsetSelectValue('fugas_left', 'No');\r\n\tsetSelectValue('presostato_alta_found', 'Pasa');\r\n\tsetSelectValue('presostato_alta_left', 'Pasa');\r\n\tsetSelectValue('presostato_baja_found', 'Pasa');\r\n\tsetSelectValue('presostato_baja_left', 'Pasa');\r\n\r\n\tconst stageDetails = {\r\n\t\tetapa1: 'Filtro sedimentos 5┬Ám (cambio)',\r\n\t\tetapa2: 'Cartucho CTO 10\" reemplazado',\r\n\t\tetapa3: 'GAC + pulido final verificado',\r\n\t\tetapa4: 'Membrana 75 GPD instalada',\r\n\t\tetapa5: 'Postfiltro remineralizador nuevo',\r\n\t\tetapa6: 'UV operativa y sanitizada',\r\n\t};\r\n\r\n\tCOMPONENT_STAGES.forEach(stage => {\r\n\t\tconst detailId = `${stage.id}_detalles`;\r\n\t\tsetInputValue(detailId, stageDetails[stage.id] || stage.title);\r\n\r\n\t\tconst changedRadio = document.getElementById(`${stage.id}_accion_cambiado`);\r\n\t\tif (changedRadio instanceof HTMLInputElement) {\r\n\t\t\tchangedRadio.checked = true;\r\n\t\t\tchangedRadio.dispatchEvent(new Event('change', { bubbles: true }));\r\n\t\t}\r\n\t});\r\n\r\n\tconst sanitizacionRadio = document.querySelector('input[name=\"sanitizacion\"][value=\"Realizada\"]');\r\n\tif (sanitizacionRadio instanceof HTMLInputElement) {\r\n\t\tsanitizacionRadio.checked = true;\r\n\t\tsanitizacionRadio.dispatchEvent(new Event('change', { bubbles: true }));\r\n\t}\r\n\r\n\tconst comentarios = [\r\n\t\t'Se reemplazaron todos los filtros y se normalizaron los par├ímetros.',\r\n\t\t'Equipo calibrado tras cambio integral de cartuchos y sanitizaci├│n completa.',\r\n\t\t'Mantenimiento preventivo completado sin novedades, par├ímetros dentro de lo esperado.',\r\n\t\t'Cambios realizados y pruebas finales exitosas, equipo queda operativo.',\r\n\t];\r\n\tconst resumen = document.getElementById('resumen');\r\n\tif (resumen instanceof HTMLTextAreaElement) {\r\n\t\tconst comentarioAleatorio = comentarios[Math.floor(Math.random() * comentarios.length)];\r\n\t\tresumen.value = comentarioAleatorio;\r\n\t\tresumen.dispatchEvent(new Event('input', { bubbles: true }));\r\n\t}\r\n\r\n\tcalculateAll();\r\n\r\n\t['caudal_perm_found', 'caudal_perm_left', 'caudal_rech_found', 'caudal_rech_left'].forEach(id => {\r\n\t\tconst element = getElement(id);\r\n\t\tif (element instanceof HTMLInputElement) {\r\n\t\t\telement.dispatchEvent(new Event('input', { bubbles: true }));\r\n\t\t}\r\n\t});\r\n\r\n\tconfigureSanitizacionRadios();\r\n}\r\n\r\n// ===== Cliente Autocomplete =====\r\nlet clientesListCache = [];\r\nlet autocompleteInitialized = false;\r\nlet selectedClientIndex = -1;\r\n\r\nfunction normalizeForSearch(text) {\r\n\tif (!text) return '';\r\n\treturn text\r\n\t\t.toLowerCase()\r\n\t\t.normalize('NFD')\r\n\t\t.replace(/[\\u0300-\\u036f]/g, '') // Remove accents\r\n\t\t.trim();\r\n}\r\n\r\nfunction highlightMatch(text, query) {\r\n\tif (!query || !text) return text;\r\n\tconst normalizedText = normalizeForSearch(text);\r\n\tconst normalizedQuery = normalizeForSearch(query);\r\n\tconst index = normalizedText.indexOf(normalizedQuery);\r\n\tif (index === -1) return text;\r\n\r\n\tconst before = text.slice(0, index);\r\n\tconst match = text.slice(index, index + query.length);\r\n\tconst after = text.slice(index + query.length);\r\n\treturn `${before}<mark>${match}</mark>${after}`;\r\n}\r\n\r\nfunction filterClientes(query) {\r\n\tif (!query || query.length < 1) {\r\n\t\treturn clientesListCache.slice(0, 10); // Show first 10 when empty\r\n\t}\r\n\r\n\tconst normalizedQuery = normalizeForSearch(query);\r\n\r\n\treturn clientesListCache\r\n\t\t.filter(cliente => {\r\n\t\t\tconst name = normalizeForSearch(extractClientName(cliente));\r\n\t\t\tconst direccion = normalizeForSearch(cliente.direccion || '');\r\n\t\t\tconst cuit = normalizeForSearch(cliente.cuit || '');\r\n\r\n\t\t\treturn name.includes(normalizedQuery) ||\r\n\t\t\t\tdireccion.includes(normalizedQuery) ||\r\n\t\t\t\tcuit.includes(normalizedQuery);\r\n\t\t})\r\n\t\t.slice(0, 15); // Limit results\r\n}\r\n\r\nfunction renderDropdown(clientes, query) {\r\n\tconst dropdown = getElement('cliente-dropdown');\r\n\tif (!dropdown) return;\r\n\r\n\tif (clientes.length === 0) {\r\n\t\tdropdown.innerHTML = `\r\n\t\t\t<div class=\"cliente-dropdown-empty\">\r\n\t\t\t\tNo se encontraron clientes con \"${query}\"\r\n\t\t\t</div>\r\n\t\t`;\r\n\t\tdropdown.classList.remove('hidden');\r\n\t\treturn;\r\n\t}\r\n\r\n\tdropdown.innerHTML = clientes.map((cliente, index) => {\r\n\t\tconst name = extractClientName(cliente);\r\n\t\tconst direccion = cliente.direccion || '';\r\n\t\tconst highlightedName = highlightMatch(name, query);\r\n\t\tconst highlightedDireccion = highlightMatch(direccion, query);\r\n\t\tconst clientKey = `cliente-${clientesListCache.indexOf(cliente)}`;\r\n\r\n\t\treturn `\r\n\t\t\t<div class=\"cliente-dropdown-item ${index === selectedClientIndex ? 'selected' : ''}\" \r\n\t\t\t     data-cliente-key=\"${clientKey}\"\r\n\t\t\t     data-cliente-index=\"${index}\"\r\n\t\t\t     role=\"option\"\r\n\t\t\t     tabindex=\"-1\">\r\n\t\t\t\t<div class=\"cliente-dropdown-item-name\">${highlightedName}</div>\r\n\t\t\t\t${direccion ? `<div class=\"cliente-dropdown-item-detail\">${highlightedDireccion}</div>` : ''}\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}).join('');\r\n\r\n\tdropdown.classList.remove('hidden');\r\n}\r\n\r\nfunction hideDropdown() {\r\n\tconst dropdown = getElement('cliente-dropdown');\r\n\tif (dropdown) {\r\n\t\tdropdown.classList.add('hidden');\r\n\t}\r\n\tselectedClientIndex = -1;\r\n}\r\n\r\nfunction selectClient(clientKey) {\r\n\tconst index = parseInt(clientKey.replace('cliente-', ''), 10);\r\n\tconst cliente = clientesListCache[index];\r\n\tif (!cliente) return;\r\n\r\n\tconst searchInput = getElement('cliente-search');\r\n\tconst hiddenInput = getElement('cliente');\r\n\tconst clearBtn = getElement('cliente-clear-btn');\r\n\r\n\tconst clientId = extractClientId(cliente) || extractClientName(cliente);\r\n\tconst clientName = extractClientName(cliente);\r\n\r\n\tif (hiddenInput) {\r\n\t\thiddenInput.value = clientId;\r\n\t}\r\n\r\n\tif (searchInput) {\r\n\t\tsearchInput.value = clientName;\r\n\t\tsearchInput.classList.add('has-selection');\r\n\t}\r\n\r\n\tif (clearBtn) {\r\n\t\tclearBtn.classList.remove('hidden');\r\n\t}\r\n\r\n\t// Store client details and apply them\r\n\tclienteDataMap.set(clientKey, createClientDetails(cliente));\r\n\tapplyClientDetails(createClientDetails(cliente));\r\n\t// Consultar equipos y mostrar selector\r\n\tconst clientIdForEquipos = extractClientId(cliente);\r\n\tif (clientIdForEquipos) {\r\n\t\tcargarEquiposParaCliente(clientIdForEquipos);\r\n\t} else {\r\n\t\tequiposPorCliente = [];\r\n\t\trenderEquiposSelector();\r\n\t}\r\n\thideDropdown();\r\n}\r\n\r\nfunction clearClientSelection() {\r\n\tconst searchInput = getElement('cliente-search');\r\n\tconst hiddenInput = getElement('cliente');\r\n\tconst clearBtn = getElement('cliente-clear-btn');\r\n\r\n\tif (searchInput) {\r\n\t\tsearchInput.value = '';\r\n\t\tsearchInput.classList.remove('has-selection');\r\n\t\tsearchInput.focus();\r\n\t}\r\n\r\n\tif (hiddenInput) {\r\n\t\thiddenInput.value = '';\r\n\t}\r\n\r\n\tif (clearBtn) {\r\n\t\tclearBtn.classList.add('hidden');\r\n\t}\r\n\r\n\tclearClientDetails();\r\n\thideDropdown();\r\n}\r\n\r\nfunction initializeClientAutocomplete() {\r\n\tif (autocompleteInitialized) return;\r\n\r\n\tconst searchInput = getElement('cliente-search');\r\n\tconst dropdown = getElement('cliente-dropdown');\r\n\tconst clearBtn = getElement('cliente-clear-btn');\r\n\r\n\tif (!searchInput || !dropdown) return;\r\n\r\n\t// Input event - filter as user types\r\n\tsearchInput.addEventListener('input', (e) => {\r\n\t\tconst query = e.target.value;\r\n\t\tsearchInput.classList.remove('has-selection');\r\n\r\n\t\t// Clear hidden input when user modifies search\r\n\t\tconst hiddenInput = getElement('cliente');\r\n\t\tif (hiddenInput) {\r\n\t\t\thiddenInput.value = '';\r\n\t\t}\r\n\r\n\t\tif (clearBtn) {\r\n\t\t\tclearBtn.classList.toggle('hidden', !query);\r\n\t\t}\r\n\r\n\t\tconst filtered = filterClientes(query);\r\n\t\tselectedClientIndex = -1;\r\n\t\trenderDropdown(filtered, query);\r\n\t});\r\n\r\n\t// Focus event - show dropdown\r\n\tsearchInput.addEventListener('focus', () => {\r\n\t\tconst query = searchInput.value;\r\n\t\tif (!searchInput.classList.contains('has-selection')) {\r\n\t\t\tconst filtered = filterClientes(query);\r\n\t\t\trenderDropdown(filtered, query);\r\n\t\t}\r\n\t});\r\n\r\n\t// Keyboard navigation\r\n\tsearchInput.addEventListener('keydown', (e) => {\r\n\t\tconst items = dropdown.querySelectorAll('.cliente-dropdown-item');\r\n\r\n\t\tif (e.key === 'ArrowDown') {\r\n\t\t\te.preventDefault();\r\n\t\t\tselectedClientIndex = Math.min(selectedClientIndex + 1, items.length - 1);\r\n\t\t\tupdateDropdownSelection(items);\r\n\t\t} else if (e.key === 'ArrowUp') {\r\n\t\t\te.preventDefault();\r\n\t\t\tselectedClientIndex = Math.max(selectedClientIndex - 1, 0);\r\n\t\t\tupdateDropdownSelection(items);\r\n\t\t} else if (e.key === 'Enter') {\r\n\t\t\te.preventDefault();\r\n\t\t\tif (selectedClientIndex >= 0 && items[selectedClientIndex]) {\r\n\t\t\t\tconst clientKey = items[selectedClientIndex].dataset.clienteKey;\r\n\t\t\t\tselectClient(clientKey);\r\n\t\t\t}\r\n\t\t} else if (e.key === 'Escape') {\r\n\t\t\thideDropdown();\r\n\t\t}\r\n\t});\r\n\r\n\t// Click on dropdown item\r\n\tdropdown.addEventListener('click', (e) => {\r\n\t\tconst item = e.target.closest('.cliente-dropdown-item');\r\n\t\tif (item) {\r\n\t\t\tconst clientKey = item.dataset.clienteKey;\r\n\t\t\tselectClient(clientKey);\r\n\t\t}\r\n\t});\r\n\r\n\t// Clear button\r\n\tif (clearBtn) {\r\n\t\tclearBtn.addEventListener('click', (e) => {\r\n\t\t\te.preventDefault();\r\n\t\t\tclearClientSelection();\r\n\t\t});\r\n\t}\r\n\r\n\t// Click outside to close\r\n\tdocument.addEventListener('click', (e) => {\r\n\t\tconst container = getElement('cliente-autocomplete-container');\r\n\t\tif (container && !container.contains(e.target)) {\r\n\t\t\thideDropdown();\r\n\t\t}\r\n\t});\r\n\r\n\tautocompleteInitialized = true;\r\n}\r\n\r\nfunction updateDropdownSelection(items) {\r\n\titems.forEach((item, index) => {\r\n\t\titem.classList.toggle('selected', index === selectedClientIndex);\r\n\t\tif (index === selectedClientIndex) {\r\n\t\t\titem.scrollIntoView({ block: 'nearest' });\r\n\t\t}\r\n\t});\r\n}\r\n\r\nexport function configureClientSelect(clientes = []) {\r\n\t// Store clients for autocomplete\r\n\tclientesListCache = Array.isArray(clientes) ? clientes : [];\r\n\r\n\t// Clear and rebuild the data map\r\n\tclienteDataMap.clear();\r\n\tclientesListCache.forEach((cliente, index) => {\r\n\t\tif (!cliente || typeof cliente !== 'object') return;\r\n\t\tconst clientKey = `cliente-${index}`;\r\n\t\tclienteDataMap.set(clientKey, createClientDetails(cliente));\r\n\t});\r\n\r\n\t// Initialize autocomplete if not already done\r\n\tinitializeClientAutocomplete();\r\n\r\n\t// If there was a previous selection, try to restore it\r\n\tconst hiddenInput = getElement('cliente');\r\n\tconst searchInput = getElement('cliente-search');\r\n\r\n\tif (hiddenInput && hiddenInput.value && searchInput) {\r\n\t\t// Find the client by ID\r\n\t\tconst existingClient = clientesListCache.find(c => {\r\n\t\t\tconst id = extractClientId(c) || extractClientName(c);\r\n\t\t\treturn id === hiddenInput.value;\r\n\t\t});\r\n\r\n\t\tif (existingClient) {\r\n\t\t\tsearchInput.value = extractClientName(existingClient);\r\n\t\t\tsearchInput.classList.add('has-selection');\r\n\t\t\tconst clearBtn = getElement('cliente-clear-btn');\r\n\t\t\tif (clearBtn) clearBtn.classList.remove('hidden');\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function initializeForm() {\r\n\tsetDefaultDate();\r\n\tconfigureNumberInputs();\r\n\tconfigureConversionInputs();\r\n\tconfigureStatusSelects();\r\n\r\n\tconfigureAutoResizeInputs();\r\n\tconfigureClientDetailFieldInteractions();\r\n\r\n\tconfigureSanitizacionRadios();\r\n\tconfigureFieldValidation();\r\n\r\n\t// Autocompletar t├®cnico con el nombre del usuario logueado\r\n\tconst userName = getCurrentUserName();\r\n\tif (userName) {\r\n\t\tsetInputValue('tecnico', userName);\r\n\t}\r\n\r\n\t// Autocompletar fecha pr├│ximo mantenimiento con fecha actual + 365 d├¡as\r\n\tconst proximoMant = addDays(new Date(), 365);\r\n\tconst proximoMantInput = getElement('proximo_mant');\r\n\tif (proximoMantInput instanceof HTMLInputElement) {\r\n\t\tproximoMantInput.value = normalizeDateToISO(proximoMant);\r\n\t}\r\n\r\n\tcalculateAll();\r\n}\r\n\r\nexport function resetForm() {\r\n\tconst form = getElement('maintenance-form');\r\n\tif (form) {\r\n\t\tform.reset();\r\n\t}\r\n\tresetClientSelection();\r\n\tsetDefaultDate();\r\n\tclearDerivedFields();\r\n\tclearConversionOutputs();\r\n\tresetValidationStates();\r\n\tresetComponentStages();\r\n\r\n\tapplyStatusColorsToSelects();\r\n\tresizeAutoResizeInputs();\r\n\r\n\tconfigureSanitizacionRadios();\r\n\r\n}\r\n\r\nexport function getFormData() {\r\n\tconst form = getElement('maintenance-form');\r\n\tif (!(form instanceof HTMLFormElement)) {\r\n\t\treturn {};\r\n\t}\r\n\r\n\tconst data = serializeForm(form);\r\n\r\n\tconst sanitizacionOption = form.querySelector('input[name=\"sanitizacion\"]:checked');\r\n\tdata.sanitizacion = sanitizacionOption ? sanitizacionOption.value : '';\r\n\r\n\tif (Object.prototype.hasOwnProperty.call(data, 'fecha')) {\r\n\t\tconst isoFecha = normalizeDateToISO(data.fecha);\r\n\t\tdata.fecha = isoFecha || normalizeDateToISO(new Date());\r\n\t}\r\n\r\n\tif (Object.prototype.hasOwnProperty.call(data, 'proximo_mant')) {\r\n\t\tdata.proximo_mant = normalizeDateToISO(data.proximo_mant);\r\n\t}\r\n\tconst numericFields = [\r\n\t\t'cond_red_found',\r\n\t\t'cond_red_left',\r\n\t\t'cond_perm_found',\r\n\t\t'cond_perm_left',\r\n\t\t'presion_found',\r\n\t\t'presion_left',\r\n\t\t'caudal_perm_found',\r\n\t\t'caudal_perm_left',\r\n\t\t'caudal_rech_found',\r\n\t\t'caudal_rech_left',\r\n\t\t'precarga_found',\r\n\t\t'precarga_left',\r\n\t];\r\n\r\n\tnumericFields.forEach(field => {\r\n\t\tif (Object.prototype.hasOwnProperty.call(data, field) && data[field] === '') {\r\n\t\t\tdata[field] = 0;\r\n\t\t}\r\n\t});\r\n\r\n\t// Agregar el nombre del cliente si hay un cliente seleccionado\r\n\tif (data.cliente) {\r\n\t\t// Intentar obtener el nombre del cliente desde el input de b├║squeda (que tiene el nombre visible)\r\n\t\tconst searchInput = getElement('cliente-search');\r\n\t\tif (searchInput && searchInput.value && searchInput.classList.contains('has-selection')) {\r\n\t\t\tdata.cliente_nombre = searchInput.value;\r\n\t\t} else {\r\n\t\t\t// Si no est├í en el input de b├║squeda, buscarlo en el cache\r\n\t\t\tconst selectedCliente = clientesListCache.find(c => {\r\n\t\t\t\tconst id = extractClientId(c) || extractClientName(c);\r\n\t\t\t\treturn id === data.cliente;\r\n\t\t\t});\r\n\t\t\tif (selectedCliente) {\r\n\t\t\t\tdata.cliente_nombre = extractClientName(selectedCliente);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\treturn data;\r\n}\r\n\r\nexport function setReportNumber(reportNumber) {\r\n\tconst display = getElement('report-number-display');\r\n\tif (display) {\r\n\t\tdisplay.textContent = reportNumber;\r\n\t}\r\n}\r\n\r\nexport function generateReportNumber() {\r\n\tconst now = new Date();\r\n\tconst padZero = (num) => String(num).padStart(2, '0');\r\n\tconst timestamp = `${now.getFullYear()}${padZero(now.getMonth() + 1)}${padZero(now.getDate())}-${padZero(now.getHours())}${padZero(now.getMinutes())}${padZero(now.getSeconds())}`;\r\n\treturn `REP-${timestamp}`;\r\n}\r\n\r\nexport const __testables__ = {\r\n\tcalculateAll,\r\n\tupdateConversions,\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\mantenimiento\\maintenance.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\mantenimiento\\state.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\mantenimiento\\templates.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\mantenimientos-gestion\\mantenimientos-gestion.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\remito\\remito.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'navigateToDashboard' is assigned a value but never used.","line":1320,"column":79,"nodeType":"Identifier","messageId":"unusedVar","endLine":1320,"endColumn":98},{"ruleId":"no-unused-vars","severity":2,"message":"'buildEmailStatusAlertMessage' is defined but never used.","line":1366,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":1366,"endColumn":42},{"ruleId":"no-unused-vars","severity":2,"message":"'emailStatus' is assigned a value but never used.","line":1791,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":1791,"endColumn":30},{"ruleId":"no-undef","severity":2,"message":"'html2canvas' is not defined.","line":2040,"column":26,"nodeType":"Identifier","messageId":"undef","endLine":2040,"endColumn":37}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { COMPONENT_STAGES } from '../mantenimiento/templates.js';\r\n\r\nconst MAX_REMITO_PHOTOS = 4;\r\nconst MAX_PHOTO_SIZE_BYTES = 5 * 1024 * 1024; // 5 MB\r\nconst DRIVE_DIRECT_URL_BASE = 'https://drive.google.com/uc?export=view&id=';\r\n\r\nconst PHOTO_MIME_EXTENSION_MAP = Object.freeze({\r\n    'image/jpeg': 'jpg',\r\n    'image/jpg': 'jpg',\r\n    'image/png': 'png',\r\n    'image/webp': 'webp',\r\n    'image/heic': 'heic',\r\n    'image/heif': 'heif',\r\n});\r\n\r\nfunction escapeHtml(value) {\r\n    return String(value ?? '')\r\n        .replace(/&/g, '&amp;')\r\n        .replace(/</g, '&lt;')\r\n        .replace(/>/g, '&gt;')\r\n        .replace(/\"/g, '&quot;')\r\n        .replace(/'/g, '&#39;');\r\n}\r\n\r\nfunction guessExtensionFromMimeType(mimeType) {\r\n    const normalized = normalizeString(mimeType).toLowerCase();\r\n    return PHOTO_MIME_EXTENSION_MAP[normalized] || 'jpg';\r\n}\r\n\r\nfunction sanitizePhotoFileName(name, fallbackBase, index, mimeType) {\r\n    const base = normalizeString(name) || `${fallbackBase}-foto-${index + 1}`;\r\n    const withoutSeparators = base.replace(/[\\\\/]/g, '-');\r\n    const normalized = withoutSeparators.replace(/[^a-zA-Z0-9._-]+/g, '_');\r\n    const extension = guessExtensionFromMimeType(mimeType);\r\n\r\n    if (normalized.toLowerCase().endsWith(`.${extension}`)) {\r\n        return normalized;\r\n    }\r\n\r\n    const withoutExtension = normalized.replace(/\\.[^.]+$/, '');\r\n    return `${withoutExtension}.${extension}`;\r\n}\r\n\r\nfunction buildDriveDirectUrl(fileId) {\r\n    const id = normalizeString(fileId);\r\n    if (!id) {\r\n        return '';\r\n    }\r\n\r\n    try {\r\n        return `${DRIVE_DIRECT_URL_BASE}${encodeURIComponent(id)}`;\r\n    } catch (error) {\r\n        return `${DRIVE_DIRECT_URL_BASE}${id}`;\r\n    }\r\n}\r\n\r\nfunction extractDriveFileId(value) {\r\n    const text = normalizeString(value);\r\n    if (!text || text.startsWith('data:')) {\r\n        return '';\r\n    }\r\n\r\n    const directMatch = text.match(/[?&]id=([a-zA-Z0-9_-]+)/);\r\n    if (directMatch && directMatch[1]) {\r\n        return directMatch[1];\r\n    }\r\n\r\n    const pathMatch = text.match(/\\/d\\/([a-zA-Z0-9_-]+)/);\r\n    if (pathMatch && pathMatch[1]) {\r\n        return pathMatch[1];\r\n    }\r\n\r\n    if (/^[a-zA-Z0-9_-]{10,}$/.test(text)) {\r\n        return text;\r\n    }\r\n\r\n    return '';\r\n}\r\n\r\nfunction createEmptyPhotoSlot(index = 0) {\r\n    return {\r\n        index,\r\n        previewUrl: '',\r\n        base64Data: '',\r\n        mimeType: '',\r\n        fileName: '',\r\n        url: '',\r\n        driveId: '',\r\n        shouldRemove: false,\r\n    };\r\n}\r\n\r\nfunction createEmptyPhotoSlots() {\r\n    return Array.from({ length: MAX_REMITO_PHOTOS }, (_, index) => createEmptyPhotoSlot(index));\r\n}\r\n\r\nfunction clonePhotoSlots(slots = []) {\r\n    return Array.from({ length: MAX_REMITO_PHOTOS }, (_, index) => {\r\n        const slot = Array.isArray(slots) ? slots[index] : undefined;\r\n        if (!slot || typeof slot !== 'object') {\r\n            return createEmptyPhotoSlot(index);\r\n        }\r\n\r\n        return {\r\n            index: Number.isFinite(Number(slot.index)) ? Number(slot.index) : index,\r\n            previewUrl: typeof slot.previewUrl === 'string' ? slot.previewUrl : '',\r\n            base64Data: typeof slot.base64Data === 'string' ? slot.base64Data : '',\r\n            mimeType: typeof slot.mimeType === 'string' ? slot.mimeType : '',\r\n            fileName: typeof slot.fileName === 'string' ? slot.fileName : '',\r\n            url: typeof slot.url === 'string' ? slot.url : '',\r\n            driveId: typeof slot.driveId === 'string' ? slot.driveId : '',\r\n            shouldRemove: Boolean(slot.shouldRemove),\r\n        };\r\n    });\r\n}\r\n\r\nfunction getPhotoPreviewSource(slot) {\r\n    if (!slot || typeof slot !== 'object') {\r\n        return '';\r\n    }\r\n\r\n    const previewUrl = normalizeString(slot.previewUrl);\r\n    if (previewUrl) {\r\n        return previewUrl;\r\n    }\r\n\r\n    const driveId = normalizeString(slot.driveId || slot.driveFileId || slot.id);\r\n    if (driveId) {\r\n        return buildDriveDirectUrl(driveId);\r\n    }\r\n\r\n    const url = normalizeString(slot.url);\r\n    const derivedId = extractDriveFileId(url);\r\n    if (derivedId) {\r\n        return buildDriveDirectUrl(derivedId);\r\n    }\r\n\r\n    return url;\r\n}\r\n\r\nfunction formatPhotoFileLabel(slot) {\r\n    if (!slot || typeof slot !== 'object') {\r\n        return 'Sin archivo seleccionado';\r\n    }\r\n\r\n    const fileName = normalizeString(slot.fileName);\r\n    if (fileName) {\r\n        return fileName;\r\n    }\r\n\r\n    const driveId = normalizeString(slot.driveId || slot.driveFileId || slot.id);\r\n    if (driveId) {\r\n        return `Foto en Drive (${driveId.slice(0, 8)}...)`;\r\n    }\r\n\r\n    const url = normalizeString(slot.url);\r\n    if (url) {\r\n        try {\r\n            const parsed = new URL(url);\r\n            const segments = parsed.pathname.split('/');\r\n            const lastSegment = segments[segments.length - 1];\r\n            return lastSegment || 'Foto subida';\r\n        } catch (error) {\r\n            return 'Foto subida';\r\n        }\r\n    }\r\n\r\n    return 'Sin archivo seleccionado';\r\n}\r\n\r\nfunction isFileReaderSupported() {\r\n    return typeof window !== 'undefined' && typeof window.FileReader !== 'undefined';\r\n}\r\n\r\nfunction readFileAsDataUrl(file) {\r\n    return new Promise((resolve, reject) => {\r\n        const reader = new FileReader();\r\n        reader.onload = () => {\r\n            resolve(reader.result);\r\n        };\r\n        reader.onerror = () => {\r\n            reject(new Error('No se pudo leer el archivo seleccionado.'));\r\n        };\r\n        reader.readAsDataURL(file);\r\n    });\r\n}\r\n\r\nfunction extractBase64FromDataUrl(dataUrl) {\r\n    if (typeof dataUrl !== 'string') {\r\n        throw new Error('No se pudo interpretar la imagen seleccionada.');\r\n    }\r\n\r\n    const match = dataUrl.match(/^data:([^;]+);base64,(.+)$/);\r\n    if (!match) {\r\n        throw new Error('El formato de la imagen no es compatible.');\r\n    }\r\n\r\n    return match[2];\r\n}\r\n\r\nfunction getElement(id) {\r\n    return typeof document !== 'undefined' ? document.getElementById(id) : null;\r\n}\r\n\r\nfunction getSelectedOptionText(selectId) {\r\n    const select = getElement(selectId);\r\n    if (!(select instanceof HTMLSelectElement)) {\r\n        return '';\r\n    }\r\n\r\n    const option = select.selectedOptions?.[0];\r\n    return option ? option.textContent.trim() : '';\r\n}\r\n\r\nfunction getInputValue(id) {\r\n    const element = getElement(id);\r\n    if (!(element instanceof HTMLInputElement || element instanceof HTMLTextAreaElement)) {\r\n        return '';\r\n    }\r\n    return element.value.trim();\r\n}\r\n\r\nfunction cloneReportData(data) {\r\n    if (!data || typeof data !== 'object') {\r\n        return {};\r\n    }\r\n\r\n    try {\r\n        return JSON.parse(JSON.stringify(data));\r\n    } catch (error) {\r\n        return { ...data };\r\n    }\r\n}\r\n\r\nfunction normalizeString(value) {\r\n    if (value === null || value === undefined) {\r\n        return '';\r\n    }\r\n\r\n    const text = String(value).trim();\r\n    return text;\r\n}\r\n\r\nfunction hasContent(value) {\r\n    return Boolean(normalizeString(value));\r\n}\r\n\r\nfunction buildRepuestoDescripcion(item = {}) {\r\n    const descripcion = [item.descripcion, item.detalle, item.detalles, item.title, item.nombre]\r\n        .map(normalizeString)\r\n        .filter(Boolean)\r\n        .join(' - ');\r\n\r\n    return descripcion;\r\n}\r\n\r\nfunction normalizeRepuestoItem(item = {}) {\r\n    if (!item || typeof item !== 'object') {\r\n        return { codigo: '', descripcion: '', cantidad: '' };\r\n    }\r\n\r\n    const codigo = normalizeString(item.codigo || item.id || item.codigo_repuesto || item.cod || item.codigoArticulo);\r\n    const descripcion = buildRepuestoDescripcion(item);\r\n    const cantidadRaw = item.cantidad ?? item.cant ?? item.unidades ?? '';\r\n    const cantidadText = normalizeString(cantidadRaw);\r\n\r\n    if (cantidadText) {\r\n        const parsed = Number(String(cantidadText).replace(',', '.'));\r\n        if (Number.isFinite(parsed) && parsed >= 0) {\r\n            return { codigo, descripcion, cantidad: String(parsed) };\r\n        }\r\n    }\r\n\r\n    return { codigo, descripcion, cantidad: cantidadText };\r\n}\r\n\r\nfunction isReplacementAction(value) {\r\n    const normalized = normalizeString(value).toLowerCase();\r\n    if (!normalized) {\r\n        return false;\r\n    }\r\n\r\n    const replacementKeywords = ['cambi', 'reempl', 'instal', 'nuevo'];\r\n    return replacementKeywords.some(keyword => normalized.includes(keyword));\r\n}\r\n\r\nfunction buildComponentStageLookup(stages) {\r\n    if (!Array.isArray(stages)) {\r\n        return {};\r\n    }\r\n\r\n    return stages.reduce((map, stage) => {\r\n        if (stage?.id) {\r\n            map[stage.id] = normalizeString(stage.title) || stage.id;\r\n        }\r\n        return map;\r\n    }, {});\r\n}\r\n\r\nfunction buildStageIdList(stages) {\r\n    const defaultIds = Array.from({ length: 6 }, (_, index) => `etapa${index + 1}`);\r\n\r\n    if (!Array.isArray(stages) || stages.length === 0) {\r\n        return defaultIds;\r\n    }\r\n\r\n    const providedIds = stages\r\n        .map(stage => normalizeString(stage?.id))\r\n        .filter(Boolean);\r\n\r\n    const uniqueIds = new Set([...providedIds, ...defaultIds]);\r\n    return Array.from(uniqueIds);\r\n}\r\n\r\nfunction buildComponentesFromReport(report, stages = COMPONENT_STAGES) {\r\n    if (!report || typeof report !== 'object') {\r\n        return [];\r\n    }\r\n\r\n    const stageLookup = buildComponentStageLookup(stages);\r\n    const stageIds = buildStageIdList(stages);\r\n\r\n    return stageIds.reduce((acc, stageId) => {\r\n        const accionKey = `${stageId}_accion`;\r\n        const detallesKey = `${stageId}_detalles`;\r\n\r\n        const accion = normalizeString(report[accionKey]);\r\n        const detalles = normalizeString(report[detallesKey]);\r\n\r\n        if (!isReplacementAction(accion)) {\r\n            return acc;\r\n        }\r\n\r\n        acc.push({\r\n            accion,\r\n            detalles,\r\n            title: stageLookup[stageId] || stageId,\r\n        });\r\n\r\n        return acc;\r\n    }, []);\r\n}\r\n\r\nfunction formatDateValue(rawDate) {\r\n    const value = normalizeString(rawDate);\r\n    if (!value) {\r\n        return '';\r\n    }\r\n\r\n    if (/^\\d{2}\\/\\d{2}\\/\\d{4}$/.test(value)) {\r\n        return value;\r\n    }\r\n\r\n    const isoMatch = value.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\r\n    if (isoMatch) {\r\n        const [, year, month, day] = isoMatch;\r\n        return `${day}/${month}/${year}`;\r\n    }\r\n\r\n    const timestamp = Date.parse(value);\r\n    if (!Number.isNaN(timestamp)) {\r\n        const date = new Date(timestamp);\r\n        const day = String(date.getDate()).padStart(2, '0');\r\n        const month = String(date.getMonth() + 1).padStart(2, '0');\r\n        const year = String(date.getFullYear());\r\n        return `${day}/${month}/${year}`;\r\n    }\r\n\r\n    return value;\r\n}\r\n\r\nfunction resolveReportValue(report, keys, fallback = '') {\r\n    if (!report || typeof report !== 'object') {\r\n        return fallback;\r\n    }\r\n\r\n    const candidates = Array.isArray(keys) ? keys : [keys];\r\n    for (const key of candidates) {\r\n        const value = normalizeString(report[key]);\r\n        if (value) {\r\n            return value;\r\n        }\r\n    }\r\n\r\n    return fallback;\r\n}\r\n\r\nfunction getRemitoLogoUrl() {\r\n    if (typeof window === 'undefined') {\r\n        return '';\r\n    }\r\n\r\n    const candidates = [];\r\n    const pushCandidate = value => {\r\n        const normalized = normalizeString(value);\r\n        if (normalized && !candidates.includes(normalized)) {\r\n            candidates.push(normalized);\r\n        }\r\n    };\r\n\r\n    try {\r\n        const baseElementHref = window.document?.querySelector?.('base[href]')?.href;\r\n        if (baseElementHref) {\r\n            pushCandidate(new URL('OHM-agua.png', baseElementHref).href);\r\n        }\r\n    } catch (error) {\r\n        console.warn('No se pudo determinar la URL del logo del remito desde la etiqueta <base>.', error);\r\n    }\r\n\r\n    try {\r\n        const locationHref = window.location?.href;\r\n        if (locationHref) {\r\n            pushCandidate(new URL('OHM-agua.png', locationHref).href);\r\n        }\r\n    } catch (error) {\r\n        console.warn('No se pudo determinar la URL del logo del remito desde la ubicaci├│n actual.', error);\r\n    }\r\n\r\n    try {\r\n        const locationOrigin = window.location?.origin;\r\n        if (locationOrigin) {\r\n            pushCandidate(new URL('OHM-agua.png', locationOrigin).href);\r\n        }\r\n    } catch (error) {\r\n        console.warn('No se pudo determinar la URL del logo del remito desde el origen actual.', error);\r\n    }\r\n\r\n    pushCandidate('/OHM-agua.png');\r\n\r\n    return candidates.find(Boolean) || '';\r\n}\r\n\r\nfunction buildPrintableRepuestosList(repuestos, report) {\r\n    if (Array.isArray(repuestos) && repuestos.length > 0) {\r\n        return repuestos;\r\n    }\r\n\r\n    if (Array.isArray(report?.repuestos) && report.repuestos.length > 0) {\r\n        return report.repuestos;\r\n    }\r\n\r\n    return buildComponentesFromReport(report);\r\n}\r\n\r\nfunction buildPrintablePhotos(photoSlots = []) {\r\n    if (!Array.isArray(photoSlots) || photoSlots.length === 0) {\r\n        return [];\r\n    }\r\n\r\n    return photoSlots\r\n        .map((slot, index) => {\r\n            if (!slot || typeof slot !== 'object') {\r\n                return null;\r\n            }\r\n\r\n            const previewSource = normalizeString(getPhotoPreviewSource(slot));\r\n            let photoSource = previewSource;\r\n\r\n            if (!photoSource) {\r\n                const base64Data = normalizeString(slot.base64Data);\r\n                const mimeType = normalizeString(slot.mimeType) || 'image/jpeg';\r\n                if (base64Data) {\r\n                    photoSource = `data:${mimeType};base64,${base64Data}`;\r\n                }\r\n            }\r\n\r\n            if (!photoSource) {\r\n                return null;\r\n            }\r\n\r\n            const label = normalizeString(formatPhotoFileLabel(slot)) || `Foto ${index + 1}`;\r\n\r\n            return {\r\n                src: photoSource,\r\n                label,\r\n            };\r\n        })\r\n        .filter(Boolean);\r\n}\r\n\r\nfunction buildPrintableRemitoData(report, { observaciones = '', repuestos = [], photoSlots = [] } = {}) {\r\n    if (!report || typeof report !== 'object') {\r\n        return null;\r\n    }\r\n\r\n    const numero = resolveReportValue(report, ['NumeroRemito', 'numero_remito', 'remitoNumero', 'numero_reporte']);\r\n    const fecha = formatDateValue(resolveReportValue(report, ['fecha_display', 'fecha']));\r\n\r\n    const cliente = {\r\n        nombre: resolveReportValue(report, ['clienteNombre', 'cliente_nombre', 'cliente']),\r\n        direccion: resolveReportValue(report, ['direccion', 'cliente_direccion', 'ubicacion']),\r\n        telefono: resolveReportValue(report, ['cliente_telefono', 'telefono_cliente', 'telefono']),\r\n        email: resolveReportValue(report, ['cliente_email', 'email']),\r\n        cuit: resolveReportValue(report, ['cliente_cuit', 'cuit']),\r\n    };\r\n\r\n\r\n    // Extraer datos del equipo desde la estructura de Supabase\r\n    const seccionEquipo = report.seccion_B_equipo || {};\r\n    const seccionCliente = report.seccion_A_cliente || {};\r\n\r\n    const equipo = {\r\n        descripcion: resolveReportValue(report, [\r\n            'equipo', 'modelo', 'descripcion_equipo', 'tipoEquipo', 'tipo_equipo',\r\n            'TipoEquipo', 'sistemaTipo', 'modelo_sistema', 'tipo_sistema'\r\n        ]) || seccionEquipo.tipo,\r\n        modelo: seccionEquipo.modelo || resolveReportValue(report, [\r\n            'modelo', 'modelo_equipo', 'ModeloEquipo', 'modelo_sistema', 'volumen_resina', 'modeloSistema'\r\n        ]),\r\n        serie: seccionEquipo.numero_serie || resolveReportValue(report, [\r\n            'n_serie', 'numero_serie', 'NumeroSerie', 'serialNumber', 'serie', 'Serie'\r\n        ]),\r\n        interno: seccionEquipo.id_interna || resolveReportValue(report, [\r\n            'id_interna', 'codigo_interno', 'IDInterna', 'ActivoInterno', 'idInterno', 'activoId'\r\n        ]),\r\n        ubicacion: seccionEquipo.ubicacion || resolveReportValue(report, [\r\n            'ubicacion', 'direccion', 'cliente_direccion', 'Ubicacion', 'ubicacionEquipo'\r\n        ]),\r\n        tecnico: seccionCliente.tecnico || resolveReportValue(report, [\r\n            'tecnico', 'tecnico_asignado', 'TecnicoResponsable', 'tecnicoNombre', 'usuario'\r\n        ]),\r\n    };\r\n\r\n\r\n    const repuestosFuente = buildPrintableRepuestosList(repuestos, report);\r\n    const repuestosNormalizados = Array.isArray(repuestosFuente)\r\n        ? repuestosFuente\r\n            .map(item => normalizeRepuestoItem(item))\r\n            .map(item => ({\r\n                codigo: normalizeString(item.codigo),\r\n                descripcion: normalizeString(item.descripcion),\r\n                cantidad: normalizeString(item.cantidad),\r\n            }))\r\n            .filter(item => hasContent(item.codigo) || hasContent(item.descripcion) || hasContent(item.cantidad))\r\n        : [];\r\n\r\n    const observacionesTexto = normalizeString(observaciones || report.observaciones || report.resumen || '');\r\n    const fotos = buildPrintablePhotos(photoSlots);\r\n\r\n    return {\r\n        numero: normalizeString(numero),\r\n        fecha: normalizeString(fecha),\r\n        cliente,\r\n        equipo,\r\n        repuestos: repuestosNormalizados,\r\n        observaciones: observacionesTexto,\r\n        fotos,\r\n    };\r\n}\r\n\r\nfunction buildInfoTableRows(entries = []) {\r\n    return entries\r\n        .map(entry => {\r\n            const label = escapeHtml(entry?.label || '');\r\n            const value = escapeHtml(normalizeString(entry?.value || ''));\r\n            return `\r\n                <tr>\r\n                    <th scope=\"row\">${label}</th>\r\n                    <td>${value || '<span class=\"placeholder\">ÔÇö</span>'}</td>\r\n                </tr>\r\n            `;\r\n        })\r\n        .join('');\r\n}\r\n\r\nfunction buildRepuestosTableRows(repuestos = []) {\r\n    if (!Array.isArray(repuestos) || repuestos.length === 0) {\r\n        return `\r\n            <tr class=\"empty-row\">\r\n                <td colspan=\"4\">Sin repuestos registrados.</td>\r\n            </tr>\r\n        `;\r\n    }\r\n\r\n    return repuestos\r\n        .map((item, index) => {\r\n            const posicion = escapeHtml(String(index + 1));\r\n            const codigo = escapeHtml(item.codigo);\r\n            const descripcion = escapeHtml(item.descripcion);\r\n            const cantidad = escapeHtml(item.cantidad);\r\n\r\n            return `\r\n                <tr>\r\n                    <td class=\"index\">${posicion}</td>\r\n                    <td>${codigo || '<span class=\"placeholder\">ÔÇö</span>'}</td>\r\n                    <td>${descripcion || '<span class=\"placeholder\">ÔÇö</span>'}</td>\r\n                    <td class=\"cantidad\">${cantidad || '<span class=\"placeholder\">ÔÇö</span>'}</td>\r\n                </tr>\r\n            `;\r\n        })\r\n        .join('');\r\n}\r\n\r\nfunction buildPhotosSection(fotos = []) {\r\n    if (!Array.isArray(fotos) || fotos.length === 0) {\r\n        return '<p class=\"placeholder\">Sin fotos adjuntas para este remito.</p>';\r\n    }\r\n\r\n    return `\r\n        <div class=\"photo-grid\">\r\n            ${fotos\r\n            .map((foto, index) => {\r\n                const labelValue = normalizeString(foto?.label) || `Foto ${index + 1}`;\r\n                const sanitizedLabel = escapeHtml(labelValue);\r\n                const sourceValue = normalizeString(foto?.src);\r\n                if (!sourceValue) {\r\n                    return '';\r\n                }\r\n\r\n                const sanitizedSource = escapeHtml(sourceValue);\r\n                const altText = escapeHtml(`Registro fotogr├ífico ${labelValue}`);\r\n                return `\r\n                        <figure class=\"photo-item\">\r\n                            <div class=\"photo-item__frame\">\r\n                                <img src=\"${sanitizedSource}\" alt=\"${altText}\" loading=\"lazy\">\r\n                            </div>\r\n                            <figcaption>${sanitizedLabel}</figcaption>\r\n                        </figure>\r\n                    `;\r\n            })\r\n            .join('')}\r\n        </div>\r\n    `;\r\n}\r\n\r\nfunction createRemitoPrintHtml(data) {\r\n    if (!data) {\r\n        return '';\r\n    }\r\n\r\n    const numero = escapeHtml(data.numero || 'ÔÇö');\r\n    const fecha = escapeHtml(data.fecha || 'ÔÇö');\r\n    const logoUrl = escapeHtml(getRemitoLogoUrl());\r\n    const observaciones = data.observaciones\r\n        ? escapeHtml(data.observaciones).replace(/\\r?\\n/g, '<br>')\r\n        : '<span class=\"placeholder\">Sin observaciones registradas.</span>';\r\n\r\n    const clienteRows = buildInfoTableRows([\r\n        { label: 'Raz├│n social', value: data.cliente?.nombre },\r\n        { label: 'Direcci├│n', value: data.cliente?.direccion },\r\n        { label: 'Tel├®fono', value: data.cliente?.telefono },\r\n        { label: 'Email', value: data.cliente?.email },\r\n        { label: 'CUIT', value: data.cliente?.cuit },\r\n    ]);\r\n\r\n    const equipoRows = buildInfoTableRows([\r\n        { label: 'Descripci├│n', value: data.equipo?.descripcion },\r\n        { label: 'Modelo', value: data.equipo?.modelo },\r\n        { label: 'N┬░ de serie', value: data.equipo?.serie },\r\n        { label: 'Activo / ID interno', value: data.equipo?.interno },\r\n        { label: 'Ubicaci├│n', value: data.equipo?.ubicacion },\r\n        { label: 'T├®cnico responsable', value: data.equipo?.tecnico },\r\n    ]);\r\n\r\n    const repuestosRows = buildRepuestosTableRows(data.repuestos);\r\n    const fotosSection = buildPhotosSection(data.fotos);\r\n\r\n    return `<!DOCTYPE html>\r\n<html lang=\"es\">\r\n<head>\r\n    <meta charset=\"utf-8\">\r\n    <title>Remito ${numero}</title>\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <style>\r\n        :root {\r\n            color-scheme: only light;\r\n        }\r\n\r\n        @page {\r\n            size: A4;\r\n            margin: 1.5cm;\r\n        }\r\n\r\n        * {\r\n            box-sizing: border-box;\r\n        }\r\n\r\n        body {\r\n            margin: 0;\r\n            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;\r\n            font-size: 12px;\r\n            line-height: 1.5;\r\n            color: #111827;\r\n            background: #f3f4f6;\r\n        }\r\n\r\n        .document {\r\n            background: #ffffff;\r\n            padding: 28px;\r\n            border-radius: 12px;\r\n            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);\r\n        }\r\n\r\n        .document__header {\r\n            display: flex;\r\n            justify-content: space-between;\r\n            align-items: center;\r\n            gap: 16px;\r\n            border-bottom: 2px solid #2563eb;\r\n            padding-bottom: 18px;\r\n            margin-bottom: 24px;\r\n        }\r\n\r\n        .document__identity {\r\n            display: flex;\r\n            flex-direction: column;\r\n            gap: 4px;\r\n        }\r\n\r\n        .document__title {\r\n            font-size: 22px;\r\n            font-weight: 700;\r\n            color: #1f2937;\r\n            margin: 0;\r\n        }\r\n\r\n        .document__meta {\r\n            display: flex;\r\n            flex-wrap: wrap;\r\n            gap: 12px;\r\n            color: #374151;\r\n            font-weight: 600;\r\n        }\r\n\r\n        .document__logo {\r\n            flex: none;\r\n            max-width: 140px;\r\n        }\r\n\r\n        .document__logo img {\r\n            width: 100%;\r\n            height: auto;\r\n            display: block;\r\n        }\r\n\r\n        .section {\r\n            margin-bottom: 24px;\r\n        }\r\n\r\n        .section__title {\r\n            font-size: 15px;\r\n            font-weight: 700;\r\n            margin: 0 0 12px;\r\n            color: #1f2937;\r\n            text-transform: uppercase;\r\n            letter-spacing: 0.04em;\r\n        }\r\n\r\n        .info-table,\r\n        .repuestos-table {\r\n            width: 100%;\r\n            border-collapse: collapse;\r\n            border: 1px solid #d1d5db;\r\n            border-radius: 8px;\r\n            overflow: hidden;\r\n        }\r\n\r\n        .info-table th,\r\n        .info-table td {\r\n            text-align: left;\r\n            padding: 8px 10px;\r\n            border-bottom: 1px solid #e5e7eb;\r\n            vertical-align: top;\r\n        }\r\n\r\n        .info-table th {\r\n            width: 32%;\r\n            font-weight: 600;\r\n            background: #f9fafb;\r\n            color: #1f2937;\r\n        }\r\n\r\n        .info-table tr:last-child th,\r\n        .info-table tr:last-child td {\r\n            border-bottom: none;\r\n        }\r\n\r\n        .repuestos-table thead {\r\n            background: #2563eb;\r\n            color: #ffffff;\r\n        }\r\n\r\n        .repuestos-table th,\r\n        .repuestos-table td {\r\n            padding: 10px;\r\n            border-bottom: 1px solid #e5e7eb;\r\n        }\r\n\r\n        .repuestos-table th {\r\n            text-transform: uppercase;\r\n            font-size: 11px;\r\n            letter-spacing: 0.05em;\r\n        }\r\n\r\n        .repuestos-table td.index {\r\n            width: 48px;\r\n            font-weight: 600;\r\n            text-align: center;\r\n        }\r\n\r\n        .repuestos-table td.cantidad {\r\n            text-align: right;\r\n            width: 80px;\r\n            font-weight: 600;\r\n        }\r\n\r\n        .repuestos-table tr:last-child td {\r\n            border-bottom: none;\r\n        }\r\n\r\n        .placeholder {\r\n            color: #9ca3af;\r\n            font-style: italic;\r\n        }\r\n\r\n        .observaciones {\r\n            padding: 16px;\r\n            border: 1px solid #d1d5db;\r\n            border-radius: 10px;\r\n            background: #f9fafb;\r\n            min-height: 90px;\r\n            white-space: pre-line;\r\n        }\r\n\r\n        .photo-grid {\r\n            display: grid;\r\n            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));\r\n            gap: 16px;\r\n        }\r\n\r\n        .photo-item {\r\n            margin: 0;\r\n            display: flex;\r\n            flex-direction: column;\r\n            gap: 8px;\r\n        }\r\n\r\n        .photo-item__frame {\r\n            position: relative;\r\n            overflow: hidden;\r\n            border-radius: 12px;\r\n            border: 1px solid #e5e7eb;\r\n            background: #111827;\r\n            aspect-ratio: 3 / 2;\r\n        }\r\n\r\n        .photo-item__frame img {\r\n            width: 100%;\r\n            height: 100%;\r\n            object-fit: contain;\r\n            background: #111827;\r\n        }\r\n\r\n        .photo-item figcaption {\r\n            font-size: 11px;\r\n            color: #4b5563;\r\n            text-align: center;\r\n        }\r\n\r\n        .document__footer {\r\n            margin-top: 32px;\r\n            display: grid;\r\n            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));\r\n            gap: 24px;\r\n        }\r\n\r\n        .firma {\r\n            border-top: 1px solid #9ca3af;\r\n            padding-top: 12px;\r\n            text-align: center;\r\n            color: #6b7280;\r\n        }\r\n\r\n        @media print {\r\n            body {\r\n                background: #ffffff;\r\n                -webkit-print-color-adjust: exact;\r\n                print-color-adjust: exact;\r\n            }\r\n\r\n            .document {\r\n                box-shadow: none;\r\n            }\r\n\r\n            .document__header {\r\n                margin-bottom: 18px;\r\n            }\r\n\r\n            .section {\r\n                page-break-inside: avoid;\r\n            }\r\n\r\n            .photo-item {\r\n                page-break-inside: avoid;\r\n            }\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <div class=\"document\">\r\n        <header class=\"document__header\">\r\n            <div class=\"document__identity\">\r\n                <p class=\"document__title\">Remito de servicio</p>\r\n                <div class=\"document__meta\">\r\n                    <span>N├║mero: <strong>${numero}</strong></span>\r\n                    <span>Fecha: <strong>${fecha}</strong></span>\r\n                </div>\r\n            </div>\r\n            <div class=\"document__logo\">\r\n                <img src=\"${logoUrl}\" alt=\"Logo de OHM Agua\">\r\n            </div>\r\n        </header>\r\n\r\n        <section class=\"section\">\r\n            <h2 class=\"section__title\">Datos del cliente</h2>\r\n            <table class=\"info-table\">\r\n                <tbody>\r\n                    ${clienteRows}\r\n                </tbody>\r\n            </table>\r\n        </section>\r\n\r\n        <section class=\"section\">\r\n            <h2 class=\"section__title\">Datos del equipo</h2>\r\n            <table class=\"info-table\">\r\n                <tbody>\r\n                    ${equipoRows}\r\n                </tbody>\r\n            </table>\r\n        </section>\r\n\r\n        <section class=\"section\">\r\n            <h2 class=\"section__title\">Repuestos y materiales</h2>\r\n            <table class=\"repuestos-table\">\r\n                <thead>\r\n                    <tr>\r\n                        <th>#</th>\r\n                        <th>C├│digo</th>\r\n                        <th>Descripci├│n</th>\r\n                        <th>Cantidad</th>\r\n                    </tr>\r\n                </thead>\r\n                <tbody>\r\n                    ${repuestosRows}\r\n                </tbody>\r\n            </table>\r\n        </section>\r\n\r\n        <section class=\"section\">\r\n            <h2 class=\"section__title\">Observaciones</h2>\r\n            <div class=\"observaciones\">${observaciones}</div>\r\n        </section>\r\n\r\n        <section class=\"section\">\r\n            <h2 class=\"section__title\">Registro fotogr├ífico</h2>\r\n            ${fotosSection}\r\n        </section>\r\n\r\n        <footer class=\"document__footer\">\r\n            <div class=\"firma\">\r\n                <p>Firma del responsable de OHM Agua</p>\r\n            </div>\r\n            <div class=\"firma\">\r\n                <p>Firma y aclaraci├│n del cliente</p>\r\n            </div>\r\n        </footer>\r\n    </div>\r\n    <script>\r\n        window.addEventListener('load', () => {\r\n            window.focus();\r\n            setTimeout(() => {\r\n                try {\r\n                    window.print();\r\n                } catch (error) {\r\n                    console.error('No se pudo iniciar la impresi├│n autom├ítica.', error);\r\n                }\r\n            }, 150);\r\n        });\r\n\r\n        window.addEventListener('afterprint', () => {\r\n            setTimeout(() => {\r\n                window.close();\r\n            }, 250);\r\n        });\r\n    </script>\r\n</body>\r\n</html>`;\r\n}\r\n\r\nfunction openRemitoPrintPreview(report, options = {}) {\r\n    if (typeof window === 'undefined') {\r\n        return false;\r\n    }\r\n\r\n    const printableData = buildPrintableRemitoData(report, options);\r\n    if (!printableData) {\r\n        return false;\r\n    }\r\n\r\n    const html = createRemitoPrintHtml(printableData);\r\n    if (!html) {\r\n        return false;\r\n    }\r\n\r\n    const printWindow = window.open('', '_blank');\r\n    if (!printWindow) {\r\n        return false;\r\n    }\r\n\r\n    try {\r\n        printWindow.document.open();\r\n        printWindow.document.write(html);\r\n        printWindow.document.close();\r\n        printWindow.opener = null;\r\n        return true;\r\n    } catch (error) {\r\n        console.error('No se pudo abrir la vista de impresi├│n del remito.', error);\r\n        return false;\r\n    }\r\n}\r\n\r\nfunction setReadonlyInputValue(id, value) {\r\n    const element = getElement(id);\r\n    if (!(element instanceof HTMLInputElement)) {\r\n        return;\r\n    }\r\n\r\n    element.value = normalizeString(value);\r\n    element.readOnly = true;\r\n    element.setAttribute('readonly', 'readonly');\r\n}\r\n\r\nfunction clearReadonlyInputs(ids = []) {\r\n    ids.forEach(id => {\r\n        const element = getElement(id);\r\n        if (element instanceof HTMLInputElement) {\r\n            element.value = '';\r\n            element.readOnly = true;\r\n            element.setAttribute('readonly', 'readonly');\r\n        }\r\n    });\r\n}\r\n\r\nfunction createRepuestoRow(data = {}, { forceDefaultCantidad = false } = {}) {\r\n    if (typeof document === 'undefined') {\r\n        return null;\r\n    }\r\n\r\n    const { codigo = '', descripcion = '', cantidad = '' } = data;\r\n    const resolvedCantidad = forceDefaultCantidad && !hasContent(cantidad) ? '1' : cantidad;\r\n\r\n    const row = document.createElement('tr');\r\n    row.className = 'remito-repuesto-row transition-colors duration-150 hover:bg-gray-50';\r\n\r\n    const codigoCell = document.createElement('td');\r\n    codigoCell.className = 'px-4 py-3 align-top';\r\n    const codigoInput = document.createElement('input');\r\n    codigoInput.type = 'text';\r\n    codigoInput.name = 'repuesto-codigo';\r\n    codigoInput.placeholder = 'C├│digo del repuesto';\r\n    codigoInput.value = codigo;\r\n    codigoInput.dataset.field = 'codigo';\r\n    codigoInput.className = 'repuestos-table-input';\r\n    codigoCell.appendChild(codigoInput);\r\n\r\n    const descripcionCell = document.createElement('td');\r\n    descripcionCell.className = 'px-4 py-3 align-top';\r\n    const descripcionInput = document.createElement('input');\r\n    descripcionInput.type = 'text';\r\n    descripcionInput.name = 'repuesto-descripcion';\r\n    descripcionInput.placeholder = 'Descripci├│n del repuesto';\r\n    descripcionInput.value = descripcion;\r\n    descripcionInput.dataset.field = 'descripcion';\r\n    descripcionInput.className = 'repuestos-table-input';\r\n    descripcionCell.appendChild(descripcionInput);\r\n\r\n    const cantidadCell = document.createElement('td');\r\n    cantidadCell.className = 'px-4 py-3 align-top text-right';\r\n    const cantidadInput = document.createElement('input');\r\n    cantidadInput.type = 'number';\r\n    cantidadInput.name = 'repuesto-cantidad';\r\n    cantidadInput.placeholder = '0';\r\n    cantidadInput.inputMode = 'numeric';\r\n    cantidadInput.min = '0';\r\n    cantidadInput.step = '1';\r\n    cantidadInput.value = resolvedCantidad;\r\n    cantidadInput.dataset.field = 'cantidad';\r\n    cantidadInput.className = 'repuestos-table-input text-right';\r\n    cantidadCell.appendChild(cantidadInput);\r\n\r\n    row.append(codigoCell, descripcionCell, cantidadCell);\r\n    return row;\r\n}\r\n\r\nfunction renderRepuestosList(repuestos = []) {\r\n    const tbody = getElement('remito-repuestos-body');\r\n    if (!(tbody instanceof HTMLElement)) {\r\n        return;\r\n    }\r\n\r\n    tbody.innerHTML = '';\r\n\r\n    if (!Array.isArray(repuestos) || repuestos.length === 0) {\r\n        const emptyRow = createRepuestoRow();\r\n        if (emptyRow) {\r\n            tbody.appendChild(emptyRow);\r\n        }\r\n        return;\r\n    }\r\n\r\n    repuestos.forEach(item => {\r\n        const normalized = normalizeRepuestoItem(item);\r\n        const hasValues = hasContent(normalized.codigo) || hasContent(normalized.descripcion) || hasContent(normalized.cantidad);\r\n        const row = createRepuestoRow(normalized, { forceDefaultCantidad: hasValues });\r\n        if (row) {\r\n            tbody.appendChild(row);\r\n        }\r\n    });\r\n}\r\n\r\nfunction normalizeCantidadValue(value) {\r\n    const textValue = normalizeString(value);\r\n    if (!textValue) {\r\n        return '';\r\n    }\r\n\r\n    const numericValue = Number(textValue.replace(',', '.'));\r\n    if (Number.isFinite(numericValue)) {\r\n        return String(numericValue);\r\n    }\r\n\r\n    return textValue;\r\n}\r\n\r\nfunction collectRepuestosFromForm() {\r\n    const tbody = getElement('remito-repuestos-body');\r\n    if (!(tbody instanceof HTMLElement)) {\r\n        return [];\r\n    }\r\n\r\n    const rows = Array.from(tbody.querySelectorAll('tr'));\r\n    return rows.reduce((acc, row) => {\r\n        const inputs = Array.from(row.querySelectorAll('input[data-field]'));\r\n        if (inputs.length === 0) {\r\n            return acc;\r\n        }\r\n\r\n        const item = { codigo: '', descripcion: '', cantidad: '' };\r\n\r\n        inputs.forEach(input => {\r\n            if (!(input instanceof HTMLInputElement)) {\r\n                return;\r\n            }\r\n\r\n            const field = input.dataset.field;\r\n            if (!field) {\r\n                return;\r\n            }\r\n\r\n            if (field === 'cantidad') {\r\n                item.cantidad = normalizeCantidadValue(input.value);\r\n            } else {\r\n                item[field] = normalizeString(input.value);\r\n            }\r\n        });\r\n\r\n        const hasValues = hasContent(item.codigo) || hasContent(item.descripcion) || hasContent(item.cantidad);\r\n        if (hasValues) {\r\n            acc.push(item);\r\n        }\r\n\r\n        return acc;\r\n    }, []);\r\n}\r\n\r\nfunction addEmptyRepuestoRow({ focus = false } = {}) {\r\n    const tbody = getElement('remito-repuestos-body');\r\n    if (!(tbody instanceof HTMLElement)) {\r\n        return;\r\n    }\r\n\r\n    const row = createRepuestoRow();\r\n    if (!row) {\r\n        return;\r\n    }\r\n\r\n    tbody.appendChild(row);\r\n\r\n    if (focus) {\r\n        const firstInput = row.querySelector('input');\r\n        if (firstInput instanceof HTMLInputElement) {\r\n            firstInput.focus();\r\n        }\r\n    }\r\n}\r\n\r\nfunction createReportSnapshot(rawData) {\r\n    const snapshot = cloneReportData(rawData);\r\n\r\n    // Helper para detectar UUID\r\n    const isUUID = (value) => {\r\n        if (!value || typeof value !== 'string') return false;\r\n        return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(value);\r\n    };\r\n\r\n    if (!snapshot.clienteNombre) {\r\n        const selectedText = getSelectedOptionText('cliente');\r\n        const clienteValue = snapshot.cliente;\r\n        const clienteNombreValue = snapshot.cliente_nombre;\r\n\r\n        // Preferir en este orden: texto seleccionado, cliente_nombre, cliente (solo si no es UUID)\r\n        snapshot.clienteNombre = selectedText ||\r\n            clienteNombreValue ||\r\n            (!isUUID(clienteValue) ? clienteValue : '');\r\n    }\r\n\r\n    // Datos del cliente\r\n    snapshot.direccion = snapshot.direccion || getInputValue('direccion');\r\n    snapshot.cliente_telefono = snapshot.cliente_telefono || getInputValue('cliente_telefono');\r\n    snapshot.cliente_email = snapshot.cliente_email || getInputValue('cliente_email');\r\n    snapshot.cliente_cuit = snapshot.cliente_cuit || getInputValue('cliente_cuit');\r\n    snapshot.fecha_display = snapshot.fecha_display || getInputValue('fecha_display');\r\n\r\n    // Datos del equipo - capturar desde la estructura correcta de Supabase\r\n    // Primero intentar obtener desde seccion_B_equipo (estructura de Supabase)\r\n    const seccionEquipo = snapshot.seccion_B_equipo || {};\r\n    const seccionCliente = snapshot.seccion_A_cliente || {};\r\n\r\n    snapshot.modelo = snapshot.modelo || seccionEquipo.modelo || snapshot.modelo_sistema || getInputValue('softener-modelo-sistema') || getInputValue('modelo');\r\n    snapshot.n_serie = snapshot.n_serie || seccionEquipo.numero_serie || snapshot.numero_serie || getInputValue('softener-numero-serie') || getInputValue('n_serie');\r\n    snapshot.id_interna = snapshot.id_interna || seccionEquipo.id_interna || getInputValue('softener-id-interna') || getInputValue('id_interna');\r\n    snapshot.ubicacion = snapshot.ubicacion || seccionEquipo.ubicacion || getInputValue('softener-ubicacion') || getInputValue('ubicacion');\r\n    snapshot.tecnico = snapshot.tecnico || seccionCliente.tecnico || getInputValue('softener-tecnico') || getInputValue('tecnico');\r\n\r\n    const componentesDerivados = buildComponentesFromReport(snapshot);\r\n    snapshot.componentes = componentesDerivados;\r\n\r\n    if (!Array.isArray(snapshot.repuestos) || snapshot.repuestos.length === 0) {\r\n        snapshot.repuestos = componentesDerivados.map(item => ({ ...item }));\r\n    }\r\n\r\n    return snapshot;\r\n}\r\n\r\nfunction populateRemitoForm(report) {\r\n    if (!report || typeof report !== 'object') {\r\n        return;\r\n    }\r\n\r\n    const numeroRemito = resolveReportValue(report, ['NumeroRemito', 'numero_remito', 'remitoNumero', 'numero_reporte']);\r\n    const fechaRemito = formatDateValue(resolveReportValue(report, ['fecha_display', 'fecha']));\r\n\r\n    setReadonlyInputValue('remito-numero', numeroRemito);\r\n    setReadonlyInputValue('remito-fecha', fechaRemito);\r\n    setReadonlyInputValue('remito-cliente-nombre', resolveReportValue(report, ['clienteNombre', 'cliente_nombre', 'cliente']));\r\n    setReadonlyInputValue('remito-cliente-direccion', resolveReportValue(report, ['direccion', 'cliente_direccion', 'ubicacion']));\r\n    setReadonlyInputValue('remito-cliente-telefono', resolveReportValue(report, ['cliente_telefono', 'telefono_cliente', 'telefono']));\r\n    setReadonlyInputValue('remito-cliente-email', resolveReportValue(report, ['cliente_email', 'email']));\r\n    setReadonlyInputValue('remito-cliente-cuit', resolveReportValue(report, ['cliente_cuit', 'cuit']));\r\n\r\n    // Mapeo de datos del equipo - buscar en seccion_B_equipo y luego en campos directos\r\n    const seccionEquipo = report.seccion_B_equipo || {};\r\n    const seccionCliente = report.seccion_A_cliente || {};\r\n\r\n    const descripcionEquipo = resolveReportValue(report, [\r\n        'equipo', 'modelo', 'descripcion_equipo', 'tipoEquipo', 'tipo_equipo',\r\n        'TipoEquipo', 'sistemaTipo', 'modelo_sistema', 'tipo_sistema'\r\n    ]) || seccionEquipo.tipo;\r\n    setReadonlyInputValue('remito-equipo-descripcion', descripcionEquipo);\r\n    setReadonlyInputValue('remito-equipo-modelo', seccionEquipo.modelo || resolveReportValue(report, [\r\n        'modelo', 'modelo_equipo', 'ModeloEquipo', 'modelo_sistema', 'volumen_resina', 'modeloSistema'\r\n    ]));\r\n    setReadonlyInputValue('remito-equipo-serie', seccionEquipo.numero_serie || resolveReportValue(report, [\r\n        'n_serie', 'numero_serie', 'NumeroSerie', 'serialNumber', 'serie', 'Serie'\r\n    ]));\r\n    setReadonlyInputValue('remito-equipo-interno', seccionEquipo.id_interna || resolveReportValue(report, [\r\n        'id_interna', 'codigo_interno', 'IDInterna', 'ActivoInterno', 'idInterno', 'activoId'\r\n    ]));\r\n    setReadonlyInputValue('remito-equipo-ubicacion', seccionEquipo.ubicacion || resolveReportValue(report, [\r\n        'ubicacion', 'direccion', 'cliente_direccion', 'Ubicacion', 'ubicacionEquipo'\r\n    ]));\r\n    setReadonlyInputValue('remito-equipo-tecnico', seccionCliente.tecnico || resolveReportValue(report, [\r\n        'tecnico', 'tecnico_asignado', 'TecnicoResponsable', 'tecnicoNombre', 'usuario'\r\n    ]));\r\n\r\n    const observaciones = getElement('remito-observaciones');\r\n    if (observaciones instanceof HTMLTextAreaElement) {\r\n        const texto = normalizeString(report.observaciones || report.resumen || '');\r\n        observaciones.value = texto;\r\n        observaciones.removeAttribute('readonly');\r\n    }\r\n\r\n    const componentesDerivados = Array.isArray(report.componentes) && report.componentes.length > 0\r\n        ? report.componentes\r\n        : buildComponentesFromReport(report);\r\n\r\n    const repuestos = Array.isArray(report.repuestos) && report.repuestos.length > 0\r\n        ? report.repuestos\r\n        : componentesDerivados;\r\n\r\n    renderRepuestosList(repuestos);\r\n}\r\n\r\nfunction disableButton(buttonId) {\r\n    const button = getElement(buttonId);\r\n    if (button instanceof HTMLButtonElement) {\r\n        button.disabled = true;\r\n        button.setAttribute('disabled', 'disabled');\r\n    }\r\n}\r\n\r\nfunction enableButton(buttonId) {\r\n    const button = getElement(buttonId);\r\n    if (button instanceof HTMLButtonElement) {\r\n        button.disabled = false;\r\n        button.removeAttribute('disabled');\r\n    }\r\n}\r\n\r\nexport function createRemitoModule({ showView, crearRemito, guardarPdfRemito, navigateToDashboard } = {}) {\r\n    let lastSavedReport = null;\r\n    let eventsInitialized = false;\r\n    let photoSlots = createEmptyPhotoSlots();\r\n    let photoEventsInitialized = false;\r\n    let lastPrintableSnapshot = null;\r\n\r\n    function getPhotoContainer() {\r\n        const container = getElement('remito-fotos-container');\r\n        return container instanceof HTMLElement ? container : null;\r\n    }\r\n\r\n    function getPrintButton() {\r\n        const button = getElement('imprimir-remito-btn');\r\n        return button instanceof HTMLButtonElement ? button : null;\r\n    }\r\n\r\n    function setPrintButtonVisibility(visible) {\r\n        const button = getPrintButton();\r\n        if (!button) {\r\n            return;\r\n        }\r\n\r\n        if (visible) {\r\n            button.classList.remove('hidden');\r\n            button.disabled = false;\r\n        } else {\r\n            button.classList.add('hidden');\r\n            button.disabled = true;\r\n        }\r\n    }\r\n\r\n    function buildPrintableSnapshot() {\r\n        if (!lastSavedReport) {\r\n            return null;\r\n        }\r\n\r\n        const reportClone = cloneReportData(lastSavedReport);\r\n        const slotsClone = clonePhotoSlots(photoSlots);\r\n\r\n        return {\r\n            report: reportClone,\r\n            photoSlots: slotsClone,\r\n        };\r\n    }\r\n\r\n    function buildEmailStatusAlertMessage(status) {\r\n        if (!status || typeof status !== 'object') {\r\n            return '';\r\n        }\r\n\r\n        if (status.sent) {\r\n            return '­ƒôº Se envi├│ el remito por correo electr├│nico correctamente.';\r\n        }\r\n\r\n        const errorMessage = typeof status.error === 'string' ? status.error.trim() : '';\r\n        if (errorMessage) {\r\n            return `ÔÜá´©Å El remito se gener├│, pero no se pudo enviar el correo electr├│nico: ${errorMessage}`;\r\n        }\r\n\r\n        if (status.skipped) {\r\n            const infoMessage = typeof status.message === 'string' ? status.message.trim() : '';\r\n            return infoMessage\r\n                ? `Ôä╣´©Å ${infoMessage}`\r\n                : 'Ôä╣´©Å El env├¡o de correo electr├│nico est├í deshabilitado.';\r\n        }\r\n\r\n        return '';\r\n    }\r\n\r\n    function renderPhotoSlots() {\r\n        const container = getPhotoContainer();\r\n        if (!container) {\r\n            return;\r\n        }\r\n\r\n        const slotsHtml = photoSlots\r\n            .map((slot, index) => {\r\n                const previewSource = getPhotoPreviewSource(slot);\r\n                const hasPreview = Boolean(previewSource);\r\n                const labelText = escapeHtml(formatPhotoFileLabel(slot));\r\n                const buttonClasses = [\r\n                    'group relative flex w-full items-center justify-center overflow-hidden rounded-xl border-2',\r\n                    'min-h-[180px]',\r\n                    hasPreview ? 'border-transparent bg-gray-900/5' : 'border-dashed border-gray-300 bg-gray-50',\r\n                    'text-gray-400 transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2',\r\n                ].join(' ');\r\n                const triggerContent = hasPreview\r\n                    ? `\r\n                        <img src=\"${escapeHtml(previewSource)}\" alt=\"Foto ${index + 1}\" class=\"max-h-72 max-w-full object-contain mx-auto\" loading=\"lazy\">\r\n                    `\r\n                    : `\r\n                        <div class=\"flex flex-col items-center justify-center gap-2 text-gray-400\">\r\n                            <span class=\"text-5xl font-light leading-none\">+</span>\r\n                            <span class=\"text-xs font-medium\">Agregar foto</span>\r\n                        </div>\r\n                    `;\r\n                const removeButton = hasPreview\r\n                    ? `\r\n                        <button type=\"button\" class=\"absolute right-3 top-3 inline-flex h-8 w-8 items-center justify-center rounded-full bg-white text-red-500 shadow-md transition hover:bg-red-50 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2\" data-remito-photo-action=\"remove\" data-remito-photo-index=\"${index}\" title=\"Eliminar foto\" aria-label=\"Eliminar foto\">\r\n                            <span aria-hidden=\"true\" class=\"text-lg leading-none\">&times;</span>\r\n                        </button>\r\n                    `\r\n                    : '';\r\n\r\n                const menuHtml = `\r\n                    <div class=\"absolute inset-0 z-10 hidden items-center justify-center rounded-xl bg-black/40 p-4\" data-remito-photo-menu=\"${index}\" aria-hidden=\"true\">\r\n                        <button type=\"button\" class=\"absolute inset-0 cursor-default\" data-remito-photo-menu-dismiss></button>\r\n                        <div class=\"relative z-10 w-full max-w-[220px] space-y-2 rounded-lg bg-white p-4 text-center shadow-lg\">\r\n                            <p class=\"text-sm font-semibold text-gray-700\">Seleccion├í una opci├│n</p>\r\n                            <button type=\"button\" class=\"w-full rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2\" data-remito-photo-action=\"capture\" data-remito-photo-index=\"${index}\">Tomar foto</button>\r\n                            <button type=\"button\" class=\"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm transition hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2\" data-remito-photo-action=\"upload\" data-remito-photo-index=\"${index}\">Subir foto</button>\r\n                            <button type=\"button\" class=\"w-full rounded-lg border border-transparent bg-gray-100 px-3 py-2 text-sm font-semibold text-gray-600 transition hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2\" data-remito-photo-menu-dismiss>Cerrar</button>\r\n                        </div>\r\n                    </div>\r\n                `;\r\n\r\n                return `\r\n                    <div class=\"remito-photo-slot space-y-2\" data-remito-photo-slot=\"${index}\">\r\n                        <div class=\"flex items-center justify-between gap-2\">\r\n                            <p class=\"text-sm font-medium text-gray-700\">Foto ${index + 1}</p>\r\n                            <p class=\"max-w-[60%] truncate text-[11px] text-gray-500\">${labelText}</p>\r\n                        </div>\r\n                        <div class=\"relative\">\r\n                            <button type=\"button\" class=\"${buttonClasses}\" data-remito-photo-trigger data-remito-photo-index=\"${index}\" aria-label=\"Agregar o reemplazar foto ${index + 1}\">\r\n                                ${triggerContent}\r\n                            </button>\r\n                            ${removeButton}\r\n                            ${menuHtml}\r\n                        </div>\r\n                        <input type=\"file\" accept=\"image/*\" capture=\"environment\" class=\"hidden\" data-remito-photo-input=\"capture\" data-remito-photo-index=\"${index}\">\r\n                        <input type=\"file\" accept=\"image/*\" class=\"hidden\" data-remito-photo-input=\"upload\" data-remito-photo-index=\"${index}\">\r\n                    </div>\r\n                `;\r\n            })\r\n            .join('');\r\n\r\n        container.innerHTML = slotsHtml;\r\n    }\r\n\r\n    function resetPhotoSlots() {\r\n        photoSlots = createEmptyPhotoSlots();\r\n        renderPhotoSlots();\r\n    }\r\n\r\n    function closeAllPhotoMenus() {\r\n        const container = getPhotoContainer();\r\n        if (!container) {\r\n            return;\r\n        }\r\n\r\n        const menus = container.querySelectorAll('[data-remito-photo-menu]');\r\n        menus.forEach(menu => {\r\n            menu.classList.add('hidden');\r\n            menu.setAttribute('aria-hidden', 'true');\r\n        });\r\n    }\r\n\r\n    function togglePhotoMenu(index) {\r\n        const container = getPhotoContainer();\r\n        if (!container) {\r\n            return;\r\n        }\r\n\r\n        const normalizedIndex = Number(index);\r\n        if (!Number.isFinite(normalizedIndex) || normalizedIndex < 0 || normalizedIndex >= MAX_REMITO_PHOTOS) {\r\n            return;\r\n        }\r\n\r\n        const selector = `[data-remito-photo-menu=\"${normalizedIndex}\"]`;\r\n        const menu = container.querySelector(selector);\r\n        if (!menu) {\r\n            return;\r\n        }\r\n\r\n        const isHidden = menu.classList.contains('hidden');\r\n        closeAllPhotoMenus();\r\n        if (isHidden) {\r\n            menu.classList.remove('hidden');\r\n            menu.setAttribute('aria-hidden', 'false');\r\n        }\r\n    }\r\n\r\n    function openPhotoFileDialog(mode, index) {\r\n        const container = getPhotoContainer();\r\n        if (!container) {\r\n            return;\r\n        }\r\n\r\n        const selector = `[data-remito-photo-input=\"${mode}\"][data-remito-photo-index=\"${index}\"]`;\r\n        const input = container.querySelector(selector);\r\n        if (input instanceof HTMLInputElement) {\r\n            input.value = '';\r\n            input.click();\r\n        }\r\n    }\r\n\r\n    function removePhotoSlot(index) {\r\n        const normalizedIndex = Number(index);\r\n        if (!Number.isFinite(normalizedIndex) || normalizedIndex < 0 || normalizedIndex >= photoSlots.length) {\r\n            return;\r\n        }\r\n\r\n        closeAllPhotoMenus();\r\n        photoSlots[normalizedIndex] = createEmptyPhotoSlot(normalizedIndex);\r\n        renderPhotoSlots();\r\n    }\r\n\r\n    async function handlePhotoFileSelection(index, file) {\r\n        const normalizedIndex = Number(index);\r\n        if (!Number.isFinite(normalizedIndex) || normalizedIndex < 0 || normalizedIndex >= photoSlots.length) {\r\n            return;\r\n        }\r\n\r\n        if (!file) {\r\n            return;\r\n        }\r\n\r\n        if (!file.type || !file.type.startsWith('image/')) {\r\n            window.alert?.('Solo se pueden cargar archivos de imagen.');\r\n            return;\r\n        }\r\n\r\n        if (file.size && file.size > MAX_PHOTO_SIZE_BYTES) {\r\n            window.alert?.('La foto supera el l├¡mite de 5 MB permitido.');\r\n            return;\r\n        }\r\n\r\n        if (!isFileReaderSupported()) {\r\n            window.alert?.('El navegador no permite procesar im├ígenes desde este formulario.');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const dataUrl = await readFileAsDataUrl(file);\r\n            const base64Data = extractBase64FromDataUrl(dataUrl);\r\n            const mimeType = normalizeString(file.type) || 'image/jpeg';\r\n            const numeroRemitoInput = getElement('remito-numero');\r\n            const numeroRemito = numeroRemitoInput instanceof HTMLInputElement\r\n                ? normalizeString(numeroRemitoInput.value)\r\n                : '';\r\n            const fallbackBase = numeroRemito || 'remito';\r\n            const fileName = sanitizePhotoFileName(file.name, fallbackBase, normalizedIndex, mimeType);\r\n\r\n            photoSlots[normalizedIndex] = {\r\n                index: normalizedIndex,\r\n                previewUrl: typeof dataUrl === 'string' ? dataUrl : '',\r\n                base64Data,\r\n                mimeType,\r\n                fileName,\r\n                url: '',\r\n                driveId: '',\r\n                shouldRemove: false,\r\n            };\r\n            closeAllPhotoMenus();\r\n            renderPhotoSlots();\r\n        } catch (error) {\r\n            const message = error instanceof Error\r\n                ? error.message\r\n                : 'No se pudo procesar la foto seleccionada.';\r\n            window.alert?.(message);\r\n        }\r\n    }\r\n\r\n    function handlePhotoAction(action, index) {\r\n        if (!action) {\r\n            return;\r\n        }\r\n\r\n        const normalizedIndex = Number(index);\r\n        if (!Number.isFinite(normalizedIndex) || normalizedIndex < 0 || normalizedIndex >= photoSlots.length) {\r\n            return;\r\n        }\r\n\r\n        if (action === 'remove') {\r\n            removePhotoSlot(normalizedIndex);\r\n            return;\r\n        }\r\n\r\n        if (action === 'capture' || action === 'upload') {\r\n            closeAllPhotoMenus();\r\n            openPhotoFileDialog(action, normalizedIndex);\r\n        }\r\n    }\r\n\r\n    function handlePhotoContainerClick(event) {\r\n        const dismiss = event.target.closest?.('[data-remito-photo-menu-dismiss]');\r\n        if (dismiss) {\r\n            event.preventDefault();\r\n            closeAllPhotoMenus();\r\n            return;\r\n        }\r\n\r\n        const actionButton = event.target.closest?.('[data-remito-photo-action]');\r\n        if (actionButton) {\r\n            event.preventDefault();\r\n            const action = actionButton.dataset.remitoPhotoAction;\r\n            const index = actionButton.dataset.remitoPhotoIndex;\r\n            handlePhotoAction(action, index);\r\n            return;\r\n        }\r\n\r\n        const trigger = event.target.closest?.('[data-remito-photo-trigger]');\r\n        if (trigger) {\r\n            event.preventDefault();\r\n            togglePhotoMenu(trigger.dataset.remitoPhotoIndex);\r\n            return;\r\n        }\r\n\r\n        const clickedInsideMenu = Boolean(event.target.closest?.('[data-remito-photo-menu]'));\r\n        if (!clickedInsideMenu) {\r\n            closeAllPhotoMenus();\r\n        }\r\n    }\r\n\r\n    function handlePhotoContainerChange(event) {\r\n        const input = event.target;\r\n        if (!(input instanceof HTMLInputElement)) {\r\n            return;\r\n        }\r\n\r\n        const mode = input.dataset.remitoPhotoInput;\r\n        if (!mode) {\r\n            return;\r\n        }\r\n\r\n        const index = Number.parseInt(input.dataset.remitoPhotoIndex ?? '', 10);\r\n        const file = input.files && input.files[0];\r\n        if (Number.isFinite(index) && file) {\r\n            void handlePhotoFileSelection(index, file);\r\n        }\r\n\r\n        input.value = '';\r\n    }\r\n\r\n    function ensurePhotoEvents() {\r\n        if (photoEventsInitialized) {\r\n            return;\r\n        }\r\n\r\n        const container = getPhotoContainer();\r\n        if (!container) {\r\n            return;\r\n        }\r\n\r\n        container.addEventListener('click', handlePhotoContainerClick);\r\n        container.addEventListener('change', handlePhotoContainerChange);\r\n        photoEventsInitialized = true;\r\n    }\r\n\r\n    function buildPhotosPayload() {\r\n        return photoSlots\r\n            .map((slot, index) => ({\r\n                slot: index + 1,\r\n                base64Data: normalizeString(slot.base64Data),\r\n                mimeType: normalizeString(slot.mimeType) || 'image/jpeg',\r\n                fileName: normalizeString(slot.fileName) || `remito-foto-${index + 1}.jpg`,\r\n                driveFileId: normalizeString(slot.driveId),\r\n            }))\r\n            .filter(item => Boolean(item.base64Data) || Boolean(item.driveFileId));\r\n    }\r\n\r\n    function ensureReportAvailable() {\r\n        if (!lastSavedReport) {\r\n            disableButton('generar-remito-btn');\r\n            window.alert?.('Primero deb├®s guardar el mantenimiento para generar el remito.');\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    function handleMaintenanceSaved(reportData) {\r\n        lastSavedReport = createReportSnapshot(reportData);\r\n        enableButton('generar-remito-btn');\r\n        lastPrintableSnapshot = null;\r\n        setPrintButtonVisibility(false);\r\n    }\r\n\r\n    function reset() {\r\n        lastSavedReport = null;\r\n        disableButton('generar-remito-btn');\r\n        resetPhotoSlots();\r\n        closeAllPhotoMenus();\r\n        lastPrintableSnapshot = null;\r\n        setPrintButtonVisibility(false);\r\n        clearReadonlyInputs([\r\n            'remito-numero',\r\n            'remito-fecha',\r\n            'remito-cliente-nombre',\r\n            'remito-cliente-direccion',\r\n            'remito-cliente-telefono',\r\n            'remito-cliente-email',\r\n            'remito-cliente-cuit',\r\n            'remito-equipo-descripcion',\r\n            'remito-equipo-modelo',\r\n            'remito-equipo-serie',\r\n            'remito-equipo-interno',\r\n            'remito-equipo-ubicacion',\r\n            'remito-equipo-tecnico',\r\n        ]);\r\n        renderRepuestosList([]);\r\n        const observaciones = getElement('remito-observaciones');\r\n        if (observaciones instanceof HTMLTextAreaElement) {\r\n            observaciones.value = '';\r\n        }\r\n    }\r\n\r\n    function handleGenerarRemitoClick() {\r\n        if (!ensureReportAvailable()) {\r\n            return false;\r\n        }\r\n\r\n        resetPhotoSlots();\r\n        closeAllPhotoMenus();\r\n        populateRemitoForm(lastSavedReport);\r\n        if (typeof showView === 'function') {\r\n            showView('remito-view');\r\n        }\r\n        return true;\r\n    }\r\n\r\n    async function handleFinalizarRemitoClick() {\r\n        if (!lastSavedReport) {\r\n            window.alert?.('No hay datos disponibles para generar el remito. Guard├í el mantenimiento primero.');\r\n            return;\r\n        }\r\n\r\n        const observacionesElement = getElement('remito-observaciones');\r\n        const observacionesTexto = observacionesElement instanceof HTMLTextAreaElement\r\n            ? normalizeString(observacionesElement.value)\r\n            : '';\r\n\r\n        const repuestosEditados = collectRepuestosFromForm();\r\n        lastSavedReport.repuestos = repuestosEditados;\r\n        if (repuestosEditados.length > 0) {\r\n            lastSavedReport.componentes = [];\r\n        }\r\n        lastSavedReport.observaciones = observacionesTexto;\r\n        renderRepuestosList(repuestosEditados);\r\n\r\n        const fotosPayload = buildPhotosPayload();\r\n        const finalizarBtn = getElement('finalizar-remito-btn');\r\n        let originalText = '';\r\n        if (finalizarBtn instanceof HTMLButtonElement) {\r\n            originalText = finalizarBtn.textContent || '';\r\n            finalizarBtn.textContent = 'Generando remito...';\r\n            finalizarBtn.disabled = true;\r\n        }\r\n\r\n        try {\r\n            if (typeof crearRemito !== 'function') {\r\n                throw new Error('La funci├│n crearRemito no est├í configurada.');\r\n            }\r\n\r\n            const requestBody = {\r\n                reporteData: lastSavedReport,\r\n                observaciones: observacionesTexto,\r\n            };\r\n\r\n            if (Array.isArray(fotosPayload) && fotosPayload.length > 0) {\r\n                requestBody.fotos = fotosPayload;\r\n            }\r\n\r\n            // Crear el remito primero para obtener el n├║mero\r\n            const payload = await crearRemito(requestBody);\r\n\r\n            if (!payload || typeof payload !== 'object') {\r\n                throw new Error('Respuesta inv├ílida del servidor.');\r\n            }\r\n\r\n            const remitoData = payload?.data || {};\r\n            const emailStatus = remitoData?.emailStatus;\r\n            const numeroRemito = normalizeString(remitoData?.NumeroRemito);\r\n            if (numeroRemito) {\r\n                lastSavedReport.NumeroRemito = numeroRemito;\r\n                setReadonlyInputValue('remito-numero', numeroRemito);\r\n            }\r\n\r\n            lastPrintableSnapshot = buildPrintableSnapshot();\r\n            setPrintButtonVisibility(Boolean(lastPrintableSnapshot));\r\n\r\n            const printableReport = lastPrintableSnapshot?.report || lastSavedReport;\r\n            const printablePhotoSlots = lastPrintableSnapshot?.photoSlots || clonePhotoSlots(photoSlots);\r\n\r\n            // Generar y guardar el PDF en Storage\r\n            const remitoId = remitoData?.id || remitoData?.IdUnico;\r\n            if (remitoId && typeof guardarPdfRemito === 'function') {\r\n                try {\r\n                    const printableData = buildPrintableRemitoData(printableReport, {\r\n                        observaciones: printableReport?.observaciones,\r\n                        repuestos: printableReport?.repuestos,\r\n                        photoSlots: printablePhotoSlots,\r\n                    });\r\n                    const html = createRemitoPrintHtml(printableData);\r\n                    if (html) {\r\n                        const pdfBlob = await generatePdfBlob(html);\r\n                        if (pdfBlob) {\r\n                            await guardarPdfRemito(remitoId, pdfBlob, numeroRemito);\r\n                        }\r\n                    }\r\n                } catch (pdfError) {\r\n                    console.warn('No se pudo guardar el PDF del remito:', pdfError);\r\n                }\r\n            }\r\n\r\n            // Preguntar al usuario si quiere ver el remito\r\n            const shouldShowRemito = await (async () => {\r\n                if (window.Swal && typeof window.Swal.fire === 'function') {\r\n                    const result = await window.Swal.fire({\r\n                        title: 'Ô£à Remito generado',\r\n                        text: `El remito N┬░ ${numeroRemito || 'N/A'} fue creado exitosamente. ┬┐Deseas ver el PDF ahora?`,\r\n                        icon: 'success',\r\n                        showCancelButton: true,\r\n                        confirmButtonText: 'S├¡, ver remito',\r\n                        cancelButtonText: 'No, volver al dashboard',\r\n                        confirmButtonColor: '#2563eb',\r\n                        cancelButtonColor: '#6b7280',\r\n                    });\r\n                    return result.isConfirmed;\r\n                } else {\r\n                    return window.confirm(`Ô£à Remito N┬░ ${numeroRemito || 'N/A'} generado exitosamente.\\n\\n┬┐Quer├®s ver el PDF ahora?\\n(Aceptar = Ver remito | Cancelar = Volver al dashboard)`);\r\n                }\r\n            })();\r\n\r\n            // Si el usuario quiere ver el remito, abrirlo\r\n            if (shouldShowRemito) {\r\n                const didOpenPrintPreview = openRemitoPrintPreview(printableReport, {\r\n                    observaciones: printableReport?.observaciones,\r\n                    repuestos: printableReport?.repuestos,\r\n                    photoSlots: printablePhotoSlots,\r\n                });\r\n\r\n                if (!didOpenPrintPreview && window.Swal && typeof window.Swal.fire === 'function') {\r\n                    await window.Swal.fire({\r\n                        title: 'Error al abrir vista',\r\n                        text: 'No se pudo abrir la vista de impresi├│n. Revisa el bloqueador de ventanas emergentes.',\r\n                        icon: 'warning',\r\n                        confirmButtonText: 'Entendido',\r\n                    });\r\n                } else if (!didOpenPrintPreview) {\r\n                    window.alert?.('ÔÜá´©Å No se pudo abrir la vista de impresi├│n. Revisa el bloqueador de ventanas emergentes.');\r\n                }\r\n            }\r\n\r\n            // Volver al dashboard\r\n            if (typeof showView === 'function') {\r\n                showView('tab-dashboard');\r\n            }\r\n        } catch (error) {\r\n            console.error('Error al generar el remito:', error);\r\n            const message = error instanceof Error ? error.message : 'Error desconocido al generar el remito.';\r\n            window.alert?.(`ÔØî ${message}`);\r\n        } finally {\r\n            if (finalizarBtn instanceof HTMLButtonElement) {\r\n                finalizarBtn.textContent = originalText || 'Finalizar y Guardar Remito';\r\n                finalizarBtn.disabled = false;\r\n            }\r\n        }\r\n    }\r\n\r\n    function initialize() {\r\n        if (eventsInitialized) {\r\n            return;\r\n        }\r\n\r\n        disableButton('generar-remito-btn');\r\n        renderRepuestosList([]);\r\n        renderPhotoSlots();\r\n        ensurePhotoEvents();\r\n        setPrintButtonVisibility(Boolean(lastPrintableSnapshot));\r\n\r\n        const generarBtn = getElement('generar-remito-btn');\r\n        if (generarBtn instanceof HTMLButtonElement) {\r\n            generarBtn.addEventListener('click', event => {\r\n                event.preventDefault();\r\n                handleGenerarRemitoClick();\r\n            });\r\n        }\r\n\r\n        const finalizarBtn = getElement('finalizar-remito-btn');\r\n        if (finalizarBtn instanceof HTMLButtonElement) {\r\n            finalizarBtn.addEventListener('click', event => {\r\n                event.preventDefault();\r\n                void handleFinalizarRemitoClick();\r\n            });\r\n        }\r\n\r\n        const imprimirBtn = getPrintButton();\r\n        if (imprimirBtn) {\r\n            imprimirBtn.addEventListener('click', event => {\r\n                event.preventDefault();\r\n                if (!lastPrintableSnapshot) {\r\n                    window.alert?.('Gener├í y guard├í un remito antes de intentar imprimirlo.');\r\n                    return;\r\n                }\r\n\r\n                const printableReport = lastPrintableSnapshot.report;\r\n                const printablePhotoSlots = lastPrintableSnapshot.photoSlots || [];\r\n                const didOpen = openRemitoPrintPreview(printableReport, {\r\n                    observaciones: printableReport?.observaciones,\r\n                    repuestos: printableReport?.repuestos,\r\n                    photoSlots: printablePhotoSlots,\r\n                });\r\n\r\n                if (!didOpen) {\r\n                    window.alert?.('No pudimos abrir la vista de impresi├│n. Revis├í el bloqueador de ventanas emergentes e intent├í nuevamente.');\r\n                }\r\n            });\r\n        }\r\n\r\n        const agregarRepuestoBtn = getElement('remito-agregar-repuesto');\r\n        if (agregarRepuestoBtn instanceof HTMLButtonElement) {\r\n            agregarRepuestoBtn.addEventListener('click', event => {\r\n                event.preventDefault();\r\n                addEmptyRepuestoRow({ focus: true });\r\n            });\r\n        }\r\n\r\n        eventsInitialized = true;\r\n    }\r\n\r\n    function setLastSavedReportForTests(data) {\r\n        lastSavedReport = data ? cloneReportData(data) : null;\r\n    }\r\n\r\n    function getLastSavedReportForTests() {\r\n        return lastSavedReport;\r\n    }\r\n\r\n    return {\r\n        initialize,\r\n        handleMaintenanceSaved,\r\n        reset,\r\n        handleGenerarRemitoClick,\r\n        handleFinalizarRemitoClick,\r\n        setLastSavedReportForTests,\r\n        getLastSavedReportForTests,\r\n    };\r\n}\r\n\r\n/**\r\n * Genera un PDF blob a partir del HTML del remito usando html2canvas + jsPDF\r\n * Este PDF es para subir a Storage, NO para imprimir directamente.\r\n * @param {string} html - HTML del remito\r\n * @returns {Promise<Blob>} Blob del PDF generado\r\n */\r\nasync function generatePdfBlob(html) {\r\n    // Crear un iframe oculto para renderizar el HTML\r\n    const iframe = document.createElement('iframe');\r\n    iframe.style.position = 'fixed';\r\n    iframe.style.left = '-9999px';\r\n    iframe.style.top = '-9999px';\r\n    iframe.style.width = '794px'; // A4 width at 96 DPI\r\n    iframe.style.height = '1123px'; // A4 height at 96 DPI\r\n    iframe.style.border = 'none';\r\n    iframe.style.visibility = 'hidden';\r\n    // Sandbox para evitar ejecuci├│n de scripts\r\n    iframe.sandbox = 'allow-same-origin';\r\n    document.body.appendChild(iframe);\r\n\r\n    // Limpiar el HTML: remover todos los scripts y eventos de print\r\n    let cleanHtml = html\r\n        .replace(/<script[\\s\\S]*?<\\/script>/gi, '') // Remover scripts\r\n        .replace(/onload\\s*=\\s*[\"'][^\"']*[\"']/gi, '') // Remover onload\r\n        .replace(/window\\.print\\s*\\(\\s*\\)/gi, '') // Remover llamadas a print\r\n        .replace(/window\\.addEventListener\\s*\\(\\s*['\"]afterprint['\"]/gi, '// disabled: addEventListener(\"afterprint\"')\r\n        .replace(/window\\.addEventListener\\s*\\(\\s*['\"]load['\"]/gi, '// disabled: addEventListener(\"load\"');\r\n\r\n    // Escribir el HTML en el iframe\r\n    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;\r\n\r\n    // Bloquear window.print en el iframe antes de escribir\r\n    try {\r\n        iframe.contentWindow.print = () => { };\r\n        iframe.contentWindow.alert = () => { };\r\n        iframe.contentWindow.confirm = () => true;\r\n    } catch (e) {\r\n        // Sandbox puede bloquear esto, est├í ok\r\n    }\r\n\r\n    iframeDoc.open();\r\n    iframeDoc.write(cleanHtml);\r\n    iframeDoc.close();\r\n\r\n    // Esperar a que las im├ígenes se carguen\r\n    await new Promise(resolve => {\r\n        const images = iframeDoc.querySelectorAll('img');\r\n        if (images.length === 0) {\r\n            setTimeout(resolve, 100);\r\n            return;\r\n        }\r\n\r\n        let loadedCount = 0;\r\n        const checkComplete = () => {\r\n            loadedCount++;\r\n            if (loadedCount >= images.length) {\r\n                setTimeout(resolve, 100);\r\n            }\r\n        };\r\n\r\n        images.forEach(img => {\r\n            if (img.complete) {\r\n                checkComplete();\r\n            } else {\r\n                img.onload = checkComplete;\r\n                img.onerror = checkComplete;\r\n            }\r\n        });\r\n\r\n        // Timeout de seguridad\r\n        setTimeout(resolve, 5000);\r\n    });\r\n\r\n    // Usar html2canvas para capturar el contenido\r\n    const documentElement = iframeDoc.querySelector('.document');\r\n    if (!documentElement) {\r\n        document.body.removeChild(iframe);\r\n        throw new Error('No se encontr├│ el elemento .document en el HTML');\r\n    }\r\n\r\n    const canvas = await html2canvas(documentElement, {\r\n        scale: 2, // Mayor resoluci├│n\r\n        useCORS: true,\r\n        allowTaint: true,\r\n        backgroundColor: '#ffffff',\r\n        logging: false,\r\n    });\r\n\r\n    // Crear PDF con jsPDF (versi├│n UMD cargada globalmente)\r\n    const { jsPDF } = window.jspdf;\r\n    const imgData = canvas.toDataURL('image/jpeg', 0.95);\r\n    const pdf = new jsPDF({\r\n        orientation: 'portrait',\r\n        unit: 'mm',\r\n        format: 'a4',\r\n    });\r\n\r\n    const pdfWidth = pdf.internal.pageSize.getWidth();\r\n    const pdfHeight = pdf.internal.pageSize.getHeight();\r\n    const imgWidth = canvas.width;\r\n    const imgHeight = canvas.height;\r\n\r\n    // Calcular el ratio para que quepa en la p├ígina\r\n    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);\r\n    const imgX = (pdfWidth - imgWidth * ratio) / 2;\r\n    const imgY = 0;\r\n\r\n    // Si el contenido es m├ís alto que una p├ígina, dividir en m├║ltiples p├íginas\r\n    const scaledHeight = imgHeight * ratio;\r\n    if (scaledHeight > pdfHeight) {\r\n        // M├║ltiples p├íginas\r\n        let remainingHeight = imgHeight;\r\n        let position = 0;\r\n        const pageImgHeight = pdfHeight / ratio;\r\n\r\n        while (remainingHeight > 0) {\r\n            // Crear canvas parcial para esta p├ígina\r\n            const pageCanvas = document.createElement('canvas');\r\n            pageCanvas.width = canvas.width;\r\n            pageCanvas.height = Math.min(pageImgHeight, remainingHeight);\r\n\r\n            const ctx = pageCanvas.getContext('2d');\r\n            ctx.drawImage(\r\n                canvas,\r\n                0, position,\r\n                canvas.width, pageCanvas.height,\r\n                0, 0,\r\n                pageCanvas.width, pageCanvas.height\r\n            );\r\n\r\n            const pageImgData = pageCanvas.toDataURL('image/jpeg', 0.95);\r\n\r\n            if (position > 0) {\r\n                pdf.addPage();\r\n            }\r\n\r\n            pdf.addImage(\r\n                pageImgData,\r\n                'JPEG',\r\n                imgX,\r\n                0,\r\n                imgWidth * ratio,\r\n                pageCanvas.height * ratio\r\n            );\r\n\r\n            position += pageImgHeight;\r\n            remainingHeight -= pageImgHeight;\r\n        }\r\n    } else {\r\n        // Una sola p├ígina\r\n        pdf.addImage(imgData, 'JPEG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);\r\n    }\r\n\r\n    // Limpiar\r\n    document.body.removeChild(iframe);\r\n\r\n    // Retornar el blob\r\n    return pdf.output('blob');\r\n}\r\n\r\n// Utilidades exportadas para reutilizar en Gesti├│n de Remitos (ABM manual)\r\nexport { buildPrintableRemitoData, createRemitoPrintHtml, generatePdfBlob };\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\remitos-gestion\\remitos-gestion.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'hasPhotoContent' is defined but never used.","line":309,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":309,"endColumn":25},{"ruleId":"no-unused-vars","severity":2,"message":"'buildClienteOptionsHtml' is defined but never used.","line":785,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":785,"endColumn":33},{"ruleId":"no-unused-vars","severity":2,"message":"'hasEquipoSelected' is assigned a value but never used.","line":1391,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1391,"endColumn":28},{"ruleId":"no-unused-vars","severity":2,"message":"'numeroRemitoPlaceholderAttr' is assigned a value but never used.","line":1440,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1440,"endColumn":38},{"ruleId":"no-unused-vars","severity":2,"message":"'numeroRemitoHelpHtml' is assigned a value but never used.","line":1443,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1443,"endColumn":31},{"ruleId":"no-unused-vars","severity":2,"message":"'numeroReporteFieldHtml' is assigned a value but never used.","line":1446,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1446,"endColumn":33}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getEquiposByCliente } from '../admin/sistemasEquipos.js';\r\nimport { getCurrentUserName, getCurrentUserRole } from '../login/auth.js';\r\nimport { buildPrintableRemitoData, createRemitoPrintHtml, generatePdfBlob } from '../remito/remito.js';\r\n\r\n// Verificar si el usuario es administrador\r\nfunction isAdmin() {\r\n    const role = getCurrentUserRole();\r\n    return role === 'Administrador' || role === 'admin';\r\n}\r\n\r\nconst DEFAULT_PAGE_SIZE = 20;\r\nconst MAX_REMITO_PHOTOS = 4;\r\nconst MAX_PHOTO_SIZE_BYTES = 5 * 1024 * 1024; // 5 MB\r\n\r\nconst REMITO_FOTO_KEYS = Object.freeze([\r\n    ['Foto1Id', 'Foto1ID', 'foto1Id', 'foto1ID', 'Foto1URL', 'Foto1Url', 'foto1URL', 'foto1Url', 'foto1', 'Foto1', 'foto_1', 'Foto_1'],\r\n    ['Foto2Id', 'Foto2ID', 'foto2Id', 'foto2ID', 'Foto2URL', 'Foto2Url', 'foto2URL', 'foto2Url', 'foto2', 'Foto2', 'foto_2', 'Foto_2'],\r\n    ['Foto3Id', 'Foto3ID', 'foto3Id', 'foto3ID', 'Foto3URL', 'Foto3Url', 'foto3URL', 'foto3Url', 'foto3', 'Foto3', 'foto_3', 'Foto_3'],\r\n    ['Foto4Id', 'Foto4ID', 'foto4Id', 'foto4ID', 'Foto4URL', 'Foto4Url', 'foto4URL', 'foto4Url', 'foto4', 'Foto4', 'foto_4', 'Foto_4'],\r\n]);\r\nconst DRIVE_DIRECT_URL_BASE = 'https://drive.google.com/uc?export=view&id=';\r\n\r\nconst PHOTO_MIME_EXTENSION_MAP = Object.freeze({\r\n    'image/jpeg': 'jpg',\r\n    'image/jpg': 'jpg',\r\n    'image/png': 'png',\r\n    'image/webp': 'webp',\r\n    'image/heic': 'heic',\r\n    'image/heif': 'heif',\r\n});\r\n\r\nfunction pickValue(source, keys) {\r\n    if (!source || typeof source !== 'object' || !Array.isArray(keys)) {\r\n        return undefined;\r\n    }\r\n\r\n    for (const key of keys) {\r\n        if (!key || typeof key !== 'string') {\r\n            continue;\r\n        }\r\n\r\n        const value = source[key];\r\n        if (value !== undefined && value !== null && value !== '') {\r\n            return value;\r\n        }\r\n    }\r\n\r\n    return undefined;\r\n}\r\n\r\nfunction sanitizeString(value) {\r\n    if (value === null || value === undefined) {\r\n        return '';\r\n    }\r\n\r\n    if (typeof value === 'string') {\r\n        return value.trim();\r\n    }\r\n\r\n    if (typeof value === 'number') {\r\n        return Number.isFinite(value) ? String(value) : '';\r\n    }\r\n\r\n    if (Object.prototype.toString.call(value) === '[object Date]' && !Number.isNaN(value.getTime())) {\r\n        try {\r\n            return value.toLocaleDateString('es-AR');\r\n        } catch (error) {\r\n            return value.toISOString();\r\n        }\r\n    }\r\n\r\n    return String(value).trim();\r\n}\r\n\r\nfunction formatIsoToDisplay(value) {\r\n    if (value === null || value === undefined) {\r\n        return '';\r\n    }\r\n\r\n    if (Object.prototype.toString.call(value) === '[object Date]' && !Number.isNaN(value.getTime())) {\r\n        try {\r\n            return value.toLocaleDateString('es-AR');\r\n        } catch (error) {\r\n            return value.toISOString();\r\n        }\r\n    }\r\n\r\n    if (typeof value === 'number') {\r\n        const parsed = new Date(value);\r\n        if (!Number.isNaN(parsed.getTime())) {\r\n            try {\r\n                return parsed.toLocaleDateString('es-AR');\r\n            } catch (error) {\r\n                return parsed.toISOString().split('T')[0] || '';\r\n            }\r\n        }\r\n        return '';\r\n    }\r\n\r\n    if (typeof value !== 'string') {\r\n        return '';\r\n    }\r\n\r\n    const trimmed = value.trim();\r\n    if (!trimmed) {\r\n        return '';\r\n    }\r\n\r\n    const isoMatch = trimmed.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/);\r\n    if (isoMatch) {\r\n        return `${isoMatch[3]}/${isoMatch[2]}/${isoMatch[1]}`;\r\n    }\r\n\r\n    const parsed = new Date(trimmed);\r\n    if (!Number.isNaN(parsed.getTime())) {\r\n        try {\r\n            return parsed.toLocaleDateString('es-AR');\r\n        } catch (error) {\r\n            return trimmed;\r\n        }\r\n    }\r\n\r\n    return trimmed;\r\n}\r\n\r\nfunction formatDateValue(primary, isoValue) {\r\n    const primaryValue = sanitizeString(primary);\r\n    if (primaryValue) {\r\n        return primaryValue;\r\n    }\r\n\r\n    return formatIsoToDisplay(isoValue);\r\n}\r\n\r\nfunction escapeHtml(value) {\r\n    return String(value ?? '')\r\n        .replace(/&/g, '&amp;')\r\n        .replace(/</g, '&lt;')\r\n        .replace(/>/g, '&gt;')\r\n        .replace(/\"/g, '&quot;')\r\n        .replace(/'/g, '&#39;');\r\n}\r\n\r\nfunction getDisplayValue(value) {\r\n    const sanitized = sanitizeString(value);\r\n    return sanitized || 'ÔÇö';\r\n}\r\n\r\nfunction guessExtensionFromMimeType(mimeType) {\r\n    const normalized = sanitizeString(mimeType).toLowerCase();\r\n    return PHOTO_MIME_EXTENSION_MAP[normalized] || 'jpg';\r\n}\r\n\r\nfunction sanitizePhotoFileName(name, fallbackBase, index, mimeType) {\r\n    const base = sanitizeString(name) || `${fallbackBase}-foto-${index + 1}`;\r\n    const withoutSeparators = base.replace(/[\\\\/]/g, '-');\r\n    const normalized = withoutSeparators.replace(/[^a-zA-Z0-9._-]+/g, '_');\r\n    const extension = guessExtensionFromMimeType(mimeType);\r\n\r\n    if (normalized.toLowerCase().endsWith(`.${extension}`)) {\r\n        return normalized;\r\n    }\r\n\r\n    const withoutExtension = normalized.replace(/\\.[^.]+$/, '');\r\n    return `${withoutExtension}.${extension}`;\r\n}\r\n\r\nfunction buildDriveDirectUrl(fileId) {\r\n    const id = sanitizeString(fileId);\r\n    if (!id) {\r\n        return '';\r\n    }\r\n\r\n    try {\r\n        return `${DRIVE_DIRECT_URL_BASE}${encodeURIComponent(id)}`;\r\n    } catch (error) {\r\n        return `${DRIVE_DIRECT_URL_BASE}${id}`;\r\n    }\r\n}\r\n\r\nfunction extractDriveFileId(value) {\r\n    const text = sanitizeString(value);\r\n    if (!text || text.startsWith('data:')) {\r\n        return '';\r\n    }\r\n\r\n    const directMatch = text.match(/[?&]id=([a-zA-Z0-9_-]+)/);\r\n    if (directMatch && directMatch[1]) {\r\n        return directMatch[1];\r\n    }\r\n\r\n    const pathMatch = text.match(/\\/d\\/([a-zA-Z0-9_-]+)/);\r\n    if (pathMatch && pathMatch[1]) {\r\n        return pathMatch[1];\r\n    }\r\n\r\n    if (/^[a-zA-Z0-9_-]{10,}$/.test(text)) {\r\n        return text;\r\n    }\r\n\r\n    return '';\r\n}\r\n\r\nfunction createEmptyPhotoSlot(index = 0) {\r\n    return {\r\n        index,\r\n        previewUrl: '',\r\n        base64Data: '',\r\n        mimeType: '',\r\n        fileName: '',\r\n        url: '',\r\n        driveId: '',\r\n        shouldRemove: false,\r\n    };\r\n}\r\n\r\nfunction createEmptyPhotoSlots() {\r\n    return Array.from({ length: MAX_REMITO_PHOTOS }, (_, index) => createEmptyPhotoSlot(index));\r\n}\r\n\r\nfunction normalizePhotoSlots(slots) {\r\n    const baseSlots = createEmptyPhotoSlots();\r\n\r\n    if (!Array.isArray(slots)) {\r\n        return baseSlots;\r\n    }\r\n\r\n    return baseSlots.map((slot, index) => {\r\n        const source = slots[index];\r\n        if (!source || typeof source !== 'object') {\r\n            return slot;\r\n        }\r\n\r\n        const normalizedUrl = sanitizeString(source.url);\r\n        const driveId = sanitizeString(source.driveId || source.driveFileId)\r\n            || extractDriveFileId(normalizedUrl);\r\n\r\n        return {\r\n            ...slot,\r\n            previewUrl: sanitizeString(source.previewUrl),\r\n            base64Data: sanitizeString(source.base64Data),\r\n            mimeType: sanitizeString(source.mimeType),\r\n            fileName: sanitizeString(source.fileName),\r\n            url: driveId ? buildDriveDirectUrl(driveId) : normalizedUrl,\r\n            driveId,\r\n            shouldRemove: Boolean(source.shouldRemove),\r\n        };\r\n    });\r\n}\r\n\r\nfunction buildPhotoSlotsFromSources(ids = [], urls = []) {\r\n    const slots = createEmptyPhotoSlots();\r\n\r\n    slots.forEach((slot, index) => {\r\n        if (index >= slots.length) {\r\n            return;\r\n        }\r\n\r\n        const id = Array.isArray(ids) ? sanitizeString(ids[index]) : '';\r\n        const rawUrl = Array.isArray(urls) ? sanitizeString(urls[index]) : '';\r\n        const driveId = id || extractDriveFileId(rawUrl);\r\n        const directUrl = driveId ? buildDriveDirectUrl(driveId) : rawUrl;\r\n\r\n        slot.driveId = driveId;\r\n        slot.url = directUrl;\r\n    });\r\n\r\n    return slots;\r\n}\r\n\r\nfunction extractBase64FromDataUrl(dataUrl) {\r\n    const text = sanitizeString(dataUrl);\r\n    if (!text) {\r\n        return '';\r\n    }\r\n\r\n    const commaIndex = text.indexOf(',');\r\n    if (commaIndex !== -1) {\r\n        return text.slice(commaIndex + 1);\r\n    }\r\n\r\n    return text;\r\n}\r\n\r\nfunction getPhotoPreviewSource(slot) {\r\n    if (!slot || typeof slot !== 'object') {\r\n        return '';\r\n    }\r\n\r\n    const previewUrl = sanitizeString(slot.previewUrl);\r\n    if (previewUrl) {\r\n        return previewUrl;\r\n    }\r\n\r\n    const driveId = sanitizeString(slot.driveId);\r\n    if (driveId) {\r\n        return buildDriveDirectUrl(driveId);\r\n    }\r\n\r\n    const url = sanitizeString(slot.url);\r\n    const derivedId = extractDriveFileId(url);\r\n    if (derivedId) {\r\n        return buildDriveDirectUrl(derivedId);\r\n    }\r\n\r\n    return url;\r\n}\r\n\r\nfunction hasPhotoContent(slot) {\r\n    if (!slot || typeof slot !== 'object') {\r\n        return false;\r\n    }\r\n\r\n    return Boolean(\r\n        sanitizeString(slot.previewUrl)\r\n        || sanitizeString(slot.url)\r\n        || sanitizeString(slot.driveId)\r\n        || sanitizeString(slot.base64Data),\r\n    );\r\n}\r\n\r\nfunction formatPhotoFileLabel(slot) {\r\n    if (!slot || typeof slot !== 'object') {\r\n        return 'Sin foto seleccionada';\r\n    }\r\n\r\n    if (sanitizeString(slot.fileName)) {\r\n        return slot.fileName;\r\n    }\r\n\r\n    const driveId = sanitizeString(slot.driveId);\r\n    if (driveId) {\r\n        return `Foto en Drive (${driveId.slice(0, 8)}...)`;\r\n    }\r\n\r\n    if (sanitizeString(slot.url)) {\r\n        return slot.url;\r\n    }\r\n\r\n    return 'Sin foto seleccionada';\r\n}\r\n\r\nfunction isFileReaderSupported() {\r\n    return typeof FileReader !== 'undefined';\r\n}\r\n\r\nfunction readFileAsDataUrl(file) {\r\n    return new Promise((resolve, reject) => {\r\n        if (!file || typeof FileReader === 'undefined') {\r\n            reject(new Error('La lectura de archivos no es compatible.'));\r\n            return;\r\n        }\r\n\r\n        const reader = new FileReader();\r\n        reader.onload = () => resolve(reader.result);\r\n        reader.onerror = () => reject(new Error('No se pudo leer el archivo seleccionado.'));\r\n        reader.readAsDataURL(file);\r\n    });\r\n}\r\n\r\nconst CLIENT_NAME_KEYS = Object.freeze([\r\n    'nombre',\r\n    'Nombre',\r\n    'cliente',\r\n    'Cliente',\r\n    'razon_social',\r\n    'RazonSocial',\r\n]);\r\n\r\nconst CLIENT_ID_KEYS = Object.freeze([\r\n    'id',\r\n    'ID',\r\n    'id_cliente',\r\n    'IdCliente',\r\n    'codigo',\r\n    'Codigo',\r\n    'cuit',\r\n    'CUIT',\r\n]);\r\n\r\nconst CLIENT_ADDRESS_KEYS = Object.freeze([\r\n    'direccion',\r\n    'Direccion',\r\n    'domicilio',\r\n    'Domicilio',\r\n]);\r\n\r\nconst CLIENT_PHONE_KEYS = Object.freeze([\r\n    'telefono',\r\n    'Telefono',\r\n    'tel',\r\n    'Tel',\r\n    'celular',\r\n    'Celular',\r\n]);\r\n\r\nconst CLIENT_EMAIL_KEYS = Object.freeze([\r\n    'email',\r\n    'Email',\r\n    'mail',\r\n    'Mail',\r\n    'correo',\r\n    'Correo',\r\n]);\r\n\r\nconst CLIENT_CUIT_KEYS = Object.freeze([\r\n    'cuit',\r\n    'CUIT',\r\n]);\r\n\r\nfunction getTodayInputDate() {\r\n    const now = new Date();\r\n    if (Number.isNaN(now.getTime())) {\r\n        return '';\r\n    }\r\n\r\n    const year = now.getFullYear();\r\n    const month = String(now.getMonth() + 1).padStart(2, '0');\r\n    const day = String(now.getDate()).padStart(2, '0');\r\n\r\n    return `${year}-${month}-${day}`;\r\n}\r\n\r\nfunction normalizeRemitoForDisplay(remito) {\r\n    if (!remito || typeof remito !== 'object') {\r\n        return {\r\n            numeroRemito: '',\r\n            numeroReporte: '',\r\n            cliente: '',\r\n            fechaRemito: '',\r\n            fechaRemitoISO: '',\r\n            fechaServicio: '',\r\n            fechaServicioISO: '',\r\n            tecnico: '',\r\n            observaciones: '',\r\n            direccion: '',\r\n            telefono: '',\r\n            email: '',\r\n            cuit: '',\r\n            reporteId: '',\r\n        };\r\n    }\r\n\r\n    const fechaRemitoISO = remito.fechaRemitoISO ?? remito.FechaRemitoISO;\r\n    const fechaServicioISO = remito.fechaServicioISO ?? remito.FechaServicioISO;\r\n\r\n    const numeroRemitoValue = pickValue(remito, ['numeroRemito', 'NumeroRemito', 'numero_remito']);\r\n    const numeroReporteValue = pickValue(remito, ['numeroReporte', 'NumeroReporte', 'numero_reporte']);\r\n    const clienteValue = pickValue(remito, ['cliente', 'Cliente', 'NombreCliente', 'cliente_nombre']);\r\n    const fechaRemitoValue = pickValue(remito, ['fechaRemito', 'FechaRemito', 'FechaCreacion']);\r\n    const fechaRemitoIsoValue = pickValue(remito, ['fechaRemitoISO', 'FechaRemitoISO', 'FechaCreacionISO']);\r\n    const fechaServicioValue = pickValue(remito, ['fechaServicio', 'FechaServicio']);\r\n    const tecnicoValue = pickValue(remito, ['tecnico', 'Tecnico', 'MailTecnico']);\r\n    const observacionesValue = pickValue(remito, ['observaciones', 'Observaciones']);\r\n    const direccionValue = pickValue(remito, ['direccion', 'Direccion']);\r\n    const telefonoValue = pickValue(remito, ['telefono', 'Telefono']);\r\n    const emailValue = pickValue(remito, ['email', 'Email', 'MailCliente']);\r\n    const cuitValue = pickValue(remito, ['cuit', 'CUIT', 'cliente_cuit']);\r\n    const reporteIdValue = pickValue(remito, ['reporteId', 'ReporteID', 'IdUnico', 'IDInterna']);\r\n    const fotoValues = REMITO_FOTO_KEYS.map(keys => sanitizeString(pickValue(remito, keys)) || '');\r\n    const fotoDriveIds = fotoValues.map(value => extractDriveFileId(value));\r\n    const fotoUrls = fotoValues.map((value, index) => {\r\n        const driveId = fotoDriveIds[index];\r\n        if (driveId) {\r\n            return buildDriveDirectUrl(driveId);\r\n        }\r\n        return value;\r\n    });\r\n\r\n    return {\r\n        numeroRemito: sanitizeString(numeroRemitoValue),\r\n        numeroReporte: sanitizeString(numeroReporteValue),\r\n        cliente: sanitizeString(clienteValue),\r\n        fechaRemito: formatDateValue(\r\n            fechaRemitoValue,\r\n            fechaRemitoIsoValue ?? fechaRemitoISO,\r\n        ),\r\n        fechaRemitoISO: sanitizeString(fechaRemitoIsoValue ?? fechaRemitoISO),\r\n        fechaServicio: formatDateValue(fechaServicioValue, fechaServicioISO),\r\n        fechaServicioISO: sanitizeString(fechaServicioISO),\r\n        tecnico: sanitizeString(tecnicoValue),\r\n        observaciones: sanitizeString(observacionesValue),\r\n        direccion: sanitizeString(direccionValue),\r\n        telefono: sanitizeString(telefonoValue),\r\n        email: sanitizeString(emailValue),\r\n        cuit: sanitizeString(cuitValue),\r\n        reporteId: sanitizeString(reporteIdValue),\r\n        // Path del PDF guardado en Storage\r\n        pdf_path: sanitizeString(remito.pdf_path) || '',\r\n        // Datos del equipo\r\n        equipo_descripcion: sanitizeString(remito.equipo_descripcion) || '',\r\n        equipo_modelo: sanitizeString(remito.equipo_modelo) || '',\r\n        equipo_serie: sanitizeString(remito.equipo_serie) || '',\r\n        equipo_interno: sanitizeString(remito.equipo_interno) || '',\r\n        equipo_ubicacion: sanitizeString(remito.equipo_ubicacion) || '',\r\n        // Repuestos\r\n        repuestos: remito.repuestos || [],\r\n        // Fotos\r\n        Foto1Id: fotoDriveIds[0] || '',\r\n        Foto2Id: fotoDriveIds[1] || '',\r\n        Foto3Id: fotoDriveIds[2] || '',\r\n        Foto4Id: fotoDriveIds[3] || '',\r\n        Foto1URL: fotoUrls[0] || '',\r\n        Foto2URL: fotoUrls[1] || '',\r\n        Foto3URL: fotoUrls[2] || '',\r\n        Foto4URL: fotoUrls[3] || '',\r\n        fotos: fotoUrls,\r\n        fotosDriveIds: fotoDriveIds,\r\n    };\r\n}\r\n\r\nfunction getEmptyFormData() {\r\n    // Obtener el nombre del t├®cnico logueado autom├íticamente\r\n    const tecnicoLogueado = getCurrentUserName() || '';\r\n\r\n    return {\r\n        numeroRemito: '',\r\n        numeroReporte: '',\r\n        cliente: '',\r\n        fechaRemitoISO: getTodayInputDate(),\r\n        fechaServicioISO: '',\r\n        tecnico: tecnicoLogueado,\r\n        referencia: '', // Referencia / O.C / Presupuesto\r\n        observaciones: '',\r\n        direccion: '',\r\n        telefono: '',\r\n        email: '',\r\n        cuit: '',\r\n        reporteId: '',\r\n        fotos: createEmptyPhotoSlots(),\r\n        // Campos de equipo\r\n        equipoId: '',\r\n        sistemaNombre: '',\r\n        modelo: '',\r\n        serie: '',\r\n        tagId: '',\r\n        // Repuestos\r\n        repuestos: [],\r\n    };\r\n}\r\n\r\nfunction formatDateForInput(value) {\r\n    const sanitized = sanitizeString(value);\r\n    if (!sanitized) {\r\n        return '';\r\n    }\r\n\r\n    if (/^\\d{4}-\\d{2}-\\d{2}/.test(sanitized)) {\r\n        return sanitized.slice(0, 10);\r\n    }\r\n\r\n    if (/^\\d{2}\\/\\d{2}\\/\\d{4}$/.test(sanitized)) {\r\n        const [day, month, year] = sanitized.split('/');\r\n        return `${year}-${month}-${day}`;\r\n    }\r\n\r\n    const parsed = new Date(sanitized);\r\n    if (!Number.isNaN(parsed.getTime())) {\r\n        return parsed.toISOString().split('T')[0];\r\n    }\r\n\r\n    return '';\r\n}\r\n\r\nfunction mapRemitoToFormData(remito = {}) {\r\n    return {\r\n        numeroRemito: sanitizeString(remito.numeroRemito),\r\n        numeroReporte: sanitizeString(remito.numeroReporte),\r\n        cliente: sanitizeString(remito.cliente),\r\n        fechaRemitoISO: formatDateForInput(remito.fechaRemitoISO || remito.fechaRemito),\r\n        fechaServicioISO: formatDateForInput(remito.fechaServicioISO || remito.fechaServicio),\r\n        tecnico: sanitizeString(remito.tecnico),\r\n        observaciones: sanitizeString(remito.observaciones),\r\n        direccion: sanitizeString(remito.direccion),\r\n        telefono: sanitizeString(remito.telefono),\r\n        email: sanitizeString(remito.email),\r\n        cuit: sanitizeString(remito.cuit),\r\n        reporteId: sanitizeString(remito.reporteId),\r\n        fotos: buildPhotoSlotsFromSources(\r\n            Array.isArray(remito.fotosDriveIds) ? remito.fotosDriveIds : [],\r\n            Array.isArray(remito.fotos) ? remito.fotos : [],\r\n        ),\r\n    };\r\n}\r\n\r\nfunction createClientOptionKey(identifier, label, index = 0) {\r\n    const candidate = sanitizeString(identifier) || sanitizeString(label);\r\n    if (candidate) {\r\n        const normalized = candidate\r\n            .toLowerCase()\r\n            .replace(/[^a-z0-9]+/g, '-')\r\n            .replace(/^-+|-+$/g, '');\r\n\r\n        if (normalized) {\r\n            return `cliente-${normalized}-${index}`;\r\n        }\r\n    }\r\n\r\n    return `cliente-${index}`;\r\n}\r\n\r\nfunction normalizeClientRecord(cliente, index = 0) {\r\n    if (!cliente || typeof cliente !== 'object') {\r\n        return null;\r\n    }\r\n\r\n    const nombre = sanitizeString(pickValue(cliente, CLIENT_NAME_KEYS));\r\n    const identificador = sanitizeString(pickValue(cliente, CLIENT_ID_KEYS));\r\n    const direccion = sanitizeString(pickValue(cliente, CLIENT_ADDRESS_KEYS));\r\n    const telefono = sanitizeString(pickValue(cliente, CLIENT_PHONE_KEYS));\r\n    const email = sanitizeString(pickValue(cliente, CLIENT_EMAIL_KEYS));\r\n    const cuit = sanitizeString(pickValue(cliente, CLIENT_CUIT_KEYS));\r\n\r\n    // Obtener el ID real del cliente (UUID de Supabase)\r\n    const clientId = cliente.id || cliente.ID || identificador;\r\n\r\n    const label = nombre || identificador;\r\n    if (!label) {\r\n        return null;\r\n    }\r\n\r\n    const key = createClientOptionKey(identificador, label, index);\r\n    const matchValues = Array.from(\r\n        new Set(\r\n            [nombre, identificador, label]\r\n                .map(value => sanitizeString(value).toLowerCase())\r\n                .filter(value => !!value),\r\n        ),\r\n    );\r\n\r\n    return {\r\n        key,\r\n        id: clientId,\r\n        label,\r\n        nombre: nombre || identificador || '',\r\n        direccion,\r\n        telefono,\r\n        email,\r\n        cuit,\r\n        matchValues,\r\n    };\r\n}\r\n\r\nfunction normalizeClientesList(clientes = []) {\r\n    if (!Array.isArray(clientes)) {\r\n        return [];\r\n    }\r\n\r\n    return clientes\r\n        .map((cliente, index) => normalizeClientRecord(cliente, index))\r\n        .filter(item => item !== null);\r\n}\r\n\r\nfunction findClienteByKey(key) {\r\n    if (!key) {\r\n        return null;\r\n    }\r\n\r\n    if (!Array.isArray(state.clienteOptions)) {\r\n        return null;\r\n    }\r\n\r\n    return state.clienteOptions.find(option => option.key === key) || null;\r\n}\r\n\r\nfunction findClienteByMatch(value) {\r\n    const target = sanitizeString(value).toLowerCase();\r\n    if (!target || !Array.isArray(state.clienteOptions)) {\r\n        return null;\r\n    }\r\n\r\n    return state.clienteOptions.find(option => option.matchValues.includes(target)) || null;\r\n}\r\n\r\nfunction syncSelectedClienteFromForm() {\r\n    const currentKey = sanitizeString(state.selectedClienteKey);\r\n    if (currentKey && findClienteByKey(currentKey)) {\r\n        return;\r\n    }\r\n\r\n    const currentCliente = sanitizeString(state.formData?.cliente);\r\n    if (!currentCliente) {\r\n        state.selectedClienteKey = '';\r\n        return;\r\n    }\r\n\r\n    const match = findClienteByMatch(currentCliente);\r\n    state.selectedClienteKey = match ? match.key : '';\r\n}\r\n\r\nasync function applyClienteSelection(key) {\r\n    const option = findClienteByKey(key);\r\n    state.selectedClienteKey = option ? option.key : '';\r\n\r\n    // Limpiar equipos y datos de equipo previos\r\n    state.equiposCliente = [];\r\n    state.selectedEquipoId = '';\r\n    state.formData.equipoId = '';\r\n    state.formData.sistemaNombre = '';\r\n    state.formData.modelo = '';\r\n    state.formData.serie = '';\r\n    state.formData.tagId = '';\r\n\r\n    if (!option) {\r\n        return;\r\n    }\r\n\r\n    state.formData.cliente = option.nombre || option.label || '';\r\n    state.formData.direccion = option.direccion || '';\r\n    state.formData.telefono = option.telefono || '';\r\n    state.formData.email = option.email || '';\r\n    state.formData.cuit = option.cuit || '';\r\n\r\n    // Cargar equipos del cliente seleccionado\r\n    if (option.id) {\r\n        console.log('[RemitosGestion] Cargando equipos para cliente ID:', option.id, 'Nombre:', option.nombre);\r\n        state.isLoadingEquipos = true;\r\n        renderManagementView();\r\n\r\n        try {\r\n            const equipos = await getEquiposByCliente(option.id);\r\n            console.log('[RemitosGestion] Equipos encontrados:', equipos?.length || 0, equipos);\r\n            state.equiposCliente = equipos || [];\r\n        } catch (error) {\r\n            console.warn('[RemitosGestion] Error cargando equipos del cliente:', error);\r\n            state.equiposCliente = [];\r\n        } finally {\r\n            state.isLoadingEquipos = false;\r\n            renderManagementView();\r\n        }\r\n    }\r\n}\r\n\r\nfunction applyEquipoSelection(equipoId) {\r\n    state.selectedEquipoId = equipoId || '';\r\n    state.formData.equipoId = equipoId || '';\r\n\r\n    if (!equipoId) {\r\n        state.formData.sistemaNombre = '';\r\n        state.formData.modelo = '';\r\n        state.formData.serie = '';\r\n        state.formData.tagId = '';\r\n        return;\r\n    }\r\n\r\n    const equipo = state.equiposCliente.find(e => e.id === equipoId);\r\n    if (equipo) {\r\n        state.formData.sistemaNombre = equipo.sistema_nombre || '';\r\n        state.formData.modelo = equipo.modelo || '';\r\n        state.formData.serie = equipo.serie || '';\r\n        state.formData.tagId = equipo.tag_id || '';\r\n    }\r\n}\r\n\r\nfunction buildEquiposOptionsHtml() {\r\n    if (state.isLoadingEquipos) {\r\n        return '<option value=\"\">Cargando equipos...</option>';\r\n    }\r\n\r\n    if (!Array.isArray(state.equiposCliente) || state.equiposCliente.length === 0) {\r\n        return '<option value=\"\">Sin equipos registrados</option>';\r\n    }\r\n\r\n    const selectedId = sanitizeString(state.selectedEquipoId);\r\n\r\n    return '<option value=\"\">Seleccionar equipo (opcional)...</option>' +\r\n        state.equiposCliente\r\n            .map(equipo => {\r\n                const selectedAttr = selectedId && equipo.id === selectedId ? ' selected' : '';\r\n                const label = buildEquipoLabel(equipo);\r\n                return `<option value=\"${equipo.id}\"${selectedAttr}>${escapeHtml(label)}</option>`;\r\n            })\r\n            .join('');\r\n}\r\n\r\nfunction buildEquipoLabel(equipo) {\r\n    const parts = [];\r\n    if (equipo.sistema_nombre) parts.push(equipo.sistema_nombre);\r\n    if (equipo.modelo) parts.push(`Mod: ${equipo.modelo}`);\r\n    if (equipo.serie) parts.push(`S/N: ${equipo.serie}`);\r\n    if (equipo.tag_id) parts.push(`TAG: ${equipo.tag_id}`);\r\n    return parts.length > 0 ? parts.join(' | ') : 'Equipo sin datos';\r\n}\r\n\r\nfunction buildClienteOptionsHtml() {\r\n    if (!Array.isArray(state.clienteOptions) || state.clienteOptions.length === 0) {\r\n        return '';\r\n    }\r\n\r\n    const selectedKey = sanitizeString(state.selectedClienteKey);\r\n\r\n    return state.clienteOptions\r\n        .map(option => {\r\n            const selectedAttr = selectedKey && option.key === selectedKey ? ' selected' : '';\r\n            const label = escapeHtml(option.label || option.nombre || option.id || '');\r\n            return `<option value=\"${option.key}\"${selectedAttr}>${label}</option>`;\r\n        })\r\n        .join('');\r\n}\r\n\r\nfunction buildPhotoSlotHtml(slot, index, disabledAttr) {\r\n    const previewSource = getPhotoPreviewSource(slot);\r\n    const hasPreview = Boolean(previewSource);\r\n    const labelText = escapeHtml(formatPhotoFileLabel(slot));\r\n    const buttonClasses = [\r\n        'group relative flex w-full items-center justify-center overflow-hidden rounded-xl border-2',\r\n        'min-h-[180px]',\r\n        hasPreview ? 'border-transparent bg-gray-900/5' : 'border-dashed border-gray-300 bg-gray-50',\r\n        'text-gray-400 transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60',\r\n    ].join(' ');\r\n    const triggerContent = hasPreview\r\n        ? `\r\n            <img src=\"${escapeHtml(previewSource)}\" alt=\"Foto ${index + 1}\" class=\"max-h-72 max-w-full object-contain mx-auto\" loading=\"lazy\">\r\n        `\r\n        : `\r\n            <div class=\"flex flex-col items-center justify-center gap-2 text-gray-400\">\r\n                <span class=\"text-5xl font-light leading-none\">+</span>\r\n                <span class=\"text-xs font-medium\">Agregar foto</span>\r\n            </div>\r\n        `;\r\n    const removeButton = hasPreview\r\n        ? `\r\n            <button type=\"button\" class=\"absolute right-3 top-3 inline-flex h-8 w-8 items-center justify-center rounded-full bg-white text-red-500 shadow-md transition hover:bg-red-50 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60\" data-remito-photo-action=\"remove\" data-remito-photo-index=\"${index}\" title=\"Eliminar foto\" aria-label=\"Eliminar foto\"${disabledAttr}>\r\n                <span aria-hidden=\"true\" class=\"text-lg leading-none\">&times;</span>\r\n            </button>\r\n        `\r\n        : '';\r\n\r\n    const menuHtml = `\r\n        <div class=\"absolute inset-0 z-10 flex items-center justify-center rounded-xl bg-black/40 p-4\" data-remito-photo-menu=\"${index}\" aria-hidden=\"true\" style=\"display: none;\">\r\n            <button type=\"button\" class=\"absolute inset-0 cursor-default\" data-remito-photo-menu-dismiss></button>\r\n            <div class=\"relative z-10 w-full max-w-[220px] space-y-2 rounded-lg bg-white p-4 text-center shadow-lg\">\r\n                <p class=\"text-sm font-semibold text-gray-700\">Seleccion├í una opci├│n</p>\r\n                <button type=\"button\" class=\"w-full rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60\" data-remito-photo-action=\"capture\" data-remito-photo-index=\"${index}\"${disabledAttr}>Tomar foto</button>\r\n                <button type=\"button\" class=\"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm transition hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60\" data-remito-photo-action=\"upload\" data-remito-photo-index=\"${index}\"${disabledAttr}>Subir foto</button>\r\n                <button type=\"button\" class=\"w-full rounded-lg border border-transparent bg-gray-100 px-3 py-2 text-sm font-semibold text-gray-600 transition hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2\" data-remito-photo-menu-dismiss>Cerrar</button>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    return `\r\n        <div class=\"remito-photo-slot space-y-2\" data-remito-photo-slot=\"${index}\">\r\n            <div class=\"flex items-center justify-between gap-2\">\r\n                <p class=\"text-sm font-medium text-gray-700\">Foto ${index + 1}</p>\r\n                <p class=\"max-w-[60%] truncate text-[11px] text-gray-500\">${labelText}</p>\r\n            </div>\r\n            <div class=\"relative\">\r\n                <button type=\"button\" class=\"${buttonClasses}\" data-remito-photo-trigger data-remito-photo-index=\"${index}\" aria-label=\"Agregar o reemplazar foto ${index + 1}\"${disabledAttr}>\r\n                    ${triggerContent}\r\n                </button>\r\n                ${removeButton}\r\n                ${menuHtml}\r\n            </div>\r\n            <input type=\"file\" accept=\"image/*\" capture=\"environment\" class=\"hidden\" data-remito-photo-input=\"capture\" data-remito-photo-index=\"${index}\"${disabledAttr}>\r\n            <input type=\"file\" accept=\"image/*\" class=\"hidden\" data-remito-photo-input=\"upload\" data-remito-photo-index=\"${index}\"${disabledAttr}>\r\n        </div>\r\n    `;\r\n}\r\n\r\nfunction buildRepuestosSectionHtml(disableFormFields) {\r\n    const disabledAttr = disableFormFields ? ' disabled' : '';\r\n    const repuestos = Array.isArray(state.formData?.repuestos) ? state.formData.repuestos : [];\r\n\r\n    const repuestosRowsHtml = repuestos.length > 0\r\n        ? repuestos.map((rep, index) => `\r\n            <tr data-repuesto-index=\"${index}\">\r\n                <td class=\"px-4 py-3\">\r\n                    <input type=\"text\" class=\"w-full border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                        data-repuesto-field=\"codigo\" value=\"${escapeHtml(rep.codigo || '')}\" placeholder=\"C├│digo\" ${disabledAttr}>\r\n                </td>\r\n                <td class=\"px-4 py-3\">\r\n                    <input type=\"text\" class=\"w-full border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                        data-repuesto-field=\"descripcion\" value=\"${escapeHtml(rep.descripcion || '')}\" placeholder=\"Descripci├│n del repuesto\" ${disabledAttr}>\r\n                </td>\r\n                <td class=\"px-4 py-3\">\r\n                    <input type=\"number\" min=\"1\" class=\"w-24 border border-gray-300 rounded-lg px-3 py-1.5 text-sm text-right focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                        data-repuesto-field=\"cantidad\" value=\"${escapeHtml(rep.cantidad || '1')}\" ${disabledAttr}>\r\n                </td>\r\n                <td class=\"px-4 py-3 text-center\">\r\n                    <button type=\"button\" class=\"text-red-500 hover:text-red-700 focus:outline-none\" data-repuesto-remove=\"${index}\" title=\"Eliminar repuesto\" ${disabledAttr}>\r\n                        <svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\r\n                        </svg>\r\n                    </button>\r\n                </td>\r\n            </tr>\r\n        `).join('')\r\n        : `\r\n            <tr id=\"repuestos-empty-row\">\r\n                <td colspan=\"4\" class=\"px-4 py-6 text-center text-sm text-gray-500\">\r\n                    No hay repuestos agregados. Us├í el bot├│n \"Agregar repuesto\" para a├▒adir uno.\r\n                </td>\r\n            </tr>\r\n        `;\r\n\r\n    return `\r\n        <section class=\"bg-white rounded-2xl shadow-sm border border-gray-200 p-6\">\r\n            <div class=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\r\n                <div>\r\n                    <h3 class=\"text-lg font-semibold text-gray-800\">Repuestos y Materiales</h3>\r\n                    <p class=\"text-sm text-gray-500\">Detalle de los repuestos utilizados durante el servicio.</p>\r\n                </div>\r\n                <button type=\"button\" id=\"remitos-gestion-agregar-repuesto\" \r\n                    class=\"inline-flex items-center justify-center px-5 py-2.5 rounded-lg font-semibold text-sm bg-blue-600 text-white shadow-sm transition-colors duration-150 ease-out hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500\"\r\n                    ${disabledAttr}>\r\n                    Agregar repuesto\r\n                </button>\r\n            </div>\r\n            <div class=\"mt-4 overflow-x-auto rounded-xl border border-gray-200\">\r\n                <table class=\"min-w-full divide-y divide-gray-200\" id=\"remito-repuestos-table\">\r\n                    <thead class=\"bg-gray-50\">\r\n                        <tr>\r\n                            <th scope=\"col\" class=\"px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500\">C├│digo</th>\r\n                            <th scope=\"col\" class=\"px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500\">Descripci├│n</th>\r\n                            <th scope=\"col\" class=\"px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-gray-500\">Cantidad</th>\r\n                            <th scope=\"col\" class=\"px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-500 w-16\"></th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody id=\"remitos-gestion-repuestos-body\" class=\"bg-white divide-y divide-gray-200\">\r\n                        ${repuestosRowsHtml}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </section>\r\n    `;\r\n}\r\n\r\nfunction buildPhotoSectionHtml(disableFormFields) {\r\n    const disabledAttr = disableFormFields ? ' disabled' : '';\r\n    const slots = normalizePhotoSlots(state.formData?.fotos);\r\n\r\n    // Siempre mostrar los 4 slots de fotos\r\n    const slotsHtml = slots\r\n        .slice(0, MAX_REMITO_PHOTOS)\r\n        .map((slot, index) => buildPhotoSlotHtml(slot, index, disabledAttr))\r\n        .join('');\r\n\r\n    return `\r\n        <section class=\"bg-white rounded-2xl shadow-sm border border-gray-200 p-6\">\r\n            <div class=\"flex flex-col gap-1\">\r\n                <h3 class=\"text-lg font-semibold text-gray-800\">Fotos del servicio</h3>\r\n                <p class=\"text-sm text-gray-500\">Pod├®s subir hasta cuatro im├ígenes. Cada archivo puede pesar hasta 5 MB.</p>\r\n            </div>\r\n            <div class=\"mt-4 grid grid-cols-1 gap-4 md:grid-cols-2\">\r\n                ${slotsHtml}\r\n            </div>\r\n        </section>\r\n    `;\r\n}\r\n\r\nfunction closeAllPhotoMenus() {\r\n    if (typeof document === 'undefined') {\r\n        return;\r\n    }\r\n\r\n    const container = getContainerElement();\r\n    if (!container) {\r\n        return;\r\n    }\r\n\r\n    const menus = container.querySelectorAll('[data-remito-photo-menu]');\r\n    menus.forEach((menu) => {\r\n        menu.style.display = 'none';\r\n        menu.setAttribute('aria-hidden', 'true');\r\n    });\r\n}\r\n\r\nfunction togglePhotoMenu(index) {\r\n    if (typeof document === 'undefined') {\r\n        return;\r\n    }\r\n\r\n    const container = getContainerElement();\r\n    if (!container) {\r\n        return;\r\n    }\r\n\r\n    const normalizedIndex = Number(index);\r\n    if (!Number.isFinite(normalizedIndex) || normalizedIndex < 0 || normalizedIndex >= MAX_REMITO_PHOTOS) {\r\n        return;\r\n    }\r\n\r\n    const selector = `[data-remito-photo-menu=\"${normalizedIndex}\"]`;\r\n    const menu = container.querySelector(selector);\r\n    if (!menu) {\r\n        return;\r\n    }\r\n\r\n    const isHidden = menu.style.display === 'none' || menu.style.display === '';\r\n    closeAllPhotoMenus();\r\n    if (isHidden) {\r\n        menu.style.display = 'flex';\r\n        menu.setAttribute('aria-hidden', 'false');\r\n    }\r\n}\r\n\r\nfunction buildPayloadFromForm(formData = {}) {\r\n    const fechaRemitoISO = sanitizeString(formData.fechaRemitoISO);\r\n    const fechaServicioISO = sanitizeString(formData.fechaServicioISO);\r\n    const fotoSlots = normalizePhotoSlots(formData.fotos);\r\n\r\n    return {\r\n        numeroRemito: sanitizeString(formData.numeroRemito),\r\n        numeroReporte: sanitizeString(formData.numeroReporte),\r\n        cliente: sanitizeString(formData.cliente),\r\n        fechaRemito: fechaRemitoISO,\r\n        fechaRemitoISO,\r\n        fechaServicio: fechaServicioISO,\r\n        fechaServicioISO,\r\n        tecnico: sanitizeString(formData.tecnico),\r\n        referencia: sanitizeString(formData.referencia),\r\n        observaciones: sanitizeString(formData.observaciones),\r\n        direccion: sanitizeString(formData.direccion),\r\n        telefono: sanitizeString(formData.telefono),\r\n        email: sanitizeString(formData.email),\r\n        cuit: sanitizeString(formData.cuit),\r\n        reporteId: sanitizeString(formData.reporteId),\r\n        // Datos del equipo seleccionado\r\n        equipo_id: sanitizeString(formData.equipo_id),\r\n        equipo_numero_serie: sanitizeString(formData.equipo_numero_serie),\r\n        equipo_modelo: sanitizeString(formData.equipo_modelo),\r\n        equipo_ubicacion: sanitizeString(formData.equipo_ubicacion),\r\n        // Repuestos utilizados\r\n        repuestos: Array.isArray(formData.repuestos)\r\n            ? formData.repuestos.map(r => ({\r\n                descripcion: sanitizeString(r.descripcion),\r\n                cantidad: parseInt(r.cantidad, 10) || 1,\r\n                codigo: sanitizeString(r.codigo)\r\n            })).filter(r => r.descripcion) // Solo incluir si tiene descripci├│n\r\n            : [],\r\n        fotos: fotoSlots.map((slot, index) => ({\r\n            slot: index + 1,\r\n            url: sanitizeString(slot.url),\r\n            base64Data: sanitizeString(slot.base64Data),\r\n            mimeType: sanitizeString(slot.mimeType),\r\n            fileName: sanitizeString(slot.fileName),\r\n            driveFileId: sanitizeString(slot.driveId),\r\n            shouldRemove: Boolean(slot.shouldRemove),\r\n        })),\r\n    };\r\n}\r\n\r\nfunction buildReporteDataFromPayload(payload = {}) {\r\n    const numeroRemito = sanitizeString(payload.numeroRemito);\r\n    const numeroReporte = sanitizeString(payload.numeroReporte);\r\n    const cliente = sanitizeString(payload.cliente);\r\n    const fechaRemitoISO = sanitizeString(payload.fechaRemitoISO);\r\n    const fechaRemito = sanitizeString(payload.fechaRemito) || fechaRemitoISO;\r\n    const fechaServicioISO = sanitizeString(payload.fechaServicioISO);\r\n    const fechaServicio = sanitizeString(payload.fechaServicio) || fechaServicioISO;\r\n    const tecnico = sanitizeString(payload.tecnico);\r\n    const observaciones = sanitizeString(payload.observaciones);\r\n    const direccion = sanitizeString(payload.direccion);\r\n    const telefono = sanitizeString(payload.telefono);\r\n    const email = sanitizeString(payload.email);\r\n    const cuit = sanitizeString(payload.cuit);\r\n    const reporteId = sanitizeString(payload.reporteId);\r\n\r\n    const reporteData = {\r\n        NumeroRemito: numeroRemito || undefined,\r\n        numero_remito: numeroRemito || undefined,\r\n        remitoNumero: numeroRemito || undefined,\r\n        NumeroReporte: numeroReporte || undefined,\r\n        numero_reporte: numeroReporte || undefined,\r\n        numeroReporte: numeroReporte || undefined,\r\n        clienteNombre: cliente || undefined,\r\n        Cliente: cliente || undefined,\r\n        cliente: cliente || undefined,\r\n        fecha_display: fechaRemito || undefined,\r\n        FechaRemito: fechaRemito || undefined,\r\n        FechaRemitoISO: fechaRemitoISO || undefined,\r\n        fecha: fechaServicio || undefined,\r\n        fecha_servicio: fechaServicio || undefined,\r\n        Fecha_Servicio: fechaServicio || undefined,\r\n        FechaServicio: fechaServicio || undefined,\r\n        FechaServicioISO: fechaServicioISO || undefined,\r\n        tecnico: tecnico || undefined,\r\n        Tecnico: tecnico || undefined,\r\n        observaciones: observaciones || undefined,\r\n        Observaciones: observaciones || undefined,\r\n        direccion: direccion || undefined,\r\n        Direccion: direccion || undefined,\r\n        cliente_direccion: direccion || undefined,\r\n        cliente_telefono: telefono || undefined,\r\n        telefono_cliente: telefono || undefined,\r\n        Telefono: telefono || undefined,\r\n        cliente_email: email || undefined,\r\n        email: email || undefined,\r\n        Email: email || undefined,\r\n        cliente_cuit: cuit || undefined,\r\n        cuit: cuit || undefined,\r\n        CUIT: cuit || undefined,\r\n        reporteId: reporteId || undefined,\r\n        ID: reporteId || undefined,\r\n        Id: reporteId || undefined,\r\n        ID_Unico: reporteId || undefined,\r\n    };\r\n\r\n    const fotoSlots = normalizePhotoSlots(payload.fotos);\r\n    const fotoIds = fotoSlots\r\n        .map(slot => sanitizeString(slot.driveId))\r\n        .filter(id => !!id);\r\n\r\n    if (fotoIds.length > 0) {\r\n        reporteData.fotosDriveIds = fotoIds;\r\n        reporteData.fotos_drive_ids = fotoIds;\r\n        reporteData.fotoIds = fotoIds;\r\n    }\r\n\r\n    return Object.fromEntries(\r\n        Object.entries(reporteData).filter(([, value]) => value !== undefined && value !== ''),\r\n    );\r\n}\r\n\r\nfunction buildCreateRemitoRequest(payload = {}) {\r\n    const reporteData = buildReporteDataFromPayload(payload);\r\n\r\n    if (!reporteData || Object.keys(reporteData).length === 0) {\r\n        throw new Error('No se pudo generar la informaci├│n del remito para enviarla al servidor.');\r\n    }\r\n\r\n    const request = { reporteData };\r\n    const observaciones = sanitizeString(payload.observaciones);\r\n    if (observaciones) {\r\n        request.observaciones = observaciones;\r\n    }\r\n\r\n    if (Array.isArray(payload.fotos)) {\r\n        const fotos = payload.fotos\r\n            .map((item) => {\r\n                if (!item || typeof item !== 'object') {\r\n                    return null;\r\n                }\r\n\r\n                const slot = Number(item.slot);\r\n                const base64Data = sanitizeString(item.base64Data);\r\n                const mimeType = sanitizeString(item.mimeType);\r\n                const fileName = sanitizeString(item.fileName);\r\n                const url = sanitizeString(item.url);\r\n                const driveFileId = sanitizeString(item.driveFileId || item.driveId);\r\n                const shouldRemove = Boolean(item.shouldRemove);\r\n\r\n                if (!base64Data && !url && !driveFileId && !shouldRemove) {\r\n                    return null;\r\n                }\r\n\r\n                const normalized = {};\r\n                if (Number.isFinite(slot) && slot > 0) {\r\n                    normalized.slot = slot;\r\n                }\r\n                if (base64Data) {\r\n                    normalized.base64Data = base64Data;\r\n                }\r\n                if (mimeType) {\r\n                    normalized.mimeType = mimeType;\r\n                }\r\n                if (fileName) {\r\n                    normalized.fileName = fileName;\r\n                }\r\n                if (url) {\r\n                    normalized.url = url;\r\n                }\r\n                if (driveFileId) {\r\n                    normalized.driveFileId = driveFileId;\r\n                }\r\n                if (shouldRemove) {\r\n                    normalized.shouldRemove = true;\r\n                }\r\n\r\n                return normalized;\r\n            })\r\n            .filter(Boolean);\r\n\r\n        if (fotos.length > 0) {\r\n            request.fotos = fotos;\r\n        }\r\n    }\r\n\r\n    return request;\r\n}\r\n\r\nfunction validateFormData(formData = {}) {\r\n    const errors = [];\r\n\r\n    const requireNumeroRemito = state.formMode === 'edit';\r\n    if (requireNumeroRemito && !sanitizeString(formData.numeroRemito)) {\r\n        errors.push('El n├║mero de remito es obligatorio.');\r\n    }\r\n\r\n    if (!sanitizeString(formData.cliente)) {\r\n        errors.push('El nombre del cliente es obligatorio.');\r\n    }\r\n\r\n    return errors;\r\n}\r\n\r\nfunction getRemitoIdentifier(remito) {\r\n    if (!remito || typeof remito !== 'object') {\r\n        return '';\r\n    }\r\n\r\n    return sanitizeString(remito.reporteId) || sanitizeString(remito.numeroRemito);\r\n}\r\n\r\nconst state = {\r\n    remitos: [],\r\n    currentPage: 1,\r\n    totalPages: 0,\r\n    totalItems: 0,\r\n    pageSize: DEFAULT_PAGE_SIZE,\r\n    isLoading: false,\r\n    lastError: null,\r\n    viewMode: 'list',\r\n    formMode: 'create',\r\n    formData: getEmptyFormData(),\r\n    editingRemitoId: null,\r\n    editingRemitoLabel: '',\r\n    editingRemitoOriginal: null,\r\n    isSaving: false,\r\n    isDeleting: false,\r\n    deletingIndex: null,\r\n    feedback: null,\r\n    clienteOptions: [],\r\n    clientesLoaded: false,\r\n    isLoadingClientes: false,\r\n    clientesError: null,\r\n    selectedClienteKey: '',\r\n    // Equipos del cliente seleccionado\r\n    equiposCliente: [],\r\n    isLoadingEquipos: false,\r\n    selectedEquipoId: '',\r\n};\r\n\r\nfunction ensurePhotoSlotsInFormData() {\r\n    if (!state.formData || typeof state.formData !== 'object') {\r\n        state.formData = getEmptyFormData();\r\n    }\r\n\r\n    state.formData.fotos = normalizePhotoSlots(state.formData.fotos);\r\n}\r\n\r\nconst defaultDependencies = {\r\n    obtenerRemitos: async () => {\r\n        throw new Error('La funci├│n obtenerRemitos no fue provista.');\r\n    },\r\n    crearRemito: async () => {\r\n        throw new Error('La funci├│n crearRemito no fue provista.');\r\n    },\r\n    actualizarRemito: async () => {\r\n        throw new Error('La funci├│n actualizarRemito no fue provista.');\r\n    },\r\n    eliminarRemito: async () => {\r\n        throw new Error('La funci├│n eliminarRemito no fue provista.');\r\n    },\r\n    obtenerClientes: async () => {\r\n        throw new Error('La funci├│n obtenerClientes no fue provista.');\r\n    },\r\n    obtenerUrlPdfRemito: async () => {\r\n        return null; // Fallback: no hay URL, se regenerar├í el PDF\r\n    },\r\n    guardarPdfRemito: async () => {\r\n        return null; // Fallback: no se guarda PDF si no est├í provista\r\n    },\r\n};\r\n\r\nlet dependencies = { ...defaultDependencies };\r\n\r\nfunction setDependencies(overrides = {}) {\r\n    dependencies = { ...defaultDependencies, ...(overrides || {}) };\r\n}\r\n\r\nasync function ensureClientesLoaded({ force = false, reRender = false } = {}) {\r\n    const obtenerClientes = dependencies.obtenerClientes;\r\n    if (typeof obtenerClientes !== 'function') {\r\n        state.clienteOptions = [];\r\n        state.clientesLoaded = false;\r\n        state.clientesError = 'No se configur├│ la funci├│n para obtener clientes.';\r\n        if (reRender) {\r\n            renderManagementView();\r\n        }\r\n        return;\r\n    }\r\n\r\n    if (state.isLoadingClientes) {\r\n        return;\r\n    }\r\n\r\n    if (!force && state.clientesLoaded && Array.isArray(state.clienteOptions) && state.clienteOptions.length > 0) {\r\n        syncSelectedClienteFromForm();\r\n        return;\r\n    }\r\n\r\n    state.isLoadingClientes = true;\r\n    if (reRender) {\r\n        renderManagementView();\r\n    }\r\n\r\n    try {\r\n        const clientes = await obtenerClientes({ forceRefresh: Boolean(force) });\r\n        state.clienteOptions = normalizeClientesList(clientes);\r\n        state.clientesLoaded = true;\r\n        state.clientesError = null;\r\n        syncSelectedClienteFromForm();\r\n    } catch (error) {\r\n        state.clienteOptions = [];\r\n        state.clientesLoaded = false;\r\n        state.clientesError = error?.message || 'No se pudieron cargar los clientes.';\r\n    } finally {\r\n        state.isLoadingClientes = false;\r\n        if (reRender) {\r\n            renderManagementView();\r\n        }\r\n    }\r\n}\r\n\r\nfunction getContainerElement() {\r\n    return document.getElementById('remitos-gestion-container');\r\n}\r\n\r\nfunction showLoadingState() {\r\n    const container = getContainerElement();\r\n    if (!container) {\r\n        return;\r\n    }\r\n\r\n    container.innerHTML = `\r\n        <div class=\"flex items-center justify-center rounded-xl border border-gray-200 bg-white p-10 shadow-sm\">\r\n            <span class=\"text-gray-600 text-sm font-medium\">Cargando remitos...</span>\r\n        </div>\r\n    `;\r\n}\r\n\r\nfunction showErrorState(message) {\r\n    const container = getContainerElement();\r\n    if (!container) {\r\n        return;\r\n    }\r\n\r\n    const safeMessage = escapeHtml(message || 'Ocurri├│ un error inesperado al obtener los remitos.');\r\n\r\n    container.innerHTML = `\r\n        <div class=\"rounded-xl border border-red-200 bg-red-50 p-6 shadow-sm\">\r\n            <h3 class=\"text-base font-semibold text-red-700 mb-2\">No se pudieron cargar los remitos</h3>\r\n            <p class=\"text-sm text-red-600 mb-4\">${safeMessage}</p>\r\n            <button type=\"button\" class=\"inline-flex items-center rounded-lg border border-red-200 bg-white px-4 py-2 text-sm font-medium text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-1\" data-remitos-action=\"reload\">\r\n                Reintentar\r\n            </button>\r\n        </div>\r\n    `;\r\n}\r\n\r\nfunction setFeedback(type, message) {\r\n    const messageText = sanitizeString(message);\r\n    if (!type || !messageText) {\r\n        state.feedback = null;\r\n        return;\r\n    }\r\n\r\n    state.feedback = { type, message: messageText };\r\n}\r\n\r\nfunction resetFormState({ viewMode = 'list' } = {}) {\r\n    state.formMode = 'create';\r\n    state.formData = getEmptyFormData();\r\n    ensurePhotoSlotsInFormData();\r\n    state.editingRemitoId = null;\r\n    state.editingRemitoLabel = '';\r\n    state.editingRemitoOriginal = null;\r\n    state.viewMode = viewMode;\r\n    state.selectedClienteKey = '';\r\n    // Limpiar equipos\r\n    state.equiposCliente = [];\r\n    state.selectedEquipoId = '';\r\n}\r\n\r\nfunction renderManagementView() {\r\n    const container = getContainerElement();\r\n    if (!container) {\r\n        return;\r\n    }\r\n\r\n    ensurePhotoSlotsInFormData();\r\n    const disableFormFields = state.isSaving || state.isLoading;\r\n    const disabledAttr = disableFormFields ? 'disabled' : '';\r\n\r\n    // Equipos del cliente\r\n    const hasClienteSelected = Boolean(state.selectedClienteKey);\r\n    const equiposOptionsHtml = buildEquiposOptionsHtml();\r\n    const equipoSelectDisabledAttr = (disableFormFields || state.isLoadingEquipos || !hasClienteSelected) ? 'disabled' : '';\r\n    const hasEquipos = hasClienteSelected && state.equiposCliente.length > 0;\r\n    const hasEquipoSelected = Boolean(state.selectedEquipoId);\r\n\r\n    // Construir secci├│n de equipo - ahora como campos individuales para el grid\r\n    const equipoSectionHtml = hasClienteSelected ? `\r\n        <div class=\"md:col-span-2\">\r\n            <label for=\"remito-form-equipo-select\" class=\"block text-sm font-semibold text-gray-600\">Equipo del cliente</label>\r\n            <select id=\"remito-form-equipo-select\" class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" ${equipoSelectDisabledAttr}>\r\n                ${equiposOptionsHtml}\r\n            </select>\r\n            <p class=\"mt-1 text-xs text-gray-500\">${hasEquipos ? 'Seleccion├í un equipo para completar los datos t├®cnicos.' : 'Este cliente no tiene equipos registrados.'}</p>\r\n        </div>\r\n        <div>\r\n            <label for=\"remito-form-sistema\" class=\"block text-sm font-semibold text-gray-600\">Sistema / Descripci├│n</label>\r\n            <input id=\"remito-form-sistema\" type=\"text\" readonly\r\n                class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 bg-gray-50\" \r\n                value=\"${escapeHtml(state.formData.sistemaNombre || '')}\" \r\n                placeholder=\"Se completa al seleccionar equipo\">\r\n        </div>\r\n        <div>\r\n            <label for=\"remito-form-modelo\" class=\"block text-sm font-semibold text-gray-600\">Modelo</label>\r\n            <input id=\"remito-form-modelo\" type=\"text\" readonly\r\n                class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 bg-gray-50\" \r\n                value=\"${escapeHtml(state.formData.modelo || '')}\" \r\n                placeholder=\"Se completa al seleccionar equipo\">\r\n        </div>\r\n        <div>\r\n            <label for=\"remito-form-serie\" class=\"block text-sm font-semibold text-gray-600\">N├║mero de Serie</label>\r\n            <input id=\"remito-form-serie\" type=\"text\" readonly\r\n                class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 bg-gray-50\" \r\n                value=\"${escapeHtml(state.formData.serie || '')}\" \r\n                placeholder=\"Se completa al seleccionar equipo\">\r\n        </div>\r\n        <div>\r\n            <label for=\"remito-form-tag\" class=\"block text-sm font-semibold text-gray-600\">TAG / ID Interno</label>\r\n            <input id=\"remito-form-tag\" type=\"text\" readonly\r\n                class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 bg-gray-50\" \r\n                value=\"${escapeHtml(state.formData.tagId || '')}\" \r\n                placeholder=\"Se completa al seleccionar equipo\">\r\n        </div>\r\n    ` : `\r\n        <div class=\"md:col-span-2\">\r\n            <div class=\"rounded-lg bg-gray-50 border border-gray-200 p-4 text-center text-sm text-gray-500\">\r\n                <p>Seleccion├í un cliente para ver sus equipos disponibles.</p>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    const shouldShowNumeroRemitoPlaceholder = state.formMode === 'create'\r\n        && !sanitizeString(state.formData.numeroRemito);\r\n    const numeroRemitoPlaceholderAttr = shouldShowNumeroRemitoPlaceholder\r\n        ? ' placeholder=\"Se asignar├í autom├íticamente\"'\r\n        : '';\r\n    const numeroRemitoHelpHtml = shouldShowNumeroRemitoPlaceholder\r\n        ? '<p class=\"mt-1 text-xs text-gray-500\">Se asignar├í autom├íticamente al guardar.</p>'\r\n        : '';\r\n    const numeroReporteFieldHtml = state.formMode === 'edit' && sanitizeString(state.formData.numeroReporte)\r\n        ? `\r\n            <div class=\"flex flex-col gap-1\">\r\n                <label for=\"remito-form-reporte\" class=\"text-sm font-medium text-gray-700\">N├║mero de reporte</label>\r\n                <input id=\"remito-form-reporte\" type=\"text\" class=\"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500\" value=\"${escapeHtml(state.formData.numeroReporte)}\" readonly ${disabledAttr}>\r\n            </div>\r\n        `\r\n        : '';\r\n    const submitLabel = state.formMode === 'edit'\r\n        ? (state.isSaving ? 'Guardando cambios...' : 'Actualizar remito')\r\n        : (state.isSaving ? 'Guardando remito...' : 'Crear remito');\r\n\r\n    const feedbackHtml = state.feedback\r\n        ? `<div class=\"rounded-lg border ${state.feedback.type === 'error' ? 'border-red-200 bg-red-50 text-red-700' : 'border-green-200 bg-green-50 text-green-700'} px-4 py-3 text-sm font-medium\">${escapeHtml(state.feedback.message)}</div>`\r\n        : '';\r\n\r\n    const formTitle = state.formMode === 'edit' ? 'Editar remito' : 'Registrar nuevo remito';\r\n    const editingLabel = escapeHtml(state.editingRemitoLabel || state.formData.numeroRemito || '');\r\n    const formSubtitle = state.formMode === 'edit'\r\n        ? `Est├ís editando el remito ${editingLabel}.`\r\n        : 'Complet├í los datos para registrar un remito manualmente.';\r\n\r\n    const secondaryButtons = [\r\n        `<button type=\"button\" class=\"inline-flex justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60\" data-remitos-action=\"back-to-list\" ${disabledAttr}>Volver al listado</button>`,\r\n    ];\r\n\r\n    if (state.formMode === 'edit') {\r\n        secondaryButtons.unshift(`<button type=\"button\" class=\"inline-flex justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60\" data-remitos-action=\"cancel-edit\" ${disabledAttr}>Cancelar edici├│n</button>`);\r\n    }\r\n\r\n    const secondaryButtonHtml = secondaryButtons.join('');\r\n    const photoSectionHtml = buildPhotoSectionHtml(disableFormFields);\r\n\r\n    // Construir secci├│n de repuestos\r\n    const repuestosHtml = buildRepuestosSectionHtml(disableFormFields);\r\n\r\n    if (state.viewMode === 'form') {\r\n        container.innerHTML = `\r\n            <div class=\"max-w-5xl mx-auto space-y-6\">\r\n                ${feedbackHtml ? `<div>${feedbackHtml}</div>` : ''}\r\n                \r\n                <!-- Header -->\r\n                <div class=\"bg-white shadow-lg rounded-3xl p-8 border border-gray-200\">\r\n                    <h2 class=\"text-2xl font-bold text-gray-800\">${escapeHtml(formTitle)}</h2>\r\n                    <p class=\"mt-2 text-sm text-gray-500\">${formSubtitle}</p>\r\n                </div>\r\n\r\n                <form id=\"remito-abm-form\" class=\"space-y-6\">\r\n                    <!-- N├║mero, Fecha, T├®cnico y Referencia -->\r\n                    <section class=\"bg-white rounded-2xl shadow-sm border border-gray-200 p-6\">\r\n                        <div class=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4\">\r\n                            <div>\r\n                                <label class=\"block text-sm font-semibold text-gray-600\">N├║mero de Remito</label>\r\n                                <div class=\"mt-2 w-full border border-gray-200 bg-gray-50 rounded-lg px-4 py-2 text-gray-500 italic text-sm\">\r\n                                    Autom├ítico\r\n                                </div>\r\n                            </div>\r\n                            <div>\r\n                                <label for=\"remito-form-fecha\" class=\"block text-sm font-semibold text-gray-600\">Fecha *</label>\r\n                                <input id=\"remito-form-fecha\" type=\"date\" \r\n                                    class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                                    data-remito-field=\"fechaRemitoISO\" \r\n                                    value=\"${escapeHtml(state.formData.fechaRemitoISO)}\" \r\n                                    ${disabledAttr}>\r\n                            </div>\r\n                            <div>\r\n                                <label for=\"remito-form-tecnico\" class=\"block text-sm font-semibold text-gray-600\">T├®cnico Responsable</label>\r\n                                <input id=\"remito-form-tecnico\" type=\"text\" \r\n                                    class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 bg-gray-50\" \r\n                                    data-remito-field=\"tecnico\" \r\n                                    value=\"${escapeHtml(state.formData.tecnico)}\" \r\n                                    placeholder=\"Nombre del t├®cnico\"\r\n                                    readonly\r\n                                    ${disabledAttr}>\r\n                            </div>\r\n                            <div>\r\n                                <label for=\"remito-form-referencia\" class=\"block text-sm font-semibold text-gray-600\">Referencia / O.C / Presupuesto</label>\r\n                                <input id=\"remito-form-referencia\" type=\"text\" \r\n                                    class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                                    data-remito-field=\"referencia\" \r\n                                    value=\"${escapeHtml(state.formData.referencia || '')}\" \r\n                                    placeholder=\"Identificador asociado\"\r\n                                    ${disabledAttr}>\r\n                            </div>\r\n                        </div>\r\n                    </section>\r\n\r\n                    <!-- Datos del Cliente -->\r\n                    <section class=\"bg-white rounded-2xl shadow-sm border border-gray-200 p-6\">\r\n                        <h3 class=\"text-lg font-semibold text-gray-800\">Datos del Cliente</h3>\r\n                        <div class=\"mt-4 grid grid-cols-1 gap-4 md:grid-cols-2\">\r\n                            <div class=\"md:col-span-2\">\r\n                                <label for=\"remito-form-cliente\" class=\"block text-sm font-semibold text-gray-600\">Raz├│n Social *</label>\r\n                                <div class=\"relative mt-2\">\r\n                                    <div class=\"flex gap-2\">\r\n                                        <input id=\"remito-form-cliente\" type=\"text\" \r\n                                            class=\"flex-1 border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                                            data-remito-field=\"cliente\" \r\n                                            value=\"${escapeHtml(state.formData.cliente)}\" \r\n                                            placeholder=\"${state.isLoadingClientes ? 'Cargando clientes...' : 'Buscar cliente...'}\" \r\n                                            autocomplete=\"off\"\r\n                                            ${disabledAttr}>\r\n                                        ${hasClienteSelected ? `\r\n                                        <button type=\"button\" id=\"remito-form-cliente-clear\" class=\"px-4 py-2 text-sm font-medium text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg border border-gray-300 transition-colors\" title=\"Limpiar cliente\" ${disabledAttr}>\r\n                                            Ô£ò\r\n                                        </button>\r\n                                        ` : ''}\r\n                                    </div>\r\n                                    <div id=\"remito-form-cliente-dropdown\" class=\"hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto\"></div>\r\n                                </div>\r\n                                <p class=\"mt-1 text-xs text-gray-500\">${hasClienteSelected ? 'Cliente seleccionado. Los datos se completaron autom├íticamente.' : 'Escrib├¡ para buscar un cliente o ingres├í los datos manualmente.'}</p>\r\n                            </div>\r\n                            <div>\r\n                                <label for=\"remito-form-direccion\" class=\"block text-sm font-semibold text-gray-600\">Direcci├│n</label>\r\n                                <input id=\"remito-form-direccion\" type=\"text\" \r\n                                    class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                                    data-remito-field=\"direccion\" \r\n                                    value=\"${escapeHtml(state.formData.direccion)}\" \r\n                                    placeholder=\"Domicilio del servicio\"\r\n                                    ${disabledAttr}>\r\n                            </div>\r\n                            <div>\r\n                                <label for=\"remito-form-telefono\" class=\"block text-sm font-semibold text-gray-600\">Tel├®fono</label>\r\n                                <input id=\"remito-form-telefono\" type=\"tel\" \r\n                                    class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                                    data-remito-field=\"telefono\" \r\n                                    value=\"${escapeHtml(state.formData.telefono)}\" \r\n                                    placeholder=\"Tel├®fono de contacto\"\r\n                                    ${disabledAttr}>\r\n                            </div>\r\n                            <div>\r\n                                <label for=\"remito-form-email\" class=\"block text-sm font-semibold text-gray-600\">Email</label>\r\n                                <input id=\"remito-form-email\" type=\"email\" \r\n                                    class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                                    data-remito-field=\"email\" \r\n                                    value=\"${escapeHtml(state.formData.email)}\" \r\n                                    placeholder=\"Correo electr├│nico\"\r\n                                    ${disabledAttr}>\r\n                            </div>\r\n                            <div>\r\n                                <label for=\"remito-form-cuit\" class=\"block text-sm font-semibold text-gray-600\">CUIT</label>\r\n                                <input id=\"remito-form-cuit\" type=\"text\" \r\n                                    class=\"mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                                    data-remito-field=\"cuit\" \r\n                                    value=\"${escapeHtml(state.formData.cuit)}\" \r\n                                    placeholder=\"CUIT del cliente\"\r\n                                    ${disabledAttr}>\r\n                            </div>\r\n                        </div>\r\n                    </section>\r\n\r\n                    <!-- Datos del Equipo -->\r\n                    <section class=\"bg-white rounded-2xl shadow-sm border border-gray-200 p-6\">\r\n                        <h3 class=\"text-lg font-semibold text-gray-800\">Datos del Equipo</h3>\r\n                        <div class=\"mt-4 grid grid-cols-1 gap-4 md:grid-cols-2\">\r\n                            ${equipoSectionHtml}\r\n                        </div>\r\n                    </section>\r\n\r\n                    <!-- Repuestos y Materiales -->\r\n                    ${repuestosHtml}\r\n\r\n                    <!-- Fotos del Servicio -->\r\n                    ${photoSectionHtml}\r\n\r\n                    <!-- Observaciones -->\r\n                    <section class=\"bg-white rounded-2xl shadow-sm border border-gray-200 p-6\">\r\n                        <label for=\"remito-form-observaciones\" class=\"block text-lg font-semibold text-gray-800\">Observaciones</label>\r\n                        <textarea id=\"remito-form-observaciones\" \r\n                            class=\"mt-4 w-full border border-gray-300 rounded-lg p-4 text-gray-700 min-h-[120px] focus:ring-2 focus:ring-blue-500 focus:border-blue-500\" \r\n                            data-remito-field=\"observaciones\"\r\n                            placeholder=\"Agreg├í observaciones o comentarios relevantes\"\r\n                            ${disabledAttr}>${escapeHtml(state.formData.observaciones)}</textarea>\r\n                    </section>\r\n\r\n                    <!-- Botones de acci├│n -->\r\n                    <div class=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\r\n                        <p class=\"text-sm text-gray-500\">Al guardar, el n├║mero de remito se generar├í autom├íticamente.</p>\r\n                        <div class=\"flex flex-col items-stretch gap-3 md:flex-row md:items-center md:justify-end md:gap-3\">\r\n                            ${secondaryButtonHtml}\r\n                            <button type=\"submit\" class=\"inline-flex justify-center rounded-lg border border-transparent bg-blue-600 px-6 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60\" ${disabledAttr}>\r\n                                ${escapeHtml(submitLabel)}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        `;\r\n        return;\r\n    }\r\n\r\n    const rowsHtml = state.remitos.length\r\n        ? state.remitos\r\n            .map((remito, index) => {\r\n                const numeroRemito = escapeHtml(getDisplayValue(remito.numeroRemito));\r\n                const fecha = escapeHtml(getDisplayValue(remito.fechaRemito));\r\n                const cliente = escapeHtml(getDisplayValue(remito.cliente));\r\n                const numeroReporte = escapeHtml(getDisplayValue(remito.numeroReporte));\r\n                const isDeletingRow = state.isDeleting && state.deletingIndex === index;\r\n\r\n                // Botones de editar/eliminar solo para administradores\r\n                const adminButtons = isAdmin() ? `\r\n                                <button type=\"button\" class=\"text-sm font-semibold text-gray-600 hover:text-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2\" data-remito-edit=\"${index}\">\r\n                                    Editar\r\n                                </button>\r\n                                <button type=\"button\" class=\"text-sm font-semibold text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60\" data-remito-delete=\"${index}\" ${isDeletingRow ? 'disabled' : ''}>\r\n                                    ${isDeletingRow ? 'Eliminando...' : 'Eliminar'}\r\n                                </button>\r\n                ` : '';\r\n\r\n                return `\r\n                    <tr class=\"hover:bg-gray-50\">\r\n                        <td class=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700\">${numeroRemito}</td>\r\n                        <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-600\">${fecha}</td>\r\n                        <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-600\">${cliente}</td>\r\n                        <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-600\">${numeroReporte}</td>\r\n                        <td class=\"px-6 py-4 whitespace-nowrap\">\r\n                            <div class=\"flex items-center justify-end gap-3\">\r\n                                <button type=\"button\" class=\"text-sm font-semibold text-emerald-600 hover:text-emerald-800 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2\" data-remito-pdf=\"${index}\" title=\"Descargar PDF\">\r\n                                    ­ƒôä PDF\r\n                                </button>\r\n                                <button type=\"button\" class=\"text-sm font-semibold text-blue-600 hover:text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2\" data-remito-detalle=\"${index}\">\r\n                                    Ver detalle\r\n                                </button>\r\n                                ${adminButtons}\r\n                            </div>\r\n                        </td>\r\n                    </tr>\r\n                `;\r\n            })\r\n            .join('')\r\n        : `\r\n            <tr>\r\n                <td colspan=\"5\" class=\"px-6 py-10 text-center text-sm text-gray-500\">\r\n                    No hay remitos registrados todav├¡a. Us├í el bot├│n \"Crear nuevo remito\" para cargar uno.\r\n                </td>\r\n            </tr>\r\n        `;\r\n\r\n    const paginationInfo = state.totalPages > 0\r\n        ? `P├ígina ${state.currentPage} de ${state.totalPages}`\r\n        : 'P├ígina 1 de 1';\r\n\r\n    const firstItemIndex = (state.currentPage - 1) * state.pageSize + 1;\r\n    const lastItemIndex = firstItemIndex + state.remitos.length - 1;\r\n    const summaryInfo = state.totalItems > 0\r\n        ? `Mostrando ${firstItemIndex} - ${lastItemIndex} de ${state.totalItems} remitos`\r\n        : 'No hay remitos registrados.';\r\n\r\n    const createDisabledAttr = (state.isLoading || state.isSaving) ? 'disabled' : '';\r\n\r\n    container.innerHTML = `\r\n        <div class=\"space-y-6\">\r\n            ${feedbackHtml ? `<div>${feedbackHtml}</div>` : ''}\r\n            <div class=\"rounded-xl border border-gray-200 bg-white shadow-sm overflow-hidden\">\r\n                <div class=\"flex flex-col gap-3 border-b border-gray-100 px-6 py-4 md:flex-row md:items-center md:justify-between\">\r\n                    <div class=\"flex flex-col\">\r\n                        <h3 class=\"text-lg font-semibold text-gray-800\">Listado de Remitos</h3>\r\n                        <span class=\"text-sm text-gray-500\">${escapeHtml(paginationInfo)}</span>\r\n                    </div>\r\n                    <button type=\"button\" class=\"inline-flex items-center justify-center rounded-lg border border-transparent bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60\" data-remitos-action=\"open-create\" ${createDisabledAttr}>\r\n                        Crear nuevo remito\r\n                    </button>\r\n                </div>\r\n                <div class=\"overflow-x-auto\">\r\n                    <table class=\"min-w-full divide-y divide-gray-200\">\r\n                        <thead class=\"bg-gray-50\">\r\n                            <tr>\r\n                                <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500\">N├║mero de Remito</th>\r\n                                <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500\">Fecha</th>\r\n                                <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500\">Cliente</th>\r\n                                <th scope=\"col\" class=\"px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500\">N├║mero de Reporte</th>\r\n                                <th scope=\"col\" class=\"px-6 py-3 text-right text-xs font-semibold uppercase tracking-wide text-gray-500\">Acciones</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody class=\"divide-y divide-gray-200 bg-white\">\r\n                            ${rowsHtml}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n                <div class=\"flex flex-col gap-3 border-t border-gray-100 px-6 py-4 md:flex-row md:items-center md:justify-between\">\r\n                    <div class=\"text-sm text-gray-500\">${escapeHtml(summaryInfo)}</div>\r\n                    <div class=\"flex items-center gap-3\">\r\n                        <button type=\"button\" class=\"inline-flex items-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60\" data-remitos-action=\"prev\" ${state.currentPage <= 1 ? 'disabled' : ''}>\r\n                            Anterior\r\n                        </button>\r\n                        <button type=\"button\" class=\"inline-flex items-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60\" data-remitos-action=\"next\" ${(state.totalPages === 0 || state.currentPage >= state.totalPages) ? 'disabled' : ''}>\r\n                            Siguiente\r\n                        </button>\r\n                        <button type=\"button\" class=\"inline-flex items-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2\" data-remitos-action=\"reload\">\r\n                            Actualizar\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n}\r\n\r\nfunction showModal(title, contentHtml) {\r\n    const modalId = 'remito-detail-modal';\r\n    let modal = document.getElementById(modalId);\r\n\r\n    if (modal) {\r\n        modal.remove();\r\n    }\r\n\r\n    const modalHtml = `\r\n        <div id=\"${modalId}\" class=\"fixed inset-0 z-50 flex items-center justify-center overflow-y-auto overflow-x-hidden bg-gray-900 bg-opacity-50 p-4 md:inset-0 h-modal md:h-full\">\r\n            <div class=\"relative w-full max-w-2xl h-full md:h-auto\">\r\n                <div class=\"relative bg-white rounded-lg shadow dark:bg-gray-700\">\r\n                    <div class=\"flex items-start justify-between p-4 border-b rounded-t dark:border-gray-600\">\r\n                        <h3 class=\"text-xl font-semibold text-gray-900 dark:text-white\">\r\n                            ${escapeHtml(title)}\r\n                        </h3>\r\n                        <button type=\"button\" class=\"text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white\" onclick=\"document.getElementById('${modalId}').remove()\">\r\n                            <svg aria-hidden=\"true\" class=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\" xmlns=\"http://www.w3.org/2000/svg\"><path fill-rule=\"evenodd\" d=\"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z\" clip-rule=\"evenodd\"></path></svg>\r\n                            <span class=\"sr-only\">Cerrar</span>\r\n                        </button>\r\n                    </div>\r\n                    <div class=\"p-6 space-y-6 max-h-[70vh] overflow-y-auto\">\r\n                        ${contentHtml}\r\n                    </div>\r\n                    <div class=\"flex items-center p-6 space-x-2 border-t border-gray-200 rounded-b dark:border-gray-600\">\r\n                        <button type=\"button\" class=\"text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800\" onclick=\"document.getElementById('${modalId}').remove()\">Cerrar</button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    document.body.insertAdjacentHTML('beforeend', modalHtml);\r\n}\r\n\r\nfunction handleDetalleRemito(index) {\r\n    if (!Array.isArray(state.remitos) || state.remitos.length === 0) {\r\n        return;\r\n    }\r\n\r\n    if (!Number.isFinite(index) || index < 0 || index >= state.remitos.length) {\r\n        return;\r\n    }\r\n\r\n    const remito = state.remitos[index];\r\n    if (!remito) {\r\n        return;\r\n    }\r\n\r\n    const fields = [\r\n        { label: 'N├║mero de Remito', value: remito.numeroRemito },\r\n        { label: 'Fecha del Remito', value: remito.fechaRemito },\r\n        { label: 'Cliente', value: remito.cliente },\r\n        { label: 'N├║mero de Reporte', value: remito.numeroReporte },\r\n        { label: 'Referencia / O.C', value: remito.reporteId },\r\n        { label: 'Fecha del Servicio', value: remito.fechaServicio },\r\n        { label: 'T├®cnico', value: remito.tecnico },\r\n        { label: 'Direcci├│n', value: remito.direccion },\r\n        { label: 'Tel├®fono', value: remito.telefono },\r\n        { label: 'Email', value: remito.email },\r\n        { label: 'Observaciones', value: remito.observaciones },\r\n    ];\r\n\r\n    // Agregar datos del equipo si existen\r\n    if (remito.equipo_descripcion || remito.equipo_modelo) {\r\n        fields.push({ label: 'Equipo', value: `${remito.equipo_descripcion} ${remito.equipo_modelo}` });\r\n        if (remito.equipo_serie) fields.push({ label: 'Serie', value: remito.equipo_serie });\r\n        if (remito.equipo_ubicacion) fields.push({ label: 'Ubicaci├│n', value: remito.equipo_ubicacion });\r\n    }\r\n\r\n    const contentHtml = `\r\n        <dl class=\"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2\">\r\n            ${fields.map(field => {\r\n        const val = getDisplayValue(field.value);\r\n        if (val === '-') return ''; // Omitir campos vac├¡os\r\n        return `\r\n                    <div class=\"sm:col-span-1\">\r\n                        <dt class=\"text-sm font-medium text-gray-500\">${escapeHtml(field.label)}</dt>\r\n                        <dd class=\"mt-1 text-sm text-gray-900\">${escapeHtml(val)}</dd>\r\n                    </div>\r\n                `;\r\n    }).join('')}\r\n        </dl>\r\n        ${remito.repuestos && remito.repuestos.length > 0 ? `\r\n            <div class=\"mt-6\">\r\n                <h4 class=\"text-sm font-medium text-gray-900\">Repuestos</h4>\r\n                <ul class=\"mt-2 border border-gray-200 rounded-md divide-y divide-gray-200\">\r\n                    ${remito.repuestos.map(r => `\r\n                        <li class=\"pl-3 pr-4 py-3 flex items-center justify-between text-sm\">\r\n                            <div class=\"w-0 flex-1 flex items-center\">\r\n                                <span class=\"ml-2 flex-1 w-0 truncate\">${escapeHtml(r.descripcion || r.Descripcion)} (${escapeHtml(r.codigo || r.Codigo || '-')})</span>\r\n                            </div>\r\n                            <div class=\"ml-4 flex-shrink-0\">\r\n                                <span class=\"font-medium text-gray-900\">Cant: ${r.cantidad || r.Cantidad}</span>\r\n                            </div>\r\n                        </li>\r\n                    `).join('')}\r\n                </ul>\r\n            </div>\r\n        ` : ''}\r\n    `;\r\n\r\n    showModal(`Detalle del Remito ${getDisplayValue(remito.numeroRemito)}`, contentHtml);\r\n}\r\n\r\nfunction handleEditRemito(index) {\r\n    if (!Array.isArray(state.remitos) || state.remitos.length === 0) {\r\n        return;\r\n    }\r\n\r\n    if (!Number.isFinite(index) || index < 0 || index >= state.remitos.length) {\r\n        return;\r\n    }\r\n\r\n    const remito = state.remitos[index];\r\n    if (!remito) {\r\n        return;\r\n    }\r\n\r\n    state.formMode = 'edit';\r\n    state.formData = mapRemitoToFormData(remito);\r\n    ensurePhotoSlotsInFormData();\r\n    state.editingRemitoId = getRemitoIdentifier(remito);\r\n    state.editingRemitoLabel = sanitizeString(remito.numeroRemito) || sanitizeString(remito.reporteId);\r\n    state.editingRemitoOriginal = remito;\r\n    syncSelectedClienteFromForm();\r\n    state.viewMode = 'form';\r\n\r\n    renderManagementView();\r\n    void ensureClientesLoaded({ reRender: true });\r\n}\r\n\r\nasync function handleDeleteRemito(index) {\r\n    if (state.isDeleting || state.isSaving) {\r\n        return;\r\n    }\r\n\r\n    if (!Array.isArray(state.remitos) || index < 0 || index >= state.remitos.length) {\r\n        return;\r\n    }\r\n\r\n    const remito = state.remitos[index];\r\n    if (!remito) {\r\n        return;\r\n    }\r\n\r\n    const identifier = getRemitoIdentifier(remito);\r\n    if (!identifier) {\r\n        setFeedback('error', 'No se pudo determinar el remito a eliminar.');\r\n        renderManagementView();\r\n        return;\r\n    }\r\n\r\n    if (typeof window !== 'undefined' && typeof window.confirm === 'function') {\r\n        const confirmed = window.confirm(`┬┐Seguro que quer├®s eliminar el remito ${remito.numeroRemito || identifier}?`);\r\n        if (!confirmed) {\r\n            return;\r\n        }\r\n    }\r\n\r\n    state.isDeleting = true;\r\n    state.deletingIndex = index;\r\n    renderManagementView();\r\n\r\n    try {\r\n        await dependencies.eliminarRemito({\r\n            remitoId: identifier,\r\n            numeroRemito: remito.numeroRemito,\r\n            reporteId: remito.reporteId,\r\n        });\r\n\r\n        setFeedback('success', 'El remito se elimin├│ correctamente.');\r\n\r\n        const wasEditingDeleted = state.formMode === 'edit'\r\n            && identifier === state.editingRemitoId;\r\n        if (wasEditingDeleted) {\r\n            resetFormState();\r\n        }\r\n\r\n        state.isDeleting = false;\r\n        state.deletingIndex = null;\r\n\r\n        const remainingItems = state.remitos.length - 1;\r\n        const targetPage = remainingItems === 0 && state.currentPage > 1\r\n            ? state.currentPage - 1\r\n            : state.currentPage;\r\n\r\n        await renderListado({ page: targetPage });\r\n    } catch (error) {\r\n        state.isDeleting = false;\r\n        state.deletingIndex = null;\r\n        setFeedback('error', error?.message || 'No se pudo eliminar el remito.');\r\n        renderManagementView();\r\n    }\r\n}\r\n\r\n/**\r\n * Agrega un nuevo repuesto vac├¡o a la lista\r\n */\r\nfunction handleAgregarRepuesto() {\r\n    if (!Array.isArray(state.formData.repuestos)) {\r\n        state.formData.repuestos = [];\r\n    }\r\n\r\n    // Recolectar valores actuales del formulario antes de agregar\r\n    collectRepuestosFromForm();\r\n\r\n    state.formData.repuestos.push({\r\n        codigo: '',\r\n        descripcion: '',\r\n        cantidad: '1'\r\n    });\r\n\r\n    renderManagementView();\r\n\r\n    // Focus en el campo c├│digo del nuevo repuesto\r\n    setTimeout(() => {\r\n        const lastIndex = state.formData.repuestos.length - 1;\r\n        const codigoInput = document.querySelector(`tr[data-repuesto-index=\"${lastIndex}\"] input[data-repuesto-field=\"codigo\"]`);\r\n        if (codigoInput) {\r\n            codigoInput.focus();\r\n        }\r\n    }, 50);\r\n}\r\n\r\n/**\r\n * Elimina un repuesto de la lista\r\n */\r\nfunction handleRemoveRepuesto(index) {\r\n    if (!Array.isArray(state.formData.repuestos)) {\r\n        return;\r\n    }\r\n\r\n    // Recolectar valores actuales antes de eliminar\r\n    collectRepuestosFromForm();\r\n\r\n    if (index >= 0 && index < state.formData.repuestos.length) {\r\n        state.formData.repuestos.splice(index, 1);\r\n        renderManagementView();\r\n    }\r\n}\r\n\r\n/**\r\n * Recolecta los valores de repuestos desde el formulario DOM\r\n */\r\nfunction collectRepuestosFromForm() {\r\n    const container = getContainerElement();\r\n    if (!container) return [];\r\n\r\n    const rows = container.querySelectorAll('#remitos-gestion-repuestos-body tr[data-repuesto-index]');\r\n    const repuestos = [];\r\n\r\n    rows.forEach((row) => {\r\n        const codigo = row.querySelector('input[data-repuesto-field=\"codigo\"]')?.value || '';\r\n        const descripcion = row.querySelector('input[data-repuesto-field=\"descripcion\"]')?.value || '';\r\n        const cantidad = row.querySelector('input[data-repuesto-field=\"cantidad\"]')?.value || '1';\r\n\r\n        repuestos.push({ codigo, descripcion, cantidad });\r\n    });\r\n\r\n    state.formData.repuestos = repuestos;\r\n    return repuestos;\r\n}\r\n\r\n/**\r\n * Descarga el PDF guardado del remito.\r\n * Si no hay PDF guardado (remitos antiguos), muestra un mensaje informativo.\r\n */\r\nasync function handleDescargarPdfRemito(index) {\r\n    console.log('[PDF Debug] handleDescargarPdfRemito llamado con index:', index);\r\n\r\n    if (!Array.isArray(state.remitos) || index < 0 || index >= state.remitos.length) {\r\n        console.log('[PDF Debug] Index inv├ílido o remitos vac├¡o');\r\n        return;\r\n    }\r\n\r\n    const remito = state.remitos[index];\r\n    console.log('[PDF Debug] Remito encontrado:', {\r\n        numeroRemito: remito?.numeroRemito,\r\n        pdf_path: remito?.pdf_path,\r\n        id: remito?.id,\r\n    });\r\n\r\n    if (!remito) {\r\n        console.log('[PDF Debug] Remito es null/undefined');\r\n        return;\r\n    }\r\n\r\n    // Solo intentar descargar si hay PDF guardado (Snapshot Inmutable)\r\n    if (remito.pdf_path) {\r\n        console.log('[PDF Debug] Tiene pdf_path, intentando obtener URL firmada...');\r\n        try {\r\n            const obtenerUrlPdfRemito = dependencies.obtenerUrlPdfRemito;\r\n            console.log('[PDF Debug] obtenerUrlPdfRemito disponible:', typeof obtenerUrlPdfRemito === 'function');\r\n\r\n            if (typeof obtenerUrlPdfRemito === 'function') {\r\n                const url = await obtenerUrlPdfRemito(remito.pdf_path);\r\n                console.log('[PDF Debug] URL obtenida:', url ? 'S├ì (abriendo...)' : 'NO (null)');\r\n\r\n                if (url) {\r\n                    // Abrir el PDF guardado directamente\r\n                    window.open(url, '_blank');\r\n                    return;\r\n                } else {\r\n                    console.warn('[PDF Debug] obtenerUrlPdfRemito retorn├│ null para path:', remito.pdf_path);\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.warn('[PDF Debug] Error obteniendo URL del PDF guardado:', error);\r\n            setFeedback('error', 'No se pudo obtener el PDF. Intent├í nuevamente.');\r\n            renderManagementView();\r\n            return;\r\n        }\r\n    } else {\r\n        console.log('[PDF Debug] Remito NO tiene pdf_path');\r\n    }\r\n\r\n    // Si no hay PDF guardado, mostrar mensaje informativo\r\n    // Los remitos nuevos siempre tendr├ín PDF guardado\r\n    console.log('[PDF Debug] Mostrando warning - sin PDF guardado');\r\n    setFeedback('warning', `El remito ${remito.numeroRemito || ''} no tiene PDF guardado. Solo los remitos generados a partir de ahora tendr├ín PDF disponible.`);\r\n    renderManagementView();\r\n}\r\n\r\nasync function handlePhotoFileSelection(index, file) {\r\n    if (state.isSaving || state.isLoading) {\r\n        return;\r\n    }\r\n\r\n    const normalizedIndex = Number(index);\r\n    if (!Number.isFinite(normalizedIndex) || normalizedIndex < 0 || normalizedIndex >= MAX_REMITO_PHOTOS) {\r\n        return;\r\n    }\r\n\r\n    if (!file) {\r\n        return;\r\n    }\r\n\r\n    if (!file.type || !file.type.startsWith('image/')) {\r\n        setFeedback('error', 'Solo se pueden cargar archivos de imagen.');\r\n        renderManagementView();\r\n        return;\r\n    }\r\n\r\n    if (file.size && file.size > MAX_PHOTO_SIZE_BYTES) {\r\n        setFeedback('error', 'La foto supera el l├¡mite de 5 MB permitido.');\r\n        renderManagementView();\r\n        return;\r\n    }\r\n\r\n    if (!isFileReaderSupported()) {\r\n        setFeedback('error', 'El navegador no permite procesar im├ígenes desde este formulario.');\r\n        renderManagementView();\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const dataUrl = await readFileAsDataUrl(file);\r\n        const base64Data = extractBase64FromDataUrl(dataUrl);\r\n        const mimeType = sanitizeString(file.type) || 'image/jpeg';\r\n        const numeroRemito = sanitizeString(state.formData?.numeroRemito) || 'remito';\r\n        const fileName = sanitizePhotoFileName(file.name, numeroRemito, normalizedIndex, mimeType);\r\n\r\n        ensurePhotoSlotsInFormData();\r\n        const slots = normalizePhotoSlots(state.formData.fotos);\r\n        slots[normalizedIndex] = {\r\n            index: normalizedIndex,\r\n            previewUrl: typeof dataUrl === 'string' ? dataUrl : '',\r\n            base64Data,\r\n            mimeType,\r\n            fileName,\r\n            url: '',\r\n            driveId: '',\r\n            shouldRemove: false,\r\n        };\r\n        state.formData.fotos = slots;\r\n        setFeedback(null);\r\n        renderManagementView();\r\n    } catch (error) {\r\n        setFeedback('error', error?.message || 'No se pudo procesar la foto seleccionada.');\r\n        renderManagementView();\r\n    }\r\n}\r\n\r\nfunction removePhotoSlot(index) {\r\n    const normalizedIndex = Number(index);\r\n    if (!Number.isFinite(normalizedIndex) || normalizedIndex < 0 || normalizedIndex >= MAX_REMITO_PHOTOS) {\r\n        return;\r\n    }\r\n\r\n    closeAllPhotoMenus();\r\n    ensurePhotoSlotsInFormData();\r\n    const slots = normalizePhotoSlots(state.formData.fotos);\r\n    const previous = slots[normalizedIndex];\r\n    const hadExistingUrl = Boolean(previous?.url);\r\n    slots[normalizedIndex] = {\r\n        ...createEmptyPhotoSlot(normalizedIndex),\r\n        shouldRemove: hadExistingUrl,\r\n    };\r\n    state.formData.fotos = slots;\r\n    renderManagementView();\r\n}\r\n\r\nfunction handlePhotoAction(action, index) {\r\n    if (!action) {\r\n        return;\r\n    }\r\n\r\n    const normalizedIndex = Number(index);\r\n    if (!Number.isFinite(normalizedIndex) || normalizedIndex < 0 || normalizedIndex >= MAX_REMITO_PHOTOS) {\r\n        return;\r\n    }\r\n\r\n    if (action === 'remove') {\r\n        removePhotoSlot(normalizedIndex);\r\n        return;\r\n    }\r\n\r\n    if (state.isSaving || state.isLoading) {\r\n        return;\r\n    }\r\n\r\n    if (typeof document === 'undefined') {\r\n        return;\r\n    }\r\n\r\n    const container = getContainerElement();\r\n    if (!container) {\r\n        return;\r\n    }\r\n\r\n    closeAllPhotoMenus();\r\n    const selector = `[data-remito-photo-input=\"${action}\"][data-remito-photo-index=\"${normalizedIndex}\"]`;\r\n    const input = container.querySelector(selector);\r\n    if (input) {\r\n        input.value = '';\r\n        input.click();\r\n    }\r\n}\r\n\r\nfunction handleFormInput(event) {\r\n    const field = event?.target?.dataset?.remitoField;\r\n    if (!field || !(field in state.formData)) {\r\n        return;\r\n    }\r\n\r\n    state.formData[field] = event.target.value;\r\n}\r\n\r\nfunction handleContainerInput(event) {\r\n    const target = event?.target;\r\n\r\n    // B├║squeda inteligente de cliente\r\n    if (target && target.id === 'remito-form-cliente') {\r\n        const searchText = (target.value || '').toLowerCase().trim();\r\n        const dropdown = document.getElementById('remito-form-cliente-dropdown');\r\n\r\n        if (!dropdown) {\r\n            handleFormInput(event);\r\n            return;\r\n        }\r\n\r\n        // Si el texto est├í vac├¡o o muy corto, ocultar dropdown\r\n        if (searchText.length < 2) {\r\n            dropdown.classList.add('hidden');\r\n            dropdown.innerHTML = '';\r\n            // Si se borr├│ el texto, limpiar selecci├│n\r\n            if (searchText.length === 0 && state.selectedClienteKey) {\r\n                state.selectedClienteKey = '';\r\n                state.equiposCliente = [];\r\n                state.selectedEquipoId = '';\r\n            }\r\n            handleFormInput(event);\r\n            return;\r\n        }\r\n\r\n        // Filtrar clientes\r\n        const filtered = (state.clienteOptions || [])\r\n            .filter(option => {\r\n                const label = (option.label || option.nombre || '').toLowerCase();\r\n                return label.includes(searchText);\r\n            })\r\n            .slice(0, 5); // Limitar a 5 resultados\r\n\r\n        if (filtered.length === 0) {\r\n            dropdown.innerHTML = '<div class=\"px-4 py-3 text-sm text-gray-500\">No se encontraron clientes</div>';\r\n            dropdown.classList.remove('hidden');\r\n        } else {\r\n            dropdown.innerHTML = filtered.map(option => `\r\n                <div class=\"remito-cliente-option px-4 py-2.5 cursor-pointer hover:bg-blue-50 transition-colors text-sm border-b border-gray-100 last:border-b-0\" \r\n                     data-cliente-key=\"${option.key}\">\r\n                    <div class=\"font-medium text-gray-800\">${escapeHtml(option.label || option.nombre)}</div>\r\n                    ${option.direccion ? `<div class=\"text-xs text-gray-500 mt-0.5\">${escapeHtml(option.direccion)}</div>` : ''}\r\n                </div>\r\n            `).join('');\r\n            dropdown.classList.remove('hidden');\r\n        }\r\n\r\n        handleFormInput(event);\r\n        return;\r\n    }\r\n\r\n    handleFormInput(event);\r\n}\r\n\r\nfunction handleContainerChange(event) {\r\n    const target = event?.target;\r\n    if (!target) {\r\n        return;\r\n    }\r\n\r\n    const photoInputMode = target.dataset?.remitoPhotoInput;\r\n    if (photoInputMode) {\r\n        const index = Number.parseInt(target.dataset.remitoPhotoIndex ?? '', 10);\r\n        const file = target.files && target.files[0];\r\n        if (Number.isFinite(index) && index >= 0 && index < MAX_REMITO_PHOTOS && file) {\r\n            void handlePhotoFileSelection(index, file);\r\n        }\r\n\r\n        target.value = '';\r\n        return;\r\n    }\r\n\r\n    if (target.id === 'remito-form-equipo-select') {\r\n        const value = typeof target.value === 'string' ? target.value : '';\r\n        applyEquipoSelection(value);\r\n        renderManagementView();\r\n        return;\r\n    }\r\n\r\n    handleFormInput(event);\r\n}\r\n\r\nasync function handleFormSubmit() {\r\n    if (state.isSaving || state.isLoading) {\r\n        return;\r\n    }\r\n\r\n    // Recolectar repuestos del formulario antes de validar\r\n    collectRepuestosFromForm();\r\n\r\n    const errors = validateFormData(state.formData);\r\n    if (errors.length > 0) {\r\n        setFeedback('error', errors.join(' '));\r\n        renderManagementView();\r\n        return;\r\n    }\r\n\r\n    const payload = buildPayloadFromForm(state.formData);\r\n    const targetPage = state.currentPage || 1;\r\n    const wasEditMode = state.formMode === 'edit';\r\n\r\n    state.isSaving = true;\r\n    renderManagementView();\r\n\r\n    try {\r\n        if (wasEditMode) {\r\n            const remitoId = state.editingRemitoId\r\n                || getRemitoIdentifier(state.editingRemitoOriginal)\r\n                || sanitizeString(state.formData.reporteId)\r\n                || sanitizeString(state.formData.numeroRemito);\r\n\r\n            if (!remitoId) {\r\n                throw new Error('No se pudo determinar el remito a actualizar.');\r\n            }\r\n\r\n            await dependencies.actualizarRemito({\r\n                ...payload,\r\n                remitoId,\r\n            });\r\n            setFeedback('success', 'El remito se actualiz├│ correctamente.');\r\n        } else {\r\n            const requestPayload = buildCreateRemitoRequest(payload);\r\n            const response = await dependencies.crearRemito(requestPayload);\r\n            const nuevoNumero = sanitizeString(response?.NumeroRemito || response?.numeroRemito || response?.data?.NumeroRemito || response?.data?.numeroRemito);\r\n            setFeedback(\r\n                'success',\r\n                nuevoNumero\r\n                    ? `El remito ${nuevoNumero} se cre├│ correctamente.`\r\n                    : 'El remito se cre├│ correctamente.',\r\n            );\r\n\r\n            // Generar y guardar PDF para remitos creados manualmente\r\n            try {\r\n                const remitoId = sanitizeString(response?.data?.id || response?.id);\r\n                if (remitoId) {\r\n                    const reporteData = requestPayload?.reporteData || {};\r\n                    const printableReport = { ...reporteData, NumeroRemito: nuevoNumero };\r\n                    const photoSlots = normalizePhotoSlots(state.formData?.fotos || []);\r\n\r\n                    const printableData = buildPrintableRemitoData(printableReport, {\r\n                        observaciones: sanitizeString(payload?.observaciones || state.formData?.observaciones || ''),\r\n                        repuestos: Array.isArray(state.formData?.repuestos) ? state.formData.repuestos : [],\r\n                        photoSlots,\r\n                    });\r\n\r\n                    const html = createRemitoPrintHtml(printableData);\r\n                    if (html) {\r\n                        const blob = await generatePdfBlob(html);\r\n                        if (blob) {\r\n                            await dependencies.guardarPdfRemito(remitoId, blob, nuevoNumero);\r\n                        }\r\n                    }\r\n                }\r\n            } catch (pdfErr) {\r\n                console.warn('No se pudo generar/guardar el PDF del remito manual:', pdfErr);\r\n            }\r\n        }\r\n\r\n        resetFormState();\r\n        state.isSaving = false;\r\n        await renderListado({ page: targetPage });\r\n    } catch (error) {\r\n        state.isSaving = false;\r\n        setFeedback('error', error?.message || 'No se pudo guardar el remito.');\r\n        renderManagementView();\r\n    }\r\n}\r\n\r\nfunction handleContainerSubmit(event) {\r\n    if (event.target && event.target.id === 'remito-abm-form') {\r\n        event.preventDefault();\r\n        void handleFormSubmit();\r\n    }\r\n}\r\n\r\nfunction handleAction(action) {\r\n    if (!action || state.isLoading) {\r\n        return;\r\n    }\r\n\r\n    if (action === 'prev') {\r\n        if (state.currentPage > 1) {\r\n            void renderListado({ page: state.currentPage - 1 });\r\n        }\r\n        return;\r\n    }\r\n\r\n    if (action === 'next') {\r\n        if (state.totalPages > 0 && state.currentPage < state.totalPages) {\r\n            void renderListado({ page: state.currentPage + 1 });\r\n        }\r\n        return;\r\n    }\r\n\r\n    if (action === 'reload') {\r\n        const targetPage = state.currentPage && state.currentPage > 0 ? state.currentPage : 1;\r\n        void renderListado({ page: targetPage });\r\n        return;\r\n    }\r\n\r\n    if (action === 'open-create') {\r\n        resetFormState({ viewMode: 'form' });\r\n        renderManagementView();\r\n        void ensureClientesLoaded({ reRender: true });\r\n        return;\r\n    }\r\n\r\n    if (action === 'back-to-list') {\r\n        resetFormState({ viewMode: 'list' });\r\n        renderManagementView();\r\n        return;\r\n    }\r\n\r\n    if (action === 'cancel-edit') {\r\n        resetFormState({ viewMode: 'form' });\r\n        renderManagementView();\r\n        return;\r\n    }\r\n}\r\n\r\nfunction handleContainerClick(event) {\r\n    // Verificar si el click es en un trigger de foto PRIMERO\r\n    const photoTrigger = event.target.closest('[data-remito-photo-trigger]');\r\n    if (photoTrigger) {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        togglePhotoMenu(photoTrigger.dataset.remitoPhotoIndex);\r\n        return;\r\n    }\r\n\r\n    // Si el click no est├í dentro del men├║ ni en el trigger, cerrar men├║s\r\n    const clickedInsidePhotoMenu = Boolean(event.target.closest('[data-remito-photo-menu]'));\r\n    if (!clickedInsidePhotoMenu) {\r\n        closeAllPhotoMenus();\r\n    }\r\n\r\n    const photoMenuDismiss = event.target.closest('[data-remito-photo-menu-dismiss]');\r\n    if (photoMenuDismiss) {\r\n        event.preventDefault();\r\n        closeAllPhotoMenus();\r\n        return;\r\n    }\r\n\r\n    // Selecci├│n de cliente desde dropdown\r\n    const clienteOption = event.target.closest('.remito-cliente-option');\r\n    if (clienteOption) {\r\n        event.preventDefault();\r\n        const key = clienteOption.dataset.clienteKey;\r\n        if (key) {\r\n            void applyClienteSelection(key);\r\n            // Ocultar dropdown\r\n            const dropdown = document.getElementById('remito-form-cliente-dropdown');\r\n            if (dropdown) {\r\n                dropdown.classList.add('hidden');\r\n                dropdown.innerHTML = '';\r\n            }\r\n        }\r\n        return;\r\n    }\r\n\r\n    // Bot├│n limpiar cliente\r\n    if (event.target.id === 'remito-form-cliente-clear' || event.target.closest('#remito-form-cliente-clear')) {\r\n        event.preventDefault();\r\n        void applyClienteSelection('');\r\n        return;\r\n    }\r\n\r\n    const actionButton = event.target.closest('[data-remitos-action]');\r\n    if (actionButton) {\r\n        event.preventDefault();\r\n        handleAction(actionButton.dataset.remitosAction);\r\n        return;\r\n    }\r\n\r\n    const photoButton = event.target.closest('[data-remito-photo-action]');\r\n    if (photoButton) {\r\n        event.preventDefault();\r\n        handlePhotoAction(photoButton.dataset.remitoPhotoAction, photoButton.dataset.remitoPhotoIndex);\r\n        return;\r\n    }\r\n\r\n    const detalleButton = event.target.closest('[data-remito-detalle]');\r\n    if (detalleButton) {\r\n        event.preventDefault();\r\n        const index = Number.parseInt(detalleButton.dataset.remitoDetalle, 10);\r\n        if (Number.isFinite(index)) {\r\n            handleDetalleRemito(index);\r\n        }\r\n        return;\r\n    }\r\n\r\n    const editButton = event.target.closest('[data-remito-edit]');\r\n    if (editButton) {\r\n        event.preventDefault();\r\n        const index = Number.parseInt(editButton.dataset.remitoEdit, 10);\r\n        if (Number.isFinite(index)) {\r\n            handleEditRemito(index);\r\n        }\r\n        return;\r\n    }\r\n\r\n    const deleteButton = event.target.closest('[data-remito-delete]');\r\n    if (deleteButton) {\r\n        event.preventDefault();\r\n        const index = Number.parseInt(deleteButton.dataset.remitoDelete, 10);\r\n        if (Number.isFinite(index)) {\r\n            void handleDeleteRemito(index);\r\n        }\r\n        return;\r\n    }\r\n\r\n    const pdfButton = event.target.closest('[data-remito-pdf]');\r\n    if (pdfButton) {\r\n        event.preventDefault();\r\n        const index = Number.parseInt(pdfButton.dataset.remitoPdf, 10);\r\n        if (Number.isFinite(index)) {\r\n            handleDescargarPdfRemito(index);\r\n        }\r\n        return;\r\n    }\r\n\r\n    // Agregar repuesto\r\n    if (event.target.id === 'remitos-gestion-agregar-repuesto' || event.target.closest('#remitos-gestion-agregar-repuesto')) {\r\n        event.preventDefault();\r\n        handleAgregarRepuesto();\r\n        return;\r\n    }\r\n\r\n    // Eliminar repuesto\r\n    const removeRepuestoBtn = event.target.closest('[data-repuesto-remove]');\r\n    if (removeRepuestoBtn) {\r\n        event.preventDefault();\r\n        const index = Number.parseInt(removeRepuestoBtn.dataset.repuestoRemove, 10);\r\n        if (Number.isFinite(index)) {\r\n            handleRemoveRepuesto(index);\r\n        }\r\n        return;\r\n    }\r\n}\r\n\r\nasync function renderListado({ page } = {}) {\r\n    const requestedPage = Number.isFinite(Number(page)) && Number(page) > 0\r\n        ? Math.floor(Number(page))\r\n        : (state.currentPage && state.currentPage > 0 ? state.currentPage : 1);\r\n\r\n    state.isLoading = true;\r\n    state.lastError = null;\r\n    showLoadingState();\r\n\r\n    try {\r\n        const data = await dependencies.obtenerRemitos({ page: requestedPage, pageSize: state.pageSize });\r\n\r\n        const remitos = Array.isArray(data?.remitos) ? data.remitos : [];\r\n        state.remitos = remitos.map((item) => normalizeRemitoForDisplay(item));\r\n\r\n        const totalPages = Number(data?.totalPages);\r\n        state.totalPages = Number.isFinite(totalPages) && totalPages >= 0 ? totalPages : 0;\r\n\r\n        const totalItems = Number(data?.totalItems);\r\n        state.totalItems = Number.isFinite(totalItems) && totalItems >= 0 ? totalItems : state.remitos.length;\r\n\r\n        const reportedPageSize = Number(data?.pageSize);\r\n        if (Number.isFinite(reportedPageSize) && reportedPageSize > 0) {\r\n            state.pageSize = Math.floor(reportedPageSize);\r\n        }\r\n\r\n        let currentPage = Number(data?.currentPage);\r\n        if (!Number.isFinite(currentPage) || currentPage <= 0) {\r\n            currentPage = state.totalPages > 0 ? 1 : 0;\r\n        }\r\n        state.currentPage = currentPage || requestedPage;\r\n\r\n        state.isLoading = false;\r\n        renderManagementView();\r\n    } catch (error) {\r\n        state.lastError = error;\r\n        const message = error?.message || 'No se pudieron obtener los remitos.';\r\n        state.isLoading = false;\r\n        showErrorState(message);\r\n    } finally {\r\n        state.isLoading = false;\r\n    }\r\n}\r\n\r\nexport function createRemitosGestionModule(overrides = {}) {\r\n    setDependencies(overrides);\r\n    let initialized = false;\r\n\r\n    function initialize() {\r\n        if (initialized) {\r\n            return;\r\n        }\r\n\r\n        const container = getContainerElement();\r\n        if (!container) {\r\n            console.warn('No se encontr├│ el contenedor de gesti├│n de remitos.');\r\n            return;\r\n        }\r\n\r\n        container.addEventListener('click', handleContainerClick);\r\n        container.addEventListener('input', handleContainerInput);\r\n        container.addEventListener('change', handleContainerChange);\r\n        container.addEventListener('submit', handleContainerSubmit);\r\n        initialized = true;\r\n    }\r\n\r\n    return {\r\n        initialize,\r\n        renderListado,\r\n    };\r\n}\r\n\r\nexport const __testables__ = {\r\n    sanitizeString,\r\n    formatIsoToDisplay,\r\n    formatDateValue,\r\n    escapeHtml,\r\n    normalizeRemitoForDisplay,\r\n    mapRemitoToFormData,\r\n    buildPayloadFromForm,\r\n    buildReporteDataFromPayload,\r\n    buildCreateRemitoRequest,\r\n    handleFormSubmit,\r\n    state,\r\n};\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\remitos-gestion\\remitos-gestion.test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\signature\\signaturePad.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\modules\\theme\\theme.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\search.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\supabaseClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\templates.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\Nicolas Pingitzer\\reportesOBM\\frontend\\js\\viewManager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]}]

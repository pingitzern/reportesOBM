(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const ve={},Q=typeof window<"u"?window.__APP_CONFIG__:void 0,Qe=Q&&typeof Q.API_URL=="string"?Q.API_URL.trim():"";let D=Qe;if(!D){const e=typeof import.meta<"u"&&import.meta&&typeof ve=="object"?ve:void 0;e&&typeof e.VITE_API_URL=="string"&&(D=e.VITE_API_URL.trim())}const V=typeof globalThis<"u"&&typeof globalThis.process=="object"?globalThis.process:void 0;!D&&V&&V.env&&typeof V.env.API_URL=="string"&&(D=V.env.API_URL);D||console.warn("[config] API_URL no está configurada. Define window.__APP_CONFIG__.API_URL o la variable de entorno VITE_API_URL/API_URL.");const b=D,et=60,tt=60*24/3.78541,J="reportesOBM.user";let y=null,Le=!1,I=null,x=!1,K=!1;function le(){return typeof window<"u"&&window.localStorage?window.localStorage:typeof globalThis<"u"&&globalThis.localStorage?globalThis.localStorage:null}function nt(e){if(!e||typeof e!="object")return null;const t=typeof e.nombre=="string"?e.nombre.trim():typeof e.Nombre=="string"?e.Nombre.trim():"",n=typeof e.cargo=="string"?e.cargo.trim():typeof e.Cargo=="string"?e.Cargo.trim():"",o=typeof e.rol=="string"?e.rol.trim():typeof e.Rol=="string"?e.Rol.trim():"";return!t||!o?null:{nombre:t,cargo:n,rol:o}}function ot(e){return typeof e=="string"?e.trim():""}function it(e){if(e==null)return{value:null,valid:!0};if(e instanceof Date)return Number.isNaN(e.getTime())?{value:null,valid:!1}:{value:e.toISOString(),valid:!0};if(typeof e=="number"){if(!Number.isFinite(e))return{value:null,valid:!1};const t=new Date(e);return Number.isNaN(t.getTime())?{value:null,valid:!1}:{value:t.toISOString(),valid:!0}}if(typeof e=="string"){const t=e.trim();return t?{value:t,valid:!0}:{value:null,valid:!0}}return{value:null,valid:!1}}function Pe(e,t){if(!e)return!1;if(!t)return!0;const n=new Date(t);return Number.isNaN(n.getTime())?!1:n.getTime()>Date.now()}function de({user:e,token:t,expiresAt:n}){const o=nt(e),i=ot(t),{value:r,valid:a}=it(n);return!o||!i||!a||!Pe(i,r)?null:{user:o,token:i,expiresAt:r}}function ue(){if(y&&Pe(y.token,y.expiresAt))return y;y=null;const e=le();if(!e)return null;const t=e.getItem(J);if(!t)return null;try{const n=JSON.parse(t),o=de({user:(n==null?void 0:n.user)??(n==null?void 0:n.usuario)??n,token:n==null?void 0:n.token,expiresAt:n==null?void 0:n.expiresAt});if(o)return y=o,y}catch(n){return console.warn("[auth] No se pudo leer la sesión almacenada:",n),null}return e.removeItem(J),null}function rt(e){const t=de({user:(e==null?void 0:e.user)??(e==null?void 0:e.usuario),token:e==null?void 0:e.token,expiresAt:e==null?void 0:e.expiresAt});if(!t)throw new Error("Los datos de sesión son inválidos.");y=t;const n=le();n&&n.setItem(J,JSON.stringify(t)),X(t.user)}function Ce(){y=null;const e=le();e&&e.removeItem(J),X(null)}function h(){if(typeof document>"u")return{};const e=document.getElementById("auth-user-panel"),t=document.getElementById("user-menu");let n=null,o=null,i=null;if(t&&typeof t.querySelector=="function"&&(n=t.querySelector("[data-user-name]")||t.querySelector(".user-menu__user-name")||null,o=t.querySelector('[data-auth-action="help"]'),i=t.querySelector('[data-auth-action="settings"]')),t&&typeof t.querySelectorAll=="function"){const r=c=>typeof c=="string"?c.trim().toLowerCase():"",a=Array.from(t.querySelectorAll('[role="menuitem"]')||[]);o||(o=a.find(c=>r(c==null?void 0:c.textContent)==="ayuda")||null),i||(i=a.find(c=>r(c==null?void 0:c.textContent)==="configuración")||null),n||(n=a.find(c=>{var l;return(l=c==null?void 0:c.dataset)==null?void 0:l.userName})||null)}return{mainView:document.getElementById("main-view"),loginContainer:document.getElementById("login-container"),form:document.getElementById("login-form"),error:document.getElementById("login-error"),mailInput:document.getElementById("login-mail"),passwordInput:document.getElementById("login-password"),logoutButton:document.getElementById("logout-button"),panel:e,menuButton:document.getElementById("user-menu-toggle"),menu:t,helpLink:o,settingsLink:i,userNameDisplay:n}}function ie(){const{loginContainer:e,error:t,mailInput:n}=h();e&&e.classList.remove("hidden"),t&&(t.textContent="",t.classList.add("hidden")),n&&n.focus()}function Me(){const{loginContainer:e,form:t,error:n}=h();e&&e.classList.add("hidden"),t&&t.reset(),n&&(n.textContent="",n.classList.add("hidden"))}function Y(e){const{mainView:t,loginContainer:n}=h();t&&(e?t.classList.remove("hidden"):t.classList.add("hidden")),n&&(e?n.classList.add("hidden"):n.classList.remove("hidden"))}function Ae(e,t){if(!e)return;e.querySelectorAll("input").forEach(i=>{i.disabled=t});const o=e.querySelector('button[type="submit"]');o&&(t?(o.dataset.originalText=o.textContent,o.textContent="Ingresando...",o.disabled=!0):(o.textContent=o.dataset.originalText||"Iniciar sesión",o.disabled=!1,delete o.dataset.originalText))}function re(e){const{error:t}=h();t&&(t.textContent=e,t.classList.remove("hidden"))}function at(e,...t){return e?t.some(n=>{if(!n)return!1;if(e===n)return!0;if(typeof n.contains=="function")try{return n.contains(e)}catch{return!1}return!1}):!1}function ct(){K||typeof document>"u"||typeof document.addEventListener!="function"||(document.addEventListener("click",ze),document.addEventListener("keydown",Be),K=!0)}function st(){!K||typeof document>"u"||typeof document.removeEventListener!="function"||(document.removeEventListener("click",ze),document.removeEventListener("keydown",Be),K=!1)}function lt(){var n;const{menuButton:e,menu:t}=h();!e||e.disabled||!t||((n=t.classList)!=null&&n.remove&&t.classList.remove("hidden"),typeof t.setAttribute=="function"&&t.setAttribute("aria-hidden","false"),typeof e.setAttribute=="function"&&e.setAttribute("aria-expanded","true"),x=!0,ct())}function F(e={}){var i;const{focusButton:t=!1}=e,{menuButton:n,menu:o}=h();x=!1,(i=o==null?void 0:o.classList)!=null&&i.add&&o.classList.add("hidden"),typeof(o==null?void 0:o.setAttribute)=="function"&&o.setAttribute("aria-hidden","true"),typeof(n==null?void 0:n.setAttribute)=="function"&&n.setAttribute("aria-expanded","false"),st(),t&&typeof(n==null?void 0:n.focus)=="function"&&n.focus()}function ze(e){if(!x)return;const{panel:t,menuButton:n,menu:o}=h();at(e==null?void 0:e.target,t,n,o)||F()}function Be(e){if(!x)return;const t=(e==null?void 0:e.key)||(e==null?void 0:e.code);(t==="Escape"||t==="Esc")&&F({focusButton:!0})}function dt(e){var n,o;e&&((n=e.preventDefault)==null||n.call(e),(o=e.stopPropagation)==null||o.call(e));const{menuButton:t}=h();!t||t.disabled||(x?F():lt())}function ut(e){if(typeof document>"u"||typeof document.dispatchEvent!="function")return;const t={action:e};let n=null;if(typeof window<"u"&&typeof window.CustomEvent=="function"?n=window.CustomEvent:typeof CustomEvent=="function"&&(n=CustomEvent),n){document.dispatchEvent(new n("auth:navigate",{detail:t}));return}if(typeof Event=="function"){const o=new Event("auth:navigate");o.detail=t,document.dispatchEvent(o);return}document.dispatchEvent({type:"auth:navigate",detail:t})}function Re(e,t){var n,o;e&&((n=e.preventDefault)==null||n.call(e),(o=e.stopPropagation)==null||o.call(e)),F(),ut(t)}function ft(e){Re(e,"help")}function mt(e){Re(e,"settings")}function X(e){var l,s,u,f,_,m,g,k,P,E,M,v,z,L,B,R,$;const{panel:t,menuButton:n,menu:o,logoutButton:i,userNameDisplay:r}=h(),a=typeof(e==null?void 0:e.usuario)=="string"?e.usuario.trim():typeof(e==null?void 0:e.nombre)=="string"?e.nombre.trim():"",c=!!a;!t&&!n&&!o&&!i&&!r||(c?((s=(l=t==null?void 0:t.classList)==null?void 0:l.remove)==null||s.call(l,"hidden"),n&&(n.disabled=!1,(u=n.setAttribute)==null||u.call(n,"aria-expanded",x?"true":"false")),o&&(x?((_=(f=o.classList)==null?void 0:f.remove)==null||_.call(f,"hidden"),(m=o.setAttribute)==null||m.call(o,"aria-hidden","false")):((k=(g=o.classList)==null?void 0:g.add)==null||k.call(g,"hidden"),(P=o.setAttribute)==null||P.call(o,"aria-hidden","true"))),i&&(i.disabled=!1),r&&(r.textContent=a,(M=(E=r.classList)==null?void 0:E.remove)==null||M.call(E,"hidden"))):(r&&(r.textContent="",(z=(v=r.classList)==null?void 0:v.add)==null||z.call(v,"hidden")),F(),(B=(L=t==null?void 0:t.classList)==null?void 0:L.add)==null||B.call(L,"hidden"),n&&(n.disabled=!0,(R=n.setAttribute)==null||R.call(n,"aria-expanded","false")),($=o==null?void 0:o.setAttribute)==null||$.call(o,"aria-hidden","true"),i&&(i.disabled=!0)))}function ae(){if(I)return I.promise;let e,t;const n=new Promise((o,i)=>{e=o,t=i});return I={promise:n,resolve:e,reject:t},n}function pt(e){I&&typeof I.resolve=="function"&&I.resolve(e),I=null}async function ht({mail:e,password:t}){var a,c,l,s;if(!b)throw new Error("API_URL no está configurada.");const n={action:"login",mail:typeof e=="string"?e.trim():"",password:typeof t=="string"?t.trim():""};let o;try{o=await fetch(b,{method:"POST",headers:{"Content-Type":"text/plain; charset=utf-8"},body:JSON.stringify(n)})}catch(u){throw(u==null?void 0:u.name)==="AbortError"?new Error("La solicitud de autenticación excedió el tiempo de espera."):u instanceof TypeError?new Error("No se pudo conectar con el servidor de autenticación."):new Error((u==null?void 0:u.message)||"Error inesperado al iniciar sesión.")}if(!o.ok)throw o.status===401||o.status===403?new Error("Mail o contraseña incorrectos"):new Error(`HTTP ${o.status}`);let i;try{i=await o.json()}catch{throw new Error("No se pudo interpretar la respuesta de autenticación.")}if(i.result!=="success")throw new Error("Mail o contraseña incorrectos");const r=de({user:((a=i.data)==null?void 0:a.usuario)??((c=i.data)==null?void 0:c.user)??i.data,token:(l=i.data)==null?void 0:l.token,expiresAt:(s=i.data)==null?void 0:s.expiresAt});if(!r)throw new Error("Mail o contraseña incorrectos");return r}async function gt(e){e.preventDefault();const{form:t,mailInput:n,passwordInput:o}=h();if(!t||!(t instanceof HTMLFormElement))return;const i=(n==null?void 0:n.value)||"",r=(o==null?void 0:o.value)||"";if(!i.trim()||!r.trim()){re("Completa el mail y la contraseña.");return}Ae(t,!0);try{const a=await ht({mail:i,password:r});rt(a),Y(!0),Me(),pt(a)}catch(a){re((a==null?void 0:a.message)||"No se pudo iniciar sesión.")}finally{Ae(t,!1)}}async function $e(e){e&&e.preventDefault();const t=ue(),n=typeof(t==null?void 0:t.token)=="string"?t.token.trim():"";try{b&&n&&await fetch(b,{method:"POST",headers:{"Content-Type":"text/plain; charset=utf-8"},body:JSON.stringify({action:"logout",token:n})})}catch{}finally{Ce(),Y(!1),ie(),ae()}F(),Ce(),ie(),ae()}function yt(){if(Le)return;const{form:e,logoutButton:t,menuButton:n,helpLink:o,settingsLink:i}=h();e&&e.addEventListener("submit",gt),t&&t.addEventListener("click",$e),n&&n.addEventListener("click",dt),o&&o.addEventListener("click",ft),i&&i.addEventListener("click",mt),Le=!0}function bt(){const e=ue();return(typeof(e==null?void 0:e.token)=="string"?e.token.trim():"")||null}async function _t(){yt();const e=ue();return e?(X(e.user),Y(!0),Me(),e):(Y(!1),X(null),ie(),ae())}async function Et(){await $e(),re("Tu sesión ha expirado. Por favor, ingresá de nuevo.")}const p={mantenimientos:[],mantenimientoEditando:null,clientes:[],clientesLoaded:!1};async function O(e){if(!b)throw new Error("API_URL no está configurada.");const t={...e||{}};if((typeof t.action=="string"?t.action:void 0)!=="login"){const r=bt();if(!r)throw new Error("No hay una sesión activa. Por favor, ingresá de nuevo.");t.token=r}let o;try{o=await fetch(b,{method:"POST",headers:{"Content-Type":"text/plain; charset=utf-8"},body:JSON.stringify(t)})}catch(r){throw(r==null?void 0:r.name)==="AbortError"?new Error("La solicitud excedió el tiempo de espera. Inténtalo nuevamente."):r instanceof TypeError?new Error("No se pudo conectar con el servidor. Verifica tu conexión a internet."):new Error((r==null?void 0:r.message)||"Error inesperado al comunicarse con el servidor.")}if(!o.ok)throw new Error(`HTTP ${o.status}`);let i;try{i=await o.json()}catch{throw new Error("No se pudo interpretar la respuesta del servidor.")}if(i.result!=="success"){const r=typeof i.error=="string"?i.error.trim():typeof i.message=="string"?i.message.trim():"";throw r==="Sesión expirada"||r==="Token inválido"?(Et(),new Error("Tu sesión ha expirado. Por favor, ingresá de nuevo.")):new Error(r||"Error desconocido")}return i.data}async function vt(e){return O({action:"guardar",...e})}async function Lt(e){return O({action:"buscar",...e})}async function Ct(e){return O({action:"actualizar",...e})}async function At(e){return O({action:"eliminar",id:e})}async function It(){return O({action:"dashboard"})}async function wt({forceRefresh:e=!1}={}){if(!e&&p.clientesLoaded)return p.clientes;const t=await O({action:"clientes"});if(!Array.isArray(t))throw new Error("La respuesta de clientes no es válida.");return p.clientes=t,p.clientesLoaded=!0,p.clientes}let ee=null,te=null;function w(e){return document.getElementById(e)}function St(e=[]){const t=w("chart-mensual");t&&(ee&&ee.destroy(),ee=new Chart(t,{type:"bar",data:{labels:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],datasets:[{label:"Mantenimientos por Mes",data:e,backgroundColor:"rgba(54, 162, 235, 0.5)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1}]},options:{responsive:!0,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}}))}function xt(e=[]){const t=w("chart-tecnicos");t&&(te&&te.destroy(),te=new Chart(t,{type:"pie",data:{labels:e.map(n=>n.tecnico),datasets:[{data:e.map(n=>n.count),backgroundColor:["rgba(255, 99, 132, 0.5)","rgba(54, 162, 235, 0.5)","rgba(255, 206, 86, 0.5)","rgba(75, 192, 192, 0.5)","rgba(153, 102, 255, 0.5)","rgba(255, 159, 64, 0.5)"],borderWidth:1}]},options:{responsive:!0}}))}function Nt(e=[]){const t=w("tabla-proximos");if(t){if(t.innerHTML="",!e.length){const n=document.createElement("tr"),o=document.createElement("td");o.colSpan=4,o.className="px-6 py-4 text-center",o.textContent="No hay próximos mantenimientos",n.appendChild(o),t.appendChild(n);return}e.forEach(n=>{const o=document.createElement("tr"),i=r=>{const a=document.createElement("td");return a.className="px-6 py-4 whitespace-nowrap",a.textContent=r,a};o.appendChild(i(n.cliente||"N/A")),o.appendChild(i(n.fecha||"N/A")),o.appendChild(i(n.tecnico||"N/A")),o.appendChild(i(`${n.dias_restantes} días`)),t.appendChild(o)})}}function Tt(e){if(!e)return;const t=w("total-mantenimientos"),n=w("mantenimientos-mes"),o=w("proximos-mantenimientos"),i=w("tecnicos-activos");t&&(t.textContent=e.total??0),n&&(n.textContent=e.esteMes??0),o&&(o.textContent=e.proximos??0),i&&(i.textContent=e.tecnicos??0),St(Array.isArray(e.mensual)?e.mensual:[]),xt(Array.isArray(e.tecnicosData)?e.tecnicosData:[]),Nt(Array.isArray(e.proximosMantenimientos)?e.proximosMantenimientos:[])}function d(e){return document.getElementById(e)}const Ie="data-cliente-option",Dt=Object.freeze(["nombre","Nombre","cliente","Cliente","razon_social","RazonSocial"]),Ft=Object.freeze(["id","ID","id_cliente","IdCliente","codigo","Codigo","cuit","CUIT"]),j=Object.freeze({direccion:["direccion","Direccion","domicilio","Domicilio"],telefono:["telefono","Telefono","tel","Tel"],email:["email","Email","mail","Mail","correo","Correo"],cuit:["cuit","CUIT"]}),Ue=Object.freeze(["direccion","cliente_telefono","cliente_email","cliente_cuit"]),we="client-detail-empty",Se="client-detail-locked",qe="data-auto-resize",ne="autoResizeBaseWidth",Ot=8,kt=6,xe=48,Ne=new WeakSet,Te=new WeakSet;function Pt(e){return e instanceof HTMLInputElement&&e.hasAttribute(qe)}function q(e){if(!Pt(e))return;if(!e.dataset[ne]){const c=Math.max(e.clientWidth||0,e.offsetWidth||0);e.dataset[ne]=String(c>0?c:xe)}const t=Number(e.dataset[ne])||xe,n=typeof e.placeholder=="string"?e.placeholder.length:0,o=typeof e.value=="string"?e.value.length:0,i=Math.max(o,n,1);e.style.width="auto";let r=e.scrollWidth;(!r||Number.isNaN(r))&&(r=(Number(e.dataset.autoResizeCharWidth)||Ot)*i);const a=Math.max(t,r+kt);e.style.width=`${a}px`}function He(){return typeof document>"u"?[]:Array.from(document.querySelectorAll(`input[${qe}]`))}function Mt(){He().forEach(t=>{q(t),Ne.has(t)||(t.addEventListener("input",()=>q(t)),Ne.add(t))})}function zt(){He().forEach(q)}const U=new Map;let W=null;function fe(e){return e==null?"":String(e).trim()}function T(e,t){if(!e||typeof e!="object")return"";for(const n of t)if(Object.prototype.hasOwnProperty.call(e,n)){const o=fe(e[n]);if(o)return o}return""}function De(e){return T(e,Dt)}function Bt(e){return T(e,Ft)}function Rt(e){return{direccion:T(e,j.direccion),telefono:T(e,j.telefono),email:T(e,j.email),cuit:T(e,j.cuit)}}function ce(e,{lockWhenFilled:t=!1}={}){if(!(e instanceof HTMLInputElement)||!Ue.includes(e.id))return;const n=fe(e.value)!=="";t?(e.readOnly=n,e.disabled=n):n||(e.readOnly=!1,e.disabled=!1),n&&(e.disabled||e.readOnly)?e.classList.add(Se):e.classList.remove(Se),n?e.classList.remove(we):e.classList.add(we)}function $t(){Ue.forEach(e=>{const t=d(e);t instanceof HTMLInputElement&&(ce(t),Te.has(t)||(t.addEventListener("input",()=>{ce(t)}),Te.add(t)))})}function Ut(e,t,n={}){const o=d(e);if(!o)return;const i=fe(t);"value"in o&&(o.value=i),o instanceof HTMLInputElement&&(q(o),ce(o,{lockWhenFilled:!!n.lockWhenFilled}))}function Ve(e={}){const t={direccion:e.direccion,cliente_telefono:e.telefono,cliente_email:e.email,cliente_cuit:e.cuit};Object.entries(t).forEach(([n,o])=>{Ut(n,o,{lockWhenFilled:!0})})}function H(){Ve({})}function Fe(e){if(!e){H();return}let t=null;const n=e.selectedOptions&&e.selectedOptions.length>0?e.selectedOptions[0]:null,o=typeof e.selectedIndex=="number"&&e.selectedIndex>=0?e.options[e.selectedIndex]:null;if(n){const r=n.getAttribute("data-cliente-key");r&&(t=U.get(r)||null)}if((!t||o&&n&&n!==o)&&o){const r=o.getAttribute("data-cliente-key");if(r){const a=U.get(r);a&&(t=a)}}t||(t=U.get(e.value)),t?Ve(t):H()}function qt(){const e=d("cliente");if(!e){H();return}if(e.options.length>0){const t=e.querySelector('option[value=""]');t?(t.selected=!0,e.value=t.value):e.selectedIndex=0}else e.value="";H()}function Oe(e){return String(e).padStart(2,"0")}function Ht(e){return Object.prototype.toString.call(e)==="[object Date]"}function je(e){return Ht(e)&&!Number.isNaN(e.getTime())}function oe(e,t,n){const o=new Date(e,t,n);return Number.isNaN(o.getTime())||o.getFullYear()!==e||o.getMonth()!==t||o.getDate()!==n?null:o}function C(e){return je(e)?`${e.getFullYear()}-${Oe(e.getMonth()+1)}-${Oe(e.getDate())}`:""}function S(e){if(e==null||e==="")return"";if(je(e))return C(e);if(typeof e=="number")return C(new Date(e));if(typeof e=="string"){const t=e.trim();if(!t)return"";let n=t.match(/^(\d{4})-(\d{2})-(\d{2})(?:$|T)/);if(n){const i=Number(n[1]),r=Number(n[2]),a=Number(n[3]),c=oe(i,r-1,a);return c?C(c):""}if(n=t.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/),n){const i=Number(n[1]),r=Number(n[2]),a=Number(n[3]),c=oe(i,r-1,a);return c?C(c):""}if(n=t.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/),n){const i=Number(n[1]),r=Number(n[2]),a=Number(n[3]),c=oe(a,r-1,i);return c?C(c):""}const o=new Date(t);return C(o)}if(typeof e=="object"){const t=new Date(e);return C(t)}return""}function Vt(e){if(!e)return"";const[t,n,o]=e.split("-");if(!t||!n||!o)return"";const i=Number(t),r=Number(n),a=Number(o);if(Number.isNaN(i)||Number.isNaN(r)||Number.isNaN(a))return"";const c=new Date(i,r-1,a);return Number.isNaN(c.getTime())?"":c.toLocaleDateString("es-AR",{year:"numeric",month:"2-digit",day:"2-digit"})}function jt(e){const t=S(e),n=d("fecha");n&&(n.value=t);const o=d("fecha_display");o&&(o.value=Vt(t),q(o))}function We(e){if(!(e instanceof HTMLFormElement))return{};const t=new FormData(e),n={};t.forEach((i,r)=>{Object.prototype.hasOwnProperty.call(n,r)?(Array.isArray(n[r])||(n[r]=[n[r]]),n[r].push(i)):n[r]=i});const o=new Set;return e.querySelectorAll('input[type="radio"][name]').forEach(i=>o.add(i.name)),o.forEach(i=>{Object.prototype.hasOwnProperty.call(n,i)||(n[i]="")}),n}function Ge(){jt(new Date)}function Ze(){var $,pe,he,ge,ye,be,_e,Ee;const e=parseFloat(($=d("cond_red_found"))==null?void 0:$.value)||0,t=parseFloat((pe=d("cond_perm_found"))==null?void 0:pe.value)||0,n=parseFloat((he=d("cond_red_left"))==null?void 0:he.value)||0,o=parseFloat((ge=d("cond_perm_left"))==null?void 0:ge.value)||0,i=parseFloat((ye=d("caudal_perm_found"))==null?void 0:ye.value)||0,r=parseFloat((be=d("caudal_rech_found"))==null?void 0:be.value)||0,a=parseFloat((_e=d("caudal_perm_left"))==null?void 0:_e.value)||0,c=parseFloat((Ee=d("caudal_rech_left"))==null?void 0:Ee.value)||0,l=e>0?((1-t/e)*100).toFixed(2):"",s=n>0?((1-o/n)*100).toFixed(2):"",u=l?`${l} %`:"",f=s?`${s} %`:"",_=d("rechazo_found"),m=d("rechazo_found_hidden"),g=d("rechazo_left"),k=d("rechazo_left_hidden");_&&(_.value=u),m&&(m.value=u),g&&(g.value=f),k&&(k.value=f);const P=i>0?(r/i).toFixed(1):"",E=a>0?(c/a).toFixed(1):"",M=P?`${P}:1`:"",v=E?`${E}:1`:"",z=d("relacion_found"),L=d("relacion_found_hidden"),B=d("relacion_left"),R=d("relacion_left_hidden");z&&(z.value=M),L&&(L.value=M),B&&(B.value=v),R&&(R.value=v)}function Wt(e,t){const n=parseFloat(e.value);if(!Number.isNaN(n)&&n>=0){const o=n*et,i=n*tt;t.textContent=`(${o.toFixed(1)} l/h | ${i.toFixed(0)} GPD)`}else t.textContent=""}function Gt(){[["caudal_perm_found","caudal_perm_found_conv"],["caudal_perm_left","caudal_perm_left_conv"],["caudal_rech_found","caudal_rech_found_conv"],["caudal_rech_left","caudal_rech_left_conv"]].forEach(([t,n])=>{const o=d(t),i=d(n);o&&i&&o.addEventListener("input",()=>Wt(o,i))})}const Je='select[id$="_found"], select[id$="_left"]',Zt={pasa:"status-pass",no:"status-pass",falla:"status-fail","no pasa":"status-fail",sí:"status-fail",si:"status-fail","n/a":"status-na","no aplica":"status-na",na:"status-na","":"status-na"};function se(e){e.classList.remove("status-pass","status-fail","status-na");const t=String(e.value??"").trim().toLowerCase(),n=Zt[t]||"status-na";e.classList.add(n)}function Jt(){document.querySelectorAll(Je).forEach(se)}function Kt(){document.querySelectorAll(Je).forEach(t=>{se(t),t.addEventListener("change",()=>se(t))})}const Yt={Realizada:"success","No Realizada":"danger","N/A":"neutral"};function Ke(){const e=document.querySelector(".sanitizacion-options");if(!e)return;const t=e.querySelectorAll('input[type="radio"][name="sanitizacion"]');if(!t.length){e.dataset.status="neutral";return}const n=()=>{const o=e.querySelector('input[type="radio"][name="sanitizacion"]:checked'),i=(o==null?void 0:o.value)||"N/A";e.dataset.status=Yt[i]||"neutral"};e.dataset.sanitizacionConfigured||(t.forEach(o=>{o.addEventListener("change",n)}),e.dataset.sanitizacionConfigured="true"),n()}function Xt(){document.querySelectorAll('input[type="number"]').forEach(t=>{t.addEventListener("input",Ze)})}function Qt(){["rechazo_found","rechazo_found_hidden","rechazo_left","rechazo_left_hidden","relacion_found","relacion_found_hidden","relacion_left","relacion_left_hidden"].forEach(e=>{const t=d(e);t&&(t.value="")})}function en(){["caudal_perm_found_conv","caudal_perm_left_conv","caudal_rech_found_conv","caudal_rech_left_conv"].forEach(e=>{const t=d(e);t&&(t.textContent="")})}function tn(e=[]){const t=d("cliente");if(!t)return;const n=Array.isArray(e)?e:[],o=t.value,i=t.selectedOptions&&t.selectedOptions[0],r=i?i.getAttribute("data-cliente-key"):null,a=t.querySelector('option[value=""]');t.querySelectorAll(`option[${Ie}="true"]`).forEach(s=>s.remove()),U.clear();const c=document.createDocumentFragment();n.forEach((s,u)=>{if(!s||typeof s!="object")return;const f=Bt(s)||De(s);if(!f)return;const _=De(s)||f,m=document.createElement("option");m.value=f,m.textContent=_;const g=`cliente-${u}`;m.setAttribute("data-cliente-key",g),m.setAttribute(Ie,"true"),c.appendChild(m),U.set(g,Rt(s))}),t.appendChild(c),W&&t.removeEventListener("change",W),W=()=>{Fe(t)},t.addEventListener("change",W);let l=!1;if(r){const s=t.querySelector(`option[data-cliente-key="${r}"]`);s&&(s.selected=!0,t.value=s.value,l=!0)}!l&&o&&(t.value=o,l=t.value===o&&t.selectedIndex!==-1),l?Fe(t):(a?(a.selected=!0,t.value=a.value):t.options.length>0?t.selectedIndex=0:t.value="",H())}function nn(){Ge(),Xt(),Gt(),Kt(),Mt(),$t(),Ke(),Ze()}function Ye(){const e=d("maintenance-form");e&&e.reset(),qt(),Ge(),Qt(),en(),Jt(),zt(),Ke()}function on(){const e=d("maintenance-form");if(!(e instanceof HTMLFormElement))return{};const t=We(e),n=e.querySelector('input[name="sanitizacion"]:checked');if(t.sanitizacion=n?n.value:"",Object.prototype.hasOwnProperty.call(t,"fecha")){const i=S(t.fecha);t.fecha=i||S(new Date)}return Object.prototype.hasOwnProperty.call(t,"proximo_mant")&&(t.proximo_mant=S(t.proximo_mant)),["cond_red_found","cond_red_left","cond_perm_found","cond_perm_left","presion_found","presion_left","caudal_perm_found","caudal_perm_left","caudal_rech_found","caudal_rech_left","precarga_found","precarga_left"].forEach(i=>{Object.prototype.hasOwnProperty.call(t,i)&&t[i]===""&&(t[i]=0)}),t}function rn(e){const t=d("report-number-display");t&&(t.textContent=e)}function an(){const e=new Date,t=o=>String(o).padStart(2,"0");return`REP-${`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}`}function N(e){return document.getElementById(e)}function ke(e){return S(e)||""}function G(e){const t=document.createElement("td");return t.className="px-6 py-4 whitespace-nowrap",t.textContent=e,t}function A(e){return String(e??"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function cn(e,{onEdit:t,onDelete:n}){const o=N("tabla-resultados"),i=N("resultados-busqueda");if(!(!o||!i)){if(p.mantenimientos=Array.isArray(e)?e:[],o.innerHTML="",!p.mantenimientos.length){const r=document.createElement("tr"),a=document.createElement("td");a.colSpan=5,a.className="px-6 py-4 text-center",a.textContent="No se encontraron resultados",r.appendChild(a),o.appendChild(r),i.classList.remove("hidden");return}p.mantenimientos.forEach(r=>{const a=document.createElement("tr");a.appendChild(G(r.Cliente||"N/A")),a.appendChild(G(r.Fecha_Servicio||"N/A")),a.appendChild(G(r.Tecnico_Asignado||"N/A")),a.appendChild(G(r.Modelo_Equipo||"N/A"));const c=document.createElement("td");c.className="px-6 py-4 whitespace-nowrap";const l=document.createElement("button");l.type="button",l.className="text-blue-600 hover:text-blue-900 mr-2",l.textContent="Editar",l.addEventListener("click",()=>t(r));const s=document.createElement("button");s.type="button",s.className="text-red-600 hover:text-red-900",s.textContent="Eliminar",s.addEventListener("click",()=>n(r)),c.appendChild(l),c.appendChild(s),a.appendChild(c),o.appendChild(a)}),i.classList.remove("hidden")}}function sn(){const e=N("tabla-resultados");e&&(e.innerHTML="");const t=N("resultados-busqueda");t&&t.classList.add("hidden"),p.mantenimientos=[]}function ln(e){const t=N("modal-edicion"),n=N("formulario-edicion");if(!t||!n)return;p.mantenimientoEditando=e;const o=ke(e.Fecha_Servicio),i=ke(e.Proximo_Mantenimiento);n.innerHTML=`
        <form id="edit-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                    <input type="text" id="edit-cliente" name="cliente" value="${A(e.Cliente||"")}" class="w-full border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Servicio</label>
                    <input type="date" id="edit-fecha" name="fecha_servicio" value="${A(o)}" class="w-full border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Técnico</label>
                    <input type="text" id="edit-tecnico" name="tecnico_asignado" value="${A(e.Tecnico_Asignado||"")}" class="w-full border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Próximo Mantenimiento</label>
                    <input type="date" id="edit-proximo-mant" name="proximo_mantenimiento" value="${A(i)}" class="w-full border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Conductividad Permeado</label>
                    <input type="number" id="edit-cond-perm" name="conductividad_permeado_left" value="${A(e.Conductividad_Permeado_Left||0)}" class="w-full border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Resumen</label>
                    <textarea id="edit-resumen" name="resumen_recomendaciones" rows="3" class="w-full border-gray-300 rounded-md p-2">${A(e.Resumen_Recomendaciones||"")}</textarea>
                </div>
            </div>
            <input type="hidden" id="edit-id" name="id" value="${A(e.ID_Unico||"")}">
        </form>
    `,t.classList.remove("hidden")}function Xe(){const e=N("modal-edicion");e&&e.classList.add("hidden"),p.mantenimientoEditando=null}function dn(){const e=document.getElementById("edit-form");if(!(e instanceof HTMLFormElement))return{};const t=We(e);return Object.prototype.hasOwnProperty.call(t,"conductividad_permeado_left")&&t.conductividad_permeado_left===""&&(t.conductividad_permeado_left=0),Object.prototype.hasOwnProperty.call(t,"fecha_servicio")&&(t.fecha_servicio=S(t.fecha_servicio)),Object.prototype.hasOwnProperty.call(t,"proximo_mantenimiento")&&(t.proximo_mantenimiento=S(t.proximo_mantenimiento)),t}const un=[{id:"etapa1",title:"1ª Sedimentos (PP)",placeholder:"Micronaje: __ µm"},{id:"etapa2",title:"2ª Carbón Bloque (CTO)",placeholder:"Modelo/Tipo"},{id:"etapa3",title:"3ª Carbón GAC / PP",placeholder:"Micronaje/Tipo"},{id:"etapa4",title:"4ª Membrana RO",placeholder:"Caudal GPD | S/N",emphasize:!0},{id:"etapa5",title:"5ª Post-Filtro",placeholder:"Tipo: Carbón, Remineralizador..."},{id:"etapa6",title:"6ª Adicional",placeholder:"Tipo: UV, Alcalino..."}];function fn(e){const t=document.createElement("div");t.className="component-toggle",t.dataset.state="inspeccionado";const n=`${e}_accion_cambiado`,o=`${e}_accion_inspeccionado`,i=document.createElement("input");i.type="radio",i.name=`${e}_accion`,i.value="Cambiado",i.id=n,i.className="component-toggle__input";const r=document.createElement("input");r.type="radio",r.name=`${e}_accion`,r.value="Inspeccionado",r.id=o,r.className="component-toggle__input",r.checked=!0,r.defaultChecked=!0;const a=document.createElement("div");a.className="component-toggle__track";const c=document.createElement("div");c.className="component-toggle__thumb",a.appendChild(c);const l=document.createElement("label");l.setAttribute("for",n),l.className="component-toggle__option component-toggle__option--cambiado",l.textContent="Cambiado";const s=document.createElement("label");return s.setAttribute("for",o),s.className="component-toggle__option component-toggle__option--inspeccionado",s.textContent="Inspeccionado",t.append(i,r,a,l,s),t}function mn(e,t){const n=e.querySelector(".stage-title");n&&(n.textContent=t.title,t.emphasize&&n.classList.add("font-bold"));const o=e.querySelector(".stage-details");o&&(o.id=`${t.id}_detalles`,o.name=`${t.id}_detalles`,o.placeholder=t.placeholder);const i=e.querySelector(".stage-actions");if(i){const r=fn(t.id);i.innerHTML="",i.appendChild(r);const a=s=>{r.dataset.state=String(s).toLowerCase()};r.querySelectorAll(".component-toggle__input").forEach(s=>{s.addEventListener("change",()=>{s.checked&&a(s.value)})});const l=r.querySelector(".component-toggle__input:checked");l&&a(l.value)}}function pn({containerId:e="component-stage-container",templateId:t="component-stage-template"}={}){const n=document.getElementById(e),o=document.getElementById(t);if(!n||!(o instanceof HTMLTemplateElement))return;n.innerHTML="";const i=document.createDocumentFragment();un.forEach(r=>{const a=o.content.cloneNode(!0);mn(a,r),i.appendChild(a)}),n.appendChild(i)}const hn=typeof b=="string"&&b.length>0;hn||console.warn("API_URL no configurado. Configura window.__APP_CONFIG__.API_URL o la variable de entorno API_URL.");function gn(){const e=document.getElementById("app-version");if(e){{const t="1.0.0".trim();if(t){e.textContent=`Versión ${t}`,e.classList.remove("hidden");return}}e.textContent="",e.classList.add("hidden")}}function Z(e){document.querySelectorAll(".tab-content").forEach(o=>o.classList.add("hidden")),document.querySelectorAll(".tab-button").forEach(o=>o.classList.remove("active"));const t=document.getElementById(`tab-${e}`);t&&t.classList.remove("hidden");const n=document.getElementById(`tab-${e}-btn`);n&&n.classList.add("active"),e==="dashboard"&&Ln()}async function yn(){const e=document.getElementById("guardarButton");if(!e)return;const t=e.textContent;e.textContent="Guardando...",e.disabled=!0;try{const n=an(),o=on();o&&typeof o=="object"&&(o.numero_reporte=n),await vt(o),alert("✅ Mantenimiento guardado correctamente en el sistema"),rn(n),setTimeout(()=>{try{window.print()}catch(i){console.error("Error al imprimir el mantenimiento guardado:",i)}finally{Ye()}},500)}catch(n){console.error("Error al guardar mantenimiento:",n);const o=(n==null?void 0:n.message)||"Error desconocido al guardar los datos.";alert(`❌ Error al guardar los datos: ${o}`)}finally{e.textContent=t,e.disabled=!1}}async function me(){var t,n,o;const e={cliente:((t=document.getElementById("buscar-cliente"))==null?void 0:t.value)||"",tecnico:((n=document.getElementById("buscar-tecnico"))==null?void 0:n.value)||"",fecha:((o=document.getElementById("buscar-fecha"))==null?void 0:o.value)||""};try{const i=await Lt(e);cn(i,{onEdit:_n,onDelete:En})}catch(i){console.error("Error buscando mantenimientos:",i);const r=(i==null?void 0:i.message)||"Error desconocido al buscar mantenimientos.";alert(`❌ Error al buscar mantenimientos: ${r}`)}}function bn(){["buscar-cliente","buscar-tecnico","buscar-fecha"].forEach(t=>{const n=document.getElementById(t);n&&(n.value="")}),sn()}function _n(e){e&&ln(e)}async function En(e){if(!(!(e!=null&&e.ID_Unico)||!window.confirm("¿Estás seguro de que quieres eliminar este mantenimiento?")))try{await At(e.ID_Unico),alert("✅ Mantenimiento eliminado correctamente"),await me()}catch(n){console.error("Error eliminando mantenimiento:",n),alert("Error al eliminar mantenimiento")}}async function vn(){try{const e=dn();await Ct(e),alert("✅ Cambios guardados correctamente"),Xe(),await me()}catch(e){console.error("Error guardando cambios:",e),alert("Error al guardar cambios")}}async function Ln(){try{const e=await It();Tt(e)}catch(e){console.error("Error cargando dashboard:",e)}}function Cn(){const e=document.getElementById("guardarButton");e&&e.addEventListener("click",yn);const t=document.getElementById("resetButton");t&&t.addEventListener("click",Ye);const n=document.getElementById("buscar-btn");n&&n.addEventListener("click",s=>{s.preventDefault(),me()});const o=document.getElementById("limpiar-btn");o&&o.addEventListener("click",s=>{s.preventDefault(),bn()});const i=document.getElementById("cancelar-edicion-btn");i&&i.addEventListener("click",s=>{s.preventDefault(),Xe()});const r=document.getElementById("guardar-edicion-btn");r&&r.addEventListener("click",s=>{s.preventDefault(),vn()});const a=document.getElementById("tab-nuevo-btn");a&&a.addEventListener("click",()=>Z("nuevo"));const c=document.getElementById("tab-buscar-btn");c&&c.addEventListener("click",()=>Z("buscar"));const l=document.getElementById("tab-dashboard-btn");l&&l.addEventListener("click",()=>Z("dashboard"))}async function An(){await _t(),pn();let e=[];try{e=await wt()}catch(t){console.error("Error cargando clientes:",t);const n=t!=null&&t.message?` Detalle: ${t.message}`:"";alert(`No se pudieron cargar los datos de clientes. Podrás completar los campos manualmente.${n}`)}tn(e),nn(),Cn(),Z("nuevo")}document.addEventListener("DOMContentLoaded",()=>{gn(),An().catch(e=>{console.error("Error inicializando la aplicación:",e),alert("No se pudo inicializar la aplicación. Revisa la consola para más detalles.")})});

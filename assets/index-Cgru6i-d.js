(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();const re={},j=typeof window<"u"?window.__APP_CONFIG__:void 0,Be=j&&typeof j.API_URL=="string"?j.API_URL.trim():"";let x=Be;if(!x){const e=typeof import.meta<"u"&&import.meta&&typeof re=="object"?re:void 0;e&&typeof e.VITE_API_URL=="string"&&(x=e.VITE_API_URL.trim())}const k=typeof globalThis<"u"&&typeof globalThis.process=="object"?globalThis.process:void 0;!x&&k&&k.env&&typeof k.env.API_URL=="string"&&(x=k.env.API_URL);x||console.warn("[config] API_URL no está configurada. Define window.__APP_CONFIG__.API_URL o la variable de entorno VITE_API_URL/API_URL.");const N=x,ke=60,Re=60*24/3.78541,J="reportesOBM.auth";let w=null,ae=!1,L=null;function $e(e){if(typeof e!="string")return"";const t=e.trim().split(/\s+/).filter(Boolean);return t.length===0?"":t.slice(0,2).map(o=>o.charAt(0).toUpperCase()).join("")}function M(e){const{panel:t,userMenuButton:n}=h();!t||!n||(e?(t.classList.add("user-menu--open"),n.setAttribute("aria-expanded","true")):(t.classList.remove("user-menu--open"),n.setAttribute("aria-expanded","false")))}function Ue(){const{panel:e}=h();if(!e||e.classList.contains("hidden"))return;const t=e.classList.contains("user-menu--open");M(!t)}function ze(e){e&&(e.preventDefault(),e.stopPropagation());const{userMenuButton:t}=h();!t||t.disabled||Ue()}function je(e){const{panel:t}=h();!t||t.classList.contains("hidden")||!t.classList.contains("user-menu--open")||typeof t.contains=="function"&&t.contains(e.target)||M(!1)}function qe(e){if((e==null?void 0:e.key)!=="Escape")return;const{panel:t}=h();!t||t.classList.contains("hidden")||!t.classList.contains("user-menu--open")||M(!1)}function K(){return typeof window<"u"&&window.localStorage?window.localStorage:typeof globalThis<"u"&&globalThis.localStorage?globalThis.localStorage:null}function be(){if(w)return w;const e=K();if(!e)return null;const t=e.getItem(J);if(!t)return null;try{const n=JSON.parse(t);if(n&&typeof n=="object"){const o=typeof n.token=="string"?n.token:"",r=typeof n.usuario=="string"?n.usuario:"";if(o&&r)return w={token:o,usuario:r},w}}catch(n){console.warn("[auth] No se pudo leer la sesión almacenada:",n)}return null}function _e(e){w=e;const t=K();t&&t.setItem(J,JSON.stringify(e)),Ce(e)}function Ee(){w=null;const e=K();e&&e.removeItem(J),Ce(null)}function h(){return typeof document>"u"?{}:{modal:document.getElementById("login-modal"),form:document.getElementById("login-form"),error:document.getElementById("login-error"),usuarioInput:document.getElementById("login-usuario"),tokenInput:document.getElementById("login-token"),logoutButton:document.getElementById("logout-button"),panel:document.getElementById("auth-user-panel"),userLabel:document.getElementById("current-user"),userMenuButton:document.getElementById("user-menu-button"),userMenuInitials:document.getElementById("user-menu-initials")}}function ve(){const{modal:e,error:t,usuarioInput:n}=h();e&&e.classList.remove("hidden"),t&&(t.textContent="",t.classList.add("hidden")),n&&n.focus()}function Le(){const{modal:e,form:t,error:n}=h();e&&e.classList.add("hidden"),t&&t.reset(),n&&(n.textContent="",n.classList.add("hidden"))}function ie(e,t){if(!e)return;e.querySelectorAll("input").forEach(r=>{r.disabled=t});const o=e.querySelector('button[type="submit"]');o&&(t?(o.dataset.originalText=o.textContent,o.textContent="Ingresando...",o.disabled=!0):(o.textContent=o.dataset.originalText||"Ingresar",o.disabled=!1,delete o.dataset.originalText))}function ce(e){const{error:t}=h();t&&(t.textContent=e,t.classList.remove("hidden"))}function Ce(e){const{panel:t,userLabel:n,logoutButton:o,userMenuButton:r,userMenuInitials:a}=h();if(!t||!n||!o||!r||!a)return;M(!1);const i=typeof(e==null?void 0:e.usuario)=="string"?e.usuario.trim():"";if(i){const c=$e(i)||i.charAt(0).toUpperCase();n.textContent=i,a.textContent=c,r.disabled=!1,r.setAttribute("aria-label",`Abrir menú de ${i}`),t.classList.remove("hidden"),o.disabled=!1}else n.textContent="",a.textContent="",r.disabled=!0,r.setAttribute("aria-label","Abrir menú de usuario"),t.classList.add("hidden"),o.disabled=!0}function Ae(){if(L)return L.promise;let e,t;const n=new Promise((o,r)=>{e=o,t=r});return L={promise:n,resolve:e,reject:t},n}function Ve(e){L&&typeof L.resolve=="function"&&L.resolve(e),L=null}async function Ie({usuario:e,token:t}){if(!N)throw new Error("API_URL no está configurada.");const n={action:"login",usuario:typeof e=="string"?e.trim():"",token:typeof t=="string"?t.trim():""};let o;try{o=await fetch(N,{method:"POST",headers:{"Content-Type":"text/plain; charset=utf-8"},body:JSON.stringify(n)})}catch(c){throw(c==null?void 0:c.name)==="AbortError"?new Error("La solicitud de autenticación excedió el tiempo de espera."):c instanceof TypeError?new Error("No se pudo conectar con el servidor de autenticación."):new Error((c==null?void 0:c.message)||"Error inesperado al iniciar sesión.")}if(!o.ok)throw new Error(`HTTP ${o.status}`);let r;try{r=await o.json()}catch{throw new Error("No se pudo interpretar la respuesta de autenticación.")}if(r.result!=="success")throw new Error(r.error||"Credenciales inválidas.");const a=r.data||{},i=typeof a.usuario=="string"&&a.usuario.trim()?a.usuario.trim():n.usuario;if(!i)throw new Error("La respuesta del servidor no incluye el usuario autenticado.");return{token:n.token,usuario:i}}async function He(e){e.preventDefault();const{form:t,tokenInput:n,usuarioInput:o}=h();if(!t||!(t instanceof HTMLFormElement))return;const r=(n==null?void 0:n.value)||"",a=(o==null?void 0:o.value)||"";if(!r.trim()||!a.trim()){ce("Completa el usuario y el token de acceso.");return}ie(t,!0);try{const i=await Ie({token:r,usuario:a});_e(i),Le(),Ve(i.usuario)}catch(i){ce((i==null?void 0:i.message)||"No se pudo iniciar sesión.")}finally{ie(t,!1)}}function We(e){e&&e.preventDefault(),M(!1),Ee(),ve(),Ae()}function Ge(){if(ae)return;const{form:e,logoutButton:t,userMenuButton:n}=h();e&&e.addEventListener("submit",He),t&&t.addEventListener("click",We),n&&n.addEventListener("click",ze),typeof document<"u"&&typeof document.addEventListener=="function"&&(document.addEventListener("click",je),document.addEventListener("keydown",qe)),ae=!0}function Ze(){const e=be();if(!e||!e.token||!e.usuario)throw new Error("Sesión no autenticada. Vuelve a iniciar sesión.");return{token:e.token,usuario:e.usuario}}async function Je(){Ge();const e=be();if(e&&e.token&&e.usuario)try{const t=await Ie(e);return _e(t),Le(),t.usuario}catch(t){console.warn("[auth] Sesión almacenada inválida:",t),Ee()}return ve(),Ae()}const p={mantenimientos:[],mantenimientoEditando:null,clientes:[],clientesLoaded:!1};async function T(e,{requireAuth:t=!0}={}){if(!N)throw new Error("API_URL no está configurada.");const n={...e};t&&Object.assign(n,Ze());let o;try{o=await fetch(N,{method:"POST",headers:{"Content-Type":"text/plain; charset=utf-8"},body:JSON.stringify(n)})}catch(a){throw(a==null?void 0:a.name)==="AbortError"?new Error("La solicitud excedió el tiempo de espera. Inténtalo nuevamente."):a instanceof TypeError?new Error("No se pudo conectar con el servidor. Verifica tu conexión a internet."):new Error((a==null?void 0:a.message)||"Error inesperado al comunicarse con el servidor.")}if(!o.ok)throw new Error(`HTTP ${o.status}`);let r;try{r=await o.json()}catch{throw new Error("No se pudo interpretar la respuesta del servidor.")}if(r.result!=="success")throw new Error(r.error||"Error desconocido");return r.data}async function Ke(e){return T({action:"guardar",...e})}async function Ye(e){return T({action:"buscar",...e})}async function Xe(e){return T({action:"actualizar",...e})}async function Qe(e){return T({action:"eliminar",id:e})}async function et(){return T({action:"dashboard"})}async function tt({forceRefresh:e=!1}={}){if(!e&&p.clientesLoaded)return p.clientes;const t=await T({action:"clientes"});if(!Array.isArray(t))throw new Error("La respuesta de clientes no es válida.");return p.clientes=t,p.clientesLoaded=!0,p.clientes}let q=null,V=null;function C(e){return document.getElementById(e)}function nt(e=[]){const t=C("chart-mensual");t&&(q&&q.destroy(),q=new Chart(t,{type:"bar",data:{labels:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],datasets:[{label:"Mantenimientos por Mes",data:e,backgroundColor:"rgba(54, 162, 235, 0.5)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1}]},options:{responsive:!0,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}}))}function ot(e=[]){const t=C("chart-tecnicos");t&&(V&&V.destroy(),V=new Chart(t,{type:"pie",data:{labels:e.map(n=>n.tecnico),datasets:[{data:e.map(n=>n.count),backgroundColor:["rgba(255, 99, 132, 0.5)","rgba(54, 162, 235, 0.5)","rgba(255, 206, 86, 0.5)","rgba(75, 192, 192, 0.5)","rgba(153, 102, 255, 0.5)","rgba(255, 159, 64, 0.5)"],borderWidth:1}]},options:{responsive:!0}}))}function rt(e=[]){const t=C("tabla-proximos");if(t){if(t.innerHTML="",!e.length){const n=document.createElement("tr"),o=document.createElement("td");o.colSpan=4,o.className="px-6 py-4 text-center",o.textContent="No hay próximos mantenimientos",n.appendChild(o),t.appendChild(n);return}e.forEach(n=>{const o=document.createElement("tr"),r=a=>{const i=document.createElement("td");return i.className="px-6 py-4 whitespace-nowrap",i.textContent=a,i};o.appendChild(r(n.cliente||"N/A")),o.appendChild(r(n.fecha||"N/A")),o.appendChild(r(n.tecnico||"N/A")),o.appendChild(r(`${n.dias_restantes} días`)),t.appendChild(o)})}}function at(e){if(!e)return;const t=C("total-mantenimientos"),n=C("mantenimientos-mes"),o=C("proximos-mantenimientos"),r=C("tecnicos-activos");t&&(t.textContent=e.total??0),n&&(n.textContent=e.esteMes??0),o&&(o.textContent=e.proximos??0),r&&(r.textContent=e.tecnicos??0),nt(Array.isArray(e.mensual)?e.mensual:[]),ot(Array.isArray(e.tecnicosData)?e.tecnicosData:[]),rt(Array.isArray(e.proximosMantenimientos)?e.proximosMantenimientos:[])}function d(e){return document.getElementById(e)}const se="data-cliente-option",it=Object.freeze(["nombre","Nombre","cliente","Cliente","razon_social","RazonSocial"]),ct=Object.freeze(["id","ID","id_cliente","IdCliente","codigo","Codigo","cuit","CUIT"]),R=Object.freeze({direccion:["direccion","Direccion","domicilio","Domicilio"],telefono:["telefono","Telefono","tel","Tel"],email:["email","Email","mail","Mail","correo","Correo"],cuit:["cuit","CUIT"]}),we=Object.freeze(["direccion","cliente_telefono","cliente_email","cliente_cuit"]),le="client-detail-empty",de="client-detail-locked",Se="data-auto-resize",H="autoResizeBaseWidth",st=8,lt=6,ue=48,fe=new WeakSet,me=new WeakSet;function dt(e){return e instanceof HTMLInputElement&&e.hasAttribute(Se)}function F(e){if(!dt(e))return;if(!e.dataset[H]){const c=Math.max(e.clientWidth||0,e.offsetWidth||0);e.dataset[H]=String(c>0?c:ue)}const t=Number(e.dataset[H])||ue,n=typeof e.placeholder=="string"?e.placeholder.length:0,o=typeof e.value=="string"?e.value.length:0,r=Math.max(o,n,1);e.style.width="auto";let a=e.scrollWidth;(!a||Number.isNaN(a))&&(a=(Number(e.dataset.autoResizeCharWidth)||st)*r);const i=Math.max(t,a+lt);e.style.width=`${i}px`}function xe(){return typeof document>"u"?[]:Array.from(document.querySelectorAll(`input[${Se}]`))}function ut(){xe().forEach(t=>{F(t),fe.has(t)||(t.addEventListener("input",()=>F(t)),fe.add(t))})}function ft(){xe().forEach(F)}const D=new Map;let $=null;function Y(e){return e==null?"":String(e).trim()}function S(e,t){if(!e||typeof e!="object")return"";for(const n of t)if(Object.prototype.hasOwnProperty.call(e,n)){const o=Y(e[n]);if(o)return o}return""}function pe(e){return S(e,it)}function mt(e){return S(e,ct)}function pt(e){return{direccion:S(e,R.direccion),telefono:S(e,R.telefono),email:S(e,R.email),cuit:S(e,R.cuit)}}function G(e,{lockWhenFilled:t=!1}={}){if(!(e instanceof HTMLInputElement)||!we.includes(e.id))return;const n=Y(e.value)!=="";t?(e.readOnly=n,e.disabled=n):n||(e.readOnly=!1,e.disabled=!1),n&&(e.disabled||e.readOnly)?e.classList.add(de):e.classList.remove(de),n?e.classList.remove(le):e.classList.add(le)}function ht(){we.forEach(e=>{const t=d(e);t instanceof HTMLInputElement&&(G(t),me.has(t)||(t.addEventListener("input",()=>{G(t)}),me.add(t)))})}function gt(e,t,n={}){const o=d(e);if(!o)return;const r=Y(t);"value"in o&&(o.value=r),o instanceof HTMLInputElement&&(F(o),G(o,{lockWhenFilled:!!n.lockWhenFilled}))}function Ne(e={}){const t={direccion:e.direccion,cliente_telefono:e.telefono,cliente_email:e.email,cliente_cuit:e.cuit};Object.entries(t).forEach(([n,o])=>{gt(n,o,{lockWhenFilled:!0})})}function O(){Ne({})}function he(e){if(!e){O();return}let t=null;const n=e.selectedOptions&&e.selectedOptions.length>0?e.selectedOptions[0]:null,o=typeof e.selectedIndex=="number"&&e.selectedIndex>=0?e.options[e.selectedIndex]:null;if(n){const a=n.getAttribute("data-cliente-key");a&&(t=D.get(a)||null)}if((!t||o&&n&&n!==o)&&o){const a=o.getAttribute("data-cliente-key");if(a){const i=D.get(a);i&&(t=i)}}t||(t=D.get(e.value)),t?Ne(t):O()}function yt(){const e=d("cliente");if(!e){O();return}if(e.options.length>0){const t=e.querySelector('option[value=""]');t?(t.selected=!0,e.value=t.value):e.selectedIndex=0}else e.value="";O()}function ge(e){return String(e).padStart(2,"0")}function bt(e){return Object.prototype.toString.call(e)==="[object Date]"}function Te(e){return bt(e)&&!Number.isNaN(e.getTime())}function W(e,t,n){const o=new Date(e,t,n);return Number.isNaN(o.getTime())||o.getFullYear()!==e||o.getMonth()!==t||o.getDate()!==n?null:o}function E(e){return Te(e)?`${e.getFullYear()}-${ge(e.getMonth()+1)}-${ge(e.getDate())}`:""}function A(e){if(e==null||e==="")return"";if(Te(e))return E(e);if(typeof e=="number")return E(new Date(e));if(typeof e=="string"){const t=e.trim();if(!t)return"";let n=t.match(/^(\d{4})-(\d{2})-(\d{2})(?:$|T)/);if(n){const r=Number(n[1]),a=Number(n[2]),i=Number(n[3]),c=W(r,a-1,i);return c?E(c):""}if(n=t.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/),n){const r=Number(n[1]),a=Number(n[2]),i=Number(n[3]),c=W(r,a-1,i);return c?E(c):""}if(n=t.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/),n){const r=Number(n[1]),a=Number(n[2]),i=Number(n[3]),c=W(i,a-1,r);return c?E(c):""}const o=new Date(t);return E(o)}if(typeof e=="object"){const t=new Date(e);return E(t)}return""}function _t(e){if(!e)return"";const[t,n,o]=e.split("-");if(!t||!n||!o)return"";const r=Number(t),a=Number(n),i=Number(o);if(Number.isNaN(r)||Number.isNaN(a)||Number.isNaN(i))return"";const c=new Date(r,a-1,i);return Number.isNaN(c.getTime())?"":c.toLocaleDateString("es-AR",{year:"numeric",month:"2-digit",day:"2-digit"})}function Et(e){const t=A(e),n=d("fecha");n&&(n.value=t);const o=d("fecha_display");o&&(o.value=_t(t),F(o))}function De(e){if(!(e instanceof HTMLFormElement))return{};const t=new FormData(e),n={};t.forEach((r,a)=>{Object.prototype.hasOwnProperty.call(n,a)?(Array.isArray(n[a])||(n[a]=[n[a]]),n[a].push(r)):n[a]=r});const o=new Set;return e.querySelectorAll('input[type="radio"][name]').forEach(r=>o.add(r.name)),o.forEach(r=>{Object.prototype.hasOwnProperty.call(n,r)||(n[r]="")}),n}function Fe(){Et(new Date)}function Oe(){var m,P,B,Q,ee,te,ne,oe;const e=parseFloat((m=d("cond_red_found"))==null?void 0:m.value)||0,t=parseFloat((P=d("cond_perm_found"))==null?void 0:P.value)||0,n=parseFloat((B=d("cond_red_left"))==null?void 0:B.value)||0,o=parseFloat((Q=d("cond_perm_left"))==null?void 0:Q.value)||0,r=parseFloat((ee=d("caudal_perm_found"))==null?void 0:ee.value)||0,a=parseFloat((te=d("caudal_rech_found"))==null?void 0:te.value)||0,i=parseFloat((ne=d("caudal_perm_left"))==null?void 0:ne.value)||0,c=parseFloat((oe=d("caudal_rech_left"))==null?void 0:oe.value)||0,l=e>0?((1-t/e)*100).toFixed(2):"",s=n>0?((1-o/n)*100).toFixed(2):"",g=d("rechazo_found"),b=d("rechazo_left");g&&(g.value=l?`${l} %`:""),b&&(b.value=s?`${s} %`:"");const _=r>0?(a/r).toFixed(1):"",f=i>0?(c/i).toFixed(1):"",y=d("relacion_found"),u=d("relacion_left");y&&(y.value=_?`${_}:1`:""),u&&(u.value=f?`${f}:1`:"")}function vt(e,t){const n=parseFloat(e.value);if(!Number.isNaN(n)&&n>=0){const o=n*ke,r=n*Re;t.textContent=`(${o.toFixed(1)} l/h | ${r.toFixed(0)} GPD)`}else t.textContent=""}function Lt(){[["caudal_perm_found","caudal_perm_found_conv"],["caudal_perm_left","caudal_perm_left_conv"],["caudal_rech_found","caudal_rech_found_conv"],["caudal_rech_left","caudal_rech_left_conv"]].forEach(([t,n])=>{const o=d(t),r=d(n);o&&r&&o.addEventListener("input",()=>vt(o,r))})}const Ct=["status-pass","status-fail","status-na"],At=new Set(["Pasa","Realizada","No"]),It=new Set(["No Pasa","Falla","No Realizada","Sí"]);function wt(e){return typeof e!="string"?"":e.trim()}function Z(e){if(!(e instanceof HTMLSelectElement))return;Ct.forEach(n=>e.classList.remove(n));const t=wt(e.value);At.has(t)?e.classList.add("status-pass"):It.has(t)?e.classList.add("status-fail"):e.classList.add("status-na")}function St(){document.querySelectorAll('select[id$="_found"], select[id$="_left"]').forEach(Z)}function xt(){document.querySelectorAll('select[id$="_found"], select[id$="_left"]').forEach(t=>{Z(t),t.addEventListener("change",()=>Z(t))})}function Nt(){document.querySelectorAll('input[type="number"]').forEach(t=>{t.addEventListener("input",Oe)})}function Tt(){["rechazo_found","rechazo_left","relacion_found","relacion_left"].forEach(e=>{const t=d(e);t&&(t.value="")})}function Dt(){["caudal_perm_found_conv","caudal_perm_left_conv","caudal_rech_found_conv","caudal_rech_left_conv"].forEach(e=>{const t=d(e);t&&(t.textContent="")})}function Ft(e=[]){const t=d("cliente");if(!t)return;const n=Array.isArray(e)?e:[],o=t.value,r=t.selectedOptions&&t.selectedOptions[0],a=r?r.getAttribute("data-cliente-key"):null,i=t.querySelector('option[value=""]');t.querySelectorAll(`option[${se}="true"]`).forEach(s=>s.remove()),D.clear();const c=document.createDocumentFragment();n.forEach((s,g)=>{if(!s||typeof s!="object")return;const b=mt(s)||pe(s);if(!b)return;const _=pe(s)||b,f=document.createElement("option");f.value=b,f.textContent=_;const y=`cliente-${g}`;f.setAttribute("data-cliente-key",y),f.setAttribute(se,"true"),c.appendChild(f),D.set(y,pt(s))}),t.appendChild(c),$&&t.removeEventListener("change",$),$=()=>{he(t)},t.addEventListener("change",$);let l=!1;if(a){const s=t.querySelector(`option[data-cliente-key="${a}"]`);s&&(s.selected=!0,t.value=s.value,l=!0)}!l&&o&&(t.value=o,l=t.value===o&&t.selectedIndex!==-1),l?he(t):(i?(i.selected=!0,t.value=i.value):t.options.length>0?t.selectedIndex=0:t.value="",O())}function Ot(){Fe(),Nt(),Lt(),xt(),ut(),ht(),Oe()}function Me(){const e=d("maintenance-form");e&&e.reset(),yt(),Fe(),Tt(),Dt(),St(),ft()}function Mt(){const e=d("maintenance-form");if(!(e instanceof HTMLFormElement))return{};const t=De(e),n=e.querySelector('input[name="sanitizacion"]:checked');if(t.sanitizacion=n?n.value:"",Object.prototype.hasOwnProperty.call(t,"fecha")){const r=A(t.fecha);t.fecha=r||A(new Date)}return Object.prototype.hasOwnProperty.call(t,"proximo_mant")&&(t.proximo_mant=A(t.proximo_mant)),["cond_red_found","cond_red_left","cond_perm_found","cond_perm_left","presion_found","presion_left","caudal_perm_found","caudal_perm_left","caudal_rech_found","caudal_rech_left","precarga_found","precarga_left"].forEach(r=>{Object.prototype.hasOwnProperty.call(t,r)&&t[r]===""&&(t[r]=0)}),t}function Pt(e){const t=d("report-number-display");t&&(t.textContent=e)}function Bt(){const e=new Date,t=o=>String(o).padStart(2,"0");return`REP-${`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}`}function I(e){return document.getElementById(e)}function ye(e){return A(e)||""}function U(e){const t=document.createElement("td");return t.className="px-6 py-4 whitespace-nowrap",t.textContent=e,t}function v(e){return String(e??"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function kt(e,{onEdit:t,onDelete:n}){const o=I("tabla-resultados"),r=I("resultados-busqueda");if(!(!o||!r)){if(p.mantenimientos=Array.isArray(e)?e:[],o.innerHTML="",!p.mantenimientos.length){const a=document.createElement("tr"),i=document.createElement("td");i.colSpan=5,i.className="px-6 py-4 text-center",i.textContent="No se encontraron resultados",a.appendChild(i),o.appendChild(a),r.classList.remove("hidden");return}p.mantenimientos.forEach(a=>{const i=document.createElement("tr");i.appendChild(U(a.Cliente||"N/A")),i.appendChild(U(a.Fecha_Servicio||"N/A")),i.appendChild(U(a.Tecnico_Asignado||"N/A")),i.appendChild(U(a.Modelo_Equipo||"N/A"));const c=document.createElement("td");c.className="px-6 py-4 whitespace-nowrap";const l=document.createElement("button");l.type="button",l.className="text-blue-600 hover:text-blue-900 mr-2",l.textContent="Editar",l.addEventListener("click",()=>t(a));const s=document.createElement("button");s.type="button",s.className="text-red-600 hover:text-red-900",s.textContent="Eliminar",s.addEventListener("click",()=>n(a)),c.appendChild(l),c.appendChild(s),i.appendChild(c),o.appendChild(i)}),r.classList.remove("hidden")}}function Rt(){const e=I("tabla-resultados");e&&(e.innerHTML="");const t=I("resultados-busqueda");t&&t.classList.add("hidden"),p.mantenimientos=[]}function $t(e){const t=I("modal-edicion"),n=I("formulario-edicion");if(!t||!n)return;p.mantenimientoEditando=e;const o=ye(e.Fecha_Servicio),r=ye(e.Proximo_Mantenimiento);n.innerHTML=`
        <form id="edit-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                    <input type="text" id="edit-cliente" name="cliente" value="${v(e.Cliente||"")}" class="w-full border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Servicio</label>
                    <input type="date" id="edit-fecha" name="fecha_servicio" value="${v(o)}" class="w-full border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Técnico</label>
                    <input type="text" id="edit-tecnico" name="tecnico_asignado" value="${v(e.Tecnico_Asignado||"")}" class="w-full border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Próximo Mantenimiento</label>
                    <input type="date" id="edit-proximo-mant" name="proximo_mantenimiento" value="${v(r)}" class="w-full border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Conductividad Permeado</label>
                    <input type="number" id="edit-cond-perm" name="conductividad_permeado_left" value="${v(e.Conductividad_Permeado_Left||0)}" class="w-full border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Resumen</label>
                    <textarea id="edit-resumen" name="resumen_recomendaciones" rows="3" class="w-full border-gray-300 rounded-md p-2">${v(e.Resumen_Recomendaciones||"")}</textarea>
                </div>
            </div>
            <input type="hidden" id="edit-id" name="id" value="${v(e.ID_Unico||"")}">
        </form>
    `,t.classList.remove("hidden")}function Pe(){const e=I("modal-edicion");e&&e.classList.add("hidden"),p.mantenimientoEditando=null}function Ut(){const e=document.getElementById("edit-form");if(!(e instanceof HTMLFormElement))return{};const t=De(e);return Object.prototype.hasOwnProperty.call(t,"conductividad_permeado_left")&&t.conductividad_permeado_left===""&&(t.conductividad_permeado_left=0),Object.prototype.hasOwnProperty.call(t,"fecha_servicio")&&(t.fecha_servicio=A(t.fecha_servicio)),Object.prototype.hasOwnProperty.call(t,"proximo_mantenimiento")&&(t.proximo_mantenimiento=A(t.proximo_mantenimiento)),t}const zt=[{value:"Cambiado",label:"Cambiado"},{value:"Inspeccionado",label:"Inspeccionado",default:!0}],jt=[{id:"etapa1",title:"1ª Sedimentos (PP)",placeholder:"Micronaje: __ µm"},{id:"etapa2",title:"2ª Carbón Bloque (CTO)",placeholder:"Modelo/Tipo"},{id:"etapa3",title:"3ª Carbón GAC / PP",placeholder:"Micronaje/Tipo"},{id:"etapa4",title:"4ª Membrana RO",placeholder:"Caudal GPD | S/N",emphasize:!0},{id:"etapa5",title:"5ª Post-Filtro",placeholder:"Tipo: Carbón, Remineralizador..."},{id:"etapa6",title:"6ª Adicional",placeholder:"Tipo: UV, Alcalino..."}];function qt(e,t){if(!Array.isArray(t)||t.length===0)return null;const n=t.filter(u=>u&&typeof u=="object");if(n.length===0)return null;const o=n.find(u=>u.default)||n[0],r=n.find(u=>u!==o)||o,a=document.createDocumentFragment(),i=document.createElement("input");i.type="hidden",i.name=`${e}_accion`,i.value=typeof o.value=="string"?o.value:String(o.value??""),i.defaultValue=i.value,a.appendChild(i);const c=document.createElement("label");c.className="toggle-switch";const l=document.createElement("input");l.type="checkbox",l.className="toggle-switch-input",l.setAttribute("role","switch"),l.setAttribute("aria-label","Alternar acción de la etapa");const s=document.createElement("span");s.className="toggle-switch-slider",s.setAttribute("aria-hidden","true"),c.appendChild(l),c.appendChild(s),a.appendChild(c);const g=document.createElement("span");g.className="stage-action-status",g.id=`${e}_accion_estado`,a.appendChild(g),l.setAttribute("aria-labelledby",g.id);const _=!(r!==o);l.checked=_,l.defaultChecked=_;const f=u=>{const m=u?r:o,P=typeof m.value=="string"?m.value:String(m.value??""),B=typeof m.label=="string"?m.label:String(m.label??"");i.value=P,g.textContent=B,l.setAttribute("aria-checked",String(!!u))};f(l.checked),l.addEventListener("change",()=>{f(l.checked)});const y=document.getElementById("maintenance-form");return y instanceof HTMLFormElement&&y.addEventListener("reset",()=>{(typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame.bind(window):m=>setTimeout(m,0))(()=>{l.checked=l.defaultChecked,f(l.checked)})}),a}function Vt(e,t){const n=e.querySelector(".stage-title");n&&(n.textContent=t.title,t.emphasize&&n.classList.add("font-bold"));const o=e.querySelector(".stage-details");o&&(o.id=`${t.id}_detalles`,o.name=`${t.id}_detalles`,o.placeholder=t.placeholder);const r=e.querySelector(".stage-actions");if(r){r.innerHTML="";const a=qt(t.id,zt);a&&r.appendChild(a)}}function Ht({containerId:e="component-stage-container",templateId:t="component-stage-template"}={}){const n=document.getElementById(e),o=document.getElementById(t);if(!n||!(o instanceof HTMLTemplateElement))return;n.innerHTML="";const r=document.createDocumentFragment();jt.forEach(a=>{const i=o.content.cloneNode(!0);Vt(i,a),r.appendChild(i)}),n.appendChild(r)}const Wt=typeof N=="string"&&N.length>0;Wt||console.warn("API_URL no configurado. Configura window.__APP_CONFIG__.API_URL o la variable de entorno API_URL.");function Gt(){const e=document.getElementById("app-version");if(e){{const t="1.0.0".trim();if(t){e.textContent=`Versión ${t}`,e.classList.remove("hidden");return}}e.textContent="",e.classList.add("hidden")}}function z(e){document.querySelectorAll(".tab-content").forEach(o=>o.classList.add("hidden")),document.querySelectorAll(".tab-button").forEach(o=>o.classList.remove("active"));const t=document.getElementById(`tab-${e}`);t&&t.classList.remove("hidden");const n=document.getElementById(`tab-${e}-btn`);n&&n.classList.add("active"),e==="dashboard"&&Qt()}async function Zt(){const e=document.getElementById("guardarButton");if(!e)return;const t=e.textContent;e.textContent="Guardando...",e.disabled=!0;try{const n=Bt(),o=Mt();o&&typeof o=="object"&&(o.numero_reporte=n),await Ke(o),alert("✅ Mantenimiento guardado correctamente en el sistema"),Pt(n),setTimeout(()=>{try{window.print()}catch(r){console.error("Error al imprimir el mantenimiento guardado:",r)}finally{Me()}},500)}catch(n){console.error("Error al guardar mantenimiento:",n);const o=(n==null?void 0:n.message)||"Error desconocido al guardar los datos.";alert(`❌ Error al guardar los datos: ${o}`)}finally{e.textContent=t,e.disabled=!1}}async function X(){var t,n,o;const e={cliente:((t=document.getElementById("buscar-cliente"))==null?void 0:t.value)||"",tecnico:((n=document.getElementById("buscar-tecnico"))==null?void 0:n.value)||"",fecha:((o=document.getElementById("buscar-fecha"))==null?void 0:o.value)||""};try{const r=await Ye(e);kt(r,{onEdit:Kt,onDelete:Yt})}catch(r){console.error("Error buscando mantenimientos:",r);const a=(r==null?void 0:r.message)||"Error desconocido al buscar mantenimientos.";alert(`❌ Error al buscar mantenimientos: ${a}`)}}function Jt(){["buscar-cliente","buscar-tecnico","buscar-fecha"].forEach(t=>{const n=document.getElementById(t);n&&(n.value="")}),Rt()}function Kt(e){e&&$t(e)}async function Yt(e){if(!(!(e!=null&&e.ID_Unico)||!window.confirm("¿Estás seguro de que quieres eliminar este mantenimiento?")))try{await Qe(e.ID_Unico),alert("✅ Mantenimiento eliminado correctamente"),await X()}catch(n){console.error("Error eliminando mantenimiento:",n),alert("Error al eliminar mantenimiento")}}async function Xt(){try{const e=Ut();await Xe(e),alert("✅ Cambios guardados correctamente"),Pe(),await X()}catch(e){console.error("Error guardando cambios:",e),alert("Error al guardar cambios")}}async function Qt(){try{const e=await et();at(e)}catch(e){console.error("Error cargando dashboard:",e)}}function en(){const e=document.getElementById("guardarButton");e&&e.addEventListener("click",Zt);const t=document.getElementById("resetButton");t&&t.addEventListener("click",Me);const n=document.getElementById("buscar-btn");n&&n.addEventListener("click",s=>{s.preventDefault(),X()});const o=document.getElementById("limpiar-btn");o&&o.addEventListener("click",s=>{s.preventDefault(),Jt()});const r=document.getElementById("cancelar-edicion-btn");r&&r.addEventListener("click",s=>{s.preventDefault(),Pe()});const a=document.getElementById("guardar-edicion-btn");a&&a.addEventListener("click",s=>{s.preventDefault(),Xt()});const i=document.getElementById("tab-nuevo-btn");i&&i.addEventListener("click",()=>z("nuevo"));const c=document.getElementById("tab-buscar-btn");c&&c.addEventListener("click",()=>z("buscar"));const l=document.getElementById("tab-dashboard-btn");l&&l.addEventListener("click",()=>z("dashboard"))}async function tn(){await Je(),Ht();let e=[];try{e=await tt()}catch(t){console.error("Error cargando clientes:",t);const n=t!=null&&t.message?` Detalle: ${t.message}`:"";alert(`No se pudieron cargar los datos de clientes. Podrás completar los campos manualmente.${n}`)}Ft(e),Ot(),en(),z("nuevo")}document.addEventListener("DOMContentLoaded",()=>{Gt(),tn().catch(e=>{console.error("Error inicializando la aplicación:",e),alert("No se pudo inicializar la aplicación. Revisa la consola para más detalles.")})});
